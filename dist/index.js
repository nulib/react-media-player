var Vi=Object.create;var Et=Object.defineProperty,zi=Object.defineProperties,Yi=Object.getOwnPropertyDescriptor,$i=Object.getOwnPropertyDescriptors,Xi=Object.getOwnPropertyNames,yt=Object.getOwnPropertySymbols,Qi=Object.getPrototypeOf,Mt=Object.prototype.hasOwnProperty,sr=Object.prototype.propertyIsEnumerable;var or=(i,e,t)=>e in i?Et(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Se=(i,e)=>{for(var t in e||(e={}))Mt.call(e,t)&&or(i,t,e[t]);if(yt)for(var t of yt(e))sr.call(e,t)&&or(i,t,e[t]);return i},ut=(i,e)=>zi(i,$i(e)),Zi=i=>Et(i,"__esModule",{value:!0});var Tt=(i,e)=>{var t={};for(var g in i)Mt.call(i,g)&&e.indexOf(g)<0&&(t[g]=i[g]);if(i!=null&&yt)for(var g of yt(i))e.indexOf(g)<0&&sr.call(i,g)&&(t[g]=i[g]);return t};var lr=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var Ji=(i,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let g of Xi(e))!Mt.call(i,g)&&g!=="default"&&Et(i,g,{get:()=>e[g],enumerable:!(t=Yi(e,g))||t.enumerable});return i},ur=i=>Ji(Zi(Et(i!=null?Vi(Qi(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);var vr=lr((Lt,hr)=>{(function(i,e){typeof Lt=="object"&&typeof hr!="undefined"?e(Lt):typeof define=="function"&&define.amd?define(["exports"],e):e((i=i||self).TypesafeActions={})})(Lt,function(i){"use strict";function e(s){return s==null}function t(s){throw new Error("Argument "+s+" is empty.")}function g(s){return typeof s=="function"&&"getType"in s}function v(s){throw new Error("Argument "+s+' is invalid, it should be an action-creator instance from "typesafe-actions"')}function l(s,r){if(s==null)throw new Error("Argument contains array with empty element at index "+r);if(s.getType==null)throw new Error("Argument contains array with invalid element at index "+r+', it should be an action-creator instance from "typesafe-actions"')}function P(s){return typeof s=="string"||typeof s=="symbol"}function b(s){return!P(s)}function C(s){throw new Error("Argument "+s+" is invalid, it should be an action type of type: string | symbol")}function L(s,r){if(s==null)throw new Error("Argument contains array with empty element at index "+r);if(typeof s!="string"&&typeof s!="symbol")throw new Error("Argument contains array with invalid element at index "+r+", it should be of type: string | symbol")}function m(s,r,n,a){return e(s)&&t(1),b(s)&&v(1),{type:s,payload:r,meta:n,error:a}}function A(s,r){return e(s)&&t(1),b(s)&&C(1),Object.assign(function(){var n=r!=null?r.apply(void 0,arguments):void 0;return Object.assign({type:s},n)},{getType:function(){return s},toString:function(){return s}})}function D(s,r,n){return e(s)&&t(1),b(s)&&C(1),function(){return A(s,function(){var a=arguments.length<=0?void 0:arguments[0],p=arguments.length<=1?void 0:arguments[1];return r==null&&n==null||(a=r!=null?r.apply(void 0,arguments):void 0,p=n!=null?n.apply(void 0,arguments):void 0),Object.assign({},a!==void 0&&{payload:a},{},p!==void 0&&{meta:p})})}}function S(s){return e(s)&&t(1),g(s)||v(1),s.getType()}function O(s,r){e(s)&&t(1),b(s)&&C(1);var n=r!=null?r(s):function(){return{type:s}};return Object.assign(n,{getType:function(){return s},toString:function(){return s}})}var I={createAction:function(s,r){var n=r==null?function(){return m(s)}:r(m.bind(null,s));return Object.assign(n,{getType:function(){return s},toString:function(){return s}})},createCustomAction:O,createStandardAction:function(s){return e(s)&&t(1),b(s)&&C(1),Object.assign(function(){return O(s,function(r){return function(n,a){return{type:r,payload:n,meta:a}}})},{map:function(r){return O(s,function(n){return function(a,p){return Object.assign(r(a,p),{type:n})}})}})}};i.action=m,i.createAction=D,i.createAsyncAction=function(s,r,n,a){return function(){var p=[s,r,n,a].map(function(f,h){return Array.isArray(f)?D(f[0],f[1],f[2])():typeof f=="string"||typeof f=="symbol"?D(f)():void(h<3&&function(x){throw new Error("Argument "+x+' is invalid, it should be an action type of "string | symbol" or a tuple of "[string | symbol, Function, Function?]"')}(h))});return{request:p[0],success:p[1],failure:p[2],cancel:p[3]}}},i.createCustomAction=A,i.createReducer=function s(r,n){n===void 0&&(n={});var a=Object.assign({},n),p=function(f,h){var x=Array.isArray(f)?f:[f],E={};return x.map(function(c,u){return g(c)?S(c):P(c)?c:function(o){throw new Error("Argument "+o+' is invalid, it should be an action-creator instance from "typesafe-actions" or action type of type: string | symbol')}(u+1)}).forEach(function(c){return E[c]=h}),s(r,Object.assign({},a,{},E))};return Object.assign(function(f,h){if(f===void 0&&(f=r),a.hasOwnProperty(h.type)){var x=a[h.type];if(typeof x!="function")throw Error('Reducer under "'+h.type+'" key is not a valid reducer');return x(f,h)}return f},{handlers:Object.assign({},a),handleAction:p,handleType:p})},i.deprecated=I,i.getType=S,i.isActionOf=function(s,r){e(s)&&t(1);var n=Array.isArray(s)?s:[s];n.forEach(l);var a=function(p){return n.some(function(f){return p.type===f.getType()})};return r===void 0?a:a(r)},i.isOfType=function(s,r){e(s)&&t(1);var n=Array.isArray(s)?s:[s];n.forEach(L);var a=function(p){return n.includes(p.type)};return r===void 0?a:a(r)}})});var _i=lr((mt,ir)=>{typeof window!="undefined"&&function(e,t){typeof mt=="object"&&typeof ir=="object"?ir.exports=t():typeof define=="function"&&define.amd?define([],t):typeof mt=="object"?mt.Hls=t():e.Hls=t()}(mt,function(){return function(i){var e={};function t(g){if(e[g])return e[g].exports;var v=e[g]={i:g,l:!1,exports:{}};return i[g].call(v.exports,v,v.exports,t),v.l=!0,v.exports}return t.m=i,t.c=e,t.d=function(g,v,l){t.o(g,v)||Object.defineProperty(g,v,{enumerable:!0,get:l})},t.r=function(g){typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(g,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(g,"__esModule",{value:!0})},t.t=function(g,v){if(v&1&&(g=t(g)),v&8||v&4&&typeof g=="object"&&g&&g.__esModule)return g;var l=Object.create(null);if(t.r(l),Object.defineProperty(l,"default",{enumerable:!0,value:g}),v&2&&typeof g!="string")for(var P in g)t.d(l,P,function(b){return g[b]}.bind(null,P));return l},t.n=function(g){var v=g&&g.__esModule?function(){return g.default}:function(){return g};return t.d(v,"a",v),v},t.o=function(g,v){return Object.prototype.hasOwnProperty.call(g,v)},t.p="/dist/",t(t.s="./src/hls.ts")}({"./node_modules/eventemitter3/index.js":function(i,e,t){"use strict";var g=Object.prototype.hasOwnProperty,v="~";function l(){}Object.create&&(l.prototype=Object.create(null),new l().__proto__||(v=!1));function P(m,A,D){this.fn=m,this.context=A,this.once=D||!1}function b(m,A,D,S,O){if(typeof D!="function")throw new TypeError("The listener must be a function");var I=new P(D,S||m,O),s=v?v+A:A;return m._events[s]?m._events[s].fn?m._events[s]=[m._events[s],I]:m._events[s].push(I):(m._events[s]=I,m._eventsCount++),m}function C(m,A){--m._eventsCount==0?m._events=new l:delete m._events[A]}function L(){this._events=new l,this._eventsCount=0}L.prototype.eventNames=function(){var A=[],D,S;if(this._eventsCount===0)return A;for(S in D=this._events)g.call(D,S)&&A.push(v?S.slice(1):S);return Object.getOwnPropertySymbols?A.concat(Object.getOwnPropertySymbols(D)):A},L.prototype.listeners=function(A){var D=v?v+A:A,S=this._events[D];if(!S)return[];if(S.fn)return[S.fn];for(var O=0,I=S.length,s=new Array(I);O<I;O++)s[O]=S[O].fn;return s},L.prototype.listenerCount=function(A){var D=v?v+A:A,S=this._events[D];return S?S.fn?1:S.length:0},L.prototype.emit=function(A,D,S,O,I,s){var r=v?v+A:A;if(!this._events[r])return!1;var n=this._events[r],a=arguments.length,p,f;if(n.fn){switch(n.once&&this.removeListener(A,n.fn,void 0,!0),a){case 1:return n.fn.call(n.context),!0;case 2:return n.fn.call(n.context,D),!0;case 3:return n.fn.call(n.context,D,S),!0;case 4:return n.fn.call(n.context,D,S,O),!0;case 5:return n.fn.call(n.context,D,S,O,I),!0;case 6:return n.fn.call(n.context,D,S,O,I,s),!0}for(f=1,p=new Array(a-1);f<a;f++)p[f-1]=arguments[f];n.fn.apply(n.context,p)}else{var h=n.length,x;for(f=0;f<h;f++)switch(n[f].once&&this.removeListener(A,n[f].fn,void 0,!0),a){case 1:n[f].fn.call(n[f].context);break;case 2:n[f].fn.call(n[f].context,D);break;case 3:n[f].fn.call(n[f].context,D,S);break;case 4:n[f].fn.call(n[f].context,D,S,O);break;default:if(!p)for(x=1,p=new Array(a-1);x<a;x++)p[x-1]=arguments[x];n[f].fn.apply(n[f].context,p)}}return!0},L.prototype.on=function(A,D,S){return b(this,A,D,S,!1)},L.prototype.once=function(A,D,S){return b(this,A,D,S,!0)},L.prototype.removeListener=function(A,D,S,O){var I=v?v+A:A;if(!this._events[I])return this;if(!D)return C(this,I),this;var s=this._events[I];if(s.fn)s.fn===D&&(!O||s.once)&&(!S||s.context===S)&&C(this,I);else{for(var r=0,n=[],a=s.length;r<a;r++)(s[r].fn!==D||O&&!s[r].once||S&&s[r].context!==S)&&n.push(s[r]);n.length?this._events[I]=n.length===1?n[0]:n:C(this,I)}return this},L.prototype.removeAllListeners=function(A){var D;return A?(D=v?v+A:A,this._events[D]&&C(this,D)):(this._events=new l,this._eventsCount=0),this},L.prototype.off=L.prototype.removeListener,L.prototype.addListener=L.prototype.on,L.prefixed=v,L.EventEmitter=L,i.exports=L},"./node_modules/url-toolkit/src/url-toolkit.js":function(i,e,t){(function(g){var v=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/?#]*)?((?:[^\/?#]*\/)*[^;?#]*)?(;[^?#]*)?(\?[^#]*)?(#[^]*)?$/,l=/^([^\/?#]*)([^]*)$/,P=/(?:\/|^)\.(?=\/)/g,b=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,C={buildAbsoluteURL:function(L,m,A){if(A=A||{},L=L.trim(),m=m.trim(),!m){if(!A.alwaysNormalize)return L;var D=C.parseURL(L);if(!D)throw new Error("Error trying to parse base URL.");return D.path=C.normalizePath(D.path),C.buildURLFromParts(D)}var S=C.parseURL(m);if(!S)throw new Error("Error trying to parse relative URL.");if(S.scheme)return A.alwaysNormalize?(S.path=C.normalizePath(S.path),C.buildURLFromParts(S)):m;var O=C.parseURL(L);if(!O)throw new Error("Error trying to parse base URL.");if(!O.netLoc&&O.path&&O.path[0]!=="/"){var I=l.exec(O.path);O.netLoc=I[1],O.path=I[2]}O.netLoc&&!O.path&&(O.path="/");var s={scheme:O.scheme,netLoc:S.netLoc,path:null,params:S.params,query:S.query,fragment:S.fragment};if(!S.netLoc&&(s.netLoc=O.netLoc,S.path[0]!=="/"))if(!S.path)s.path=O.path,S.params||(s.params=O.params,S.query||(s.query=O.query));else{var r=O.path,n=r.substring(0,r.lastIndexOf("/")+1)+S.path;s.path=C.normalizePath(n)}return s.path===null&&(s.path=A.alwaysNormalize?C.normalizePath(S.path):S.path),C.buildURLFromParts(s)},parseURL:function(L){var m=v.exec(L);return m?{scheme:m[1]||"",netLoc:m[2]||"",path:m[3]||"",params:m[4]||"",query:m[5]||"",fragment:m[6]||""}:null},normalizePath:function(L){for(L=L.split("").reverse().join("").replace(P,"");L.length!==(L=L.replace(b,"")).length;);return L.split("").reverse().join("")},buildURLFromParts:function(L){return L.scheme+L.netLoc+L.path+L.params+L.query+L.fragment}};i.exports=C})(this)},"./node_modules/webworkify-webpack/index.js":function(i,e,t){function g(A){var D={};function S(I){if(D[I])return D[I].exports;var s=D[I]={i:I,l:!1,exports:{}};return A[I].call(s.exports,s,s.exports,S),s.l=!0,s.exports}S.m=A,S.c=D,S.i=function(I){return I},S.d=function(I,s,r){S.o(I,s)||Object.defineProperty(I,s,{configurable:!1,enumerable:!0,get:r})},S.r=function(I){Object.defineProperty(I,"__esModule",{value:!0})},S.n=function(I){var s=I&&I.__esModule?function(){return I.default}:function(){return I};return S.d(s,"a",s),s},S.o=function(I,s){return Object.prototype.hasOwnProperty.call(I,s)},S.p="/",S.oe=function(I){throw console.error(I),I};var O=S(S.s=ENTRY_MODULE);return O.default||O}var v="[\\.|\\-|\\+|\\w|/|@]+",l="\\(\\s*(/\\*.*?\\*/)?\\s*.*?("+v+").*?\\)";function P(A){return(A+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function b(A){return!isNaN(1*A)}function C(A,D,S){var O={};O[S]=[];var I=D.toString(),s=I.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!s)return O;for(var r=s[1],n=new RegExp("(\\\\n|\\W)"+P(r)+l,"g"),a;a=n.exec(I);)a[3]!=="dll-reference"&&O[S].push(a[3]);for(n=new RegExp("\\("+P(r)+'\\("(dll-reference\\s('+v+'))"\\)\\)'+l,"g");a=n.exec(I);)A[a[2]]||(O[S].push(a[1]),A[a[2]]=t(a[1]).m),O[a[2]]=O[a[2]]||[],O[a[2]].push(a[4]);for(var p=Object.keys(O),f=0;f<p.length;f++)for(var h=0;h<O[p[f]].length;h++)b(O[p[f]][h])&&(O[p[f]][h]=1*O[p[f]][h]);return O}function L(A){var D=Object.keys(A);return D.reduce(function(S,O){return S||A[O].length>0},!1)}function m(A,D){for(var S={main:[D]},O={main:[]},I={main:{}};L(S);)for(var s=Object.keys(S),r=0;r<s.length;r++){var n=s[r],a=S[n],p=a.pop();if(I[n]=I[n]||{},!(I[n][p]||!A[n][p])){I[n][p]=!0,O[n]=O[n]||[],O[n].push(p);for(var f=C(A,A[n][p],n),h=Object.keys(f),x=0;x<h.length;x++)S[h[x]]=S[h[x]]||[],S[h[x]]=S[h[x]].concat(f[h[x]])}}return O}i.exports=function(A,D){D=D||{};var S={main:t.m},O=D.all?{main:Object.keys(S.main)}:m(S,A),I="";Object.keys(O).filter(function(p){return p!=="main"}).forEach(function(p){for(var f=0;O[p][f];)f++;O[p].push(f),S[p][f]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",I=I+"var "+p+" = ("+g.toString().replace("ENTRY_MODULE",JSON.stringify(f))+")({"+O[p].map(function(h){return""+JSON.stringify(h)+": "+S[p][h].toString()}).join(",")+`});
`}),I=I+"new (("+g.toString().replace("ENTRY_MODULE",JSON.stringify(A))+")({"+O.main.map(function(p){return""+JSON.stringify(p)+": "+S.main[p].toString()}).join(",")+"}))(self);";var s=new window.Blob([I],{type:"text/javascript"});if(D.bare)return s;var r=window.URL||window.webkitURL||window.mozURL||window.msURL,n=r.createObjectURL(s),a=new window.Worker(n);return a.objectURL=n,a}},"./src/config.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"hlsDefaultConfig",function(){return h}),t.d(e,"mergeConfig",function(){return E}),t.d(e,"enableStreamingMode",function(){return c});var g=t("./src/controller/abr-controller.ts"),v=t("./src/controller/audio-stream-controller.ts"),l=t("./src/controller/audio-track-controller.ts"),P=t("./src/controller/subtitle-stream-controller.ts"),b=t("./src/controller/subtitle-track-controller.ts"),C=t("./src/controller/buffer-controller.ts"),L=t("./src/controller/timeline-controller.ts"),m=t("./src/controller/cap-level-controller.ts"),A=t("./src/controller/fps-controller.ts"),D=t("./src/controller/eme-controller.ts"),S=t("./src/utils/xhr-loader.ts"),O=t("./src/utils/fetch-loader.ts"),I=t("./src/utils/cues.ts"),s=t("./src/utils/mediakeys-helper.ts"),r=t("./src/utils/logger.ts");function n(){return n=Object.assign||function(u){for(var o=1;o<arguments.length;o++){var d=arguments[o];for(var T in d)Object.prototype.hasOwnProperty.call(d,T)&&(u[T]=d[T])}return u},n.apply(this,arguments)}function a(u,o){var d=Object.keys(u);if(Object.getOwnPropertySymbols){var T=Object.getOwnPropertySymbols(u);o&&(T=T.filter(function(y){return Object.getOwnPropertyDescriptor(u,y).enumerable})),d.push.apply(d,T)}return d}function p(u){for(var o=1;o<arguments.length;o++){var d=arguments[o]!=null?arguments[o]:{};o%2?a(Object(d),!0).forEach(function(T){f(u,T,d[T])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(d)):a(Object(d)).forEach(function(T){Object.defineProperty(u,T,Object.getOwnPropertyDescriptor(d,T))})}return u}function f(u,o,d){return o in u?Object.defineProperty(u,o,{value:d,enumerable:!0,configurable:!0,writable:!0}):u[o]=d,u}var h=p(p({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:S.default,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:g.default,bufferController:C.default,capLevelController:m.default,fpsController:A.default,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystemOptions:{},requestMediaKeySystemAccessFunc:s.requestMediaKeySystemAccess,testBandwidth:!0,progressive:!1,lowLatencyMode:!0},x()),{},{subtitleStreamController:P.SubtitleStreamController,subtitleTrackController:b.default,timelineController:L.TimelineController,audioStreamController:v.default,audioTrackController:l.default,emeController:D.default});function x(){return{cueHandler:I.default,enableCEA708Captions:!0,enableWebVTT:!0,enableIMSC1:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function E(u,o){if((o.liveSyncDurationCount||o.liveMaxLatencyDurationCount)&&(o.liveSyncDuration||o.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(o.liveMaxLatencyDurationCount!==void 0&&(o.liveSyncDurationCount===void 0||o.liveMaxLatencyDurationCount<=o.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(o.liveMaxLatencyDuration!==void 0&&(o.liveSyncDuration===void 0||o.liveMaxLatencyDuration<=o.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');return n({},u,o)}function c(u){var o=u.loader;if(o!==O.default&&o!==S.default)r.logger.log("[config]: Custom loader detected, cannot enable progressive streaming"),u.progressive=!1;else{var d=Object(O.fetchSupported)();d&&(u.loader=O.default,u.progressive=!0,u.enableSoftwareAES=!0,r.logger.log("[config]: Progressive streaming enabled, using FetchLoader"))}}},"./src/controller/abr-controller.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/polyfills/number.ts"),v=t("./src/utils/ewma-bandwidth-estimator.ts"),l=t("./src/events.ts"),P=t("./src/utils/buffer-helper.ts"),b=t("./src/errors.ts"),C=t("./src/types/loader.ts"),L=t("./src/utils/logger.ts");function m(S,O){for(var I=0;I<O.length;I++){var s=O[I];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(S,s.key,s)}}function A(S,O,I){return O&&m(S.prototype,O),I&&m(S,I),S}var D=function(){function S(I){this.hls=void 0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=void 0,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=I;var s=I.config;this.bwEstimator=new v.default(s.abrEwmaSlowVoD,s.abrEwmaFastVoD,s.abrEwmaDefaultEstimate),this.registerListeners()}var O=S.prototype;return O.registerListeners=function(){var s=this.hls;s.on(l.Events.FRAG_LOADING,this.onFragLoading,this),s.on(l.Events.FRAG_LOADED,this.onFragLoaded,this),s.on(l.Events.FRAG_BUFFERED,this.onFragBuffered,this),s.on(l.Events.LEVEL_LOADED,this.onLevelLoaded,this),s.on(l.Events.ERROR,this.onError,this)},O.unregisterListeners=function(){var s=this.hls;s.off(l.Events.FRAG_LOADING,this.onFragLoading,this),s.off(l.Events.FRAG_LOADED,this.onFragLoaded,this),s.off(l.Events.FRAG_BUFFERED,this.onFragBuffered,this),s.off(l.Events.LEVEL_LOADED,this.onLevelLoaded,this),s.off(l.Events.ERROR,this.onError,this)},O.destroy=function(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null},O.onFragLoading=function(s,r){var n=r.frag;if(n.type===C.PlaylistLevelType.MAIN&&!this.timer){var a;this.fragCurrent=n,this.partCurrent=(a=r.part)!=null?a:null,this.timer=self.setInterval(this.onCheck,100)}},O.onLevelLoaded=function(s,r){var n=this.hls.config;r.details.live?this.bwEstimator.update(n.abrEwmaSlowLive,n.abrEwmaFastLive):this.bwEstimator.update(n.abrEwmaSlowVoD,n.abrEwmaFastVoD)},O._abandonRulesCheck=function(){var s=this.fragCurrent,r=this.partCurrent,n=this.hls,a=n.autoLevelEnabled,p=n.config,f=n.media;if(!(!s||!f)){var h=r?r.stats:s.stats,x=r?r.duration:s.duration;if(h.aborted){L.logger.warn("frag loader destroy or aborted, disarm abandonRules"),this.clearTimer(),this._nextAutoLevel=-1;return}if(!(!a||f.paused||!f.playbackRate||!f.readyState)){var E=performance.now()-h.loading.start,c=Math.abs(f.playbackRate);if(!(E<=500*x/c)){var u=n.levels,o=n.minAutoLevel,d=u[s.level],T=h.total||Math.max(h.loaded,Math.round(x*d.maxBitrate/8)),y=Math.max(1,h.bwEstimate?h.bwEstimate/8:h.loaded*1e3/E),R=(T-h.loaded)/y,M=f.currentTime,_=(P.BufferHelper.bufferInfo(f,M,p.maxBufferHole).end-M)/c;if(!(_>=2*x/c||R<=_)){var F=Number.POSITIVE_INFINITY,B;for(B=s.level-1;B>o;B--){var w=u[B].maxBitrate;if(F=x*w/(8*.8*y),F<_)break}if(!(F>=R)){var k=this.bwEstimator.getEstimate();L.logger.warn("Fragment "+s.sn+(r?" part "+r.index:"")+" of level "+s.level+" is loading too slowly and will cause an underbuffer; aborting and switching to level "+B+`
      Current BW estimate: `+(Object(g.isFiniteNumber)(k)?(k/1024).toFixed(3):"Unknown")+` Kb/s
      Estimated load time for current fragment: `+R.toFixed(3)+` s
      Estimated load time for the next fragment: `+F.toFixed(3)+` s
      Time to underbuffer: `+_.toFixed(3)+" s"),n.nextLoadLevel=B,this.bwEstimator.sample(E,h.loaded),this.clearTimer(),s.loader&&(this.fragCurrent=this.partCurrent=null,s.loader.abort()),n.trigger(l.Events.FRAG_LOAD_EMERGENCY_ABORTED,{frag:s,part:r,stats:h})}}}}}},O.onFragLoaded=function(s,r){var n=r.frag,a=r.part;if(n.type===C.PlaylistLevelType.MAIN&&Object(g.isFiniteNumber)(n.sn)){var p=a?a.stats:n.stats,f=a?a.duration:n.duration;if(this.clearTimer(),this.lastLoadedFragLevel=n.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var h=this.hls.levels[n.level],x=(h.loaded?h.loaded.bytes:0)+p.loaded,E=(h.loaded?h.loaded.duration:0)+f;h.loaded={bytes:x,duration:E},h.realBitrate=Math.round(8*x/E)}if(n.bitrateTest){var c={stats:p,frag:n,part:a,id:n.type};this.onFragBuffered(l.Events.FRAG_BUFFERED,c),n.bitrateTest=!1}}},O.onFragBuffered=function(s,r){var n=r.frag,a=r.part,p=a?a.stats:n.stats;if(!p.aborted&&!(n.type!==C.PlaylistLevelType.MAIN||n.sn==="initSegment")){var f=p.parsing.end-p.loading.start;this.bwEstimator.sample(f,p.loaded),p.bwEstimate=this.bwEstimator.getEstimate(),n.bitrateTest?this.bitrateTestDelay=f/1e3:this.bitrateTestDelay=0}},O.onError=function(s,r){switch(r.details){case b.ErrorDetails.FRAG_LOAD_ERROR:case b.ErrorDetails.FRAG_LOAD_TIMEOUT:this.clearTimer();break;default:break}},O.clearTimer=function(){self.clearInterval(this.timer),this.timer=void 0},O.getNextABRAutoLevel=function(){var s=this.fragCurrent,r=this.partCurrent,n=this.hls,a=n.maxAutoLevel,p=n.config,f=n.minAutoLevel,h=n.media,x=r?r.duration:s?s.duration:0,E=h?h.currentTime:0,c=h&&h.playbackRate!==0?Math.abs(h.playbackRate):1,u=this.bwEstimator?this.bwEstimator.getEstimate():p.abrEwmaDefaultEstimate,o=(P.BufferHelper.bufferInfo(h,E,p.maxBufferHole).end-E)/c,d=this.findBestLevel(u,f,a,o,p.abrBandWidthFactor,p.abrBandWidthUpFactor);if(d>=0)return d;L.logger.trace((o?"rebuffering expected":"buffer is empty")+", finding optimal quality level");var T=x?Math.min(x,p.maxStarvationDelay):p.maxStarvationDelay,y=p.abrBandWidthFactor,R=p.abrBandWidthUpFactor;if(!o){var M=this.bitrateTestDelay;if(M){var _=x?Math.min(x,p.maxLoadingDelay):p.maxLoadingDelay;T=_-M,L.logger.trace("bitrate test took "+Math.round(1e3*M)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*T)+" ms"),y=R=1}}return d=this.findBestLevel(u,f,a,o+T,y,R),Math.max(d,0)},O.findBestLevel=function(s,r,n,a,p,f){for(var h,x=this.fragCurrent,E=this.partCurrent,c=this.lastLoadedFragLevel,u=this.hls.levels,o=u[c],d=!!(o!=null&&(h=o.details)!==null&&h!==void 0&&h.live),T=o==null?void 0:o.codecSet,y=E?E.duration:x?x.duration:0,R=n;R>=r;R--){var M=u[R];if(!(!M||T&&M.codecSet!==T)){var _=M.details,F=(E?_==null?void 0:_.partTarget:_==null?void 0:_.averagetargetduration)||y,B=void 0;R<=c?B=p*s:B=f*s;var w=u[R].maxBitrate,k=w*F/B;if(L.logger.trace("level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: "+R+"/"+Math.round(B)+"/"+w+"/"+F+"/"+a+"/"+k),B>w&&(!k||d&&!this.bitrateTestDelay||k<a))return R}}return-1},A(S,[{key:"nextAutoLevel",get:function(){var s=this._nextAutoLevel,r=this.bwEstimator;if(s!==-1&&(!r||!r.canEstimate()))return s;var n=this.getNextABRAutoLevel();return s!==-1&&(n=Math.min(s,n)),n},set:function(s){this._nextAutoLevel=s}}]),S}();e.default=D},"./src/controller/audio-stream-controller.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/polyfills/number.ts"),v=t("./src/controller/base-stream-controller.ts"),l=t("./src/events.ts"),P=t("./src/utils/buffer-helper.ts"),b=t("./src/controller/fragment-tracker.ts"),C=t("./src/types/level.ts"),L=t("./src/types/loader.ts"),m=t("./src/loader/fragment.ts"),A=t("./src/demux/chunk-cache.ts"),D=t("./src/demux/transmuxer-interface.ts"),S=t("./src/types/transmuxer.ts"),O=t("./src/controller/fragment-finders.ts"),I=t("./src/utils/discontinuities.ts"),s=t("./src/errors.ts"),r=t("./src/utils/logger.ts");function n(){return n=Object.assign||function(x){for(var E=1;E<arguments.length;E++){var c=arguments[E];for(var u in c)Object.prototype.hasOwnProperty.call(c,u)&&(x[u]=c[u])}return x},n.apply(this,arguments)}function a(x,E){x.prototype=Object.create(E.prototype),x.prototype.constructor=x,p(x,E)}function p(x,E){return p=Object.setPrototypeOf||function(u,o){return u.__proto__=o,u},p(x,E)}var f=100,h=function(x){a(E,x);function E(u,o){var d;return d=x.call(this,u,o,"[audio-stream-controller]")||this,d.videoBuffer=null,d.videoTrackCC=-1,d.waitingVideoCC=-1,d.audioSwitch=!1,d.trackId=-1,d.waitingData=null,d.mainDetails=null,d.bufferFlushed=!1,d._registerListeners(),d}var c=E.prototype;return c.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},c._registerListeners=function(){var o=this.hls;o.on(l.Events.MEDIA_ATTACHED,this.onMediaAttached,this),o.on(l.Events.MEDIA_DETACHING,this.onMediaDetaching,this),o.on(l.Events.MANIFEST_LOADING,this.onManifestLoading,this),o.on(l.Events.LEVEL_LOADED,this.onLevelLoaded,this),o.on(l.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),o.on(l.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),o.on(l.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),o.on(l.Events.ERROR,this.onError,this),o.on(l.Events.BUFFER_RESET,this.onBufferReset,this),o.on(l.Events.BUFFER_CREATED,this.onBufferCreated,this),o.on(l.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),o.on(l.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),o.on(l.Events.FRAG_BUFFERED,this.onFragBuffered,this)},c._unregisterListeners=function(){var o=this.hls;o.off(l.Events.MEDIA_ATTACHED,this.onMediaAttached,this),o.off(l.Events.MEDIA_DETACHING,this.onMediaDetaching,this),o.off(l.Events.MANIFEST_LOADING,this.onManifestLoading,this),o.off(l.Events.LEVEL_LOADED,this.onLevelLoaded,this),o.off(l.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),o.off(l.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),o.off(l.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),o.off(l.Events.ERROR,this.onError,this),o.off(l.Events.BUFFER_RESET,this.onBufferReset,this),o.off(l.Events.BUFFER_CREATED,this.onBufferCreated,this),o.off(l.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),o.off(l.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),o.off(l.Events.FRAG_BUFFERED,this.onFragBuffered,this)},c.onInitPtsFound=function(o,d){var T=d.frag,y=d.id,R=d.initPTS;if(y==="main"){var M=T.cc;this.initPTS[T.cc]=R,this.log("InitPTS for cc: "+M+" found from main: "+R),this.videoTrackCC=M,this.state===v.State.WAITING_INIT_PTS&&this.tick()}},c.startLoad=function(o){if(!this.levels){this.startPosition=o,this.state=v.State.STOPPED;return}var d=this.lastCurrentTime;this.stopLoad(),this.setInterval(f),this.fragLoadError=0,d>0&&o===-1?(this.log("Override startPosition with lastCurrentTime @"+d.toFixed(3)),this.state=v.State.IDLE):(this.loadedmetadata=!1,this.state=v.State.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=o,this.tick()},c.doTick=function(){switch(this.state){case v.State.IDLE:this.doTickIdle();break;case v.State.WAITING_TRACK:{var o,d=this.levels,T=this.trackId,y=d==null||(o=d[T])===null||o===void 0?void 0:o.details;if(y){if(this.waitForCdnTuneIn(y))break;this.state=v.State.WAITING_INIT_PTS}break}case v.State.FRAG_LOADING_WAITING_RETRY:{var R,M=performance.now(),_=this.retryDate;(!_||M>=_||(R=this.media)!==null&&R!==void 0&&R.seeking)&&(this.log("RetryDate reached, switch back to IDLE state"),this.state=v.State.IDLE);break}case v.State.WAITING_INIT_PTS:{var F=this.waitingData;if(F){var B=F.frag,w=F.part,k=F.cache,U=F.complete;if(this.initPTS[B.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=v.State.FRAG_LOADING;var N=k.flush(),W={frag:B,part:w,payload:N,networkDetails:null};this._handleFragmentLoadProgress(W),U&&x.prototype._handleFragmentLoadComplete.call(this,W)}else if(this.videoTrackCC!==this.waitingVideoCC)r.logger.log("Waiting fragment cc ("+B.cc+") cancelled because video is at cc "+this.videoTrackCC),this.clearWaitingFragment();else{var K=this.getLoadPosition(),H=P.BufferHelper.bufferInfo(this.mediaBuffer,K,this.config.maxBufferHole),G=Object(O.fragmentWithinToleranceTest)(H.end,this.config.maxFragLookUpTolerance,B);G<0&&(r.logger.log("Waiting fragment cc ("+B.cc+") @ "+B.start+" cancelled because another fragment at "+H.end+" is needed"),this.clearWaitingFragment())}}else this.state=v.State.IDLE}}this.onTickEnd()},c.clearWaitingFragment=function(){var o=this.waitingData;o&&(this.fragmentTracker.removeFragment(o.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=v.State.IDLE)},c.onTickEnd=function(){var o=this.media;if(!(!o||!o.readyState)){var d=this.mediaBuffer?this.mediaBuffer:o,T=d.buffered;!this.loadedmetadata&&T.length&&(this.loadedmetadata=!0),this.lastCurrentTime=o.currentTime}},c.doTickIdle=function(){var o,d,T=this.hls,y=this.levels,R=this.media,M=this.trackId,_=T.config;if(!(!y||!y[M])&&!(!R&&(this.startFragRequested||!_.startFragPrefetch))){var F=y[M],B=F.details;if(!B||B.live&&this.levelLastLoaded!==M||this.waitForCdnTuneIn(B)){this.state=v.State.WAITING_TRACK;return}this.bufferFlushed&&(this.bufferFlushed=!1,this.afterBufferFlushed(this.mediaBuffer?this.mediaBuffer:this.media,m.ElementaryStreamTypes.AUDIO,L.PlaylistLevelType.AUDIO));var w=this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,L.PlaylistLevelType.AUDIO);if(w!==null){var k=w.len,U=this.getMaxBufferLength(),N=this.audioSwitch;if(!(k>=U&&!N)){if(!N&&this._streamEnded(w,B)){T.trigger(l.Events.BUFFER_EOS,{type:"audio"}),this.state=v.State.ENDED;return}var W=B.fragments,K=W[0].start,H=w.end;if(N){var G=this.getLoadPosition();H=G,B.PTSKnown&&G<K&&(w.end>K||w.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),R.currentTime=K+.05)}var V=this.getNextFragment(H,B);if(!V){this.bufferFlushed=!0;return}((o=V.decryptdata)===null||o===void 0?void 0:o.keyFormat)==="identity"&&!((d=V.decryptdata)!==null&&d!==void 0&&d.key)?this.loadKey(V,B):this.loadFragment(V,B,H)}}}},c.getMaxBufferLength=function(){var o=x.prototype.getMaxBufferLength.call(this),d=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,L.PlaylistLevelType.MAIN);return d===null?o:Math.max(o,d.len)},c.onMediaDetaching=function(){this.videoBuffer=null,x.prototype.onMediaDetaching.call(this)},c.onAudioTracksUpdated=function(o,d){var T=d.audioTracks;this.resetTransmuxer(),this.levels=T.map(function(y){return new C.Level(y)})},c.onAudioTrackSwitching=function(o,d){var T=!!d.url;this.trackId=d.id;var y=this.fragCurrent;y!=null&&y.loader&&y.loader.abort(),this.fragCurrent=null,this.clearWaitingFragment(),T?this.setInterval(f):this.resetTransmuxer(),T?(this.audioSwitch=!0,this.state=v.State.IDLE):this.state=v.State.STOPPED,this.tick()},c.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1},c.onLevelLoaded=function(o,d){this.mainDetails=d.details},c.onAudioTrackLoaded=function(o,d){var T,y=this.levels,R=d.details,M=d.id;if(!y){this.warn("Audio tracks were reset while loading level "+M);return}this.log("Track "+M+" loaded ["+R.startSN+","+R.endSN+"],duration:"+R.totalduration);var _=y[M],F=0;if(R.live||(T=_.details)!==null&&T!==void 0&&T.live){var B=this.mainDetails;if(R.fragments[0]||(R.deltaUpdateFailed=!0),R.deltaUpdateFailed||!B)return;!_.details&&R.hasProgramDateTime&&B.hasProgramDateTime?(Object(I.alignMediaPlaylistByPDT)(R,B),F=R.fragments[0].start):F=this.alignPlaylists(R,_.details)}_.details=R,this.levelLastLoaded=M,!this.startFragRequested&&(this.mainDetails||!R.live)&&this.setStartPosition(_.details,F),this.state===v.State.WAITING_TRACK&&!this.waitForCdnTuneIn(R)&&(this.state=v.State.IDLE),this.tick()},c._handleFragmentLoadProgress=function(o){var d,T=o.frag,y=o.part,R=o.payload,M=this.config,_=this.trackId,F=this.levels;if(!F){this.warn("Audio tracks were reset while fragment load was in progress. Fragment "+T.sn+" of level "+T.level+" will not be buffered");return}var B=F[_];console.assert(B,"Audio track is defined on fragment load progress");var w=B.details;console.assert(w,"Audio track details are defined on fragment load progress");var k=M.defaultAudioCodec||B.audioCodec||"mp4a.40.2",U=this.transmuxer;U||(U=this.transmuxer=new D.default(this.hls,L.PlaylistLevelType.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));var N=this.initPTS[T.cc],W=(d=T.initSegment)===null||d===void 0?void 0:d.data;if(N!==void 0){var K=!1,H=y?y.index:-1,G=H!==-1,V=new S.ChunkMetadata(T.level,T.sn,T.stats.chunkCount,R.byteLength,H,G);U.push(R,W,k,"",T,y,w.totalduration,K,V,N)}else{r.logger.log("Unknown video PTS for cc "+T.cc+", waiting for video PTS before demuxing audio frag "+T.sn+" of ["+w.startSN+" ,"+w.endSN+"],track "+_);var X=this.waitingData=this.waitingData||{frag:T,part:y,cache:new A.default,complete:!1},z=X.cache;z.push(new Uint8Array(R)),this.waitingVideoCC=this.videoTrackCC,this.state=v.State.WAITING_INIT_PTS}},c._handleFragmentLoadComplete=function(o){if(this.waitingData){this.waitingData.complete=!0;return}x.prototype._handleFragmentLoadComplete.call(this,o)},c.onBufferReset=function(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1},c.onBufferCreated=function(o,d){var T=d.tracks.audio;T&&(this.mediaBuffer=T.buffer),d.tracks.video&&(this.videoBuffer=d.tracks.video.buffer)},c.onFragBuffered=function(o,d){var T=d.frag,y=d.part;if(T.type===L.PlaylistLevelType.AUDIO){if(this.fragContextChanged(T)){this.warn("Fragment "+T.sn+(y?" p: "+y.index:"")+" of level "+T.level+" finished buffering, but was aborted. state: "+this.state+", audioSwitch: "+this.audioSwitch);return}T.sn!=="initSegment"&&(this.fragPrevious=T,this.audioSwitch&&(this.audioSwitch=!1,this.hls.trigger(l.Events.AUDIO_TRACK_SWITCHED,{id:this.trackId}))),this.fragBufferedComplete(T,y)}},c.onError=function(o,d){switch(d.details){case s.ErrorDetails.FRAG_LOAD_ERROR:case s.ErrorDetails.FRAG_LOAD_TIMEOUT:case s.ErrorDetails.KEY_LOAD_ERROR:case s.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(L.PlaylistLevelType.AUDIO,d);break;case s.ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case s.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:this.state!==v.State.ERROR&&this.state!==v.State.STOPPED&&(this.state=d.fatal?v.State.ERROR:v.State.IDLE,this.warn(d.details+" while loading frag, switching to "+this.state+" state"));break;case s.ErrorDetails.BUFFER_FULL_ERROR:if(d.parent==="audio"&&(this.state===v.State.PARSING||this.state===v.State.PARSED)){var T=!0,y=this.getFwdBufferInfo(this.mediaBuffer,L.PlaylistLevelType.AUDIO);y&&y.len>.5&&(T=!this.reduceMaxBufferLength(y.len)),T&&(this.warn("Buffer full error also media.currentTime is not buffered, flush audio buffer"),this.fragCurrent=null,x.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.resetLoadingState()}break;default:break}},c.onBufferFlushed=function(o,d){var T=d.type;T===m.ElementaryStreamTypes.AUDIO&&(this.bufferFlushed=!0)},c._handleTransmuxComplete=function(o){var d,T="audio",y=this.hls,R=o.remuxResult,M=o.chunkMeta,_=this.getCurrentContext(M);if(!_){this.warn("The loading context changed while buffering fragment "+M.sn+" of level "+M.level+". This chunk will not be buffered."),this.resetLiveStartWhenNotLoaded(M.level);return}var F=_.frag,B=_.part,w=R.audio,k=R.text,U=R.id3,N=R.initSegment;if(!this.fragContextChanged(F)){if(this.state=v.State.PARSING,this.audioSwitch&&w&&this.completeAudioSwitch(),N!=null&&N.tracks&&(this._bufferInitSegment(N.tracks,F,M),y.trigger(l.Events.FRAG_PARSING_INIT_SEGMENT,{frag:F,id:T,tracks:N.tracks})),w){var W=w.startPTS,K=w.endPTS,H=w.startDTS,G=w.endDTS;B&&(B.elementaryStreams[m.ElementaryStreamTypes.AUDIO]={startPTS:W,endPTS:K,startDTS:H,endDTS:G}),F.setElementaryStreamInfo(m.ElementaryStreamTypes.AUDIO,W,K,H,G),this.bufferFragmentData(w,F,B,M)}if(U!=null&&(d=U.samples)!==null&&d!==void 0&&d.length){var V=n({frag:F,id:T},U);y.trigger(l.Events.FRAG_PARSING_METADATA,V)}if(k){var X=n({frag:F,id:T},k);y.trigger(l.Events.FRAG_PARSING_USERDATA,X)}}},c._bufferInitSegment=function(o,d,T){if(this.state===v.State.PARSING){o.video&&delete o.video;var y=o.audio;if(!!y){y.levelCodec=y.codec,y.id="audio",this.log("Init audio buffer, container:"+y.container+", codecs[parsed]=["+y.codec+"]"),this.hls.trigger(l.Events.BUFFER_CODECS,o);var R=y.initSegment;if(R!=null&&R.byteLength){var M={type:"audio",frag:d,part:null,chunkMeta:T,parent:d.type,data:R};this.hls.trigger(l.Events.BUFFER_APPENDING,M)}this.tick()}}},c.loadFragment=function(o,d,T){var y=this.fragmentTracker.getState(o);this.fragCurrent=o,(this.audioSwitch||y===b.FragmentState.NOT_LOADED||y===b.FragmentState.PARTIAL)&&(o.sn==="initSegment"?this._loadInitSegment(o):d.live&&!Object(g.isFiniteNumber)(this.initPTS[o.cc])?(this.log("Waiting for video PTS in continuity counter "+o.cc+" of live stream before loading audio fragment "+o.sn+" of level "+this.trackId),this.state=v.State.WAITING_INIT_PTS):(this.startFragRequested=!0,x.prototype.loadFragment.call(this,o,d,T)))},c.completeAudioSwitch=function(){var o=this.hls,d=this.media,T=this.trackId;d&&(this.log("Switching audio track : flushing all audio"),x.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.audioSwitch=!1,o.trigger(l.Events.AUDIO_TRACK_SWITCHED,{id:T})},E}(v.default);e.default=h},"./src/controller/audio-track-controller.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/events.ts"),v=t("./src/errors.ts"),l=t("./src/controller/base-playlist-controller.ts"),P=t("./src/types/loader.ts");function b(D,S){for(var O=0;O<S.length;O++){var I=S[O];I.enumerable=I.enumerable||!1,I.configurable=!0,"value"in I&&(I.writable=!0),Object.defineProperty(D,I.key,I)}}function C(D,S,O){return S&&b(D.prototype,S),O&&b(D,O),D}function L(D,S){D.prototype=Object.create(S.prototype),D.prototype.constructor=D,m(D,S)}function m(D,S){return m=Object.setPrototypeOf||function(I,s){return I.__proto__=s,I},m(D,S)}var A=function(D){L(S,D);function S(I){var s;return s=D.call(this,I,"[audio-track-controller]")||this,s.tracks=[],s.groupId=null,s.tracksInGroup=[],s.trackId=-1,s.trackName="",s.selectDefaultTrack=!0,s.registerListeners(),s}var O=S.prototype;return O.registerListeners=function(){var s=this.hls;s.on(g.Events.MANIFEST_LOADING,this.onManifestLoading,this),s.on(g.Events.MANIFEST_PARSED,this.onManifestParsed,this),s.on(g.Events.LEVEL_LOADING,this.onLevelLoading,this),s.on(g.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),s.on(g.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),s.on(g.Events.ERROR,this.onError,this)},O.unregisterListeners=function(){var s=this.hls;s.off(g.Events.MANIFEST_LOADING,this.onManifestLoading,this),s.off(g.Events.MANIFEST_PARSED,this.onManifestParsed,this),s.off(g.Events.LEVEL_LOADING,this.onLevelLoading,this),s.off(g.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),s.off(g.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),s.off(g.Events.ERROR,this.onError,this)},O.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,D.prototype.destroy.call(this)},O.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.trackName="",this.selectDefaultTrack=!0},O.onManifestParsed=function(s,r){this.tracks=r.audioTracks||[]},O.onAudioTrackLoaded=function(s,r){var n=r.id,a=r.details,p=this.tracksInGroup[n];if(!p){this.warn("Invalid audio track id "+n);return}var f=p.details;p.details=r.details,this.log("audioTrack "+n+" loaded ["+a.startSN+"-"+a.endSN+"]"),n===this.trackId&&(this.retryCount=0,this.playlistLoaded(n,r,f))},O.onLevelLoading=function(s,r){this.switchLevel(r.level)},O.onLevelSwitching=function(s,r){this.switchLevel(r.level)},O.switchLevel=function(s){var r=this.hls.levels[s];if(!!(r!=null&&r.audioGroupIds)){var n=r.audioGroupIds[r.urlId];if(this.groupId!==n){this.groupId=n;var a=this.tracks.filter(function(f){return!n||f.groupId===n});this.selectDefaultTrack&&!a.some(function(f){return f.default})&&(this.selectDefaultTrack=!1),this.tracksInGroup=a;var p={audioTracks:a};this.log("Updating audio tracks, "+a.length+' track(s) found in "'+n+'" group-id'),this.hls.trigger(g.Events.AUDIO_TRACKS_UPDATED,p),this.selectInitialTrack()}}},O.onError=function(s,r){D.prototype.onError.call(this,s,r),!(r.fatal||!r.context)&&r.context.type===P.PlaylistContextType.AUDIO_TRACK&&r.context.id===this.trackId&&r.context.groupId===this.groupId&&this.retryLoadingOrFail(r)},O.setAudioTrack=function(s){var r=this.tracksInGroup;if(s<0||s>=r.length){this.warn("Invalid id passed to audio-track controller");return}this.clearTimer();var n=r[this.trackId];this.log("Now switching to audio-track index "+s);var a=r[s],p=a.id,f=a.groupId,h=f===void 0?"":f,x=a.name,E=a.type,c=a.url;if(this.trackId=s,this.trackName=x,this.selectDefaultTrack=!1,this.hls.trigger(g.Events.AUDIO_TRACK_SWITCHING,{id:p,groupId:h,name:x,type:E,url:c}),!(a.details&&!a.details.live)){var u=this.switchParams(a.url,n==null?void 0:n.details);this.loadPlaylist(u)}},O.selectInitialTrack=function(){var s=this.tracksInGroup;console.assert(s.length,"Initial audio track should be selected when tracks are known");var r=this.trackName,n=this.findTrackId(r)||this.findTrackId();n!==-1?this.setAudioTrack(n):(this.warn("No track found for running audio group-ID: "+this.groupId),this.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.MEDIA_ERROR,details:v.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal:!0}))},O.findTrackId=function(s){for(var r=this.tracksInGroup,n=0;n<r.length;n++){var a=r[n];if((!this.selectDefaultTrack||a.default)&&(!s||s===a.name))return a.id}return-1},O.loadPlaylist=function(s){var r=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(r)){var n=r.id,a=r.groupId,p=r.url;if(s)try{p=s.addDirectives(p)}catch(f){this.warn("Could not construct new URL with HLS Delivery Directives: "+f)}this.log("loading audio-track playlist for id: "+n),this.clearTimer(),this.hls.trigger(g.Events.AUDIO_TRACK_LOADING,{url:p,id:n,groupId:a,deliveryDirectives:s||null})}},C(S,[{key:"audioTracks",get:function(){return this.tracksInGroup}},{key:"audioTrack",get:function(){return this.trackId},set:function(s){this.selectDefaultTrack=!1,this.setAudioTrack(s)}}]),S}(l.default);e.default=A},"./src/controller/base-playlist-controller.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return C});var g=t("./src/polyfills/number.ts"),v=t("./src/types/level.ts"),l=t("./src/controller/level-helper.ts"),P=t("./src/utils/logger.ts"),b=t("./src/errors.ts"),C=function(){function L(A,D){this.hls=void 0,this.timer=-1,this.canLoad=!1,this.retryCount=0,this.log=void 0,this.warn=void 0,this.log=P.logger.log.bind(P.logger,D+":"),this.warn=P.logger.warn.bind(P.logger,D+":"),this.hls=A}var m=L.prototype;return m.destroy=function(){this.clearTimer(),this.hls=this.log=this.warn=null},m.onError=function(D,S){S.fatal&&S.type===b.ErrorTypes.NETWORK_ERROR&&this.clearTimer()},m.clearTimer=function(){clearTimeout(this.timer),this.timer=-1},m.startLoad=function(){this.canLoad=!0,this.retryCount=0,this.loadPlaylist()},m.stopLoad=function(){this.canLoad=!1,this.clearTimer()},m.switchParams=function(D,S){var O=S==null?void 0:S.renditionReports;if(O)for(var I=0;I<O.length;I++){var s=O[I],r=""+s.URI;if(r===D.substr(-r.length)){var n=parseInt(s["LAST-MSN"]),a=parseInt(s["LAST-PART"]);if(S&&this.hls.config.lowLatencyMode){var p=Math.min(S.age-S.partTarget,S.targetduration);a!==void 0&&p>S.partTarget&&(a+=1)}if(Object(g.isFiniteNumber)(n))return new v.HlsUrlParameters(n,Object(g.isFiniteNumber)(a)?a:void 0,v.HlsSkip.No)}}},m.loadPlaylist=function(D){},m.shouldLoadTrack=function(D){return this.canLoad&&D&&!!D.url&&(!D.details||D.details.live)},m.playlistLoaded=function(D,S,O){var I=this,s=S.details,r=S.stats,n=r.loading.end?Math.max(0,self.performance.now()-r.loading.end):0;if(s.advancedDateTime=Date.now()-n,s.live||O!=null&&O.live){if(s.reloaded(O),O&&this.log("live playlist "+D+" "+(s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:"MISSED")),O&&s.fragments.length>0&&Object(l.mergeDetails)(O,s),!this.canLoad||!s.live)return;var a,p=void 0,f=void 0;if(s.canBlockReload&&s.endSN&&s.advanced){var h=this.hls.config.lowLatencyMode,x=s.lastPartSn,E=s.endSN,c=s.lastPartIndex,u=c!==-1,o=x===E,d=h?0:c;u?(p=o?E+1:x,f=o?d:c+1):p=E+1;var T=s.age,y=T+s.ageHeader,R=Math.min(y-s.partTarget,s.targetduration*1.5);if(R>0){if(O&&R>O.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+O.tuneInGoal+" to: "+R+" with playlist age: "+s.age),R=0;else{var M=Math.floor(R/s.targetduration);if(p+=M,f!==void 0){var _=Math.round(R%s.targetduration/s.partTarget);f+=_}this.log("CDN Tune-in age: "+s.ageHeader+"s last advanced "+T.toFixed(2)+"s goal: "+R+" skip sn "+M+" to part "+f)}s.tuneInGoal=R}if(a=this.getDeliveryDirectives(s,S.deliveryDirectives,p,f),h||!o){this.loadPlaylist(a);return}}else a=this.getDeliveryDirectives(s,S.deliveryDirectives,p,f);var F=Object(l.computeReloadInterval)(s,r);p!==void 0&&s.canBlockReload&&(F-=s.partTarget||1),this.log("reload live playlist "+D+" in "+Math.round(F)+" ms"),this.timer=self.setTimeout(function(){return I.loadPlaylist(a)},F)}else this.clearTimer()},m.getDeliveryDirectives=function(D,S,O,I){var s=Object(v.getSkipValue)(D,O);return S!=null&&S.skip&&D.deltaUpdateFailed&&(O=S.msn,I=S.part,s=v.HlsSkip.No),new v.HlsUrlParameters(O,I,s)},m.retryLoadingOrFail=function(D){var S=this,O=this.hls.config,I=this.retryCount<O.levelLoadingMaxRetry;if(I){var s;if(this.retryCount++,D.details.indexOf("LoadTimeOut")>-1&&(s=D.context)!==null&&s!==void 0&&s.deliveryDirectives)this.warn("retry playlist loading #"+this.retryCount+' after "'+D.details+'"'),this.loadPlaylist();else{var r=Math.min(Math.pow(2,this.retryCount)*O.levelLoadingRetryDelay,O.levelLoadingMaxRetryTimeout);this.timer=self.setTimeout(function(){return S.loadPlaylist()},r),this.warn("retry playlist loading #"+this.retryCount+" in "+r+' ms after "'+D.details+'"')}}else this.warn('cannot recover from error "'+D.details+'"'),this.clearTimer(),D.fatal=!0;return I},L}()},"./src/controller/base-stream-controller.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"State",function(){return E}),t.d(e,"default",function(){return c});var g=t("./src/polyfills/number.ts"),v=t("./src/task-loop.ts"),l=t("./src/controller/fragment-tracker.ts"),P=t("./src/utils/buffer-helper.ts"),b=t("./src/utils/logger.ts"),C=t("./src/events.ts"),L=t("./src/errors.ts"),m=t("./src/types/transmuxer.ts"),A=t("./src/utils/mp4-tools.ts"),D=t("./src/utils/discontinuities.ts"),S=t("./src/controller/fragment-finders.ts"),O=t("./src/controller/level-helper.ts"),I=t("./src/loader/fragment-loader.ts"),s=t("./src/crypt/decrypter.ts"),r=t("./src/utils/time-ranges.ts"),n=t("./src/types/loader.ts");function a(u,o){for(var d=0;d<o.length;d++){var T=o[d];T.enumerable=T.enumerable||!1,T.configurable=!0,"value"in T&&(T.writable=!0),Object.defineProperty(u,T.key,T)}}function p(u,o,d){return o&&a(u.prototype,o),d&&a(u,d),u}function f(u){if(u===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return u}function h(u,o){u.prototype=Object.create(o.prototype),u.prototype.constructor=u,x(u,o)}function x(u,o){return x=Object.setPrototypeOf||function(T,y){return T.__proto__=y,T},x(u,o)}var E={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",BACKTRACKING:"BACKTRACKING",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},c=function(u){h(o,u);function o(T,y,R){var M;return M=u.call(this)||this,M.hls=void 0,M.fragPrevious=null,M.fragCurrent=null,M.fragmentTracker=void 0,M.transmuxer=null,M._state=E.STOPPED,M.media=void 0,M.mediaBuffer=void 0,M.config=void 0,M.bitrateTest=!1,M.lastCurrentTime=0,M.nextLoadPosition=0,M.startPosition=0,M.loadedmetadata=!1,M.fragLoadError=0,M.retryDate=0,M.levels=null,M.fragmentLoader=void 0,M.levelLastLoaded=null,M.startFragRequested=!1,M.decrypter=void 0,M.initPTS=[],M.onvseeking=null,M.onvended=null,M.logPrefix="",M.log=void 0,M.warn=void 0,M.logPrefix=R,M.log=b.logger.log.bind(b.logger,R+":"),M.warn=b.logger.warn.bind(b.logger,R+":"),M.hls=T,M.fragmentLoader=new I.default(T.config),M.fragmentTracker=y,M.config=T.config,M.decrypter=new s.default(T,T.config),T.on(C.Events.KEY_LOADED,M.onKeyLoaded,f(M)),M}var d=o.prototype;return d.doTick=function(){this.onTickEnd()},d.onTickEnd=function(){},d.startLoad=function(y){},d.stopLoad=function(){this.fragmentLoader.abort();var y=this.fragCurrent;y&&this.fragmentTracker.removeFragment(y),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=E.STOPPED},d._streamEnded=function(y,R){var M=this.fragCurrent,_=this.fragmentTracker;if(!R.live&&M&&M.sn===R.endSN&&!y.nextStart){var F=_.getState(M);return F===l.FragmentState.PARTIAL||F===l.FragmentState.OK}return!1},d.onMediaAttached=function(y,R){var M=this.media=this.mediaBuffer=R.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),M.addEventListener("seeking",this.onvseeking),M.addEventListener("ended",this.onvended);var _=this.config;this.levels&&_.autoStartLoad&&this.state===E.STOPPED&&this.startLoad(_.startPosition)},d.onMediaDetaching=function(){var y=this.media;y!=null&&y.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),y&&(y.removeEventListener("seeking",this.onvseeking),y.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()},d.onMediaSeeking=function(){var y=this.config,R=this.fragCurrent,M=this.media,_=this.mediaBuffer,F=this.state,B=M?M.currentTime:0,w=P.BufferHelper.bufferInfo(_||M,B,y.maxBufferHole);if(this.log("media seeking to "+(Object(g.isFiniteNumber)(B)?B.toFixed(3):B)+", state: "+F),F===E.ENDED)this.resetLoadingState();else if(R&&!w.len){var k=y.maxFragLookUpTolerance,U=R.start-k,N=R.start+R.duration+k,W=B>N;(B<U||W)&&(W&&R.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),R.loader.abort()),this.resetLoadingState())}M&&(this.lastCurrentTime=B),!this.loadedmetadata&&!w.len&&(this.nextLoadPosition=this.startPosition=B),this.tickImmediate()},d.onMediaEnded=function(){this.startPosition=this.lastCurrentTime=0},d.onKeyLoaded=function(y,R){if(!(this.state!==E.KEY_LOADING||R.frag!==this.fragCurrent||!this.levels)){this.state=E.IDLE;var M=this.levels[R.frag.level].details;M&&this.loadFragment(R.frag,M,R.frag.start)}},d.onHandlerDestroying=function(){this.stopLoad(),u.prototype.onHandlerDestroying.call(this)},d.onHandlerDestroyed=function(){this.state=E.STOPPED,this.hls.off(C.Events.KEY_LOADED,this.onKeyLoaded,this),this.fragmentLoader&&this.fragmentLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.fragmentLoader=this.fragmentTracker=null,u.prototype.onHandlerDestroyed.call(this)},d.loadKey=function(y,R){this.log("Loading key for "+y.sn+" of ["+R.startSN+"-"+R.endSN+"], "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+y.level),this.state=E.KEY_LOADING,this.fragCurrent=y,this.hls.trigger(C.Events.KEY_LOADING,{frag:y})},d.loadFragment=function(y,R,M){this._loadFragForPlayback(y,R,M)},d._loadFragForPlayback=function(y,R,M){var _=this,F=function(w){if(_.fragContextChanged(y)){_.warn("Fragment "+y.sn+(w.part?" p: "+w.part.index:"")+" of level "+y.level+" was dropped during download."),_.fragmentTracker.removeFragment(y);return}y.stats.chunkCount++,_._handleFragmentLoadProgress(w)};this._doFragLoad(y,R,M,F).then(function(B){if(!!B){_.fragLoadError=0;var w=_.state;if(_.fragContextChanged(y)){(w===E.FRAG_LOADING||w===E.BACKTRACKING||!_.fragCurrent&&w===E.PARSING)&&(_.fragmentTracker.removeFragment(y),_.state=E.IDLE);return}if("payload"in B&&(_.log("Loaded fragment "+y.sn+" of level "+y.level),_.hls.trigger(C.Events.FRAG_LOADED,B),_.state===E.BACKTRACKING)){_.fragmentTracker.backtrack(y,B),_.resetFragmentLoading(y);return}_._handleFragmentLoadComplete(B)}}).catch(function(B){_.warn(B),_.resetFragmentLoading(y)})},d.flushMainBuffer=function(y,R,M){if(M===void 0&&(M=null),!!(y-R)){var _={startOffset:y,endOffset:R,type:M};this.fragLoadError=0,this.hls.trigger(C.Events.BUFFER_FLUSHING,_)}},d._loadInitSegment=function(y){var R=this;this._doFragLoad(y).then(function(M){if(!M||R.fragContextChanged(y)||!R.levels)throw new Error("init load aborted");return M}).then(function(M){var _=R.hls,F=M.payload,B=y.decryptdata;if(F&&F.byteLength>0&&B&&B.key&&B.iv&&B.method==="AES-128"){var w=self.performance.now();return R.decrypter.webCryptoDecrypt(new Uint8Array(F),B.key.buffer,B.iv.buffer).then(function(k){var U=self.performance.now();return _.trigger(C.Events.FRAG_DECRYPTED,{frag:y,payload:k,stats:{tstart:w,tdecrypt:U}}),M.payload=k,M})}return M}).then(function(M){var _=R.fragCurrent,F=R.hls,B=R.levels;if(!B)throw new Error("init load aborted, missing levels");var w=B[y.level].details;console.assert(w,"Level details are defined when init segment is loaded");var k=y.stats;R.state=E.IDLE,R.fragLoadError=0,y.data=new Uint8Array(M.payload),k.parsing.start=k.buffering.start=self.performance.now(),k.parsing.end=k.buffering.end=self.performance.now(),M.frag===_&&F.trigger(C.Events.FRAG_BUFFERED,{stats:k,frag:_,part:null,id:y.type}),R.tick()}).catch(function(M){R.warn(M),R.resetFragmentLoading(y)})},d.fragContextChanged=function(y){var R=this.fragCurrent;return!y||!R||y.level!==R.level||y.sn!==R.sn||y.urlId!==R.urlId},d.fragBufferedComplete=function(y,R){var M=this.mediaBuffer?this.mediaBuffer:this.media;this.log("Buffered "+y.type+" sn: "+y.sn+(R?" part: "+R.index:"")+" of "+(this.logPrefix==="[stream-controller]"?"level":"track")+" "+y.level+" "+r.default.toString(P.BufferHelper.getBuffered(M))),this.state=E.IDLE,this.tick()},d._handleFragmentLoadComplete=function(y){var R=this.transmuxer;if(!!R){var M=y.frag,_=y.part,F=y.partsLoaded,B=!F||F.length===0||F.some(function(k){return!k}),w=new m.ChunkMetadata(M.level,M.sn,M.stats.chunkCount+1,0,_?_.index:-1,!B);R.flush(w)}},d._handleFragmentLoadProgress=function(y){},d._doFragLoad=function(y,R,M,_){var F=this;if(M===void 0&&(M=null),!this.levels)throw new Error("frag load aborted, missing levels");if(M=Math.max(y.start,M||0),this.config.lowLatencyMode&&R){var B=R.partList;if(B&&_){M>y.end&&R.fragmentHint&&(y=R.fragmentHint);var w=this.getNextPart(B,y,M);if(w>-1){var k=B[w];return this.log("Loading part sn: "+y.sn+" p: "+k.index+" cc: "+y.cc+" of playlist ["+R.startSN+"-"+R.endSN+"] parts [0-"+w+"-"+(B.length-1)+"] "+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+y.level+", target: "+parseFloat(M.toFixed(3))),this.nextLoadPosition=k.start+k.duration,this.state=E.FRAG_LOADING,this.hls.trigger(C.Events.FRAG_LOADING,{frag:y,part:B[w],targetBufferTime:M}),this.doFragPartsLoad(y,B,w,_).catch(function(U){return F.handleFragLoadError(U)})}else if(!y.url||this.loadedEndOfParts(B,M))return Promise.resolve(null)}}return this.log("Loading fragment "+y.sn+" cc: "+y.cc+" "+(R?"of ["+R.startSN+"-"+R.endSN+"] ":"")+(this.logPrefix==="[stream-controller]"?"level":"track")+": "+y.level+", target: "+parseFloat(M.toFixed(3))),Object(g.isFiniteNumber)(y.sn)&&!this.bitrateTest&&(this.nextLoadPosition=y.start+y.duration),this.state=E.FRAG_LOADING,this.hls.trigger(C.Events.FRAG_LOADING,{frag:y,targetBufferTime:M}),this.fragmentLoader.load(y,_).catch(function(U){return F.handleFragLoadError(U)})},d.doFragPartsLoad=function(y,R,M,_){var F=this;return new Promise(function(B,w){var k=[],U=function N(W){var K=R[W];F.fragmentLoader.loadPart(y,K,_).then(function(H){k[K.index]=H;var G=H.part;F.hls.trigger(C.Events.FRAG_LOADED,H);var V=R[W+1];if(V&&V.fragment===y)N(W+1);else return B({frag:y,part:G,partsLoaded:k})}).catch(w)};U(M)})},d.handleFragLoadError=function(y){var R=y.data;return R&&R.details===L.ErrorDetails.INTERNAL_ABORTED?this.handleFragLoadAborted(R.frag,R.part):this.hls.trigger(C.Events.ERROR,R),null},d._handleTransmuxerFlush=function(y){var R=this.getCurrentContext(y);if(!R||this.state!==E.PARSING){this.fragCurrent||(this.state=E.IDLE);return}var M=R.frag,_=R.part,F=R.level,B=self.performance.now();M.stats.parsing.end=B,_&&(_.stats.parsing.end=B),this.updateLevelTiming(M,_,F,y.partial)},d.getCurrentContext=function(y){var R=this.levels,M=y.level,_=y.sn,F=y.part;if(!R||!R[M])return this.warn("Levels object was unset while buffering fragment "+_+" of level "+M+". The current chunk will not be buffered."),null;var B=R[M],w=F>-1?Object(O.getPartWith)(B,_,F):null,k=w?w.fragment:Object(O.getFragmentWithSN)(B,_,this.fragCurrent);return k?{frag:k,part:w,level:B}:null},d.bufferFragmentData=function(y,R,M,_){if(!(!y||this.state!==E.PARSING)){var F=y.data1,B=y.data2,w=F;if(F&&B&&(w=Object(A.appendUint8Array)(F,B)),!(!w||!w.length)){var k={type:y.type,frag:R,part:M,chunkMeta:_,parent:R.type,data:w};this.hls.trigger(C.Events.BUFFER_APPENDING,k),y.dropped&&y.independent&&!M&&this.flushBufferGap(R)}}},d.flushBufferGap=function(y){var R=this.media;if(!!R){if(!P.BufferHelper.isBuffered(R,R.currentTime)){this.flushMainBuffer(0,y.start);return}var M=R.currentTime,_=P.BufferHelper.bufferInfo(R,M,0),F=y.duration,B=Math.min(this.config.maxFragLookUpTolerance*2,F*.25),w=Math.max(Math.min(y.start-B,_.end-B),M+B);y.start-w>B&&this.flushMainBuffer(w,y.start)}},d.getFwdBufferInfo=function(y,R){var M=this.config,_=this.getLoadPosition();if(!Object(g.isFiniteNumber)(_))return null;var F=P.BufferHelper.bufferInfo(y,_,M.maxBufferHole);if(F.len===0&&F.nextStart!==void 0){var B=this.fragmentTracker.getBufferedFrag(_,R);if(B&&F.nextStart<B.end)return P.BufferHelper.bufferInfo(y,_,Math.max(F.nextStart,M.maxBufferHole))}return F},d.getMaxBufferLength=function(y){var R=this.config,M;return y?M=Math.max(8*R.maxBufferSize/y,R.maxBufferLength):M=R.maxBufferLength,Math.min(M,R.maxMaxBufferLength)},d.reduceMaxBufferLength=function(y){var R=this.config,M=y||R.maxBufferLength;return R.maxMaxBufferLength>=M?(R.maxMaxBufferLength/=2,this.warn("Reduce max buffer length to "+R.maxMaxBufferLength+"s"),!0):!1},d.getNextFragment=function(y,R){var M,_,F=R.fragments,B=F.length;if(!B)return null;var w=this.config,k=F[0].start,U;if(R.live){var N=w.initialLiveManifestSize;if(B<N)return this.warn("Not enough fragments to start playback (have: "+B+", need: "+N+")"),null;!R.PTSKnown&&!this.startFragRequested&&this.startPosition===-1&&(U=this.getInitialLiveFragment(R,F),this.startPosition=U?this.hls.liveSyncPosition||U.start:y)}else y<=k&&(U=F[0]);if(!U){var W=w.lowLatencyMode?R.partEnd:R.fragmentEnd;U=this.getFragmentAtPosition(y,W,R)}return(M=U)!==null&&M!==void 0&&M.initSegment&&!((_=U)!==null&&_!==void 0&&_.initSegment.data)&&!this.bitrateTest&&(U=U.initSegment),U},d.getNextPart=function(y,R,M){for(var _=-1,F=!1,B=!0,w=0,k=y.length;w<k;w++){var U=y[w];if(B=B&&!U.independent,_>-1&&M<U.start)break;var N=U.loaded;!N&&(F||U.independent||B)&&U.fragment===R&&(_=w),F=N}return _},d.loadedEndOfParts=function(y,R){var M=y[y.length-1];return M&&R>M.start&&M.loaded},d.getInitialLiveFragment=function(y,R){var M=this.fragPrevious,_=null;if(M){if(y.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+M.programDateTime),_=Object(S.findFragmentByPDT)(R,M.endProgramDateTime,this.config.maxFragLookUpTolerance)),!_){var F=M.sn+1;if(F>=y.startSN&&F<=y.endSN){var B=R[F-y.startSN];M.cc===B.cc&&(_=B,this.log("Live playlist, switching playlist, load frag with next SN: "+_.sn))}_||(_=Object(S.findFragWithCC)(R,M.cc),_&&this.log("Live playlist, switching playlist, load frag with same CC: "+_.sn))}}else{var w=this.hls.liveSyncPosition;w!==null&&(_=this.getFragmentAtPosition(w,this.bitrateTest?y.fragmentEnd:y.edge,y))}return _},d.getFragmentAtPosition=function(y,R,M){var _=this.config,F=this.fragPrevious,B=M.fragments,w=M.endSN,k=M.fragmentHint,U=_.maxFragLookUpTolerance,N=!!(_.lowLatencyMode&&M.partList&&k);N&&k&&!this.bitrateTest&&(B=B.concat(k),w=k.sn);var W;if(y<R){var K=y>R-U?0:U;W=Object(S.findFragmentByPTS)(F,B,y,K)}else W=B[B.length-1];if(W){var H=W.sn-M.startSN,G=F&&W.level===F.level,V=B[H+1],X=this.fragmentTracker.getState(W);if(X===l.FragmentState.BACKTRACKED){W=null;for(var z=H;B[z]&&this.fragmentTracker.getState(B[z])===l.FragmentState.BACKTRACKED;)F?W=B[z--]:W=B[--z];W||(W=V)}else F&&W.sn===F.sn&&!N&&G&&(W.sn<w&&this.fragmentTracker.getState(V)!==l.FragmentState.OK?(this.log("SN "+W.sn+" just loaded, load next one: "+V.sn),W=V):W=null)}return W},d.synchronizeToLiveEdge=function(y){var R=this.config,M=this.media;if(!!M){var _=this.hls.liveSyncPosition,F=M.currentTime,B=y.fragments[0].start,w=y.edge,k=F>=B-R.maxFragLookUpTolerance&&F<=w;if(_!==null&&M.duration>_&&(F<_||!k)){var U=R.liveMaxLatencyDuration!==void 0?R.liveMaxLatencyDuration:R.liveMaxLatencyDurationCount*y.targetduration;(!k&&M.readyState<4||F<w-U)&&(this.loadedmetadata||(this.nextLoadPosition=_),M.readyState&&(this.warn("Playback: "+F.toFixed(3)+" is located too far from the end of live sliding playlist: "+w+", reset currentTime to : "+_.toFixed(3)),M.currentTime=_))}}},d.alignPlaylists=function(y,R){var M=this.levels,_=this.levelLastLoaded,F=this.fragPrevious,B=_!==null?M[_]:null,w=y.fragments.length;if(!w)return this.warn("No fragments in live playlist"),0;var k=y.fragments[0].start,U=!R,N=y.alignedSliding&&Object(g.isFiniteNumber)(k);if(U||!N&&!k){Object(D.alignStream)(F,B,y);var W=y.fragments[0].start;return this.log("Live playlist sliding: "+W.toFixed(2)+" start-sn: "+(R?R.startSN:"na")+"->"+y.startSN+" prev-sn: "+(F?F.sn:"na")+" fragments: "+w),W}return k},d.waitForCdnTuneIn=function(y){var R=3;return y.live&&y.canBlockReload&&y.tuneInGoal>Math.max(y.partHoldBack,y.partTarget*R)},d.setStartPosition=function(y,R){var M=this.startPosition;if(M<R&&(M=-1),M===-1||this.lastCurrentTime===-1){var _=y.startTimeOffset;Object(g.isFiniteNumber)(_)?(M=R+_,_<0&&(M+=y.totalduration),M=Math.min(Math.max(R,M),R+y.totalduration),this.log("Start time offset "+_+" found in playlist, adjust startPosition to "+M),this.startPosition=M):y.live?M=this.hls.liveSyncPosition||R:this.startPosition=M=0,this.lastCurrentTime=M}this.nextLoadPosition=M},d.getLoadPosition=function(){var y=this.media,R=0;return this.loadedmetadata&&y?R=y.currentTime:this.nextLoadPosition&&(R=this.nextLoadPosition),R},d.handleFragLoadAborted=function(y,R){this.transmuxer&&y.sn!=="initSegment"&&y.stats.aborted&&(this.warn("Fragment "+y.sn+(R?" part"+R.index:"")+" of level "+y.level+" was aborted"),this.resetFragmentLoading(y))},d.resetFragmentLoading=function(y){(!this.fragCurrent||!this.fragContextChanged(y))&&(this.state=E.IDLE)},d.onFragmentOrKeyLoadError=function(y,R){if(!R.fatal){var M=R.frag;if(!(!M||M.type!==y)){var _=this.fragCurrent;console.assert(_&&M.sn===_.sn&&M.level===_.level&&M.urlId===_.urlId,"Frag load error must match current frag to retry");var F=this.config;if(this.fragLoadError+1<=F.fragLoadingMaxRetry){if(this.resetLiveStartWhenNotLoaded(M.level))return;var B=Math.min(Math.pow(2,this.fragLoadError)*F.fragLoadingRetryDelay,F.fragLoadingMaxRetryTimeout);this.warn("Fragment "+M.sn+" of "+y+" "+M.level+" failed to load, retrying in "+B+"ms"),this.retryDate=self.performance.now()+B,this.fragLoadError++,this.state=E.FRAG_LOADING_WAITING_RETRY}else R.levelRetry?(y===n.PlaylistLevelType.AUDIO&&(this.fragCurrent=null),this.fragLoadError=0,this.state=E.IDLE):(b.logger.error(R.details+" reaches max retry, redispatch as fatal ..."),R.fatal=!0,this.hls.stopLoad(),this.state=E.ERROR)}}},d.afterBufferFlushed=function(y,R,M){if(!!y){var _=P.BufferHelper.getBuffered(y);this.fragmentTracker.detectEvictedFragments(R,_,M),this.state===E.ENDED&&this.resetLoadingState()}},d.resetLoadingState=function(){this.fragCurrent=null,this.fragPrevious=null,this.state=E.IDLE},d.resetLiveStartWhenNotLoaded=function(y){if(!this.loadedmetadata){this.startFragRequested=!1;var R=this.levels?this.levels[y].details:null;if(R!=null&&R.live)return this.startPosition=-1,this.setStartPosition(R,0),this.resetLoadingState(),!0;this.nextLoadPosition=this.startPosition}return!1},d.updateLevelTiming=function(y,R,M,_){var F=this,B=M.details;console.assert(!!B,"level.details must be defined");var w=Object.keys(y.elementaryStreams).reduce(function(k,U){var N=y.elementaryStreams[U];if(N){var W=N.endPTS-N.startPTS;if(W<=0)return F.warn("Could not parse fragment "+y.sn+" "+U+" duration reliably ("+W+") resetting transmuxer to fallback to playlist timing"),F.resetTransmuxer(),k||!1;var K=_?0:Object(O.updateFragPTSDTS)(B,y,N.startPTS,N.endPTS,N.startDTS,N.endDTS);return F.hls.trigger(C.Events.LEVEL_PTS_UPDATED,{details:B,level:M,drift:K,type:U,frag:y,start:N.startPTS,end:N.endPTS}),!0}return k},!1);w?(this.state=E.PARSED,this.hls.trigger(C.Events.FRAG_PARSED,{frag:y,part:R})):this.resetLoadingState()},d.resetTransmuxer=function(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)},p(o,[{key:"state",get:function(){return this._state},set:function(y){var R=this._state;R!==y&&(this._state=y,this.log(R+"->"+y))}}]),o}(v.default)},"./src/controller/buffer-controller.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return S});var g=t("./src/polyfills/number.ts"),v=t("./src/events.ts"),l=t("./src/utils/logger.ts"),P=t("./src/errors.ts"),b=t("./src/utils/buffer-helper.ts"),C=t("./src/utils/mediasource-helper.ts"),L=t("./src/loader/fragment.ts"),m=t("./src/controller/buffer-operation-queue.ts"),A=Object(C.getMediaSource)(),D=/([ha]vc.)(?:\.[^.,]+)+/,S=function(){function O(s){var r=this;this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=function(){var n=r.hls,a=r.media,p=r.mediaSource;l.logger.log("[buffer-controller]: Media source opened"),a&&(r.updateMediaElementDuration(),n.trigger(v.Events.MEDIA_ATTACHED,{media:a})),p&&p.removeEventListener("sourceopen",r._onMediaSourceOpen),r.checkPendingTracks()},this._onMediaSourceClose=function(){l.logger.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=function(){l.logger.log("[buffer-controller]: Media source ended")},this.hls=s,this._initSourceBuffer(),this.registerListeners()}var I=O.prototype;return I.hasSourceTypes=function(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0},I.destroy=function(){this.unregisterListeners(),this.details=null},I.registerListeners=function(){var r=this.hls;r.on(v.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),r.on(v.Events.MEDIA_DETACHING,this.onMediaDetaching,this),r.on(v.Events.MANIFEST_PARSED,this.onManifestParsed,this),r.on(v.Events.BUFFER_RESET,this.onBufferReset,this),r.on(v.Events.BUFFER_APPENDING,this.onBufferAppending,this),r.on(v.Events.BUFFER_CODECS,this.onBufferCodecs,this),r.on(v.Events.BUFFER_EOS,this.onBufferEos,this),r.on(v.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),r.on(v.Events.LEVEL_UPDATED,this.onLevelUpdated,this),r.on(v.Events.FRAG_PARSED,this.onFragParsed,this),r.on(v.Events.FRAG_CHANGED,this.onFragChanged,this)},I.unregisterListeners=function(){var r=this.hls;r.off(v.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),r.off(v.Events.MEDIA_DETACHING,this.onMediaDetaching,this),r.off(v.Events.MANIFEST_PARSED,this.onManifestParsed,this),r.off(v.Events.BUFFER_RESET,this.onBufferReset,this),r.off(v.Events.BUFFER_APPENDING,this.onBufferAppending,this),r.off(v.Events.BUFFER_CODECS,this.onBufferCodecs,this),r.off(v.Events.BUFFER_EOS,this.onBufferEos,this),r.off(v.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),r.off(v.Events.LEVEL_UPDATED,this.onLevelUpdated,this),r.off(v.Events.FRAG_PARSED,this.onFragParsed,this),r.off(v.Events.FRAG_CHANGED,this.onFragChanged,this)},I._initSourceBuffer=function(){this.sourceBuffer={},this.operationQueue=new m.default(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]}},I.onManifestParsed=function(r,n){var a=2;(n.audio&&!n.video||!n.altAudio)&&(a=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=a,this.details=null,l.logger.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")},I.onMediaAttaching=function(r,n){var a=this.media=n.media;if(a&&A){var p=this.mediaSource=new A;p.addEventListener("sourceopen",this._onMediaSourceOpen),p.addEventListener("sourceended",this._onMediaSourceEnded),p.addEventListener("sourceclose",this._onMediaSourceClose),a.src=self.URL.createObjectURL(p),this._objectUrl=a.src}},I.onMediaDetaching=function(){var r=this.media,n=this.mediaSource,a=this._objectUrl;if(n){if(l.logger.log("[buffer-controller]: media source detaching"),n.readyState==="open")try{n.endOfStream()}catch(p){l.logger.warn("[buffer-controller]: onMediaDetaching: "+p.message+" while calling endOfStream")}this.onBufferReset(),n.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("sourceended",this._onMediaSourceEnded),n.removeEventListener("sourceclose",this._onMediaSourceClose),r&&(a&&self.URL.revokeObjectURL(a),r.src===a?(r.removeAttribute("src"),r.load()):l.logger.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(v.Events.MEDIA_DETACHED,void 0)},I.onBufferReset=function(){var r=this;this.getSourceBufferTypes().forEach(function(n){var a=r.sourceBuffer[n];try{a&&(r.removeBufferListeners(n),r.mediaSource&&r.mediaSource.removeSourceBuffer(a),r.sourceBuffer[n]=void 0)}catch(p){l.logger.warn("[buffer-controller]: Failed to reset the "+n+" buffer",p)}}),this._initSourceBuffer()},I.onBufferCodecs=function(r,n){var a=this,p=this.getSourceBufferTypes().length;Object.keys(n).forEach(function(f){if(p){var h=a.tracks[f];if(h&&typeof h.buffer.changeType=="function"){var x=n[f],E=x.codec,c=x.levelCodec,u=x.container,o=(h.levelCodec||h.codec).replace(D,"$1"),d=(c||E).replace(D,"$1");if(o!==d){var T=u+";codecs="+(c||E);a.appendChangeType(f,T)}}}else a.pendingTracks[f]=n[f]}),!p&&(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks())},I.appendChangeType=function(r,n){var a=this,p=this.operationQueue,f={execute:function(){var x=a.sourceBuffer[r];x&&(l.logger.log("[buffer-controller]: changing "+r+" sourceBuffer type to "+n),x.changeType(n)),p.shiftAndExecuteNext(r)},onStart:function(){},onComplete:function(){},onError:function(x){l.logger.warn("[buffer-controller]: Failed to change "+r+" SourceBuffer type",x)}};p.append(f,r)},I.onBufferAppending=function(r,n){var a=this,p=this.hls,f=this.operationQueue,h=this.tracks,x=n.data,E=n.type,c=n.frag,u=n.part,o=n.chunkMeta,d=o.buffering[E],T=self.performance.now();d.start=T;var y=c.stats.buffering,R=u?u.stats.buffering:null;y.start===0&&(y.start=T),R&&R.start===0&&(R.start=T);var M=h.audio,_=E==="audio"&&o.id===1&&(M==null?void 0:M.container)==="audio/mpeg",F={execute:function(){if(d.executeStart=self.performance.now(),_){var w=a.sourceBuffer[E];if(w){var k=c.start-w.timestampOffset;Math.abs(k)>=.1&&(l.logger.log("[buffer-controller]: Updating audio SourceBuffer timestampOffset to "+c.start+" (delta: "+k+") sn: "+c.sn+")"),w.timestampOffset=c.start)}}a.appendExecutor(x,E)},onStart:function(){},onComplete:function(){var w=self.performance.now();d.executeEnd=d.end=w,y.first===0&&(y.first=w),R&&R.first===0&&(R.first=w);var k=a.sourceBuffer,U={};for(var N in k)U[N]=b.BufferHelper.getBuffered(k[N]);a.appendError=0,a.hls.trigger(v.Events.BUFFER_APPENDED,{type:E,frag:c,part:u,chunkMeta:o,parent:c.type,timeRanges:U})},onError:function(w){l.logger.error("[buffer-controller]: Error encountered while trying to append to the "+E+" SourceBuffer",w);var k={type:P.ErrorTypes.MEDIA_ERROR,parent:c.type,details:P.ErrorDetails.BUFFER_APPEND_ERROR,err:w,fatal:!1};w.code===DOMException.QUOTA_EXCEEDED_ERR?k.details=P.ErrorDetails.BUFFER_FULL_ERROR:(a.appendError++,k.details=P.ErrorDetails.BUFFER_APPEND_ERROR,a.appendError>p.config.appendErrorMaxRetry&&(l.logger.error("[buffer-controller]: Failed "+p.config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),k.fatal=!0)),p.trigger(v.Events.ERROR,k)}};f.append(F,E)},I.onBufferFlushing=function(r,n){var a=this,p=this.operationQueue,f=function(x){return{execute:a.removeExecutor.bind(a,x,n.startOffset,n.endOffset),onStart:function(){},onComplete:function(){a.hls.trigger(v.Events.BUFFER_FLUSHED,{type:x})},onError:function(c){l.logger.warn("[buffer-controller]: Failed to remove from "+x+" SourceBuffer",c)}}};n.type?p.append(f(n.type),n.type):this.getSourceBufferTypes().forEach(function(h){p.append(f(h),h)})},I.onFragParsed=function(r,n){var a=this,p=n.frag,f=n.part,h=[],x=f?f.elementaryStreams:p.elementaryStreams;x[L.ElementaryStreamTypes.AUDIOVIDEO]?h.push("audiovideo"):(x[L.ElementaryStreamTypes.AUDIO]&&h.push("audio"),x[L.ElementaryStreamTypes.VIDEO]&&h.push("video"));var E=function(){var u=self.performance.now();p.stats.buffering.end=u,f&&(f.stats.buffering.end=u);var o=f?f.stats:p.stats;a.hls.trigger(v.Events.FRAG_BUFFERED,{frag:p,part:f,stats:o,id:p.type})};h.length===0&&l.logger.warn("Fragments must have at least one ElementaryStreamType set. type: "+p.type+" level: "+p.level+" sn: "+p.sn),this.blockBuffers(E,h)},I.onFragChanged=function(r,n){this.flushBackBuffer()},I.onBufferEos=function(r,n){var a=this,p=this.getSourceBufferTypes().reduce(function(f,h){var x=a.sourceBuffer[h];return(!n.type||n.type===h)&&x&&!x.ended&&(x.ended=!0,l.logger.log("[buffer-controller]: "+h+" sourceBuffer now EOS")),f&&!!(!x||x.ended)},!0);p&&this.blockBuffers(function(){var f=a.mediaSource;!f||f.readyState!=="open"||f.endOfStream()})},I.onLevelUpdated=function(r,n){var a=n.details;!a.fragments.length||(this.details=a,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())},I.flushBackBuffer=function(){var r=this.hls,n=this.details,a=this.media,p=this.sourceBuffer;if(!(!a||n===null)){var f=this.getSourceBufferTypes();if(!!f.length){var h=n.live&&r.config.liveBackBufferLength!==null?r.config.liveBackBufferLength:r.config.backBufferLength;if(!(!Object(g.isFiniteNumber)(h)||h<0)){var x=a.currentTime,E=n.levelTargetDuration,c=Math.max(h,E),u=Math.floor(x/E)*E-c;f.forEach(function(o){var d=p[o];if(d){var T=b.BufferHelper.getBuffered(d);T.length>0&&u>T.start(0)&&(r.trigger(v.Events.BACK_BUFFER_REACHED,{bufferEnd:u}),n.live&&r.trigger(v.Events.LIVE_BACK_BUFFER_REACHED,{bufferEnd:u}),r.trigger(v.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:u,type:o}))}})}}}},I.updateMediaElementDuration=function(){if(!(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")){var r=this.details,n=this.hls,a=this.media,p=this.mediaSource,f=r.fragments[0].start+r.totalduration,h=a.duration,x=Object(g.isFiniteNumber)(p.duration)?p.duration:0;r.live&&n.config.liveDurationInfinity?(l.logger.log("[buffer-controller]: Media Source duration is set to Infinity"),p.duration=1/0,this.updateSeekableRange(r)):(f>x&&f>h||!Object(g.isFiniteNumber)(h))&&(l.logger.log("[buffer-controller]: Updating Media Source duration to "+f.toFixed(3)),p.duration=f)}},I.updateSeekableRange=function(r){var n=this.mediaSource,a=r.fragments,p=a.length;if(p&&r.live&&n!==null&&n!==void 0&&n.setLiveSeekableRange){var f=Math.max(0,a[0].start),h=Math.max(f,f+r.totalduration);n.setLiveSeekableRange(f,h)}},I.checkPendingTracks=function(){var r=this.bufferCodecEventsExpected,n=this.operationQueue,a=this.pendingTracks,p=Object.keys(a).length;if(p&&!r||p===2){this.createSourceBuffers(a),this.pendingTracks={};var f=this.getSourceBufferTypes();if(f.length===0){this.hls.trigger(v.Events.ERROR,{type:P.ErrorTypes.MEDIA_ERROR,details:P.ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:"could not create source buffer for media codec(s)"});return}f.forEach(function(h){n.executeNext(h)})}},I.createSourceBuffers=function(r){var n=this.sourceBuffer,a=this.mediaSource;if(!a)throw Error("createSourceBuffers called when mediaSource was null");var p=0;for(var f in r)if(!n[f]){var h=r[f];if(!h)throw Error("source buffer exists for track "+f+", however track does not");var x=h.levelCodec||h.codec,E=h.container+";codecs="+x;l.logger.log("[buffer-controller]: creating sourceBuffer("+E+")");try{var c=n[f]=a.addSourceBuffer(E),u=f;this.addBufferListener(u,"updatestart",this._onSBUpdateStart),this.addBufferListener(u,"updateend",this._onSBUpdateEnd),this.addBufferListener(u,"error",this._onSBUpdateError),this.tracks[f]={buffer:c,codec:x,container:h.container,levelCodec:h.levelCodec,id:h.id},p++}catch(o){l.logger.error("[buffer-controller]: error while trying to add sourceBuffer: "+o.message),this.hls.trigger(v.Events.ERROR,{type:P.ErrorTypes.MEDIA_ERROR,details:P.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:o,mimeType:E})}}p&&this.hls.trigger(v.Events.BUFFER_CREATED,{tracks:this.tracks})},I._onSBUpdateStart=function(r){var n=this.operationQueue,a=n.current(r);a.onStart()},I._onSBUpdateEnd=function(r){var n=this.operationQueue,a=n.current(r);a.onComplete(),n.shiftAndExecuteNext(r)},I._onSBUpdateError=function(r,n){l.logger.error("[buffer-controller]: "+r+" SourceBuffer error",n),this.hls.trigger(v.Events.ERROR,{type:P.ErrorTypes.MEDIA_ERROR,details:P.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1});var a=this.operationQueue.current(r);a&&a.onError(n)},I.removeExecutor=function(r,n,a){var p=this.media,f=this.mediaSource,h=this.operationQueue,x=this.sourceBuffer,E=x[r];if(!p||!f||!E){l.logger.warn("[buffer-controller]: Attempting to remove from the "+r+" SourceBuffer, but it does not exist"),h.shiftAndExecuteNext(r);return}var c=Object(g.isFiniteNumber)(p.duration)?p.duration:1/0,u=Object(g.isFiniteNumber)(f.duration)?f.duration:1/0,o=Math.max(0,n),d=Math.min(a,c,u);d>o?(l.logger.log("[buffer-controller]: Removing ["+o+","+d+"] from the "+r+" SourceBuffer"),console.assert(!E.updating,r+" sourceBuffer must not be updating"),E.remove(o,d)):h.shiftAndExecuteNext(r)},I.appendExecutor=function(r,n){var a=this.operationQueue,p=this.sourceBuffer,f=p[n];if(!f){l.logger.warn("[buffer-controller]: Attempting to append to the "+n+" SourceBuffer, but it does not exist"),a.shiftAndExecuteNext(n);return}f.ended=!1,console.assert(!f.updating,n+" sourceBuffer must not be updating"),f.appendBuffer(r)},I.blockBuffers=function(r,n){var a=this;if(n===void 0&&(n=this.getSourceBufferTypes()),!n.length){l.logger.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),Promise.resolve(r);return}var p=this.operationQueue,f=n.map(function(h){return p.appendBlocker(h)});Promise.all(f).then(function(){r(),n.forEach(function(h){var x=a.sourceBuffer[h];(!x||!x.updating)&&p.shiftAndExecuteNext(h)})})},I.getSourceBufferTypes=function(){return Object.keys(this.sourceBuffer)},I.addBufferListener=function(r,n,a){var p=this.sourceBuffer[r];if(!!p){var f=a.bind(this,r);this.listeners[r].push({event:n,listener:f}),p.addEventListener(n,f)}},I.removeBufferListeners=function(r){var n=this.sourceBuffer[r];!n||this.listeners[r].forEach(function(a){n.removeEventListener(a.event,a.listener)})},O}()},"./src/controller/buffer-operation-queue.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return v});var g=t("./src/utils/logger.ts"),v=function(){function l(b){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=b}var P=l.prototype;return P.append=function(C,L){var m=this.queues[L];m.push(C),m.length===1&&this.buffers[L]&&this.executeNext(L)},P.insertAbort=function(C,L){var m=this.queues[L];m.unshift(C),this.executeNext(L)},P.appendBlocker=function(C){var L,m=new Promise(function(D){L=D}),A={execute:L,onStart:function(){},onComplete:function(){},onError:function(){}};return this.append(A,C),m},P.executeNext=function(C){var L=this.buffers,m=this.queues,A=L[C],D=m[C];if(D.length){var S=D[0];try{S.execute()}catch(O){g.logger.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),S.onError(O),(!A||!A.updating)&&(D.shift(),this.executeNext(C))}}},P.shiftAndExecuteNext=function(C){this.queues[C].shift(),this.executeNext(C)},P.current=function(C){return this.queues[C][0]},l}()},"./src/controller/cap-level-controller.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/events.ts");function v(b,C){for(var L=0;L<C.length;L++){var m=C[L];m.enumerable=m.enumerable||!1,m.configurable=!0,"value"in m&&(m.writable=!0),Object.defineProperty(b,m.key,m)}}function l(b,C,L){return C&&v(b.prototype,C),L&&v(b,L),b}var P=function(){function b(L){this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.hls=void 0,this.streamController=void 0,this.clientRect=void 0,this.hls=L,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var C=b.prototype;return C.setStreamController=function(m){this.streamController=m},C.destroy=function(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},C.registerListeners=function(){var m=this.hls;m.on(g.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),m.on(g.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),m.on(g.Events.MANIFEST_PARSED,this.onManifestParsed,this),m.on(g.Events.BUFFER_CODECS,this.onBufferCodecs,this),m.on(g.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},C.unregisterListener=function(){var m=this.hls;m.off(g.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),m.off(g.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),m.off(g.Events.MANIFEST_PARSED,this.onManifestParsed,this),m.off(g.Events.BUFFER_CODECS,this.onBufferCodecs,this),m.off(g.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},C.onFpsDropLevelCapping=function(m,A){b.isLevelAllowed(A.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(A.droppedLevel)},C.onMediaAttaching=function(m,A){this.media=A.media instanceof HTMLVideoElement?A.media:null},C.onManifestParsed=function(m,A){var D=this.hls;this.restrictedLevels=[],this.firstLevel=A.firstLevel,D.config.capLevelToPlayerSize&&A.video&&this.startCapping()},C.onBufferCodecs=function(m,A){var D=this.hls;D.config.capLevelToPlayerSize&&A.video&&this.startCapping()},C.onMediaDetaching=function(){this.stopCapping()},C.detectPlayerSize=function(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){var m=this.hls.levels;if(m.length){var A=this.hls;A.autoLevelCapping=this.getMaxLevel(m.length-1),A.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=A.autoLevelCapping}}},C.getMaxLevel=function(m){var A=this,D=this.hls.levels;if(!D.length)return-1;var S=D.filter(function(O,I){return b.isLevelAllowed(I,A.restrictedLevels)&&I<=m});return this.clientRect=null,b.getMaxLevelByMediaSize(S,this.mediaWidth,this.mediaHeight)},C.startCapping=function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},C.stopCapping=function(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)},C.getDimensions=function(){if(this.clientRect)return this.clientRect;var m=this.media,A={width:0,height:0};if(m){var D=m.getBoundingClientRect();A.width=D.width,A.height=D.height,!A.width&&!A.height&&(A.width=D.right-D.left||m.width||0,A.height=D.bottom-D.top||m.height||0)}return this.clientRect=A,A},b.isLevelAllowed=function(m,A){return A===void 0&&(A=[]),A.indexOf(m)===-1},b.getMaxLevelByMediaSize=function(m,A,D){if(!m||!m.length)return-1;for(var S=function(n,a){return a?n.width!==a.width||n.height!==a.height:!0},O=m.length-1,I=0;I<m.length;I+=1){var s=m[I];if((s.width>=A||s.height>=D)&&S(s,m[I+1])){O=I;break}}return O},l(b,[{key:"mediaWidth",get:function(){return this.getDimensions().width*b.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*b.contentScaleFactor}}],[{key:"contentScaleFactor",get:function(){var m=1;try{m=self.devicePixelRatio}catch(A){}return m}}]),b}();e.default=P},"./src/controller/eme-controller.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/events.ts"),v=t("./src/errors.ts"),l=t("./src/utils/logger.ts"),P=t("./src/utils/mediakeys-helper.ts");function b(S,O){for(var I=0;I<O.length;I++){var s=O[I];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(S,s.key,s)}}function C(S,O,I){return O&&b(S.prototype,O),I&&b(S,I),S}var L=3,m=function(O,I,s){var r={audioCapabilities:[],videoCapabilities:[]};return O.forEach(function(n){r.audioCapabilities.push({contentType:'audio/mp4; codecs="'+n+'"',robustness:s.audioRobustness||""})}),I.forEach(function(n){r.videoCapabilities.push({contentType:'video/mp4; codecs="'+n+'"',robustness:s.videoRobustness||""})}),[r]},A=function(O,I,s,r){switch(O){case P.KeySystems.WIDEVINE:return m(I,s,r);default:throw new Error("Unknown key-system: "+O)}},D=function(){function S(I){this.hls=void 0,this._widevineLicenseUrl=void 0,this._licenseXhrSetup=void 0,this._licenseResponseCallback=void 0,this._emeEnabled=void 0,this._requestMediaKeySystemAccess=void 0,this._drmSystemOptions=void 0,this._config=void 0,this._mediaKeysList=[],this._media=null,this._hasSetMediaKeys=!1,this._requestLicenseFailureCount=0,this.mediaKeysPromise=null,this._onMediaEncrypted=this.onMediaEncrypted.bind(this),this.hls=I,this._config=I.config,this._widevineLicenseUrl=this._config.widevineLicenseUrl,this._licenseXhrSetup=this._config.licenseXhrSetup,this._licenseResponseCallback=this._config.licenseResponseCallback,this._emeEnabled=this._config.emeEnabled,this._requestMediaKeySystemAccess=this._config.requestMediaKeySystemAccessFunc,this._drmSystemOptions=this._config.drmSystemOptions,this._registerListeners()}var O=S.prototype;return O.destroy=function(){this._unregisterListeners(),this.hls=this._onMediaEncrypted=null,this._requestMediaKeySystemAccess=null},O._registerListeners=function(){this.hls.on(g.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(g.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(g.Events.MANIFEST_PARSED,this.onManifestParsed,this)},O._unregisterListeners=function(){this.hls.off(g.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(g.Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(g.Events.MANIFEST_PARSED,this.onManifestParsed,this)},O.getLicenseServerUrl=function(s){switch(s){case P.KeySystems.WIDEVINE:if(!this._widevineLicenseUrl)break;return this._widevineLicenseUrl}throw new Error('no license server URL configured for key-system "'+s+'"')},O._attemptKeySystemAccess=function(s,r,n){var a=this,p=A(s,r,n,this._drmSystemOptions);l.logger.log("Requesting encrypted media key-system access");var f=this.requestMediaKeySystemAccess(s,p);this.mediaKeysPromise=f.then(function(h){return a._onMediaKeySystemAccessObtained(s,h)}),f.catch(function(h){l.logger.error('Failed to obtain key-system "'+s+'" access:',h)})},O._onMediaKeySystemAccessObtained=function(s,r){var n=this;l.logger.log('Access for key-system "'+s+'" obtained');var a={mediaKeysSessionInitialized:!1,mediaKeySystemAccess:r,mediaKeySystemDomain:s};this._mediaKeysList.push(a);var p=Promise.resolve().then(function(){return r.createMediaKeys()}).then(function(f){return a.mediaKeys=f,l.logger.log('Media-keys created for key-system "'+s+'"'),n._onMediaKeysCreated(),f});return p.catch(function(f){l.logger.error("Failed to create media-keys:",f)}),p},O._onMediaKeysCreated=function(){var s=this;this._mediaKeysList.forEach(function(r){r.mediaKeysSession||(r.mediaKeysSession=r.mediaKeys.createSession(),s._onNewMediaKeySession(r.mediaKeysSession))})},O._onNewMediaKeySession=function(s){var r=this;l.logger.log("New key-system session "+s.sessionId),s.addEventListener("message",function(n){r._onKeySessionMessage(s,n.message)},!1)},O._onKeySessionMessage=function(s,r){l.logger.log("Got EME message event, creating license request"),this._requestLicense(r,function(n){l.logger.log("Received license data (length: "+(n&&n.byteLength)+"), updating key-session"),s.update(n)})},O.onMediaEncrypted=function(s){var r=this;if(l.logger.log('Media is encrypted using "'+s.initDataType+'" init data type'),!this.mediaKeysPromise){l.logger.error("Fatal: Media is encrypted but no CDM access or no keys have been requested"),this.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.KEY_SYSTEM_ERROR,details:v.ErrorDetails.KEY_SYSTEM_NO_KEYS,fatal:!0});return}var n=function(p){!r._media||(r._attemptSetMediaKeys(p),r._generateRequestWithPreferredKeySession(s.initDataType,s.initData))};this.mediaKeysPromise.then(n).catch(n)},O._attemptSetMediaKeys=function(s){if(!this._media)throw new Error("Attempted to set mediaKeys without first attaching a media element");if(!this._hasSetMediaKeys){var r=this._mediaKeysList[0];if(!r||!r.mediaKeys){l.logger.error("Fatal: Media is encrypted but no CDM access or no keys have been obtained yet"),this.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.KEY_SYSTEM_ERROR,details:v.ErrorDetails.KEY_SYSTEM_NO_KEYS,fatal:!0});return}l.logger.log("Setting keys for encrypted media"),this._media.setMediaKeys(r.mediaKeys),this._hasSetMediaKeys=!0}},O._generateRequestWithPreferredKeySession=function(s,r){var n=this,a=this._mediaKeysList[0];if(!a){l.logger.error("Fatal: Media is encrypted but not any key-system access has been obtained yet"),this.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.KEY_SYSTEM_ERROR,details:v.ErrorDetails.KEY_SYSTEM_NO_ACCESS,fatal:!0});return}if(a.mediaKeysSessionInitialized){l.logger.warn("Key-Session already initialized but requested again");return}var p=a.mediaKeysSession;if(!p){l.logger.error("Fatal: Media is encrypted but no key-session existing"),this.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.KEY_SYSTEM_ERROR,details:v.ErrorDetails.KEY_SYSTEM_NO_SESSION,fatal:!0});return}if(!r){l.logger.warn("Fatal: initData required for generating a key session is null"),this.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.KEY_SYSTEM_ERROR,details:v.ErrorDetails.KEY_SYSTEM_NO_INIT_DATA,fatal:!0});return}l.logger.log('Generating key-session request for "'+s+'" init data type'),a.mediaKeysSessionInitialized=!0,p.generateRequest(s,r).then(function(){l.logger.debug("Key-session generation succeeded")}).catch(function(f){l.logger.error("Error generating key-session request:",f),n.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.KEY_SYSTEM_ERROR,details:v.ErrorDetails.KEY_SYSTEM_NO_SESSION,fatal:!1})})},O._createLicenseXhr=function(s,r,n){var a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=this._onLicenseRequestReadyStageChange.bind(this,a,s,r,n);var p=this._licenseXhrSetup;if(p)try{p.call(this.hls,a,s),p=void 0}catch(f){l.logger.error(f)}try{a.readyState||a.open("POST",s,!0),p&&p.call(this.hls,a,s)}catch(f){throw new Error("issue setting up KeySystem license XHR "+f)}return a},O._onLicenseRequestReadyStageChange=function(s,r,n,a){switch(s.readyState){case 4:if(s.status===200){this._requestLicenseFailureCount=0,l.logger.log("License request succeeded");var p=s.response,f=this._licenseResponseCallback;if(f)try{p=f.call(this.hls,s,r)}catch(x){l.logger.error(x)}a(p)}else{if(l.logger.error("License Request XHR failed ("+r+"). Status: "+s.status+" ("+s.statusText+")"),this._requestLicenseFailureCount++,this._requestLicenseFailureCount>L){this.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.KEY_SYSTEM_ERROR,details:v.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0});return}var h=L-this._requestLicenseFailureCount+1;l.logger.warn("Retrying license request, "+h+" attempts left"),this._requestLicense(n,a)}break}},O._generateLicenseRequestChallenge=function(s,r){switch(s.mediaKeySystemDomain){case P.KeySystems.WIDEVINE:return r}throw new Error("unsupported key-system: "+s.mediaKeySystemDomain)},O._requestLicense=function(s,r){l.logger.log("Requesting content license for key-system");var n=this._mediaKeysList[0];if(!n){l.logger.error("Fatal error: Media is encrypted but no key-system access has been obtained yet"),this.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.KEY_SYSTEM_ERROR,details:v.ErrorDetails.KEY_SYSTEM_NO_ACCESS,fatal:!0});return}try{var a=this.getLicenseServerUrl(n.mediaKeySystemDomain),p=this._createLicenseXhr(a,s,r);l.logger.log("Sending license request to URL: "+a);var f=this._generateLicenseRequestChallenge(n,s);p.send(f)}catch(h){l.logger.error("Failure requesting DRM license: "+h),this.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.KEY_SYSTEM_ERROR,details:v.ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0})}},O.onMediaAttached=function(s,r){if(!!this._emeEnabled){var n=r.media;this._media=n,n.addEventListener("encrypted",this._onMediaEncrypted)}},O.onMediaDetached=function(){var s=this._media,r=this._mediaKeysList;!s||(s.removeEventListener("encrypted",this._onMediaEncrypted),this._media=null,this._mediaKeysList=[],Promise.all(r.map(function(n){if(n.mediaKeysSession)return n.mediaKeysSession.close().catch(function(){})})).then(function(){return s.setMediaKeys(null)}).catch(function(){}))},O.onManifestParsed=function(s,r){if(!!this._emeEnabled){var n=r.levels.map(function(p){return p.audioCodec}).filter(function(p){return!!p}),a=r.levels.map(function(p){return p.videoCodec}).filter(function(p){return!!p});this._attemptKeySystemAccess(P.KeySystems.WIDEVINE,n,a)}},C(S,[{key:"requestMediaKeySystemAccess",get:function(){if(!this._requestMediaKeySystemAccess)throw new Error("No requestMediaKeySystemAccess function configured");return this._requestMediaKeySystemAccess}}]),S}();e.default=D},"./src/controller/fps-controller.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/events.ts"),v=t("./src/utils/logger.ts"),l=function(){function P(C){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=C,this.registerListeners()}var b=P.prototype;return b.setStreamController=function(L){this.streamController=L},b.registerListeners=function(){this.hls.on(g.Events.MEDIA_ATTACHING,this.onMediaAttaching,this)},b.unregisterListeners=function(){this.hls.off(g.Events.MEDIA_ATTACHING,this.onMediaAttaching)},b.destroy=function(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null},b.onMediaAttaching=function(L,m){var A=this.hls.config;if(A.capLevelOnFPSDrop){var D=m.media instanceof self.HTMLVideoElement?m.media:null;this.media=D,D&&typeof D.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),A.fpsDroppedMonitoringPeriod)}},b.checkFPS=function(L,m,A){var D=performance.now();if(m){if(this.lastTime){var S=D-this.lastTime,O=A-this.lastDroppedFrames,I=m-this.lastDecodedFrames,s=1e3*O/S,r=this.hls;if(r.trigger(g.Events.FPS_DROP,{currentDropped:O,currentDecoded:I,totalDroppedFrames:A}),s>0&&O>r.config.fpsDroppedMonitoringThreshold*I){var n=r.currentLevel;v.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+n),n>0&&(r.autoLevelCapping===-1||r.autoLevelCapping>=n)&&(n=n-1,r.trigger(g.Events.FPS_DROP_LEVEL_CAPPING,{level:n,droppedLevel:r.currentLevel}),r.autoLevelCapping=n,this.streamController.nextLevelSwitch())}}this.lastTime=D,this.lastDroppedFrames=A,this.lastDecodedFrames=m}},b.checkFPSInterval=function(){var L=this.media;if(L)if(this.isVideoPlaybackQualityAvailable){var m=L.getVideoPlaybackQuality();this.checkFPS(L,m.totalVideoFrames,m.droppedVideoFrames)}else this.checkFPS(L,L.webkitDecodedFrameCount,L.webkitDroppedFrameCount)},P}();e.default=l},"./src/controller/fragment-finders.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"findFragmentByPDT",function(){return l}),t.d(e,"findFragmentByPTS",function(){return P}),t.d(e,"fragmentWithinToleranceTest",function(){return b}),t.d(e,"pdtWithinToleranceTest",function(){return C}),t.d(e,"findFragWithCC",function(){return L});var g=t("./src/polyfills/number.ts"),v=t("./src/utils/binary-search.ts");function l(m,A,D){if(A===null||!Array.isArray(m)||!m.length||!Object(g.isFiniteNumber)(A))return null;var S=m[0].programDateTime;if(A<(S||0))return null;var O=m[m.length-1].endProgramDateTime;if(A>=(O||0))return null;D=D||0;for(var I=0;I<m.length;++I){var s=m[I];if(C(A,D,s))return s}return null}function P(m,A,D,S){D===void 0&&(D=0),S===void 0&&(S=0);var O=null;if(m?O=A[m.sn-A[0].sn+1]||null:D===0&&A[0].start===0&&(O=A[0]),O&&b(D,S,O)===0)return O;var I=v.default.search(A,b.bind(null,D,S));return I||O}function b(m,A,D){m===void 0&&(m=0),A===void 0&&(A=0);var S=Math.min(A,D.duration+(D.deltaPTS?D.deltaPTS:0));return D.start+D.duration-S<=m?1:D.start-S>m&&D.start?-1:0}function C(m,A,D){var S=Math.min(A,D.duration+(D.deltaPTS?D.deltaPTS:0))*1e3,O=D.endProgramDateTime||0;return O-S>m}function L(m,A){return v.default.search(m,function(D){return D.cc<A?1:D.cc>A?-1:0})}},"./src/controller/fragment-tracker.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"FragmentState",function(){return l}),t.d(e,"FragmentTracker",function(){return P});var g=t("./src/events.ts"),v=t("./src/types/loader.ts"),l;(function(L){L.NOT_LOADED="NOT_LOADED",L.BACKTRACKED="BACKTRACKED",L.APPENDING="APPENDING",L.PARTIAL="PARTIAL",L.OK="OK"})(l||(l={}));var P=function(){function L(A){this.activeFragment=null,this.activeParts=null,this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hls=A,this._registerListeners()}var m=L.prototype;return m._registerListeners=function(){var D=this.hls;D.on(g.Events.BUFFER_APPENDED,this.onBufferAppended,this),D.on(g.Events.FRAG_BUFFERED,this.onFragBuffered,this),D.on(g.Events.FRAG_LOADED,this.onFragLoaded,this)},m._unregisterListeners=function(){var D=this.hls;D.off(g.Events.BUFFER_APPENDED,this.onBufferAppended,this),D.off(g.Events.FRAG_BUFFERED,this.onFragBuffered,this),D.off(g.Events.FRAG_LOADED,this.onFragLoaded,this)},m.destroy=function(){this._unregisterListeners(),this.fragments=this.timeRanges=null},m.getAppendedFrag=function(D,S){if(S===v.PlaylistLevelType.MAIN){var O=this.activeFragment,I=this.activeParts;if(!O)return null;if(I)for(var s=I.length;s--;){var r=I[s],n=r?r.end:O.appendedPTS;if(r.start<=D&&n!==void 0&&D<=n)return s>9&&(this.activeParts=I.slice(s-9)),r}else if(O.start<=D&&O.appendedPTS!==void 0&&D<=O.appendedPTS)return O}return this.getBufferedFrag(D,S)},m.getBufferedFrag=function(D,S){for(var O=this.fragments,I=Object.keys(O),s=I.length;s--;){var r=O[I[s]];if((r==null?void 0:r.body.type)===S&&r.buffered){var n=r.body;if(n.start<=D&&D<=n.end)return n}}return null},m.detectEvictedFragments=function(D,S,O){var I=this;Object.keys(this.fragments).forEach(function(s){var r=I.fragments[s];if(!!r){if(!r.buffered){r.body.type===O&&I.removeFragment(r.body);return}var n=r.range[D];!n||n.time.some(function(a){var p=!I.isTimeBuffered(a.startPTS,a.endPTS,S);return p&&I.removeFragment(r.body),p})}})},m.detectPartialFragments=function(D){var S=this,O=this.timeRanges,I=D.frag,s=D.part;if(!(!O||I.sn==="initSegment")){var r=C(I),n=this.fragments[r];!n||(Object.keys(O).forEach(function(a){var p=I.elementaryStreams[a];if(!!p){var f=O[a],h=s!==null||p.partial===!0;n.range[a]=S.getBufferedTimes(I,s,h,f)}}),n.backtrack=n.loaded=null,Object.keys(n.range).length?n.buffered=!0:this.removeFragment(n.body))}},m.fragBuffered=function(D){var S=C(D),O=this.fragments[S];O&&(O.backtrack=O.loaded=null,O.buffered=!0)},m.getBufferedTimes=function(D,S,O,I){for(var s={time:[],partial:O},r=S?S.start:D.start,n=S?S.end:D.end,a=D.minEndPTS||n,p=D.maxStartPTS||r,f=0;f<I.length;f++){var h=I.start(f)-this.bufferPadding,x=I.end(f)+this.bufferPadding;if(p>=h&&a<=x){s.time.push({startPTS:Math.max(r,I.start(f)),endPTS:Math.min(n,I.end(f))});break}else if(r<x&&n>h)s.partial=!0,s.time.push({startPTS:Math.max(r,I.start(f)),endPTS:Math.min(n,I.end(f))});else if(n<=h)break}return s},m.getPartialFragment=function(D){var S=null,O,I,s,r=0,n=this.bufferPadding,a=this.fragments;return Object.keys(a).forEach(function(p){var f=a[p];!f||b(f)&&(I=f.body.start-n,s=f.body.end+n,D>=I&&D<=s&&(O=Math.min(D-I,s-D),r<=O&&(S=f.body,r=O)))}),S},m.getState=function(D){var S=C(D),O=this.fragments[S];return O?O.buffered?b(O)?l.PARTIAL:l.OK:O.backtrack?l.BACKTRACKED:l.APPENDING:l.NOT_LOADED},m.backtrack=function(D,S){var O=C(D),I=this.fragments[O];if(!I||I.backtrack)return null;var s=I.backtrack=S||I.loaded;return I.loaded=null,s},m.getBacktrackData=function(D){var S=C(D),O=this.fragments[S];if(O){var I,s=O.backtrack;if(s!=null&&(I=s.payload)!==null&&I!==void 0&&I.byteLength)return s;this.removeFragment(D)}return null},m.isTimeBuffered=function(D,S,O){for(var I,s,r=0;r<O.length;r++){if(I=O.start(r)-this.bufferPadding,s=O.end(r)+this.bufferPadding,D>=I&&S<=s)return!0;if(S<=I)return!1}return!1},m.onFragLoaded=function(D,S){var O=S.frag,I=S.part;if(!(O.sn==="initSegment"||O.bitrateTest||I)){var s=C(O);this.fragments[s]={body:O,loaded:S,backtrack:null,buffered:!1,range:Object.create(null)}}},m.onBufferAppended=function(D,S){var O=this,I=S.frag,s=S.part,r=S.timeRanges;if(I.type===v.PlaylistLevelType.MAIN)if(this.activeFragment=I,s){var n=this.activeParts;n||(this.activeParts=n=[]),n.push(s)}else this.activeParts=null;this.timeRanges=r,Object.keys(r).forEach(function(a){var p=r[a];if(O.detectEvictedFragments(a,p),!s)for(var f=0;f<p.length;f++)I.appendedPTS=Math.max(p.end(f),I.appendedPTS||0)})},m.onFragBuffered=function(D,S){this.detectPartialFragments(S)},m.hasFragment=function(D){var S=C(D);return!!this.fragments[S]},m.removeFragmentsInRange=function(D,S,O){var I=this;Object.keys(this.fragments).forEach(function(s){var r=I.fragments[s];if(!!r&&r.buffered){var n=r.body;n.type===O&&n.start<S&&n.end>D&&I.removeFragment(n)}})},m.removeFragment=function(D){var S=C(D);D.stats.loaded=0,D.clearElementaryStreamInfo(),delete this.fragments[S]},m.removeAllFragments=function(){this.fragments=Object.create(null),this.activeFragment=null,this.activeParts=null},L}();function b(L){var m,A;return L.buffered&&(((m=L.range.video)===null||m===void 0?void 0:m.partial)||((A=L.range.audio)===null||A===void 0?void 0:A.partial))}function C(L){return L.type+"_"+L.level+"_"+L.urlId+"_"+L.sn}},"./src/controller/gap-controller.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"STALL_MINIMUM_DURATION_MS",function(){return b}),t.d(e,"MAX_START_GAP_JUMP",function(){return C}),t.d(e,"SKIP_BUFFER_HOLE_STEP_SECONDS",function(){return L}),t.d(e,"SKIP_BUFFER_RANGE_START",function(){return m}),t.d(e,"default",function(){return A});var g=t("./src/utils/buffer-helper.ts"),v=t("./src/errors.ts"),l=t("./src/events.ts"),P=t("./src/utils/logger.ts"),b=250,C=2,L=.1,m=.05,A=function(){function D(O,I,s,r){this.config=void 0,this.media=void 0,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=O,this.media=I,this.fragmentTracker=s,this.hls=r}var S=D.prototype;return S.destroy=function(){this.hls=this.fragmentTracker=this.media=null},S.poll=function(I){var s=this.config,r=this.media,n=this.stalled,a=r.currentTime,p=r.seeking,f=this.seeking&&!p,h=!this.seeking&&p;if(this.seeking=p,a!==I){if(this.moved=!0,n!==null){if(this.stallReported){var x=self.performance.now()-n;P.logger.warn("playback not stuck anymore @"+a+", after "+Math.round(x)+"ms"),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if((h||f)&&(this.stalled=null),!(r.paused||r.ended||r.playbackRate===0||!g.BufferHelper.getBuffered(r).length)){var E=g.BufferHelper.bufferInfo(r,a,0),c=E.len>0,u=E.nextStart||0;if(!(!c&&!u)){if(p){var o=E.len>C,d=!u||u-a>C&&!this.fragmentTracker.getPartialFragment(a);if(o||d)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var T,y=Math.max(u,E.start||0)-a,R=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,M=R==null||(T=R.details)===null||T===void 0?void 0:T.live,_=M?R.details.targetduration*2:C;if(y>0&&y<=_){this._trySkipBufferHole(null);return}}var F=self.performance.now();if(n===null){this.stalled=F;return}var B=F-n;!p&&B>=b&&this._reportStall(E.len);var w=g.BufferHelper.bufferInfo(r,a,s.maxBufferHole);this._tryFixBufferStall(w,B)}}},S._tryFixBufferStall=function(I,s){var r=this.config,n=this.fragmentTracker,a=this.media,p=a.currentTime,f=n.getPartialFragment(p);if(f){var h=this._trySkipBufferHole(f);if(h)return}I.len>r.maxBufferHole&&s>r.highBufferWatchdogPeriod*1e3&&(P.logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())},S._reportStall=function(I){var s=this.hls,r=this.media,n=this.stallReported;n||(this.stallReported=!0,P.logger.warn("Playback stalling at @"+r.currentTime+" due to low buffer (buffer="+I+")"),s.trigger(l.Events.ERROR,{type:v.ErrorTypes.MEDIA_ERROR,details:v.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:I}))},S._trySkipBufferHole=function(I){for(var s=this.config,r=this.hls,n=this.media,a=n.currentTime,p=0,f=g.BufferHelper.getBuffered(n),h=0;h<f.length;h++){var x=f.start(h);if(a+s.maxBufferHole>=p&&a<x){var E=Math.max(x+m,n.currentTime+L);return P.logger.warn("skipping hole, adjusting currentTime from "+a+" to "+E),this.moved=!0,this.stalled=null,n.currentTime=E,I&&r.trigger(l.Events.ERROR,{type:v.ErrorTypes.MEDIA_ERROR,details:v.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:"fragment loaded with buffer holes, seeking from "+a+" to "+E,frag:I}),E}p=f.end(h)}return 0},S._tryNudgeBuffer=function(){var I=this.config,s=this.hls,r=this.media,n=r.currentTime,a=(this.nudgeRetry||0)+1;if(this.nudgeRetry=a,a<I.nudgeMaxRetry){var p=n+a*I.nudgeOffset;P.logger.warn("Nudging 'currentTime' from "+n+" to "+p),r.currentTime=p,s.trigger(l.Events.ERROR,{type:v.ErrorTypes.MEDIA_ERROR,details:v.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:!1})}else P.logger.error("Playhead still not moving while enough data buffered @"+n+" after "+I.nudgeMaxRetry+" nudges"),s.trigger(l.Events.ERROR,{type:v.ErrorTypes.MEDIA_ERROR,details:v.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!0})},D}()},"./src/controller/id3-track-controller.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/events.ts"),v=t("./src/utils/texttrack-utils.ts"),l=t("./src/demux/id3.ts"),P=.25,b=function(){function C(m){this.hls=void 0,this.id3Track=null,this.media=null,this.hls=m,this._registerListeners()}var L=C.prototype;return L.destroy=function(){this._unregisterListeners()},L._registerListeners=function(){var A=this.hls;A.on(g.Events.MEDIA_ATTACHED,this.onMediaAttached,this),A.on(g.Events.MEDIA_DETACHING,this.onMediaDetaching,this),A.on(g.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),A.on(g.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},L._unregisterListeners=function(){var A=this.hls;A.off(g.Events.MEDIA_ATTACHED,this.onMediaAttached,this),A.off(g.Events.MEDIA_DETACHING,this.onMediaDetaching,this),A.off(g.Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),A.off(g.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},L.onMediaAttached=function(A,D){this.media=D.media},L.onMediaDetaching=function(){!this.id3Track||(Object(v.clearCurrentCues)(this.id3Track),this.id3Track=null,this.media=null)},L.getID3Track=function(A){if(!!this.media){for(var D=0;D<A.length;D++){var S=A[D];if(S.kind==="metadata"&&S.label==="id3")return Object(v.sendAddTrackEvent)(S,this.media),S}return this.media.addTextTrack("metadata","id3")}},L.onFragParsingMetadata=function(A,D){if(!!this.media){var S=D.frag,O=D.samples;this.id3Track||(this.id3Track=this.getID3Track(this.media.textTracks),this.id3Track.mode="hidden");for(var I=self.WebKitDataCue||self.VTTCue||self.TextTrackCue,s=0;s<O.length;s++){var r=l.getID3Frames(O[s].data);if(r){var n=O[s].pts,a=s<O.length-1?O[s+1].pts:S.end,p=a-n;p<=0&&(a=n+P);for(var f=0;f<r.length;f++){var h=r[f];if(!l.isTimeStampFrame(h)){var x=new I(n,a,"");x.value=h,this.id3Track.addCue(x)}}}}}},L.onBufferFlushing=function(A,D){var S=D.startOffset,O=D.endOffset,I=D.type;if(!I||I==="audio"){var s=this.id3Track;s&&Object(v.removeCuesInRange)(s,S,O)}},C}();e.default=b},"./src/controller/latency-controller.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return C});var g=t("./src/errors.ts"),v=t("./src/events.ts"),l=t("./src/utils/logger.ts");function P(L,m){for(var A=0;A<m.length;A++){var D=m[A];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty(L,D.key,D)}}function b(L,m,A){return m&&P(L.prototype,m),A&&P(L,A),L}var C=function(){function L(A){var D=this;this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=function(){return D.timeupdate()},this.hls=A,this.config=A.config,this.registerListeners()}var m=L.prototype;return m.destroy=function(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null},m.registerListeners=function(){this.hls.on(v.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(v.Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(v.Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(v.Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(v.Events.ERROR,this.onError,this)},m.unregisterListeners=function(){this.hls.off(v.Events.MEDIA_ATTACHED,this.onMediaAttached),this.hls.off(v.Events.MEDIA_DETACHING,this.onMediaDetaching),this.hls.off(v.Events.MANIFEST_LOADING,this.onManifestLoading),this.hls.off(v.Events.LEVEL_UPDATED,this.onLevelUpdated),this.hls.off(v.Events.ERROR,this.onError)},m.onMediaAttached=function(D,S){this.media=S.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)},m.onMediaDetaching=function(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)},m.onManifestLoading=function(){this.levelDetails=null,this._latency=null,this.stallCount=0},m.onLevelUpdated=function(D,S){var O=S.details;this.levelDetails=O,O.advanced&&this.timeupdate(),!O.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)},m.onError=function(D,S){S.details===g.ErrorDetails.BUFFER_STALLED_ERROR&&(this.stallCount++,l.logger.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))},m.timeupdate=function(){var D=this.media,S=this.levelDetails;if(!(!D||!S)){this.currentTime=D.currentTime;var O=this.computeLatency();if(O!==null){this._latency=O;var I=this.config,s=I.lowLatencyMode,r=I.maxLiveSyncPlaybackRate;if(!(!s||r===1)){var n=this.targetLatency;if(n!==null){var a=O-n,p=Math.min(this.maxLatency,n+S.targetduration),f=a<p;if(S.live&&f&&a>.05&&this.forwardBufferLength>1){var h=Math.min(2,Math.max(1,r)),x=Math.round(2/(1+Math.exp(-.75*a-this.edgeStalled))*20)/20;D.playbackRate=Math.min(h,Math.max(1,x))}else D.playbackRate!==1&&D.playbackRate!==0&&(D.playbackRate=1)}}}}},m.estimateLiveEdge=function(){var D=this.levelDetails;return D===null?null:D.edge+D.age},m.computeLatency=function(){var D=this.estimateLiveEdge();return D===null?null:D-this.currentTime},b(L,[{key:"latency",get:function(){return this._latency||0}},{key:"maxLatency",get:function(){var D=this.config,S=this.levelDetails;return D.liveMaxLatencyDuration!==void 0?D.liveMaxLatencyDuration:S?D.liveMaxLatencyDurationCount*S.targetduration:0}},{key:"targetLatency",get:function(){var D=this.levelDetails;if(D===null)return null;var S=D.holdBack,O=D.partHoldBack,I=D.targetduration,s=this.config,r=s.liveSyncDuration,n=s.liveSyncDurationCount,a=s.lowLatencyMode,p=this.hls.userConfig,f=a&&O||S;(p.liveSyncDuration||p.liveSyncDurationCount||f===0)&&(f=r!==void 0?r:n*I);var h=I,x=1;return f+Math.min(this.stallCount*x,h)}},{key:"liveSyncPosition",get:function(){var D=this.estimateLiveEdge(),S=this.targetLatency,O=this.levelDetails;if(D===null||S===null||O===null)return null;var I=O.edge,s=D-S-this.edgeStalled,r=I-O.totalduration,n=I-(this.config.lowLatencyMode&&O.partTarget||O.targetduration);return Math.min(Math.max(r,s),n)}},{key:"drift",get:function(){var D=this.levelDetails;return D===null?1:D.drift}},{key:"edgeStalled",get:function(){var D=this.levelDetails;if(D===null)return 0;var S=(this.config.lowLatencyMode&&D.partTarget||D.targetduration)*3;return Math.max(D.age-S,0)}},{key:"forwardBufferLength",get:function(){var D=this.media,S=this.levelDetails;if(!D||!S)return 0;var O=D.buffered.length;return O?D.buffered.end(O-1):S.edge-this.currentTime}}]),L}()},"./src/controller/level-controller.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return s});var g=t("./src/types/level.ts"),v=t("./src/events.ts"),l=t("./src/errors.ts"),P=t("./src/utils/codecs.ts"),b=t("./src/controller/level-helper.ts"),C=t("./src/controller/base-playlist-controller.ts"),L=t("./src/types/loader.ts");function m(){return m=Object.assign||function(r){for(var n=1;n<arguments.length;n++){var a=arguments[n];for(var p in a)Object.prototype.hasOwnProperty.call(a,p)&&(r[p]=a[p])}return r},m.apply(this,arguments)}function A(r,n){for(var a=0;a<n.length;a++){var p=n[a];p.enumerable=p.enumerable||!1,p.configurable=!0,"value"in p&&(p.writable=!0),Object.defineProperty(r,p.key,p)}}function D(r,n,a){return n&&A(r.prototype,n),a&&A(r,a),r}function S(r,n){r.prototype=Object.create(n.prototype),r.prototype.constructor=r,O(r,n)}function O(r,n){return O=Object.setPrototypeOf||function(p,f){return p.__proto__=f,p},O(r,n)}var I=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),s=function(r){S(n,r);function n(p){var f;return f=r.call(this,p,"[level-controller]")||this,f._levels=[],f._firstLevel=-1,f._startLevel=void 0,f.currentLevelIndex=-1,f.manualLevelIndex=-1,f.onParsedComplete=void 0,f._registerListeners(),f}var a=n.prototype;return a._registerListeners=function(){var f=this.hls;f.on(v.Events.MANIFEST_LOADED,this.onManifestLoaded,this),f.on(v.Events.LEVEL_LOADED,this.onLevelLoaded,this),f.on(v.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),f.on(v.Events.FRAG_LOADED,this.onFragLoaded,this),f.on(v.Events.ERROR,this.onError,this)},a._unregisterListeners=function(){var f=this.hls;f.off(v.Events.MANIFEST_LOADED,this.onManifestLoaded,this),f.off(v.Events.LEVEL_LOADED,this.onLevelLoaded,this),f.off(v.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),f.off(v.Events.FRAG_LOADED,this.onFragLoaded,this),f.off(v.Events.ERROR,this.onError,this)},a.destroy=function(){this._unregisterListeners(),this.manualLevelIndex=-1,this._levels.length=0,r.prototype.destroy.call(this)},a.startLoad=function(){var f=this._levels;f.forEach(function(h){h.loadError=0}),r.prototype.startLoad.call(this)},a.onManifestLoaded=function(f,h){var x=[],E=[],c=[],u,o={},d,T=!1,y=!1,R=!1;if(h.levels.forEach(function(B){var w=B.attrs;T=T||!!(B.width&&B.height),y=y||!!B.videoCodec,R=R||!!B.audioCodec,I&&B.audioCodec&&B.audioCodec.indexOf("mp4a.40.34")!==-1&&(B.audioCodec=void 0);var k=B.bitrate+"-"+B.attrs.RESOLUTION+"-"+B.attrs.CODECS;d=o[k],d?d.url.push(B.url):(d=new g.Level(B),o[k]=d,x.push(d)),w&&(w.AUDIO&&Object(b.addGroupId)(d,"audio",w.AUDIO),w.SUBTITLES&&Object(b.addGroupId)(d,"text",w.SUBTITLES))}),(T||y)&&R&&(x=x.filter(function(B){var w=B.videoCodec,k=B.width,U=B.height;return!!w||!!(k&&U)})),x=x.filter(function(B){var w=B.audioCodec,k=B.videoCodec;return(!w||Object(P.isCodecSupportedInMp4)(w,"audio"))&&(!k||Object(P.isCodecSupportedInMp4)(k,"video"))}),h.audioTracks&&(E=h.audioTracks.filter(function(B){return!B.audioCodec||Object(P.isCodecSupportedInMp4)(B.audioCodec,"audio")}),Object(b.assignTrackIdsByGroup)(E)),h.subtitles&&(c=h.subtitles,Object(b.assignTrackIdsByGroup)(c)),x.length>0){u=x[0].bitrate,x.sort(function(B,w){return B.bitrate-w.bitrate}),this._levels=x;for(var M=0;M<x.length;M++)if(x[M].bitrate===u){this._firstLevel=M,this.log("manifest loaded, "+x.length+" level(s) found, first bitrate: "+u);break}var _=R&&!y,F={levels:x,audioTracks:E,subtitleTracks:c,firstLevel:this._firstLevel,stats:h.stats,audio:R,video:y,altAudio:!_&&E.some(function(B){return!!B.url})};this.hls.trigger(v.Events.MANIFEST_PARSED,F),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else this.hls.trigger(v.Events.ERROR,{type:l.ErrorTypes.MEDIA_ERROR,details:l.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:h.url,reason:"no level with compatible codecs found in manifest"})},a.onError=function(f,h){if(r.prototype.onError.call(this,f,h),!h.fatal){var x=h.context,E=this._levels[this.currentLevelIndex];if(x&&(x.type===L.PlaylistContextType.AUDIO_TRACK&&E.audioGroupIds&&x.groupId===E.audioGroupIds[E.urlId]||x.type===L.PlaylistContextType.SUBTITLE_TRACK&&E.textGroupIds&&x.groupId===E.textGroupIds[E.urlId])){this.redundantFailover(this.currentLevelIndex);return}var c=!1,u=!0,o;switch(h.details){case l.ErrorDetails.FRAG_LOAD_ERROR:case l.ErrorDetails.FRAG_LOAD_TIMEOUT:case l.ErrorDetails.KEY_LOAD_ERROR:case l.ErrorDetails.KEY_LOAD_TIMEOUT:if(h.frag){var d=this._levels[h.frag.level];d?(d.fragmentError++,d.fragmentError>this.hls.config.fragLoadingMaxRetry&&(o=h.frag.level)):o=h.frag.level}break;case l.ErrorDetails.LEVEL_LOAD_ERROR:case l.ErrorDetails.LEVEL_LOAD_TIMEOUT:x&&(x.deliveryDirectives&&(u=!1),o=x.level),c=!0;break;case l.ErrorDetails.REMUX_ALLOC_ERROR:o=h.level,c=!0;break}o!==void 0&&this.recoverLevel(h,o,c,u)}},a.recoverLevel=function(f,h,x,E){var c=f.details,u=this._levels[h];if(u.loadError++,x){var o=this.retryLoadingOrFail(f);if(o)f.levelRetry=!0;else{this.currentLevelIndex=-1;return}}if(E){var d=u.url.length;if(d>1&&u.loadError<d)f.levelRetry=!0,this.redundantFailover(h);else if(this.manualLevelIndex===-1){var T=h===0?this._levels.length-1:h-1;this.currentLevelIndex!==T&&this._levels[T].loadError===0&&(this.warn(c+": switch to "+T),f.levelRetry=!0,this.hls.nextAutoLevel=T)}}},a.redundantFailover=function(f){var h=this._levels[f],x=h.url.length;if(x>1){var E=(h.urlId+1)%x;this.warn("Switching to redundant URL-id "+E),this._levels.forEach(function(c){c.urlId=E}),this.level=f}},a.onFragLoaded=function(f,h){var x=h.frag;if(x!==void 0&&x.type===L.PlaylistLevelType.MAIN){var E=this._levels[x.level];E!==void 0&&(E.fragmentError=0,E.loadError=0)}},a.onLevelLoaded=function(f,h){var x,E=h.level,c=h.details,u=this._levels[E];if(!u){var o;this.warn("Invalid level index "+E),(o=h.deliveryDirectives)!==null&&o!==void 0&&o.skip&&(c.deltaUpdateFailed=!0);return}E===this.currentLevelIndex?(u.fragmentError===0&&(u.loadError=0,this.retryCount=0),this.playlistLoaded(E,h,u.details)):(x=h.deliveryDirectives)!==null&&x!==void 0&&x.skip&&(c.deltaUpdateFailed=!0)},a.onAudioTrackSwitched=function(f,h){var x=this.hls.levels[this.currentLevelIndex];if(!!x&&x.audioGroupIds){for(var E=-1,c=this.hls.audioTracks[h.id].groupId,u=0;u<x.audioGroupIds.length;u++)if(x.audioGroupIds[u]===c){E=u;break}E!==x.urlId&&(x.urlId=E,this.startLoad())}},a.loadPlaylist=function(f){var h=this.currentLevelIndex,x=this._levels[h];if(this.canLoad&&x&&x.url.length>0){var E=x.urlId,c=x.url[E];if(f)try{c=f.addDirectives(c)}catch(u){this.warn("Could not construct new URL with HLS Delivery Directives: "+u)}this.log("Attempt loading level index "+h+(f?" at sn "+f.msn+" part "+f.part:"")+" with URL-id "+E+" "+c),this.clearTimer(),this.hls.trigger(v.Events.LEVEL_LOADING,{url:c,level:h,id:E,deliveryDirectives:f||null})}},a.removeLevel=function(f,h){var x=function(u,o){return o!==h},E=this._levels.filter(function(c,u){return u!==f?!0:c.url.length>1&&h!==void 0?(c.url=c.url.filter(x),c.audioGroupIds&&(c.audioGroupIds=c.audioGroupIds.filter(x)),c.textGroupIds&&(c.textGroupIds=c.textGroupIds.filter(x)),c.urlId=0,!0):!1}).map(function(c,u){var o=c.details;return o!=null&&o.fragments&&o.fragments.forEach(function(d){d.level=u}),c});this._levels=E,this.hls.trigger(v.Events.LEVELS_UPDATED,{levels:E})},D(n,[{key:"levels",get:function(){return this._levels.length===0?null:this._levels}},{key:"level",get:function(){return this.currentLevelIndex},set:function(f){var h,x=this._levels;if(x.length!==0&&!(this.currentLevelIndex===f&&(h=x[f])!==null&&h!==void 0&&h.details)){if(f<0||f>=x.length){var E=f<0;if(this.hls.trigger(v.Events.ERROR,{type:l.ErrorTypes.OTHER_ERROR,details:l.ErrorDetails.LEVEL_SWITCH_ERROR,level:f,fatal:E,reason:"invalid level idx"}),E)return;f=Math.min(f,x.length-1)}this.clearTimer();var c=this.currentLevelIndex,u=x[c],o=x[f];this.log("switching to level "+f+" from "+c),this.currentLevelIndex=f;var d=m({},o,{level:f,maxBitrate:o.maxBitrate,uri:o.uri,urlId:o.urlId});delete d._urlId,this.hls.trigger(v.Events.LEVEL_SWITCHING,d);var T=o.details;if(!T||T.live){var y=this.switchParams(o.uri,u==null?void 0:u.details);this.loadPlaylist(y)}}}},{key:"manualLevel",get:function(){return this.manualLevelIndex},set:function(f){this.manualLevelIndex=f,this._startLevel===void 0&&(this._startLevel=f),f!==-1&&(this.level=f)}},{key:"firstLevel",get:function(){return this._firstLevel},set:function(f){this._firstLevel=f}},{key:"startLevel",get:function(){if(this._startLevel===void 0){var f=this.hls.config.startLevel;return f!==void 0?f:this._firstLevel}else return this._startLevel},set:function(f){this._startLevel=f}},{key:"nextLoadLevel",get:function(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel},set:function(f){this.level=f,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=f)}}]),n}(C.default)},"./src/controller/level-helper.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"addGroupId",function(){return l}),t.d(e,"assignTrackIdsByGroup",function(){return P}),t.d(e,"updatePTS",function(){return b}),t.d(e,"updateFragPTSDTS",function(){return L}),t.d(e,"mergeDetails",function(){return m}),t.d(e,"mapPartIntersection",function(){return A}),t.d(e,"mapFragmentIntersection",function(){return D}),t.d(e,"adjustSliding",function(){return S}),t.d(e,"addSliding",function(){return O}),t.d(e,"computeReloadInterval",function(){return I}),t.d(e,"getFragmentWithSN",function(){return s}),t.d(e,"getPartWith",function(){return r});var g=t("./src/polyfills/number.ts"),v=t("./src/utils/logger.ts");function l(n,a,p){switch(a){case"audio":n.audioGroupIds||(n.audioGroupIds=[]),n.audioGroupIds.push(p);break;case"text":n.textGroupIds||(n.textGroupIds=[]),n.textGroupIds.push(p);break}}function P(n){var a={};n.forEach(function(p){var f=p.groupId||"";p.id=a[f]=a[f]||0,a[f]++})}function b(n,a,p){var f=n[a],h=n[p];C(f,h)}function C(n,a){var p=a.startPTS;if(Object(g.isFiniteNumber)(p)){var f=0,h;a.sn>n.sn?(f=p-n.start,h=n):(f=n.start-p,h=a),h.duration!==f&&(h.duration=f)}else if(a.sn>n.sn){var x=n.cc===a.cc;x&&n.minEndPTS?a.start=n.start+(n.minEndPTS-n.start):a.start=n.start+n.duration}else a.start=Math.max(n.start-a.duration,0)}function L(n,a,p,f,h,x){var E=f-p;E<=0&&(v.logger.warn("Fragment should have a positive duration",a),f=p+a.duration,x=h+a.duration);var c=p,u=f,o=a.startPTS,d=a.endPTS;if(Object(g.isFiniteNumber)(o)){var T=Math.abs(o-p);Object(g.isFiniteNumber)(a.deltaPTS)?a.deltaPTS=Math.max(T,a.deltaPTS):a.deltaPTS=T,c=Math.max(p,o),p=Math.min(p,o),h=Math.min(h,a.startDTS),u=Math.min(f,d),f=Math.max(f,d),x=Math.max(x,a.endDTS)}a.duration=f-p;var y=p-a.start;a.appendedPTS=f,a.start=a.startPTS=p,a.maxStartPTS=c,a.startDTS=h,a.endPTS=f,a.minEndPTS=u,a.endDTS=x;var R=a.sn;if(!n||R<n.startSN||R>n.endSN)return 0;var M,_=R-n.startSN,F=n.fragments;for(F[_]=a,M=_;M>0;M--)C(F[M],F[M-1]);for(M=_;M<F.length-1;M++)C(F[M],F[M+1]);return n.fragmentHint&&C(F[F.length-1],n.fragmentHint),n.PTSKnown=n.alignedSliding=!0,y}function m(n,a){for(var p=null,f=n.fragments,h=f.length-1;h>=0;h--){var x=f[h].initSegment;if(x){p=x;break}}n.fragmentHint&&delete n.fragmentHint.endPTS;var E=0,c;if(D(n,a,function(R,M){var _;R.relurl&&(E=R.cc-M.cc),Object(g.isFiniteNumber)(R.startPTS)&&Object(g.isFiniteNumber)(R.endPTS)&&(M.start=M.startPTS=R.startPTS,M.startDTS=R.startDTS,M.appendedPTS=R.appendedPTS,M.maxStartPTS=R.maxStartPTS,M.endPTS=R.endPTS,M.endDTS=R.endDTS,M.minEndPTS=R.minEndPTS,M.duration=R.endPTS-R.startPTS,M.duration&&(c=M),a.PTSKnown=a.alignedSliding=!0),M.elementaryStreams=R.elementaryStreams,M.loader=R.loader,M.stats=R.stats,M.urlId=R.urlId,R.initSegment?(M.initSegment=R.initSegment,p=R.initSegment):(!M.initSegment||M.initSegment.relurl==((_=p)===null||_===void 0?void 0:_.relurl))&&(M.initSegment=p)}),a.skippedSegments&&(a.deltaUpdateFailed=a.fragments.some(function(R){return!R}),a.deltaUpdateFailed)){v.logger.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var u=a.skippedSegments;u--;)a.fragments.shift();a.startSN=a.fragments[0].sn,a.startCC=a.fragments[0].cc}var o=a.fragments;if(E){v.logger.warn("discontinuity sliding from playlist, take drift into account");for(var d=0;d<o.length;d++)o[d].cc+=E}a.skippedSegments&&(a.startCC=a.fragments[0].cc),A(n.partList,a.partList,function(R,M){M.elementaryStreams=R.elementaryStreams,M.stats=R.stats}),c?L(a,c,c.startPTS,c.endPTS,c.startDTS,c.endDTS):S(n,a),o.length&&(a.totalduration=a.edge-o[0].start),a.driftStartTime=n.driftStartTime,a.driftStart=n.driftStart;var T=a.advancedDateTime;if(a.advanced&&T){var y=a.edge;a.driftStart||(a.driftStartTime=T,a.driftStart=y),a.driftEndTime=T,a.driftEnd=y}else a.driftEndTime=n.driftEndTime,a.driftEnd=n.driftEnd,a.advancedDateTime=n.advancedDateTime}function A(n,a,p){if(n&&a)for(var f=0,h=0,x=n.length;h<=x;h++){var E=n[h],c=a[h+f];E&&c&&E.index===c.index&&E.fragment.sn===c.fragment.sn?p(E,c):f--}}function D(n,a,p){for(var f=a.skippedSegments,h=Math.max(n.startSN,a.startSN)-a.startSN,x=(n.fragmentHint?1:0)+(f?a.endSN:Math.min(n.endSN,a.endSN))-a.startSN,E=a.startSN-n.startSN,c=a.fragmentHint?a.fragments.concat(a.fragmentHint):a.fragments,u=n.fragmentHint?n.fragments.concat(n.fragmentHint):n.fragments,o=h;o<=x;o++){var d=u[E+o],T=c[o];f&&!T&&o<f&&(T=a.fragments[o]=d),d&&T&&p(d,T)}}function S(n,a){var p=a.startSN+a.skippedSegments-n.startSN,f=n.fragments;p<0||p>=f.length||O(a,f[p].start)}function O(n,a){if(a){for(var p=n.fragments,f=n.skippedSegments;f<p.length;f++)p[f].start+=a;n.fragmentHint&&(n.fragmentHint.start+=a)}}function I(n,a){var p=1e3*n.levelTargetDuration,f=p/2,h=n.age,x=h>0&&h<p*3,E=a.loading.end-a.loading.start,c,u=n.availabilityDelay;if(n.updated===!1)if(x){var o=333*n.misses;c=Math.max(Math.min(f,E*2),o),n.availabilityDelay=(n.availabilityDelay||0)+c}else c=f;else x?(u=Math.min(u||p/2,h),n.availabilityDelay=u,c=u+p-h):c=p-E;return Math.round(c)}function s(n,a,p){if(!n||!n.details)return null;var f=n.details,h=f.fragments[a-f.startSN];return h||(h=f.fragmentHint,h&&h.sn===a)?h:a<f.startSN&&p&&p.sn===a?p:null}function r(n,a,p){if(!n||!n.details)return null;var f=n.details.partList;if(f)for(var h=f.length;h--;){var x=f[h];if(x.index===p&&x.fragment.sn===a)return x}return null}},"./src/controller/stream-controller.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return f});var g=t("./src/polyfills/number.ts"),v=t("./src/controller/base-stream-controller.ts"),l=t("./src/is-supported.ts"),P=t("./src/events.ts"),b=t("./src/utils/buffer-helper.ts"),C=t("./src/controller/fragment-tracker.ts"),L=t("./src/types/loader.ts"),m=t("./src/loader/fragment.ts"),A=t("./src/demux/transmuxer-interface.ts"),D=t("./src/types/transmuxer.ts"),S=t("./src/controller/gap-controller.ts"),O=t("./src/errors.ts"),I=t("./src/utils/logger.ts");function s(h,x){for(var E=0;E<x.length;E++){var c=x[E];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(h,c.key,c)}}function r(h,x,E){return x&&s(h.prototype,x),E&&s(h,E),h}function n(h,x){h.prototype=Object.create(x.prototype),h.prototype.constructor=h,a(h,x)}function a(h,x){return a=Object.setPrototypeOf||function(c,u){return c.__proto__=u,c},a(h,x)}var p=100,f=function(h){n(x,h);function x(c,u){var o;return o=h.call(this,c,u,"[stream-controller]")||this,o.audioCodecSwap=!1,o.gapController=null,o.level=-1,o._forceStartLoad=!1,o.altAudio=!1,o.audioOnly=!1,o.fragPlaying=null,o.onvplaying=null,o.onvseeked=null,o.fragLastKbps=0,o.stalled=!1,o.couldBacktrack=!1,o.audioCodecSwitch=!1,o.videoBuffer=null,o._registerListeners(),o}var E=x.prototype;return E._registerListeners=function(){var u=this.hls;u.on(P.Events.MEDIA_ATTACHED,this.onMediaAttached,this),u.on(P.Events.MEDIA_DETACHING,this.onMediaDetaching,this),u.on(P.Events.MANIFEST_LOADING,this.onManifestLoading,this),u.on(P.Events.MANIFEST_PARSED,this.onManifestParsed,this),u.on(P.Events.LEVEL_LOADING,this.onLevelLoading,this),u.on(P.Events.LEVEL_LOADED,this.onLevelLoaded,this),u.on(P.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),u.on(P.Events.ERROR,this.onError,this),u.on(P.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),u.on(P.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),u.on(P.Events.BUFFER_CREATED,this.onBufferCreated,this),u.on(P.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),u.on(P.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),u.on(P.Events.FRAG_BUFFERED,this.onFragBuffered,this)},E._unregisterListeners=function(){var u=this.hls;u.off(P.Events.MEDIA_ATTACHED,this.onMediaAttached,this),u.off(P.Events.MEDIA_DETACHING,this.onMediaDetaching,this),u.off(P.Events.MANIFEST_LOADING,this.onManifestLoading,this),u.off(P.Events.MANIFEST_PARSED,this.onManifestParsed,this),u.off(P.Events.LEVEL_LOADED,this.onLevelLoaded,this),u.off(P.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),u.off(P.Events.ERROR,this.onError,this),u.off(P.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),u.off(P.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),u.off(P.Events.BUFFER_CREATED,this.onBufferCreated,this),u.off(P.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),u.off(P.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),u.off(P.Events.FRAG_BUFFERED,this.onFragBuffered,this)},E.onHandlerDestroying=function(){this._unregisterListeners(),this.onMediaDetaching()},E.startLoad=function(u){if(this.levels){var o=this.lastCurrentTime,d=this.hls;if(this.stopLoad(),this.setInterval(p),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var T=d.startLevel;T===-1&&(d.config.testBandwidth?(T=0,this.bitrateTest=!0):T=d.nextAutoLevel),this.level=d.nextLoadLevel=T,this.loadedmetadata=!1}o>0&&u===-1&&(this.log("Override startPosition with lastCurrentTime @"+o.toFixed(3)),u=o),this.state=v.State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=u,this.tick()}else this._forceStartLoad=!0,this.state=v.State.STOPPED},E.stopLoad=function(){this._forceStartLoad=!1,h.prototype.stopLoad.call(this)},E.doTick=function(){switch(this.state){case v.State.IDLE:this.doTickIdle();break;case v.State.WAITING_LEVEL:{var u,o=this.levels,d=this.level,T=o==null||(u=o[d])===null||u===void 0?void 0:u.details;if(T&&(!T.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(T))break;this.state=v.State.IDLE;break}break}case v.State.FRAG_LOADING_WAITING_RETRY:{var y,R=self.performance.now(),M=this.retryDate;(!M||R>=M||(y=this.media)!==null&&y!==void 0&&y.seeking)&&(this.log("retryDate reached, switch back to IDLE state"),this.state=v.State.IDLE)}break;default:break}this.onTickEnd()},E.onTickEnd=function(){h.prototype.onTickEnd.call(this),this.checkBuffer(),this.checkFragmentChanged()},E.doTickIdle=function(){var u,o,d=this.hls,T=this.levelLastLoaded,y=this.levels,R=this.media,M=d.config,_=d.nextLoadLevel;if(!(T===null||!R&&(this.startFragRequested||!M.startFragPrefetch))&&!(this.altAudio&&this.audioOnly)&&!(!y||!y[_])){var F=y[_];this.level=d.nextLoadLevel=_;var B=F.details;if(!B||this.state===v.State.WAITING_LEVEL||B.live&&this.levelLastLoaded!==_){this.state=v.State.WAITING_LEVEL;return}var w=this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:R,L.PlaylistLevelType.MAIN);if(w!==null){var k=w.len,U=this.getMaxBufferLength(F.maxBitrate);if(!(k>=U)){if(this._streamEnded(w,B)){var N={};this.altAudio&&(N.type="video"),this.hls.trigger(P.Events.BUFFER_EOS,N),this.state=v.State.ENDED;return}var W=w.end,K=this.getNextFragment(W,B);if(this.couldBacktrack&&!this.fragPrevious&&K&&K.sn!=="initSegment"){var H=K.sn-B.startSN;H>1&&(K=B.fragments[H-1],this.fragmentTracker.removeFragment(K))}if(K&&this.fragmentTracker.getState(K)===C.FragmentState.OK&&this.nextLoadPosition>W){var G=this.audioOnly&&!this.altAudio?m.ElementaryStreamTypes.AUDIO:m.ElementaryStreamTypes.VIDEO;this.afterBufferFlushed(R,G,L.PlaylistLevelType.MAIN),K=this.getNextFragment(this.nextLoadPosition,B)}!K||(K.initSegment&&!K.initSegment.data&&!this.bitrateTest&&(K=K.initSegment),((u=K.decryptdata)===null||u===void 0?void 0:u.keyFormat)==="identity"&&!((o=K.decryptdata)!==null&&o!==void 0&&o.key)?this.loadKey(K,B):this.loadFragment(K,B,W))}}}},E.loadFragment=function(u,o,d){var T,y=this.fragmentTracker.getState(u);if(this.fragCurrent=u,y===C.FragmentState.BACKTRACKED){var R=this.fragmentTracker.getBacktrackData(u);if(R){this._handleFragmentLoadProgress(R),this._handleFragmentLoadComplete(R);return}else y=C.FragmentState.NOT_LOADED}y===C.FragmentState.NOT_LOADED||y===C.FragmentState.PARTIAL?u.sn==="initSegment"?this._loadInitSegment(u):this.bitrateTest?(u.bitrateTest=!0,this.log("Fragment "+u.sn+" of level "+u.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(u)):(this.startFragRequested=!0,h.prototype.loadFragment.call(this,u,o,d)):y===C.FragmentState.APPENDING?this.reduceMaxBufferLength(u.duration)&&this.fragmentTracker.removeFragment(u):((T=this.media)===null||T===void 0?void 0:T.buffered.length)===0&&this.fragmentTracker.removeAllFragments()},E.getAppendedFrag=function(u){var o=this.fragmentTracker.getAppendedFrag(u,L.PlaylistLevelType.MAIN);return o&&"fragment"in o?o.fragment:o},E.getBufferedFrag=function(u){return this.fragmentTracker.getBufferedFrag(u,L.PlaylistLevelType.MAIN)},E.followingBufferedFrag=function(u){return u?this.getBufferedFrag(u.end+.5):null},E.immediateLevelSwitch=function(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},E.nextLevelSwitch=function(){var u=this.levels,o=this.media;if(o!=null&&o.readyState){var d,T=this.getAppendedFrag(o.currentTime);if(T&&T.start>1&&this.flushMainBuffer(0,T.start-1),!o.paused&&u){var y=this.hls.nextLoadLevel,R=u[y],M=this.fragLastKbps;M&&this.fragCurrent?d=this.fragCurrent.duration*R.maxBitrate/(1e3*M)+1:d=0}else d=0;var _=this.getBufferedFrag(o.currentTime+d);if(_){var F=this.followingBufferedFrag(_);if(F){this.abortCurrentFrag();var B=F.maxStartPTS?F.maxStartPTS:F.start,w=F.duration,k=Math.max(_.end,B+Math.min(Math.max(w-this.config.maxFragLookUpTolerance,w*.5),w*.75));this.flushMainBuffer(k,Number.POSITIVE_INFINITY)}}}},E.abortCurrentFrag=function(){var u=this.fragCurrent;this.fragCurrent=null,u!=null&&u.loader&&u.loader.abort(),this.state===v.State.KEY_LOADING&&(this.state=v.State.IDLE),this.nextLoadPosition=this.getLoadPosition()},E.flushMainBuffer=function(u,o){h.prototype.flushMainBuffer.call(this,u,o,this.altAudio?"video":null)},E.onMediaAttached=function(u,o){h.prototype.onMediaAttached.call(this,u,o);var d=o.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),d.addEventListener("playing",this.onvplaying),d.addEventListener("seeked",this.onvseeked),this.gapController=new S.default(this.config,d,this.fragmentTracker,this.hls)},E.onMediaDetaching=function(){var u=this.media;u&&(u.removeEventListener("playing",this.onvplaying),u.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),h.prototype.onMediaDetaching.call(this)},E.onMediaPlaying=function(){this.tick()},E.onMediaSeeked=function(){var u=this.media,o=u?u.currentTime:null;Object(g.isFiniteNumber)(o)&&this.log("Media seeked to "+o.toFixed(3)),this.tick()},E.onManifestLoading=function(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(P.Events.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=this.stalled=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null},E.onManifestParsed=function(u,o){var d=!1,T=!1,y;o.levels.forEach(function(R){y=R.audioCodec,y&&(y.indexOf("mp4a.40.2")!==-1&&(d=!0),y.indexOf("mp4a.40.5")!==-1&&(T=!0))}),this.audioCodecSwitch=d&&T&&!Object(l.changeTypeSupported)(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=o.levels,this.startFragRequested=!1},E.onLevelLoading=function(u,o){var d=this.levels;if(!(!d||this.state!==v.State.IDLE)){var T=d[o.level];(!T.details||T.details.live&&this.levelLastLoaded!==o.level||this.waitForCdnTuneIn(T.details))&&(this.state=v.State.WAITING_LEVEL)}},E.onLevelLoaded=function(u,o){var d,T=this.levels,y=o.level,R=o.details,M=R.totalduration;if(!T){this.warn("Levels were reset while loading level "+y);return}this.log("Level "+y+" loaded ["+R.startSN+","+R.endSN+"], cc ["+R.startCC+", "+R.endCC+"] duration:"+M);var _=this.fragCurrent;_&&(this.state===v.State.FRAG_LOADING||this.state===v.State.FRAG_LOADING_WAITING_RETRY)&&_.level!==o.level&&_.loader&&(this.state=v.State.IDLE,_.loader.abort());var F=T[y],B=0;if(R.live||(d=F.details)!==null&&d!==void 0&&d.live){if(R.fragments[0]||(R.deltaUpdateFailed=!0),R.deltaUpdateFailed)return;B=this.alignPlaylists(R,F.details)}if(F.details=R,this.levelLastLoaded=y,this.hls.trigger(P.Events.LEVEL_UPDATED,{details:R,level:y}),this.state===v.State.WAITING_LEVEL){if(this.waitForCdnTuneIn(R))return;this.state=v.State.IDLE}this.startFragRequested?R.live&&this.synchronizeToLiveEdge(R):this.setStartPosition(R,B),this.tick()},E._handleFragmentLoadProgress=function(u){var o,d=u.frag,T=u.part,y=u.payload,R=this.levels;if(!R){this.warn("Levels were reset while fragment load was in progress. Fragment "+d.sn+" of level "+d.level+" will not be buffered");return}var M=R[d.level],_=M.details;if(!_){this.warn("Dropping fragment "+d.sn+" of level "+d.level+" after level details were reset");return}var F=M.videoCodec,B=_.PTSKnown||!_.live,w=(o=d.initSegment)===null||o===void 0?void 0:o.data,k=this._getAudioCodec(M),U=this.transmuxer=this.transmuxer||new A.default(this.hls,L.PlaylistLevelType.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),N=T?T.index:-1,W=N!==-1,K=new D.ChunkMetadata(d.level,d.sn,d.stats.chunkCount,y.byteLength,N,W),H=this.initPTS[d.cc];U.push(y,w,k,F,d,T,_.totalduration,B,K,H)},E.onAudioTrackSwitching=function(u,o){var d=this.altAudio,T=!!o.url,y=o.id;if(!T){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var R=this.fragCurrent;R!=null&&R.loader&&(this.log("Switching to main audio track, cancel main fragment load"),R.loader.abort()),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var M=this.hls;d&&M.trigger(P.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),M.trigger(P.Events.AUDIO_TRACK_SWITCHED,{id:y})}},E.onAudioTrackSwitched=function(u,o){var d=o.id,T=!!this.hls.audioTracks[d].url;if(T){var y=this.videoBuffer;y&&this.mediaBuffer!==y&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=y)}this.altAudio=T,this.tick()},E.onBufferCreated=function(u,o){var d=o.tracks,T,y,R=!1;for(var M in d){var _=d[M];if(_.id==="main"){if(y=M,T=_,M==="video"){var F=d[M];F&&(this.videoBuffer=F.buffer)}}else R=!0}R&&T?(this.log("Alternate track found, use "+y+".buffered to schedule main fragment loading"),this.mediaBuffer=T.buffer):this.mediaBuffer=this.media},E.onFragBuffered=function(u,o){var d=o.frag,T=o.part;if(!(d&&d.type!==L.PlaylistLevelType.MAIN)){if(this.fragContextChanged(d)){this.warn("Fragment "+d.sn+(T?" p: "+T.index:"")+" of level "+d.level+" finished buffering, but was aborted. state: "+this.state),this.state===v.State.PARSED&&(this.state=v.State.IDLE);return}var y=T?T.stats:d.stats;this.fragLastKbps=Math.round(8*y.total/(y.buffering.end-y.loading.first)),d.sn!=="initSegment"&&(this.fragPrevious=d),this.fragBufferedComplete(d,T)}},E.onError=function(u,o){switch(o.details){case O.ErrorDetails.FRAG_LOAD_ERROR:case O.ErrorDetails.FRAG_LOAD_TIMEOUT:case O.ErrorDetails.KEY_LOAD_ERROR:case O.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(L.PlaylistLevelType.MAIN,o);break;case O.ErrorDetails.LEVEL_LOAD_ERROR:case O.ErrorDetails.LEVEL_LOAD_TIMEOUT:this.state!==v.State.ERROR&&(o.fatal?(this.warn(""+o.details),this.state=v.State.ERROR):!o.levelRetry&&this.state===v.State.WAITING_LEVEL&&(this.state=v.State.IDLE));break;case O.ErrorDetails.BUFFER_FULL_ERROR:if(o.parent==="main"&&(this.state===v.State.PARSING||this.state===v.State.PARSED)){var d=!0,T=this.getFwdBufferInfo(this.media,L.PlaylistLevelType.MAIN);T&&T.len>.5&&(d=!this.reduceMaxBufferLength(T.len)),d&&(this.warn("buffer full error also media.currentTime is not buffered, flush main"),this.immediateLevelSwitch()),this.resetLoadingState()}break;default:break}},E.checkBuffer=function(){var u=this.media,o=this.gapController;if(!(!u||!o||!u.readyState)){var d=b.BufferHelper.getBuffered(u);!this.loadedmetadata&&d.length?(this.loadedmetadata=!0,this.seekToStartPos()):o.poll(this.lastCurrentTime),this.lastCurrentTime=u.currentTime}},E.onFragLoadEmergencyAborted=function(){this.state=v.State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()},E.onBufferFlushed=function(u,o){var d=o.type;if(d!==m.ElementaryStreamTypes.AUDIO||this.audioOnly&&!this.altAudio){var T=(d===m.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(T,d,L.PlaylistLevelType.MAIN)}},E.onLevelsUpdated=function(u,o){this.levels=o.levels},E.swapAudioCodec=function(){this.audioCodecSwap=!this.audioCodecSwap},E.seekToStartPos=function(){var u=this.media,o=u.currentTime,d=this.startPosition;if(d>=0&&o<d){if(u.seeking){I.logger.log("could not seek to "+d+", already seeking at "+o);return}var T=b.BufferHelper.getBuffered(u),y=T.length?T.start(0):0,R=y-d;R>0&&(R<this.config.maxBufferHole||R<this.config.maxFragLookUpTolerance)&&(I.logger.log("adjusting start position by "+R+" to match buffer start"),d+=R,this.startPosition=d),this.log("seek to target start position "+d+" from current time "+o),u.currentTime=d}},E._getAudioCodec=function(u){var o=this.config.defaultAudioCodec||u.audioCodec;return this.audioCodecSwap&&o&&(this.log("Swapping audio codec"),o.indexOf("mp4a.40.5")!==-1?o="mp4a.40.2":o="mp4a.40.5"),o},E._loadBitrateTestFrag=function(u){var o=this;this._doFragLoad(u).then(function(d){var T=o.hls;if(!(!d||T.nextLoadLevel||o.fragContextChanged(u))){o.fragLoadError=0,o.state=v.State.IDLE,o.startFragRequested=!1,o.bitrateTest=!1;var y=u.stats;y.parsing.start=y.parsing.end=y.buffering.start=y.buffering.end=self.performance.now(),T.trigger(P.Events.FRAG_LOADED,d)}})},E._handleTransmuxComplete=function(u){var o,d="main",T=this.hls,y=u.remuxResult,R=u.chunkMeta,M=this.getCurrentContext(R);if(!M){this.warn("The loading context changed while buffering fragment "+R.sn+" of level "+R.level+". This chunk will not be buffered."),this.resetLiveStartWhenNotLoaded(R.level);return}var _=M.frag,F=M.part,B=M.level,w=y.video,k=y.text,U=y.id3,N=y.initSegment,W=this.altAudio?void 0:y.audio;if(!this.fragContextChanged(_)){if(this.state=v.State.PARSING,N){N.tracks&&(this._bufferInitSegment(B,N.tracks,_,R),T.trigger(P.Events.FRAG_PARSING_INIT_SEGMENT,{frag:_,id:d,tracks:N.tracks}));var K=N.initPTS,H=N.timescale;Object(g.isFiniteNumber)(K)&&(this.initPTS[_.cc]=K,T.trigger(P.Events.INIT_PTS_FOUND,{frag:_,id:d,initPTS:K,timescale:H}))}if(w&&y.independent!==!1){if(B.details){var G=w.startPTS,V=w.endPTS,X=w.startDTS,z=w.endDTS;if(F)F.elementaryStreams[w.type]={startPTS:G,endPTS:V,startDTS:X,endDTS:z};else if(w.firstKeyFrame&&w.independent&&(this.couldBacktrack=!0),w.dropped&&w.independent){var $=this.getLoadPosition()+this.config.maxBufferHole;if($<G){this.backtrack(_);return}_.setElementaryStreamInfo(w.type,_.start,V,_.start,z,!0)}_.setElementaryStreamInfo(w.type,G,V,X,z),this.bufferFragmentData(w,_,F,R)}}else if(y.independent===!1){this.backtrack(_);return}if(W){var Y=W.startPTS,Q=W.endPTS,ie=W.startDTS,Z=W.endDTS;F&&(F.elementaryStreams[m.ElementaryStreamTypes.AUDIO]={startPTS:Y,endPTS:Q,startDTS:ie,endDTS:Z}),_.setElementaryStreamInfo(m.ElementaryStreamTypes.AUDIO,Y,Q,ie,Z),this.bufferFragmentData(W,_,F,R)}if(U!=null&&(o=U.samples)!==null&&o!==void 0&&o.length){var ae={frag:_,id:d,samples:U.samples};T.trigger(P.Events.FRAG_PARSING_METADATA,ae)}if(k){var q={frag:_,id:d,samples:k.samples};T.trigger(P.Events.FRAG_PARSING_USERDATA,q)}}},E._bufferInitSegment=function(u,o,d,T){var y=this;if(this.state===v.State.PARSING){this.audioOnly=!!o.audio&&!o.video,this.altAudio&&!this.audioOnly&&delete o.audio;var R=o.audio,M=o.video,_=o.audiovideo;if(R){var F=u.audioCodec,B=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(F&&(F.indexOf("mp4a.40.5")!==-1?F="mp4a.40.2":F="mp4a.40.5"),R.metadata.channelCount!==1&&B.indexOf("firefox")===-1&&(F="mp4a.40.5")),B.indexOf("android")!==-1&&R.container!=="audio/mpeg"&&(F="mp4a.40.2",this.log("Android: force audio codec to "+F)),u.audioCodec&&u.audioCodec!==F&&this.log('Swapping manifest audio codec "'+u.audioCodec+'" for "'+F+'"'),R.levelCodec=F,R.id="main",this.log("Init audio buffer, container:"+R.container+", codecs[selected/level/parsed]=["+(F||"")+"/"+(u.audioCodec||"")+"/"+R.codec+"]")}M&&(M.levelCodec=u.videoCodec,M.id="main",this.log("Init video buffer, container:"+M.container+", codecs[level/parsed]=["+(u.videoCodec||"")+"/"+M.codec+"]")),_&&this.log("Init audiovideo buffer, container:"+_.container+", codecs[level/parsed]=["+(u.attrs.CODECS||"")+"/"+_.codec+"]"),this.hls.trigger(P.Events.BUFFER_CODECS,o),Object.keys(o).forEach(function(w){var k=o[w],U=k.initSegment;U!=null&&U.byteLength&&y.hls.trigger(P.Events.BUFFER_APPENDING,{type:w,data:U,frag:d,part:null,chunkMeta:T,parent:d.type})}),this.tick()}},E.backtrack=function(u){this.couldBacktrack=!0,this.resetTransmuxer(),this.flushBufferGap(u);var o=this.fragmentTracker.backtrack(u);this.fragPrevious=null,this.nextLoadPosition=u.start,o?this.resetFragmentLoading(u):this.state=v.State.BACKTRACKING},E.checkFragmentChanged=function(){var u=this.media,o=null;if(u&&u.readyState>1&&u.seeking===!1){var d=u.currentTime;if(b.BufferHelper.isBuffered(u,d)?o=this.getAppendedFrag(d):b.BufferHelper.isBuffered(u,d+.1)&&(o=this.getAppendedFrag(d+.1)),o){var T=this.fragPlaying,y=o.level;(!T||o.sn!==T.sn||T.level!==y||o.urlId!==T.urlId)&&(this.hls.trigger(P.Events.FRAG_CHANGED,{frag:o}),(!T||T.level!==y)&&this.hls.trigger(P.Events.LEVEL_SWITCHED,{level:y}),this.fragPlaying=o)}}},r(x,[{key:"nextLevel",get:function(){var u=this.nextBufferedFrag;return u?u.level:-1}},{key:"currentLevel",get:function(){var u=this.media;if(u){var o=this.getAppendedFrag(u.currentTime);if(o)return o.level}return-1}},{key:"nextBufferedFrag",get:function(){var u=this.media;if(u){var o=this.getAppendedFrag(u.currentTime);return this.followingBufferedFrag(o)}else return null}},{key:"forceStartLoad",get:function(){return this._forceStartLoad}}]),x}(v.default)},"./src/controller/subtitle-stream-controller.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"SubtitleStreamController",function(){return n});var g=t("./src/events.ts"),v=t("./src/utils/logger.ts"),l=t("./src/utils/buffer-helper.ts"),P=t("./src/controller/fragment-finders.ts"),b=t("./src/utils/discontinuities.ts"),C=t("./src/controller/level-helper.ts"),L=t("./src/controller/fragment-tracker.ts"),m=t("./src/controller/base-stream-controller.ts"),A=t("./src/types/loader.ts"),D=t("./src/types/level.ts");function S(a,p){for(var f=0;f<p.length;f++){var h=p[f];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(a,h.key,h)}}function O(a,p,f){return p&&S(a.prototype,p),f&&S(a,f),a}function I(a,p){a.prototype=Object.create(p.prototype),a.prototype.constructor=a,s(a,p)}function s(a,p){return s=Object.setPrototypeOf||function(h,x){return h.__proto__=x,h},s(a,p)}var r=500,n=function(a){I(p,a);function p(h,x){var E;return E=a.call(this,h,x,"[subtitle-stream-controller]")||this,E.levels=[],E.currentTrackId=-1,E.tracksBuffered=[],E.mainDetails=null,E._registerListeners(),E}var f=p.prototype;return f.onHandlerDestroying=function(){this._unregisterListeners(),this.mainDetails=null},f._registerListeners=function(){var x=this.hls;x.on(g.Events.MEDIA_ATTACHED,this.onMediaAttached,this),x.on(g.Events.MEDIA_DETACHING,this.onMediaDetaching,this),x.on(g.Events.MANIFEST_LOADING,this.onManifestLoading,this),x.on(g.Events.LEVEL_LOADED,this.onLevelLoaded,this),x.on(g.Events.ERROR,this.onError,this),x.on(g.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),x.on(g.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),x.on(g.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),x.on(g.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),x.on(g.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},f._unregisterListeners=function(){var x=this.hls;x.off(g.Events.MEDIA_ATTACHED,this.onMediaAttached,this),x.off(g.Events.MEDIA_DETACHING,this.onMediaDetaching,this),x.off(g.Events.MANIFEST_LOADING,this.onManifestLoading,this),x.off(g.Events.LEVEL_LOADED,this.onLevelLoaded,this),x.off(g.Events.ERROR,this.onError,this),x.off(g.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),x.off(g.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),x.off(g.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),x.off(g.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),x.off(g.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)},f.startLoad=function(){this.stopLoad(),this.state=m.State.IDLE,this.setInterval(r),this.tick()},f.onManifestLoading=function(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()},f.onLevelLoaded=function(x,E){this.mainDetails=E.details},f.onSubtitleFragProcessed=function(x,E){var c=E.frag,u=E.success;if(this.fragPrevious=c,this.state=m.State.IDLE,!!u){var o=this.tracksBuffered[this.currentTrackId];if(!!o){for(var d,T=c.start,y=0;y<o.length;y++)if(T>=o[y].start&&T<=o[y].end){d=o[y];break}var R=c.start+c.duration;d?d.end=R:(d={start:T,end:R},o.push(d)),this.fragmentTracker.fragBuffered(c)}}},f.onBufferFlushing=function(x,E){var c=E.startOffset,u=E.endOffset;if(c===0&&u!==Number.POSITIVE_INFINITY){var o=this.currentTrackId,d=this.levels;if(!d.length||!d[o]||!d[o].details)return;var T=d[o].details,y=T.targetduration,R=u-y;if(R<=0)return;E.endOffsetSubtitles=Math.max(0,R),this.tracksBuffered.forEach(function(M){for(var _=0;_<M.length;){if(M[_].end<=R){M.shift();continue}else if(M[_].start<R)M[_].start=R;else break;_++}}),this.fragmentTracker.removeFragmentsInRange(c,R,A.PlaylistLevelType.SUBTITLE)}},f.onError=function(x,E){var c,u=E.frag;!u||u.type!==A.PlaylistLevelType.SUBTITLE||((c=this.fragCurrent)!==null&&c!==void 0&&c.loader&&this.fragCurrent.loader.abort(),this.state=m.State.IDLE)},f.onSubtitleTracksUpdated=function(x,E){var c=this,u=E.subtitleTracks;this.tracksBuffered=[],this.levels=u.map(function(o){return new D.Level(o)}),this.fragmentTracker.removeAllFragments(),this.fragPrevious=null,this.levels.forEach(function(o){c.tracksBuffered[o.id]=[]}),this.mediaBuffer=null},f.onSubtitleTrackSwitch=function(x,E){if(this.currentTrackId=E.id,!this.levels.length||this.currentTrackId===-1){this.clearInterval();return}var c=this.levels[this.currentTrackId];c!=null&&c.details?(this.mediaBuffer=this.mediaBufferTimeRanges,this.setInterval(r)):this.mediaBuffer=null},f.onSubtitleTrackLoaded=function(x,E){var c,u=E.details,o=E.id,d=this.currentTrackId,T=this.levels;if(!!T.length){var y=T[d];if(!(o>=T.length||o!==d||!y)){if(this.mediaBuffer=this.mediaBufferTimeRanges,u.live||(c=y.details)!==null&&c!==void 0&&c.live){var R=this.mainDetails;if(u.deltaUpdateFailed||!R)return;var M=R.fragments[0];if(!y.details)u.hasProgramDateTime&&R.hasProgramDateTime?Object(b.alignMediaPlaylistByPDT)(u,R):M&&Object(C.addSliding)(u,M.start);else{var _=this.alignPlaylists(u,y.details);_===0&&M&&Object(C.addSliding)(u,M.start)}}if(y.details=u,this.levelLastLoaded=o,this.tick(),u.live&&!this.fragCurrent&&this.media&&this.state===m.State.IDLE){var F=Object(P.findFragmentByPTS)(null,u.fragments,this.media.currentTime,0);F||(this.warn("Subtitle playlist not aligned with playback"),y.details=void 0)}}}},f._handleFragmentLoadComplete=function(x){var E=x.frag,c=x.payload,u=E.decryptdata,o=this.hls;if(!this.fragContextChanged(E)&&c&&c.byteLength>0&&u&&u.key&&u.iv&&u.method==="AES-128"){var d=performance.now();this.decrypter.webCryptoDecrypt(new Uint8Array(c),u.key.buffer,u.iv.buffer).then(function(T){var y=performance.now();o.trigger(g.Events.FRAG_DECRYPTED,{frag:E,payload:T,stats:{tstart:d,tdecrypt:y}})})}},f.doTick=function(){if(!this.media){this.state=m.State.IDLE;return}if(this.state===m.State.IDLE){var x,E=this.currentTrackId,c=this.levels;if(!c.length||!c[E]||!c[E].details)return;var u=c[E].details,o=u.targetduration,d=this.config,T=this.media,y=l.BufferHelper.bufferedInfo(this.mediaBufferTimeRanges,T.currentTime-o,d.maxBufferHole),R=y.end,M=y.len,_=this.getMaxBufferLength()+o;if(M>_)return;console.assert(u,"Subtitle track details are defined on idle subtitle stream controller tick");var F=u.fragments,B=F.length,w=u.edge,k,U=this.fragPrevious;if(R<w){var N=d.maxFragLookUpTolerance;U&&u.hasProgramDateTime&&(k=Object(P.findFragmentByPDT)(F,U.endProgramDateTime,N)),k||(k=Object(P.findFragmentByPTS)(U,F,R,N),!k&&U&&U.start<F[0].start&&(k=F[0]))}else k=F[B-1];(x=k)!==null&&x!==void 0&&x.encrypted?(v.logger.log("Loading key for "+k.sn),this.state=m.State.KEY_LOADING,this.hls.trigger(g.Events.KEY_LOADING,{frag:k})):k&&this.fragmentTracker.getState(k)===L.FragmentState.NOT_LOADED&&this.loadFragment(k,u,R)}},f.loadFragment=function(x,E,c){this.fragCurrent=x,a.prototype.loadFragment.call(this,x,E,c)},O(p,[{key:"mediaBufferTimeRanges",get:function(){return this.tracksBuffered[this.currentTrackId]||[]}}]),p}(m.default)},"./src/controller/subtitle-track-controller.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/events.ts"),v=t("./src/utils/texttrack-utils.ts"),l=t("./src/controller/base-playlist-controller.ts"),P=t("./src/types/loader.ts");function b(S,O){for(var I=0;I<O.length;I++){var s=O[I];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(S,s.key,s)}}function C(S,O,I){return O&&b(S.prototype,O),I&&b(S,I),S}function L(S,O){S.prototype=Object.create(O.prototype),S.prototype.constructor=S,m(S,O)}function m(S,O){return m=Object.setPrototypeOf||function(s,r){return s.__proto__=r,s},m(S,O)}var A=function(S){L(O,S);function O(s){var r;return r=S.call(this,s,"[subtitle-track-controller]")||this,r.media=null,r.tracks=[],r.groupId=null,r.tracksInGroup=[],r.trackId=-1,r.selectDefaultTrack=!0,r.queuedDefaultTrack=-1,r.trackChangeListener=function(){return r.onTextTracksChanged()},r.asyncPollTrackChange=function(){return r.pollTrackChange(0)},r.useTextTrackPolling=!1,r.subtitlePollingInterval=-1,r.subtitleDisplay=!0,r.registerListeners(),r}var I=O.prototype;return I.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,S.prototype.destroy.call(this)},I.registerListeners=function(){var r=this.hls;r.on(g.Events.MEDIA_ATTACHED,this.onMediaAttached,this),r.on(g.Events.MEDIA_DETACHING,this.onMediaDetaching,this),r.on(g.Events.MANIFEST_LOADING,this.onManifestLoading,this),r.on(g.Events.MANIFEST_PARSED,this.onManifestParsed,this),r.on(g.Events.LEVEL_LOADING,this.onLevelLoading,this),r.on(g.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),r.on(g.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),r.on(g.Events.ERROR,this.onError,this)},I.unregisterListeners=function(){var r=this.hls;r.off(g.Events.MEDIA_ATTACHED,this.onMediaAttached,this),r.off(g.Events.MEDIA_DETACHING,this.onMediaDetaching,this),r.off(g.Events.MANIFEST_LOADING,this.onManifestLoading,this),r.off(g.Events.MANIFEST_PARSED,this.onManifestParsed,this),r.off(g.Events.LEVEL_LOADING,this.onLevelLoading,this),r.off(g.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),r.off(g.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),r.off(g.Events.ERROR,this.onError,this)},I.onMediaAttached=function(r,n){this.media=n.media,!!this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))},I.pollTrackChange=function(r){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,r)},I.onMediaDetaching=function(){if(!!this.media){self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId);var r=D(this.media.textTracks);r.forEach(function(n){Object(v.clearCurrentCues)(n)}),this.subtitleTrack=-1,this.media=null}},I.onManifestLoading=function(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0},I.onManifestParsed=function(r,n){this.tracks=n.subtitleTracks},I.onSubtitleTrackLoaded=function(r,n){var a=n.id,p=n.details,f=this.trackId,h=this.tracksInGroup[f];if(!h){this.warn("Invalid subtitle track id "+a);return}var x=h.details;h.details=n.details,this.log("subtitle track "+a+" loaded ["+p.startSN+"-"+p.endSN+"]"),a===this.trackId&&(this.retryCount=0,this.playlistLoaded(a,n,x))},I.onLevelLoading=function(r,n){this.switchLevel(n.level)},I.onLevelSwitching=function(r,n){this.switchLevel(n.level)},I.switchLevel=function(r){var n=this.hls.levels[r];if(!!(n!=null&&n.textGroupIds)){var a=n.textGroupIds[n.urlId];if(this.groupId!==a){var p=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0,f=this.tracks.filter(function(E){return!a||E.groupId===a});this.tracksInGroup=f;var h=this.findTrackId(p==null?void 0:p.name)||this.findTrackId();this.groupId=a;var x={subtitleTracks:f};this.log("Updating subtitle tracks, "+f.length+' track(s) found in "'+a+'" group-id'),this.hls.trigger(g.Events.SUBTITLE_TRACKS_UPDATED,x),h!==-1&&this.setSubtitleTrack(h,p)}}},I.findTrackId=function(r){for(var n=this.tracksInGroup,a=0;a<n.length;a++){var p=n[a];if((!this.selectDefaultTrack||p.default)&&(!r||r===p.name))return p.id}return-1},I.onError=function(r,n){S.prototype.onError.call(this,r,n),!(n.fatal||!n.context)&&n.context.type===P.PlaylistContextType.SUBTITLE_TRACK&&n.context.id===this.trackId&&n.context.groupId===this.groupId&&this.retryLoadingOrFail(n)},I.loadPlaylist=function(r){var n=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(n)){var a=n.id,p=n.groupId,f=n.url;if(r)try{f=r.addDirectives(f)}catch(h){this.warn("Could not construct new URL with HLS Delivery Directives: "+h)}this.log("Loading subtitle playlist for id "+a),this.hls.trigger(g.Events.SUBTITLE_TRACK_LOADING,{url:f,id:a,groupId:p,deliveryDirectives:r||null})}},I.toggleTrackModes=function(r){var n=this,a=this.media,p=this.subtitleDisplay,f=this.trackId;if(!!a){var h=D(a.textTracks),x=h.filter(function(u){return u.groupId===n.groupId});if(r===-1)[].slice.call(h).forEach(function(u){u.mode="disabled"});else{var E=x[f];E&&(E.mode="disabled")}var c=x[r];c&&(c.mode=p?"showing":"hidden")}},I.setSubtitleTrack=function(r,n){var a,p=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=r;return}if(this.trackId!==r&&this.toggleTrackModes(r),!(this.trackId===r&&(r===-1||(a=p[r])!==null&&a!==void 0&&a.details)||r<-1||r>=p.length)){this.clearTimer();var f=p[r];if(this.log("Switching to subtitle track "+r),this.trackId=r,f){var h=f.id,x=f.groupId,E=x===void 0?"":x,c=f.name,u=f.type,o=f.url;this.hls.trigger(g.Events.SUBTITLE_TRACK_SWITCH,{id:h,groupId:E,name:c,type:u,url:o});var d=this.switchParams(f.url,n==null?void 0:n.details);this.loadPlaylist(d)}else this.hls.trigger(g.Events.SUBTITLE_TRACK_SWITCH,{id:r})}},I.onTextTracksChanged=function(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!(!this.media||!this.hls.config.renderTextTracksNatively)){for(var r=-1,n=D(this.media.textTracks),a=0;a<n.length;a++)if(n[a].mode==="hidden")r=a;else if(n[a].mode==="showing"){r=a;break}this.subtitleTrack!==r&&(this.subtitleTrack=r)}},C(O,[{key:"subtitleTracks",get:function(){return this.tracksInGroup}},{key:"subtitleTrack",get:function(){return this.trackId},set:function(r){this.selectDefaultTrack=!1;var n=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(r,n)}}]),O}(l.default);function D(S){for(var O=[],I=0;I<S.length;I++){var s=S[I];s.kind==="subtitles"&&s.label&&O.push(S[I])}return O}e.default=A},"./src/controller/timeline-controller.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"TimelineController",function(){return D});var g=t("./src/polyfills/number.ts"),v=t("./src/events.ts"),l=t("./src/utils/cea-608-parser.ts"),P=t("./src/utils/output-filter.ts"),b=t("./src/utils/webvtt-parser.ts"),C=t("./src/utils/texttrack-utils.ts"),L=t("./src/utils/imsc1-ttml-parser.ts"),m=t("./src/types/loader.ts"),A=t("./src/utils/logger.ts"),D=function(){function s(n){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.timescale=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.prevCC=-1,this.vttCCs=I(),this.captionsProperties=void 0,this.hls=n,this.config=n.config,this.Cues=n.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){var a=new P.default(this,"textTrack1"),p=new P.default(this,"textTrack2"),f=new P.default(this,"textTrack3"),h=new P.default(this,"textTrack4");this.cea608Parser1=new l.default(1,a,p),this.cea608Parser2=new l.default(3,f,h)}n.on(v.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),n.on(v.Events.MEDIA_DETACHING,this.onMediaDetaching,this),n.on(v.Events.MANIFEST_LOADING,this.onManifestLoading,this),n.on(v.Events.MANIFEST_LOADED,this.onManifestLoaded,this),n.on(v.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),n.on(v.Events.FRAG_LOADING,this.onFragLoading,this),n.on(v.Events.FRAG_LOADED,this.onFragLoaded,this),n.on(v.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),n.on(v.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),n.on(v.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),n.on(v.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),n.on(v.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)}var r=s.prototype;return r.destroy=function(){var a=this.hls;a.off(v.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),a.off(v.Events.MEDIA_DETACHING,this.onMediaDetaching,this),a.off(v.Events.MANIFEST_LOADING,this.onManifestLoading,this),a.off(v.Events.MANIFEST_LOADED,this.onManifestLoaded,this),a.off(v.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),a.off(v.Events.FRAG_LOADING,this.onFragLoading,this),a.off(v.Events.FRAG_LOADED,this.onFragLoaded,this),a.off(v.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),a.off(v.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),a.off(v.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),a.off(v.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),a.off(v.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null},r.addCues=function(a,p,f,h,x){for(var E=!1,c=x.length;c--;){var u=x[c],o=O(u[0],u[1],p,f);if(o>=0&&(u[0]=Math.min(u[0],p),u[1]=Math.max(u[1],f),E=!0,o/(f-p)>.5))return}if(E||x.push([p,f]),this.config.renderTextTracksNatively){var d=this.captionsTracks[a];this.Cues.newCue(d,p,f,h)}else{var T=this.Cues.newCue(null,p,f,h);this.hls.trigger(v.Events.CUES_PARSED,{type:"captions",cues:T,track:a})}},r.onInitPtsFound=function(a,p){var f=this,h=p.frag,x=p.id,E=p.initPTS,c=p.timescale,u=this.unparsedVttFrags;x==="main"&&(this.initPTS[h.cc]=E,this.timescale[h.cc]=c),u.length&&(this.unparsedVttFrags=[],u.forEach(function(o){f.onFragLoaded(v.Events.FRAG_LOADED,o)}))},r.getExistingTrack=function(a){var p=this.media;if(p)for(var f=0;f<p.textTracks.length;f++){var h=p.textTracks[f];if(h[a])return h}return null},r.createCaptionsTrack=function(a){this.config.renderTextTracksNatively?this.createNativeTrack(a):this.createNonNativeTrack(a)},r.createNativeTrack=function(a){if(!this.captionsTracks[a]){var p=this.captionsProperties,f=this.captionsTracks,h=this.media,x=p[a],E=x.label,c=x.languageCode,u=this.getExistingTrack(a);if(u)f[a]=u,Object(C.clearCurrentCues)(f[a]),Object(C.sendAddTrackEvent)(f[a],h);else{var o=this.createTextTrack("captions",E,c);o&&(o[a]=!0,f[a]=o)}}},r.createNonNativeTrack=function(a){if(!this.nonNativeCaptionsTracks[a]){var p=this.captionsProperties[a];if(!!p){var f=p.label,h={_id:a,label:f,kind:"captions",default:p.media?!!p.media.default:!1,closedCaptions:p.media};this.nonNativeCaptionsTracks[a]=h,this.hls.trigger(v.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[h]})}}},r.createTextTrack=function(a,p,f){var h=this.media;if(!!h)return h.addTextTrack(a,p,f)},r.onMediaAttaching=function(a,p){this.media=p.media,this._cleanTracks()},r.onMediaDetaching=function(){var a=this.captionsTracks;Object.keys(a).forEach(function(p){Object(C.clearCurrentCues)(a[p]),delete a[p]}),this.nonNativeCaptionsTracks={}},r.onManifestLoading=function(){this.lastSn=-1,this.prevCC=-1,this.vttCCs=I(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.timescale=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())},r._cleanTracks=function(){var a=this.media;if(!!a){var p=a.textTracks;if(p)for(var f=0;f<p.length;f++)Object(C.clearCurrentCues)(p[f])}},r.onSubtitleTracksUpdated=function(a,p){var f=this;this.textTracks=[];var h=p.subtitleTracks||[],x=h.some(function(o){return o.textCodec===L.IMSC1_CODEC});if(this.config.enableWebVTT||x&&this.config.enableIMSC1){var E=this.tracks&&h&&this.tracks.length===h.length;if(this.tracks=h||[],this.config.renderTextTracksNatively){var c=this.media?this.media.textTracks:[];this.tracks.forEach(function(o,d){var T;if(d<c.length){for(var y=null,R=0;R<c.length;R++)if(S(c[R],o)){y=c[R];break}y&&(T=y)}T?Object(C.clearCurrentCues)(T):(T=f.createTextTrack("subtitles",o.name,o.lang),T&&(T.mode="disabled")),T&&(T.groupId=o.groupId,f.textTracks.push(T))})}else if(!E&&this.tracks&&this.tracks.length){var u=this.tracks.map(function(o){return{label:o.name,kind:o.type.toLowerCase(),default:o.default,subtitleTrack:o}});this.hls.trigger(v.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:u})}}},r.onManifestLoaded=function(a,p){var f=this;this.config.enableCEA708Captions&&p.captions&&p.captions.forEach(function(h){var x=/(?:CC|SERVICE)([1-4])/.exec(h.instreamId);if(!!x){var E="textTrack"+x[1],c=f.captionsProperties[E];!c||(c.label=h.name,h.lang&&(c.languageCode=h.lang),c.media=h)}})},r.onFragLoading=function(a,p){var f=this.cea608Parser1,h=this.cea608Parser2,x=this.lastSn;if(!(!this.enabled||!(f&&h))&&p.frag.type===m.PlaylistLevelType.MAIN){var E=p.frag.sn;E!==x+1&&(f.reset(),h.reset()),this.lastSn=E}},r.onFragLoaded=function(a,p){var f=p.frag,h=p.payload,x=this.initPTS,E=this.unparsedVttFrags;if(f.type===m.PlaylistLevelType.SUBTITLE)if(h.byteLength){if(!Object(g.isFiniteNumber)(x[f.cc])){E.push(p),x.length&&this.hls.trigger(v.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:f,error:new Error("Missing initial subtitle PTS")});return}var c=f.decryptdata;if(c==null||c.key==null||c.method!=="AES-128"){var u=this.tracks[f.level],o=this.vttCCs;o[f.cc]||(o[f.cc]={start:f.start,prevCC:this.prevCC,new:!0},this.prevCC=f.cc),u&&u.textCodec===L.IMSC1_CODEC?this._parseIMSC1(f,h):this._parseVTTs(f,h,o)}}else this.hls.trigger(v.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:f,error:new Error("Empty subtitle payload")})},r._parseIMSC1=function(a,p){var f=this,h=this.hls;Object(L.parseIMSC1)(p,this.initPTS[a.cc],this.timescale[a.cc],function(x){f._appendCues(x,a.level),h.trigger(v.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:a})},function(x){A.logger.log("Failed to parse IMSC1: "+x),h.trigger(v.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:a,error:x})})},r._parseVTTs=function(a,p,f){var h=this,x=this.hls;Object(b.parseWebVTT)(p,this.initPTS[a.cc],this.timescale[a.cc],f,a.cc,a.start,function(E){h._appendCues(E,a.level),x.trigger(v.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:a})},function(E){h._fallbackToIMSC1(a,p),A.logger.log("Failed to parse VTT cue: "+E),x.trigger(v.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:a,error:E})})},r._fallbackToIMSC1=function(a,p){var f=this,h=this.tracks[a.level];h.textCodec||Object(L.parseIMSC1)(p,this.initPTS[a.cc],this.timescale[a.cc],function(){h.textCodec=L.IMSC1_CODEC,f._parseIMSC1(a,p)},function(){h.textCodec="wvtt"})},r._appendCues=function(a,p){var f=this.hls;if(this.config.renderTextTracksNatively){var h=this.textTracks[p];if(h.mode==="disabled")return;a.forEach(function(c){return Object(C.addCueToTrack)(h,c)})}else{var x=this.tracks[p],E=x.default?"default":"subtitles"+p;f.trigger(v.Events.CUES_PARSED,{type:"subtitles",cues:a,track:E})}},r.onFragDecrypted=function(a,p){var f=p.frag;if(f.type===m.PlaylistLevelType.SUBTITLE){if(!Object(g.isFiniteNumber)(this.initPTS[f.cc])){this.unparsedVttFrags.push(p);return}this.onFragLoaded(v.Events.FRAG_LOADED,p)}},r.onSubtitleTracksCleared=function(){this.tracks=[],this.captionsTracks={}},r.onFragParsingUserdata=function(a,p){var f=this.cea608Parser1,h=this.cea608Parser2;if(!(!this.enabled||!(f&&h)))for(var x=0;x<p.samples.length;x++){var E=p.samples[x].bytes;if(E){var c=this.extractCea608Data(E);f.addData(p.samples[x].pts,c[0]),h.addData(p.samples[x].pts,c[1])}}},r.onBufferFlushing=function(a,p){var f=p.startOffset,h=p.endOffset,x=p.endOffsetSubtitles,E=p.type,c=this.media;if(!(!c||c.currentTime<h)){if(!E||E==="video"){var u=this.captionsTracks;Object.keys(u).forEach(function(d){return Object(C.removeCuesInRange)(u[d],f,h)})}if(this.config.renderTextTracksNatively&&f===0&&x!==void 0){var o=this.textTracks;Object.keys(o).forEach(function(d){return Object(C.removeCuesInRange)(o[d],f,x)})}}},r.extractCea608Data=function(a){for(var p=a[0]&31,f=2,h=[[],[]],x=0;x<p;x++){var E=a[f++],c=127&a[f++],u=127&a[f++],o=(4&E)!=0,d=3&E;c===0&&u===0||o&&(d===0||d===1)&&(h[d].push(c),h[d].push(u))}return h},s}();function S(s,r){return s&&s.label===r.name&&!(s.textTrack1||s.textTrack2)}function O(s,r,n,a){return Math.min(r,a)-Math.max(s,n)}function I(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!1}}}},"./src/crypt/aes-crypto.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return g});var g=function(){function v(P,b){this.subtle=void 0,this.aesIV=void 0,this.subtle=P,this.aesIV=b}var l=v.prototype;return l.decrypt=function(b,C){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},C,b)},v}()},"./src/crypt/aes-decryptor.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"removePadding",function(){return v}),t.d(e,"default",function(){return l});var g=t("./src/utils/typed-array.ts");function v(P){var b=P.byteLength,C=b&&new DataView(P.buffer).getUint8(b-1);return C?Object(g.sliceUint8)(P,0,b-C):P}var l=function(){function P(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var b=P.prototype;return b.uint8ArrayToUint32Array_=function(L){for(var m=new DataView(L),A=new Uint32Array(4),D=0;D<4;D++)A[D]=m.getUint32(D*4);return A},b.initTable=function(){var L=this.sBox,m=this.invSBox,A=this.subMix,D=A[0],S=A[1],O=A[2],I=A[3],s=this.invSubMix,r=s[0],n=s[1],a=s[2],p=s[3],f=new Uint32Array(256),h=0,x=0,E=0;for(E=0;E<256;E++)E<128?f[E]=E<<1:f[E]=E<<1^283;for(E=0;E<256;E++){var c=x^x<<1^x<<2^x<<3^x<<4;c=c>>>8^c&255^99,L[h]=c,m[c]=h;var u=f[h],o=f[u],d=f[o],T=f[c]*257^c*16843008;D[h]=T<<24|T>>>8,S[h]=T<<16|T>>>16,O[h]=T<<8|T>>>24,I[h]=T,T=d*16843009^o*65537^u*257^h*16843008,r[c]=T<<24|T>>>8,n[c]=T<<16|T>>>16,a[c]=T<<8|T>>>24,p[c]=T,h?(h=u^f[f[f[d^u]]],x^=f[f[x]]):h=x=1}},b.expandKey=function(L){for(var m=this.uint8ArrayToUint32Array_(L),A=!0,D=0;D<m.length&&A;)A=m[D]===this.key[D],D++;if(!A){this.key=m;var S=this.keySize=m.length;if(S!==4&&S!==6&&S!==8)throw new Error("Invalid aes key size="+S);var O=this.ksRows=(S+6+1)*4,I,s,r=this.keySchedule=new Uint32Array(O),n=this.invKeySchedule=new Uint32Array(O),a=this.sBox,p=this.rcon,f=this.invSubMix,h=f[0],x=f[1],E=f[2],c=f[3],u,o;for(I=0;I<O;I++){if(I<S){u=r[I]=m[I];continue}o=u,I%S==0?(o=o<<8|o>>>24,o=a[o>>>24]<<24|a[o>>>16&255]<<16|a[o>>>8&255]<<8|a[o&255],o^=p[I/S|0]<<24):S>6&&I%S==4&&(o=a[o>>>24]<<24|a[o>>>16&255]<<16|a[o>>>8&255]<<8|a[o&255]),r[I]=u=(r[I-S]^o)>>>0}for(s=0;s<O;s++)I=O-s,s&3?o=r[I]:o=r[I-4],s<4||I<=4?n[s]=o:n[s]=h[a[o>>>24]]^x[a[o>>>16&255]]^E[a[o>>>8&255]]^c[a[o&255]],n[s]=n[s]>>>0}},b.networkToHostOrderSwap=function(L){return L<<24|(L&65280)<<8|(L&16711680)>>8|L>>>24},b.decrypt=function(L,m,A){for(var D=this.keySize+6,S=this.invKeySchedule,O=this.invSBox,I=this.invSubMix,s=I[0],r=I[1],n=I[2],a=I[3],p=this.uint8ArrayToUint32Array_(A),f=p[0],h=p[1],x=p[2],E=p[3],c=new Int32Array(L),u=new Int32Array(c.length),o,d,T,y,R,M,_,F,B,w,k,U,N,W,K=this.networkToHostOrderSwap;m<c.length;){for(B=K(c[m]),w=K(c[m+1]),k=K(c[m+2]),U=K(c[m+3]),R=B^S[0],M=U^S[1],_=k^S[2],F=w^S[3],N=4,W=1;W<D;W++)o=s[R>>>24]^r[M>>16&255]^n[_>>8&255]^a[F&255]^S[N],d=s[M>>>24]^r[_>>16&255]^n[F>>8&255]^a[R&255]^S[N+1],T=s[_>>>24]^r[F>>16&255]^n[R>>8&255]^a[M&255]^S[N+2],y=s[F>>>24]^r[R>>16&255]^n[M>>8&255]^a[_&255]^S[N+3],R=o,M=d,_=T,F=y,N=N+4;o=O[R>>>24]<<24^O[M>>16&255]<<16^O[_>>8&255]<<8^O[F&255]^S[N],d=O[M>>>24]<<24^O[_>>16&255]<<16^O[F>>8&255]<<8^O[R&255]^S[N+1],T=O[_>>>24]<<24^O[F>>16&255]<<16^O[R>>8&255]<<8^O[M&255]^S[N+2],y=O[F>>>24]<<24^O[R>>16&255]<<16^O[M>>8&255]<<8^O[_&255]^S[N+3],u[m]=K(o^f),u[m+1]=K(y^h),u[m+2]=K(T^x),u[m+3]=K(d^E),f=B,h=w,x=k,E=U,m=m+4}return u.buffer},P}()},"./src/crypt/decrypter.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return m});var g=t("./src/crypt/aes-crypto.ts"),v=t("./src/crypt/fast-aes-key.ts"),l=t("./src/crypt/aes-decryptor.ts"),P=t("./src/utils/logger.ts"),b=t("./src/utils/mp4-tools.ts"),C=t("./src/utils/typed-array.ts"),L=16,m=function(){function A(S,O,I){var s=I===void 0?{}:I,r=s.removePKCS7Padding,n=r===void 0?!0:r;if(this.logEnabled=!0,this.observer=void 0,this.config=void 0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.observer=S,this.config=O,this.removePKCS7Padding=n,n)try{var a=self.crypto;a&&(this.subtle=a.subtle||a.webkitSubtle)}catch(p){}this.subtle===null&&(this.config.enableSoftwareAES=!0)}var D=A.prototype;return D.destroy=function(){this.observer=null},D.isSync=function(){return this.config.enableSoftwareAES},D.flush=function(){var O=this.currentResult;if(!O){this.reset();return}var I=new Uint8Array(O);return this.reset(),this.removePKCS7Padding?Object(l.removePadding)(I):I},D.reset=function(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)},D.decrypt=function(O,I,s,r){if(this.config.enableSoftwareAES){this.softwareDecrypt(new Uint8Array(O),I,s);var n=this.flush();n&&r(n.buffer)}else this.webCryptoDecrypt(new Uint8Array(O),I,s).then(r)},D.softwareDecrypt=function(O,I,s){var r=this.currentIV,n=this.currentResult,a=this.remainderData;this.logOnce("JS AES decrypt"),a&&(O=Object(b.appendUint8Array)(a,O),this.remainderData=null);var p=this.getValidChunk(O);if(!p.length)return null;r&&(s=r);var f=this.softwareDecrypter;f||(f=this.softwareDecrypter=new l.default),f.expandKey(I);var h=n;return this.currentResult=f.decrypt(p.buffer,0,s),this.currentIV=Object(C.sliceUint8)(p,-16).buffer,h||null},D.webCryptoDecrypt=function(O,I,s){var r=this,n=this.subtle;return(this.key!==I||!this.fastAesKey)&&(this.key=I,this.fastAesKey=new v.default(n,I)),this.fastAesKey.expandKey().then(function(a){if(!n)return Promise.reject(new Error("web crypto not initialized"));var p=new g.default(n,s);return p.decrypt(O.buffer,a)}).catch(function(a){return r.onWebCryptoError(a,O,I,s)})},D.onWebCryptoError=function(O,I,s,r){return P.logger.warn("[decrypter.ts]: WebCrypto Error, disable WebCrypto API:",O),this.config.enableSoftwareAES=!0,this.logEnabled=!0,this.softwareDecrypt(I,s,r)},D.getValidChunk=function(O){var I=O,s=O.length-O.length%L;return s!==O.length&&(I=Object(C.sliceUint8)(O,0,s),this.remainderData=Object(C.sliceUint8)(O,s)),I},D.logOnce=function(O){!this.logEnabled||(P.logger.log("[decrypter.ts]: "+O),this.logEnabled=!1)},A}()},"./src/crypt/fast-aes-key.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return g});var g=function(){function v(P,b){this.subtle=void 0,this.key=void 0,this.subtle=P,this.key=b}var l=v.prototype;return l.expandKey=function(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])},v}()},"./src/demux/aacdemuxer.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/demux/base-audio-demuxer.ts"),v=t("./src/demux/adts.ts"),l=t("./src/utils/logger.ts"),P=t("./src/demux/id3.ts");function b(m,A){m.prototype=Object.create(A.prototype),m.prototype.constructor=m,C(m,A)}function C(m,A){return C=Object.setPrototypeOf||function(S,O){return S.__proto__=O,S},C(m,A)}var L=function(m){b(A,m);function A(S,O){var I;return I=m.call(this)||this,I.observer=void 0,I.config=void 0,I.observer=S,I.config=O,I}var D=A.prototype;return D.resetInitSegment=function(O,I,s){m.prototype.resetInitSegment.call(this,O,I,s),this._audioTrack={container:"audio/adts",type:"audio",id:0,pid:-1,sequenceNumber:0,isAAC:!0,samples:[],manifestCodec:O,duration:s,inputTimeScale:9e4,dropped:0}},A.probe=function(O){if(!O)return!1;for(var I=P.getID3Data(O,0)||[],s=I.length,r=O.length;s<r;s++)if(v.probe(O,s))return l.logger.log("ADTS sync word found !"),!0;return!1},D.canParse=function(O,I){return v.canParse(O,I)},D.appendFrame=function(O,I,s){v.initTrackConfig(O,this.observer,I,s,O.manifestCodec);var r=v.appendFrame(O,I,s,this.initPTS,this.frameIndex);if(r&&r.missing===0)return r},A}(g.default);L.minProbeByteLength=9,e.default=L},"./src/demux/adts.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"getAudioConfig",function(){return P}),t.d(e,"isHeaderPattern",function(){return b}),t.d(e,"getHeaderLength",function(){return C}),t.d(e,"getFullFrameLength",function(){return L}),t.d(e,"canGetFrameLength",function(){return m}),t.d(e,"isHeader",function(){return A}),t.d(e,"canParse",function(){return D}),t.d(e,"probe",function(){return S}),t.d(e,"initTrackConfig",function(){return O}),t.d(e,"getFrameDuration",function(){return I}),t.d(e,"parseFrameHeader",function(){return s}),t.d(e,"appendFrame",function(){return r});var g=t("./src/utils/logger.ts"),v=t("./src/errors.ts"),l=t("./src/events.ts");function P(n,a,p,f){var h,x,E,c,u=navigator.userAgent.toLowerCase(),o=f,d=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];h=((a[p+2]&192)>>>6)+1;var T=(a[p+2]&60)>>>2;if(T>d.length-1){n.trigger(l.Events.ERROR,{type:v.ErrorTypes.MEDIA_ERROR,details:v.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+T});return}return E=(a[p+2]&1)<<2,E|=(a[p+3]&192)>>>6,g.logger.log("manifest codec:"+f+", ADTS type:"+h+", samplingIndex:"+T),/firefox/i.test(u)?T>=6?(h=5,c=new Array(4),x=T-3):(h=2,c=new Array(2),x=T):u.indexOf("android")!==-1?(h=2,c=new Array(2),x=T):(h=5,c=new Array(4),f&&(f.indexOf("mp4a.40.29")!==-1||f.indexOf("mp4a.40.5")!==-1)||!f&&T>=6?x=T-3:((f&&f.indexOf("mp4a.40.2")!==-1&&(T>=6&&E===1||/vivaldi/i.test(u))||!f&&E===1)&&(h=2,c=new Array(2)),x=T)),c[0]=h<<3,c[0]|=(T&14)>>1,c[1]|=(T&1)<<7,c[1]|=E<<3,h===5&&(c[1]|=(x&14)>>1,c[2]=(x&1)<<7,c[2]|=2<<2,c[3]=0),{config:c,samplerate:d[T],channelCount:E,codec:"mp4a.40."+h,manifestCodec:o}}function b(n,a){return n[a]===255&&(n[a+1]&246)==240}function C(n,a){return n[a+1]&1?7:9}function L(n,a){return(n[a+3]&3)<<11|n[a+4]<<3|(n[a+5]&224)>>>5}function m(n,a){return a+5<n.length}function A(n,a){return a+1<n.length&&b(n,a)}function D(n,a){return m(n,a)&&b(n,a)&&L(n,a)<=n.length-a}function S(n,a){if(A(n,a)){var p=C(n,a);if(a+p>=n.length)return!1;var f=L(n,a);if(f<=p)return!1;var h=a+f;return h===n.length||A(n,h)}return!1}function O(n,a,p,f,h){if(!n.samplerate){var x=P(a,p,f,h);if(!x)return;n.config=x.config,n.samplerate=x.samplerate,n.channelCount=x.channelCount,n.codec=x.codec,n.manifestCodec=x.manifestCodec,g.logger.log("parsed codec:"+n.codec+", rate:"+x.samplerate+", channels:"+x.channelCount)}}function I(n){return 1024*9e4/n}function s(n,a,p,f,h){var x=C(n,a),E=L(n,a);if(E-=x,E>0){var c=p+f*h;return{headerLength:x,frameLength:E,stamp:c}}}function r(n,a,p,f,h){var x=I(n.samplerate),E=s(a,p,f,h,x);if(E){var c=E.frameLength,u=E.headerLength,o=E.stamp,d=u+c,T=Math.max(0,p+d-a.length),y;T?(y=new Uint8Array(d-u),y.set(a.subarray(p+u,a.length),0)):y=a.subarray(p+u,p+d);var R={unit:y,pts:o};return T||n.samples.push(R),{sample:R,length:d,missing:T}}}},"./src/demux/base-audio-demuxer.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"initPTSFn",function(){return L});var g=t("./src/polyfills/number.ts"),v=t("./src/demux/id3.ts"),l=t("./src/demux/dummy-demuxed-track.ts"),P=t("./src/utils/mp4-tools.ts"),b=t("./src/utils/typed-array.ts"),C=function(){function m(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.initPTS=null}var A=m.prototype;return A.resetInitSegment=function(S,O,I){this._id3Track={type:"id3",id:0,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},A.resetTimeStamp=function(){},A.resetContiguity=function(){},A.canParse=function(S,O){return!1},A.appendFrame=function(S,O,I){},A.demux=function(S,O){this.cachedData&&(S=Object(P.appendUint8Array)(this.cachedData,S),this.cachedData=null);var I=v.getID3Data(S,0),s=I?I.length:0,r,n,a=this._audioTrack,p=this._id3Track,f=I?v.getTimeStamp(I):void 0,h=S.length;for((this.frameIndex===0||this.initPTS===null)&&(this.initPTS=L(f,O)),I&&I.length>0&&p.samples.push({pts:this.initPTS,dts:this.initPTS,data:I}),n=this.initPTS;s<h;){if(this.canParse(S,s)){var x=this.appendFrame(a,S,s);x?(this.frameIndex++,n=x.sample.pts,s+=x.length,r=s):s=h}else v.canParse(S,s)?(I=v.getID3Data(S,s),p.samples.push({pts:n,dts:n,data:I}),s+=I.length,r=s):s++;if(s===h&&r!==h){var E=Object(b.sliceUint8)(S,r);this.cachedData?this.cachedData=Object(P.appendUint8Array)(this.cachedData,E):this.cachedData=E}}return{audioTrack:a,avcTrack:Object(l.dummyTrack)(),id3Track:p,textTrack:Object(l.dummyTrack)()}},A.demuxSampleAes=function(S,O,I){return Promise.reject(new Error("["+this+"] This demuxer does not support Sample-AES decryption"))},A.flush=function(S){var O=this.cachedData;return O&&(this.cachedData=null,this.demux(O,0)),this.frameIndex=0,{audioTrack:this._audioTrack,avcTrack:Object(l.dummyTrack)(),id3Track:this._id3Track,textTrack:Object(l.dummyTrack)()}},A.destroy=function(){},m}(),L=function(A,D){return Object(g.isFiniteNumber)(A)?A*90:D*9e4};e.default=C},"./src/demux/chunk-cache.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return g});var g=function(){function l(){this.chunks=[],this.dataLength=0}var P=l.prototype;return P.push=function(C){this.chunks.push(C),this.dataLength+=C.length},P.flush=function(){var C=this.chunks,L=this.dataLength,m;if(C.length)C.length===1?m=C[0]:m=v(C,L);else return new Uint8Array(0);return this.reset(),m},P.reset=function(){this.chunks.length=0,this.dataLength=0},l}();function v(l,P){for(var b=new Uint8Array(P),C=0,L=0;L<l.length;L++){var m=l[L];b.set(m,C),C+=m.length}return b}},"./src/demux/dummy-demuxed-track.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"dummyTrack",function(){return g});function g(){return{type:"",id:-1,pid:-1,inputTimeScale:9e4,sequenceNumber:-1,samples:[],dropped:0}}},"./src/demux/exp-golomb.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/utils/logger.ts"),v=function(){function l(b){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=b,this.bytesAvailable=b.byteLength,this.word=0,this.bitsAvailable=0}var P=l.prototype;return P.loadWord=function(){var C=this.data,L=this.bytesAvailable,m=C.byteLength-L,A=new Uint8Array(4),D=Math.min(4,L);if(D===0)throw new Error("no bytes available");A.set(C.subarray(m,m+D)),this.word=new DataView(A.buffer).getUint32(0),this.bitsAvailable=D*8,this.bytesAvailable-=D},P.skipBits=function(C){var L;this.bitsAvailable>C?(this.word<<=C,this.bitsAvailable-=C):(C-=this.bitsAvailable,L=C>>3,C-=L>>3,this.bytesAvailable-=L,this.loadWord(),this.word<<=C,this.bitsAvailable-=C)},P.readBits=function(C){var L=Math.min(this.bitsAvailable,C),m=this.word>>>32-L;return C>32&&g.logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=L,this.bitsAvailable>0?this.word<<=L:this.bytesAvailable>0&&this.loadWord(),L=C-L,L>0&&this.bitsAvailable?m<<L|this.readBits(L):m},P.skipLZ=function(){var C;for(C=0;C<this.bitsAvailable;++C)if((this.word&2147483648>>>C)!=0)return this.word<<=C,this.bitsAvailable-=C,C;return this.loadWord(),C+this.skipLZ()},P.skipUEG=function(){this.skipBits(1+this.skipLZ())},P.skipEG=function(){this.skipBits(1+this.skipLZ())},P.readUEG=function(){var C=this.skipLZ();return this.readBits(C+1)-1},P.readEG=function(){var C=this.readUEG();return 1&C?1+C>>>1:-1*(C>>>1)},P.readBoolean=function(){return this.readBits(1)===1},P.readUByte=function(){return this.readBits(8)},P.readUShort=function(){return this.readBits(16)},P.readUInt=function(){return this.readBits(32)},P.skipScalingList=function(C){for(var L=8,m=8,A,D=0;D<C;D++)m!==0&&(A=this.readEG(),m=(L+A+256)%256),L=m===0?L:m},P.readSPS=function(){var C=0,L=0,m=0,A=0,D,S,O,I=this.readUByte.bind(this),s=this.readBits.bind(this),r=this.readUEG.bind(this),n=this.readBoolean.bind(this),a=this.skipBits.bind(this),p=this.skipEG.bind(this),f=this.skipUEG.bind(this),h=this.skipScalingList.bind(this);I();var x=I();if(s(5),a(3),I(),f(),x===100||x===110||x===122||x===244||x===44||x===83||x===86||x===118||x===128){var E=r();if(E===3&&a(1),f(),f(),a(1),n())for(S=E!==3?8:12,O=0;O<S;O++)n()&&(O<6?h(16):h(64))}f();var c=r();if(c===0)r();else if(c===1)for(a(1),p(),p(),D=r(),O=0;O<D;O++)p();f(),a(1);var u=r(),o=r(),d=s(1);d===0&&a(1),a(1),n()&&(C=r(),L=r(),m=r(),A=r());var T=[1,1];if(n()&&n()){var y=I();switch(y){case 1:T=[1,1];break;case 2:T=[12,11];break;case 3:T=[10,11];break;case 4:T=[16,11];break;case 5:T=[40,33];break;case 6:T=[24,11];break;case 7:T=[20,11];break;case 8:T=[32,11];break;case 9:T=[80,33];break;case 10:T=[18,11];break;case 11:T=[15,11];break;case 12:T=[64,33];break;case 13:T=[160,99];break;case 14:T=[4,3];break;case 15:T=[3,2];break;case 16:T=[2,1];break;case 255:{T=[I()<<8|I(),I()<<8|I()];break}}}return{width:Math.ceil((u+1)*16-C*2-L*2),height:(2-d)*(o+1)*16-(d?2:4)*(m+A),pixelRatio:T}},P.readSliceType=function(){return this.readUByte(),this.readUEG(),this.readUEG()},l}();e.default=v},"./src/demux/id3.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"isHeader",function(){return g}),t.d(e,"isFooter",function(){return v}),t.d(e,"getID3Data",function(){return l}),t.d(e,"canParse",function(){return b}),t.d(e,"getTimeStamp",function(){return C}),t.d(e,"isTimeStampFrame",function(){return L}),t.d(e,"getID3Frames",function(){return A}),t.d(e,"decodeFrame",function(){return D}),t.d(e,"utf8ArrayToStr",function(){return r}),t.d(e,"testables",function(){return n});var g=function(h,x){return x+10<=h.length&&h[x]===73&&h[x+1]===68&&h[x+2]===51&&h[x+3]<255&&h[x+4]<255&&h[x+6]<128&&h[x+7]<128&&h[x+8]<128&&h[x+9]<128},v=function(h,x){return x+10<=h.length&&h[x]===51&&h[x+1]===68&&h[x+2]===73&&h[x+3]<255&&h[x+4]<255&&h[x+6]<128&&h[x+7]<128&&h[x+8]<128&&h[x+9]<128},l=function(h,x){for(var E=x,c=0;g(h,x);){c+=10;var u=P(h,x+6);c+=u,v(h,x+10)&&(c+=10),x+=c}if(c>0)return h.subarray(E,E+c)},P=function(h,x){var E=0;return E=(h[x]&127)<<21,E|=(h[x+1]&127)<<14,E|=(h[x+2]&127)<<7,E|=h[x+3]&127,E},b=function(h,x){return g(h,x)&&P(h,x+6)+10<=h.length-x},C=function(h){for(var x=A(h),E=0;E<x.length;E++){var c=x[E];if(L(c))return s(c)}},L=function(h){return h&&h.key==="PRIV"&&h.info==="com.apple.streaming.transportStreamTimestamp"},m=function(h){var x=String.fromCharCode(h[0],h[1],h[2],h[3]),E=P(h,4),c=10;return{type:x,size:E,data:h.subarray(c,c+E)}},A=function(h){for(var x=0,E=[];g(h,x);){var c=P(h,x+6);x+=10;for(var u=x+c;x+8<u;){var o=m(h.subarray(x)),d=D(o);d&&E.push(d),x+=o.size+10}v(h,x)&&(x+=10)}return E},D=function(h){return h.type==="PRIV"?S(h):h.type[0]==="W"?I(h):O(h)},S=function(h){if(!(h.size<2)){var x=r(h.data,!0),E=new Uint8Array(h.data.subarray(x.length+1));return{key:h.type,info:x,data:E.buffer}}},O=function(h){if(!(h.size<2)){if(h.type==="TXXX"){var x=1,E=r(h.data.subarray(x),!0);x+=E.length+1;var c=r(h.data.subarray(x));return{key:h.type,info:E,data:c}}var u=r(h.data.subarray(1));return{key:h.type,data:u}}},I=function(h){if(h.type==="WXXX"){if(h.size<2)return;var x=1,E=r(h.data.subarray(x),!0);x+=E.length+1;var c=r(h.data.subarray(x));return{key:h.type,info:E,data:c}}var u=r(h.data);return{key:h.type,data:u}},s=function(h){if(h.data.byteLength===8){var x=new Uint8Array(h.data),E=x[3]&1,c=(x[4]<<23)+(x[5]<<15)+(x[6]<<7)+x[7];return c/=45,E&&(c+=4772185884e-2),Math.round(c)}},r=function(h,x){x===void 0&&(x=!1);var E=p();if(E){var c=E.decode(h);if(x){var u=c.indexOf("\0");return u!==-1?c.substring(0,u):c}return c.replace(/\0/g,"")}for(var o=h.length,d,T,y,R="",M=0;M<o;){if(d=h[M++],d===0&&x)return R;if(d===0||d===3)continue;switch(d>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:R+=String.fromCharCode(d);break;case 12:case 13:T=h[M++],R+=String.fromCharCode((d&31)<<6|T&63);break;case 14:T=h[M++],y=h[M++],R+=String.fromCharCode((d&15)<<12|(T&63)<<6|(y&63)<<0);break;default:}}return R},n={decodeTextFrame:O},a;function p(){return!a&&typeof self.TextDecoder!="undefined"&&(a=new self.TextDecoder("utf-8")),a}},"./src/demux/mp3demuxer.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/demux/base-audio-demuxer.ts"),v=t("./src/demux/id3.ts"),l=t("./src/utils/logger.ts"),P=t("./src/demux/mpegaudio.ts");function b(m,A){m.prototype=Object.create(A.prototype),m.prototype.constructor=m,C(m,A)}function C(m,A){return C=Object.setPrototypeOf||function(S,O){return S.__proto__=O,S},C(m,A)}var L=function(m){b(A,m);function A(){return m.apply(this,arguments)||this}var D=A.prototype;return D.resetInitSegment=function(O,I,s){m.prototype.resetInitSegment.call(this,O,I,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:0,pid:-1,sequenceNumber:0,isAAC:!1,samples:[],manifestCodec:O,duration:s,inputTimeScale:9e4,dropped:0}},A.probe=function(O){if(!O)return!1;for(var I=v.getID3Data(O,0)||[],s=I.length,r=O.length;s<r;s++)if(P.probe(O,s))return l.logger.log("MPEG Audio sync word found !"),!0;return!1},D.canParse=function(O,I){return P.canParse(O,I)},D.appendFrame=function(O,I,s){if(this.initPTS!==null)return P.appendFrame(O,I,s,this.initPTS,this.frameIndex)},A}(g.default);L.minProbeByteLength=4,e.default=L},"./src/demux/mp4demuxer.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/utils/mp4-tools.ts"),v=t("./src/demux/dummy-demuxed-track.ts"),l=function(){function P(C,L){this.remainderData=null,this.config=void 0,this.config=L}var b=P.prototype;return b.resetTimeStamp=function(){},b.resetInitSegment=function(){},b.resetContiguity=function(){},P.probe=function(L){return Object(g.findBox)({data:L,start:0,end:Math.min(L.length,16384)},["moof"]).length>0},b.demux=function(L){var m=L,A=Object(v.dummyTrack)();if(this.config.progressive){this.remainderData&&(m=Object(g.appendUint8Array)(this.remainderData,L));var D=Object(g.segmentValidRange)(m);this.remainderData=D.remainder,A.samples=D.valid||new Uint8Array}else A.samples=m;return{audioTrack:Object(v.dummyTrack)(),avcTrack:A,id3Track:Object(v.dummyTrack)(),textTrack:Object(v.dummyTrack)()}},b.flush=function(){var L=Object(v.dummyTrack)();return L.samples=this.remainderData||new Uint8Array,this.remainderData=null,{audioTrack:Object(v.dummyTrack)(),avcTrack:L,id3Track:Object(v.dummyTrack)(),textTrack:Object(v.dummyTrack)()}},b.demuxSampleAes=function(L,m,A){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))},b.destroy=function(){},P}();l.minProbeByteLength=1024,e.default=l},"./src/demux/mpegaudio.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"appendFrame",function(){return C}),t.d(e,"parseHeader",function(){return L}),t.d(e,"isHeaderPattern",function(){return m}),t.d(e,"isHeader",function(){return A}),t.d(e,"canParse",function(){return D}),t.d(e,"probe",function(){return S});var g=null,v=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],l=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],P=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],b=[0,1,1,4];function C(O,I,s,r,n){if(!(s+24>I.length)){var a=L(I,s);if(a&&s+a.frameLength<=I.length){var p=a.samplesPerFrame*9e4/a.sampleRate,f=r+n*p,h={unit:I.subarray(s,s+a.frameLength),pts:f,dts:f};return O.config=[],O.channelCount=a.channelCount,O.samplerate=a.sampleRate,O.samples.push(h),{sample:h,length:a.frameLength,missing:0}}}}function L(O,I){var s=O[I+1]>>3&3,r=O[I+1]>>1&3,n=O[I+2]>>4&15,a=O[I+2]>>2&3;if(s!==1&&n!==0&&n!==15&&a!==3){var p=O[I+2]>>1&1,f=O[I+3]>>6,h=s===3?3-r:r===3?3:4,x=v[h*14+n-1]*1e3,E=s===3?0:s===2?1:2,c=l[E*3+a],u=f===3?1:2,o=P[s][r],d=b[r],T=o*8*d,y=Math.floor(o*x/c+p)*d;if(g===null){var R=navigator.userAgent||"",M=R.match(/Chrome\/(\d+)/i);g=M?parseInt(M[1]):0}var _=!!g&&g<=87;return _&&r===2&&x>=224e3&&f===0&&(O[I+3]=O[I+3]|128),{sampleRate:c,channelCount:u,frameLength:y,samplesPerFrame:T}}}function m(O,I){return O[I]===255&&(O[I+1]&224)==224&&(O[I+1]&6)!=0}function A(O,I){return I+1<O.length&&m(O,I)}function D(O,I){var s=4;return m(O,I)&&s<=O.length-I}function S(O,I){if(I+1<O.length&&m(O,I)){var s=4,r=L(O,I),n=s;r!=null&&r.frameLength&&(n=r.frameLength);var a=I+n;return a===O.length||A(O,a)}return!1}},"./src/demux/sample-aes.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/crypt/decrypter.ts"),v=t("./src/demux/tsdemuxer.ts"),l=function(){function P(C,L,m){this.keyData=void 0,this.decrypter=void 0,this.keyData=m,this.decrypter=new g.default(C,L,{removePKCS7Padding:!1})}var b=P.prototype;return b.decryptBuffer=function(L,m){this.decrypter.decrypt(L,this.keyData.key.buffer,this.keyData.iv.buffer,m)},b.decryptAacSample=function(L,m,A,D){var S=L[m].unit,O=S.subarray(16,S.length-S.length%16),I=O.buffer.slice(O.byteOffset,O.byteOffset+O.length),s=this;this.decryptBuffer(I,function(r){var n=new Uint8Array(r);S.set(n,16),D||s.decryptAacSamples(L,m+1,A)})},b.decryptAacSamples=function(L,m,A){for(;;m++){if(m>=L.length){A();return}if(!(L[m].unit.length<32)){var D=this.decrypter.isSync();if(this.decryptAacSample(L,m,A,D),!D)return}}},b.getAvcEncryptedData=function(L){for(var m=Math.floor((L.length-48)/160)*16+16,A=new Int8Array(m),D=0,S=32;S<=L.length-16;S+=160,D+=16)A.set(L.subarray(S,S+16),D);return A},b.getAvcDecryptedUnit=function(L,m){for(var A=new Uint8Array(m),D=0,S=32;S<=L.length-16;S+=160,D+=16)L.set(A.subarray(D,D+16),S);return L},b.decryptAvcSample=function(L,m,A,D,S,O){var I=Object(v.discardEPB)(S.data),s=this.getAvcEncryptedData(I),r=this;this.decryptBuffer(s.buffer,function(n){S.data=r.getAvcDecryptedUnit(I,n),O||r.decryptAvcSamples(L,m,A+1,D)})},b.decryptAvcSamples=function(L,m,A,D){if(L instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;m++,A=0){if(m>=L.length){D();return}for(var S=L[m].units;!(A>=S.length);A++){var O=S[A];if(!(O.data.length<=48||O.type!==1&&O.type!==5)){var I=this.decrypter.isSync();if(this.decryptAvcSample(L,m,A,D,O,I),!I)return}}}},P}();e.default=l},"./src/demux/transmuxer-interface.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return S});var g=t("./node_modules/webworkify-webpack/index.js"),v=t.n(g),l=t("./src/events.ts"),P=t("./src/demux/transmuxer.ts"),b=t("./src/utils/logger.ts"),C=t("./src/errors.ts"),L=t("./src/utils/mediasource-helper.ts"),m=t("./node_modules/eventemitter3/index.js"),A=t.n(m),D=Object(L.getMediaSource)()||{isTypeSupported:function(){return!1}},S=function(){function O(s,r,n,a){var p=this;this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.worker=void 0,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.hls=s,this.id=r,this.onTransmuxComplete=n,this.onFlush=a;var f=s.config,h=function(o,d){d=d||{},d.frag=p.frag,d.id=p.id,s.trigger(o,d)};this.observer=new m.EventEmitter,this.observer.on(l.Events.FRAG_DECRYPTED,h),this.observer.on(l.Events.ERROR,h);var x={mp4:D.isTypeSupported("video/mp4"),mpeg:D.isTypeSupported("audio/mpeg"),mp3:D.isTypeSupported('audio/mp4; codecs="mp3"')},E=navigator.vendor;if(f.enableWorker&&typeof Worker!="undefined"){b.logger.log("demuxing in webworker");var c;try{c=this.worker=g("./src/demux/transmuxer-worker.ts"),this.onwmsg=this.onWorkerMessage.bind(this),c.addEventListener("message",this.onwmsg),c.onerror=function(u){s.trigger(l.Events.ERROR,{type:C.ErrorTypes.OTHER_ERROR,details:C.ErrorDetails.INTERNAL_EXCEPTION,fatal:!0,event:"demuxerWorker",error:new Error(u.message+"  ("+u.filename+":"+u.lineno+")")})},c.postMessage({cmd:"init",typeSupported:x,vendor:E,id:r,config:JSON.stringify(f)})}catch(u){b.logger.warn("Error in worker:",u),b.logger.error("Error while initializing DemuxerWorker, fallback to inline"),c&&self.URL.revokeObjectURL(c.objectURL),this.transmuxer=new P.default(this.observer,x,f,E,r),this.worker=null}}else this.transmuxer=new P.default(this.observer,x,f,E,r)}var I=O.prototype;return I.destroy=function(){var r=this.worker;if(r)r.removeEventListener("message",this.onwmsg),r.terminate(),this.worker=null;else{var n=this.transmuxer;n&&(n.destroy(),this.transmuxer=null)}var a=this.observer;a&&a.removeAllListeners(),this.observer=null},I.push=function(r,n,a,p,f,h,x,E,c,u){var o=this;c.transmuxing.start=self.performance.now();var d=this.transmuxer,T=this.worker,y=h?h.start:f.start,R=f.decryptdata,M=this.frag,_=!(M&&f.cc===M.cc),F=!(M&&c.level===M.level),B=M?c.sn-M.sn:-1,w=this.part?c.part-this.part.index:1,k=!F&&(B===1||B===0&&w===1),U=self.performance.now();(F||B||f.stats.parsing.start===0)&&(f.stats.parsing.start=U),h&&(w||!k)&&(h.stats.parsing.start=U);var N=new P.TransmuxState(_,k,E,F,y);if(!k||_){b.logger.log("[transmuxer-interface, "+f.type+"]: Starting new transmux session for sn: "+c.sn+" p: "+c.part+" level: "+c.level+" id: "+c.id+`
        discontinuity: `+_+`
        trackSwitch: `+F+`
        contiguous: `+k+`
        accurateTimeOffset: `+E+`
        timeOffset: `+y);var W=new P.TransmuxConfig(a,p,n,x,u);this.configureTransmuxer(W)}if(this.frag=f,this.part=h,T)T.postMessage({cmd:"demux",data:r,decryptdata:R,chunkMeta:c,state:N},r instanceof ArrayBuffer?[r]:[]);else if(d){var K=d.push(r,R,c,N);Object(P.isPromise)(K)?K.then(function(H){o.handleTransmuxComplete(H)}):this.handleTransmuxComplete(K)}},I.flush=function(r){var n=this;r.transmuxing.start=self.performance.now();var a=this.transmuxer,p=this.worker;if(p)p.postMessage({cmd:"flush",chunkMeta:r});else if(a){var f=a.flush(r);Object(P.isPromise)(f)?f.then(function(h){n.handleFlushResult(h,r)}):this.handleFlushResult(f,r)}},I.handleFlushResult=function(r,n){var a=this;r.forEach(function(p){a.handleTransmuxComplete(p)}),this.onFlush(n)},I.onWorkerMessage=function(r){var n=r.data,a=this.hls;switch(n.event){case"init":{self.URL.revokeObjectURL(this.worker.objectURL);break}case"transmuxComplete":{this.handleTransmuxComplete(n.data);break}case"flush":{this.onFlush(n.data);break}default:{n.data=n.data||{},n.data.frag=this.frag,n.data.id=this.id,a.trigger(n.event,n.data);break}}},I.configureTransmuxer=function(r){var n=this.worker,a=this.transmuxer;n?n.postMessage({cmd:"configure",config:r}):a&&a.configure(r)},I.handleTransmuxComplete=function(r){r.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(r)},O}()},"./src/demux/transmuxer-worker.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return C});var g=t("./src/demux/transmuxer.ts"),v=t("./src/events.ts"),l=t("./src/utils/logger.ts"),P=t("./node_modules/eventemitter3/index.js"),b=t.n(P);function C(S){var O=new P.EventEmitter,I=function(r,n){S.postMessage({event:r,data:n})};O.on(v.Events.FRAG_DECRYPTED,I),O.on(v.Events.ERROR,I),S.addEventListener("message",function(s){var r=s.data;switch(r.cmd){case"init":{var n=JSON.parse(r.config);S.transmuxer=new g.default(O,r.typeSupported,n,r.vendor,r.id),Object(l.enableLogs)(n.debug),I("init",null);break}case"configure":{S.transmuxer.configure(r.config);break}case"demux":{var a=S.transmuxer.push(r.data,r.decryptdata,r.chunkMeta,r.state);Object(g.isPromise)(a)?a.then(function(h){L(S,h)}):L(S,a);break}case"flush":{var p=r.chunkMeta,f=S.transmuxer.flush(p);Object(g.isPromise)(f)?f.then(function(h){A(S,h,p)}):A(S,f,p);break}default:break}})}function L(S,O){if(!D(O.remuxResult)){var I=[],s=O.remuxResult,r=s.audio,n=s.video;r&&m(I,r),n&&m(I,n),S.postMessage({event:"transmuxComplete",data:O},I)}}function m(S,O){O.data1&&S.push(O.data1.buffer),O.data2&&S.push(O.data2.buffer)}function A(S,O,I){O.forEach(function(s){L(S,s)}),S.postMessage({event:"flush",data:I})}function D(S){return!S.audio&&!S.video&&!S.text&&!S.id3&&!S.initSegment}},"./src/demux/transmuxer.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return n}),t.d(e,"isPromise",function(){return f}),t.d(e,"TransmuxConfig",function(){return h}),t.d(e,"TransmuxState",function(){return x});var g=t("./src/events.ts"),v=t("./src/errors.ts"),l=t("./src/crypt/decrypter.ts"),P=t("./src/demux/aacdemuxer.ts"),b=t("./src/demux/mp4demuxer.ts"),C=t("./src/demux/tsdemuxer.ts"),L=t("./src/demux/mp3demuxer.ts"),m=t("./src/remux/mp4-remuxer.ts"),A=t("./src/remux/passthrough-remuxer.ts"),D=t("./src/demux/chunk-cache.ts"),S=t("./src/utils/mp4-tools.ts"),O=t("./src/utils/logger.ts"),I;try{I=self.performance.now.bind(self.performance)}catch(E){O.logger.debug("Unable to use Performance API on this environment"),I=self.Date.now}var s=[{demux:C.default,remux:m.default},{demux:b.default,remux:A.default},{demux:P.default,remux:m.default},{demux:L.default,remux:m.default}],r=1024;s.forEach(function(E){var c=E.demux;r=Math.max(r,c.minProbeByteLength)});var n=function(){function E(u,o,d,T,y){this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.cache=new D.default,this.observer=u,this.typeSupported=o,this.config=d,this.vendor=T,this.id=y}var c=E.prototype;return c.configure=function(o){this.transmuxConfig=o,this.decrypter&&this.decrypter.reset()},c.push=function(o,d,T,y){var R=this,M=T.transmuxing;M.executeStart=I();var _=new Uint8Array(o),F=this.cache,B=this.config,w=this.currentTransmuxState,k=this.transmuxConfig;y&&(this.currentTransmuxState=y);var U=a(_,d);if(U&&U.method==="AES-128"){var N=this.getDecrypter();if(B.enableSoftwareAES){var W=N.softwareDecrypt(_,U.key.buffer,U.iv.buffer);if(!W)return M.executeEnd=I(),p(T);_=new Uint8Array(W)}else return this.decryptionPromise=N.webCryptoDecrypt(_,U.key.buffer,U.iv.buffer).then(function(se){var fe=R.push(se,null,T);return R.decryptionPromise=null,fe}),this.decryptionPromise}var K=y||w,H=K.contiguous,G=K.discontinuity,V=K.trackSwitch,X=K.accurateTimeOffset,z=K.timeOffset,$=k.audioCodec,Y=k.videoCodec,Q=k.defaultInitPts,ie=k.duration,Z=k.initSegmentData;if((G||V)&&this.resetInitSegment(Z,$,Y,ie),G&&this.resetInitialTimestamp(Q),H||this.resetContiguity(),this.needsProbing(_,G,V)){if(F.dataLength){var ae=F.flush();_=Object(S.appendUint8Array)(ae,_)}this.configureTransmuxer(_,k)}var q=this.transmux(_,U,z,X,T),ne=this.currentTransmuxState;return ne.contiguous=!0,ne.discontinuity=!1,ne.trackSwitch=!1,M.executeEnd=I(),q},c.flush=function(o){var d=this,T=o.transmuxing;T.executeStart=I();var y=this.decrypter,R=this.cache,M=this.currentTransmuxState,_=this.decryptionPromise;if(_)return _.then(function(){return d.flush(o)});var F=[],B=M.timeOffset;if(y){var w=y.flush();w&&F.push(this.push(w,null,o))}var k=R.dataLength;R.reset();var U=this.demuxer,N=this.remuxer;if(!U||!N)return k>=r&&this.observer.emit(g.Events.ERROR,g.Events.ERROR,{type:v.ErrorTypes.MEDIA_ERROR,details:v.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"}),T.executeEnd=I(),[p(o)];var W=U.flush(B);return f(W)?W.then(function(K){return d.flushRemux(F,K,o),F}):(this.flushRemux(F,W,o),F)},c.flushRemux=function(o,d,T){var y=d.audioTrack,R=d.avcTrack,M=d.id3Track,_=d.textTrack,F=this.currentTransmuxState,B=F.accurateTimeOffset,w=F.timeOffset;O.logger.log("[transmuxer.ts]: Flushed fragment "+T.sn+(T.part>-1?" p: "+T.part:"")+" of level "+T.level);var k=this.remuxer.remux(y,R,M,_,w,B,!0,this.id);o.push({remuxResult:k,chunkMeta:T}),T.transmuxing.executeEnd=I()},c.resetInitialTimestamp=function(o){var d=this.demuxer,T=this.remuxer;!d||!T||(d.resetTimeStamp(o),T.resetTimeStamp(o))},c.resetContiguity=function(){var o=this.demuxer,d=this.remuxer;!o||!d||(o.resetContiguity(),d.resetNextTimestamp())},c.resetInitSegment=function(o,d,T,y){var R=this.demuxer,M=this.remuxer;!R||!M||(R.resetInitSegment(d,T,y),M.resetInitSegment(o,d,T))},c.destroy=function(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)},c.transmux=function(o,d,T,y,R){var M;return d&&d.method==="SAMPLE-AES"?M=this.transmuxSampleAes(o,d,T,y,R):M=this.transmuxUnencrypted(o,T,y,R),M},c.transmuxUnencrypted=function(o,d,T,y){var R=this.demuxer.demux(o,d,!1,!this.config.progressive),M=R.audioTrack,_=R.avcTrack,F=R.id3Track,B=R.textTrack,w=this.remuxer.remux(M,_,F,B,d,T,!1,this.id);return{remuxResult:w,chunkMeta:y}},c.transmuxSampleAes=function(o,d,T,y,R){var M=this;return this.demuxer.demuxSampleAes(o,d,T).then(function(_){var F=M.remuxer.remux(_.audioTrack,_.avcTrack,_.id3Track,_.textTrack,T,y,!1,M.id);return{remuxResult:F,chunkMeta:R}})},c.configureTransmuxer=function(o,d){for(var T=this.config,y=this.observer,R=this.typeSupported,M=this.vendor,_=d.audioCodec,F=d.defaultInitPts,B=d.duration,w=d.initSegmentData,k=d.videoCodec,U,N=0,W=s.length;N<W;N++)if(s[N].demux.probe(o)){U=s[N];break}U||(O.logger.warn("Failed to find demuxer by probing frag, treating as mp4 passthrough"),U={demux:b.default,remux:A.default});var K=this.demuxer,H=this.remuxer,G=U.remux,V=U.demux;(!H||!(H instanceof G))&&(this.remuxer=new G(y,T,R,M)),(!K||!(K instanceof V))&&(this.demuxer=new V(y,T,R),this.probe=V.probe),this.resetInitSegment(w,_,k,B),this.resetInitialTimestamp(F)},c.needsProbing=function(o,d,T){return!this.demuxer||!this.remuxer||d||T},c.getDecrypter=function(){var o=this.decrypter;return o||(o=this.decrypter=new l.default(this.observer,this.config)),o},E}();function a(E,c){var u=null;return E.byteLength>0&&c!=null&&c.key!=null&&c.iv!==null&&c.method!=null&&(u=c),u}var p=function(c){return{remuxResult:{},chunkMeta:c}};function f(E){return"then"in E&&E.then instanceof Function}var h=function(c,u,o,d,T){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=c,this.videoCodec=u,this.initSegmentData=o,this.duration=d,this.defaultInitPts=T},x=function(c,u,o,d,T){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.discontinuity=c,this.contiguous=u,this.accurateTimeOffset=o,this.trackSwitch=d,this.timeOffset=T}},"./src/demux/tsdemuxer.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"discardEPB",function(){return p});var g=t("./src/demux/adts.ts"),v=t("./src/demux/mpegaudio.ts"),l=t("./src/demux/exp-golomb.ts"),P=t("./src/demux/id3.ts"),b=t("./src/demux/sample-aes.ts"),C=t("./src/events.ts"),L=t("./src/utils/mp4-tools.ts"),m=t("./src/utils/logger.ts"),A=t("./src/errors.ts"),D={video:1,audio:2,id3:3,text:4},S=function(){function f(x,E,c){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this.aacLastPTS=null,this._initPTS=null,this._initDTS=null,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=x,this.config=E,this.typeSupported=c}f.probe=function(E){var c=f.syncOffset(E);return c<0?!1:(c&&m.logger.warn("MPEG2-TS detected but first sync word found @ offset "+c+", junk ahead ?"),!0)},f.syncOffset=function(E){for(var c=Math.min(1e3,E.length-3*188),u=0;u<c;){if(E[u]===71&&E[u+188]===71&&E[u+2*188]===71)return u;u++}return-1},f.createTrack=function(E,c){return{container:E==="video"||E==="audio"?"video/mp2t":void 0,type:E,id:D[E],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:E==="audio"?c:void 0}};var h=f.prototype;return h.resetInitSegment=function(E,c,u){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=f.createTrack("video",u),this._audioTrack=f.createTrack("audio",u),this._id3Track=f.createTrack("id3",u),this._txtTrack=f.createTrack("text",u),this._audioTrack.isAAC=!0,this.aacOverFlow=null,this.aacLastPTS=null,this.avcSample=null,this.audioCodec=E,this.videoCodec=c,this._duration=u},h.resetTimeStamp=function(){},h.resetContiguity=function(){var E=this._audioTrack,c=this._avcTrack,u=this._id3Track;E&&(E.pesData=null),c&&(c.pesData=null),u&&(u.pesData=null),this.aacOverFlow=null,this.aacLastPTS=null},h.demux=function(E,c,u,o){u===void 0&&(u=!1),o===void 0&&(o=!1),u||(this.sampleAes=null);var d,T=this._avcTrack,y=this._audioTrack,R=this._id3Track,M=T.pid,_=T.pesData,F=y.pid,B=R.pid,w=y.pesData,k=R.pesData,U=!1,N=this.pmtParsed,W=this._pmtId,K=E.length;if(this.remainderData&&(E=Object(L.appendUint8Array)(this.remainderData,E),K=E.length,this.remainderData=null),K<188&&!o)return this.remainderData=E,{audioTrack:y,avcTrack:T,id3Track:R,textTrack:this._txtTrack};var H=Math.max(0,f.syncOffset(E));K-=(K+H)%188,K<E.byteLength&&!o&&(this.remainderData=new Uint8Array(E.buffer,K,E.buffer.byteLength-K));for(var G=H;G<K;G+=188)if(E[G]===71){var V=!!(E[G+1]&64),X=((E[G+1]&31)<<8)+E[G+2],z=(E[G+3]&48)>>4,$=void 0;if(z>1){if($=G+5+E[G+4],$===G+188)continue}else $=G+4;switch(X){case M:V&&(_&&(d=r(_))&&this.parseAVCPES(d,!1),_={data:[],size:0}),_&&(_.data.push(E.subarray($,G+188)),_.size+=G+188-$);break;case F:V&&(w&&(d=r(w))&&(y.isAAC?this.parseAACPES(d):this.parseMPEGPES(d)),w={data:[],size:0}),w&&(w.data.push(E.subarray($,G+188)),w.size+=G+188-$);break;case B:V&&(k&&(d=r(k))&&this.parseID3PES(d),k={data:[],size:0}),k&&(k.data.push(E.subarray($,G+188)),k.size+=G+188-$);break;case 0:V&&($+=E[$]+1),W=this._pmtId=I(E,$);break;case W:{V&&($+=E[$]+1);var Y=s(E,$,this.typeSupported.mpeg===!0||this.typeSupported.mp3===!0,u);M=Y.avc,M>0&&(T.pid=M),F=Y.audio,F>0&&(y.pid=F,y.isAAC=Y.isAAC),B=Y.id3,B>0&&(R.pid=B),U&&!N&&(m.logger.log("reparse from beginning"),U=!1,G=H-188),N=this.pmtParsed=!0;break}case 17:case 8191:break;default:U=!0;break}}else this.observer.emit(C.Events.ERROR,C.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"TS packet did not start with 0x47"});T.pesData=_,y.pesData=w,R.pesData=k;var Q={audioTrack:y,avcTrack:T,id3Track:R,textTrack:this._txtTrack};return o&&this.extractRemainingSamples(Q),Q},h.flush=function(){var E=this.remainderData;this.remainderData=null;var c;return E?c=this.demux(E,-1,!1,!0):c={audioTrack:this._audioTrack,avcTrack:this._avcTrack,textTrack:this._txtTrack,id3Track:this._id3Track},this.extractRemainingSamples(c),this.sampleAes?this.decrypt(c,this.sampleAes):c},h.extractRemainingSamples=function(E){var c=E.audioTrack,u=E.avcTrack,o=E.id3Track,d=u.pesData,T=c.pesData,y=o.pesData,R;d&&(R=r(d))?(this.parseAVCPES(R,!0),u.pesData=null):u.pesData=d,T&&(R=r(T))?(c.isAAC?this.parseAACPES(R):this.parseMPEGPES(R),c.pesData=null):(T!=null&&T.size&&m.logger.log("last AAC PES packet truncated,might overlap between fragments"),c.pesData=T),y&&(R=r(y))?(this.parseID3PES(R),o.pesData=null):o.pesData=y},h.demuxSampleAes=function(E,c,u){var o=this.demux(E,u,!0,!this.config.progressive),d=this.sampleAes=new b.default(this.observer,this.config,c);return this.decrypt(o,d)},h.decrypt=function(E,c){return new Promise(function(u){var o=E.audioTrack,d=E.avcTrack;o.samples&&o.isAAC?c.decryptAacSamples(o.samples,0,function(){d.samples?c.decryptAvcSamples(d.samples,0,0,function(){u(E)}):u(E)}):d.samples&&c.decryptAvcSamples(d.samples,0,0,function(){u(E)})})},h.destroy=function(){this._initPTS=this._initDTS=null,this._duration=0},h.parseAVCPES=function(E,c){var u=this,o=this._avcTrack,d=this.parseAVCNALu(E.data),T=!1,y=this.avcSample,R,M=!1;E.data=null,y&&d.length&&!o.audFound&&(n(y,o),y=this.avcSample=O(!1,E.pts,E.dts,"")),d.forEach(function(_){switch(_.type){case 1:{R=!0,y||(y=u.avcSample=O(!0,E.pts,E.dts,"")),T&&(y.debug+="NDR "),y.frame=!0;var F=_.data;if(M&&F.length>4){var B=new l.default(F).readSliceType();(B===2||B===4||B===7||B===9)&&(y.key=!0)}break}case 5:R=!0,y||(y=u.avcSample=O(!0,E.pts,E.dts,"")),T&&(y.debug+="IDR "),y.key=!0,y.frame=!0;break;case 6:{R=!0,T&&y&&(y.debug+="SEI ");var w=new l.default(p(_.data));w.readUByte();for(var k=0,U=0,N=!1,W=0;!N&&w.bytesAvailable>1;){k=0;do W=w.readUByte(),k+=W;while(W===255);U=0;do W=w.readUByte(),U+=W;while(W===255);if(k===4&&w.bytesAvailable!==0){N=!0;var K=w.readUByte();if(K===181){var H=w.readUShort();if(H===49){var G=w.readUInt();if(G===1195456820){var V=w.readUByte();if(V===3){for(var X=w.readUByte(),z=w.readUByte(),$=31&X,Y=[X,z],Q=0;Q<$;Q++)Y.push(w.readUByte()),Y.push(w.readUByte()),Y.push(w.readUByte());a(u._txtTrack.samples,{type:3,pts:E.pts,bytes:Y})}}}}}else if(k===5&&w.bytesAvailable!==0){if(N=!0,U>16){for(var ie=[],Z=0;Z<16;Z++)ie.push(w.readUByte().toString(16)),(Z===3||Z===5||Z===7||Z===9)&&ie.push("-");for(var ae=U-16,q=new Uint8Array(ae),ne=0;ne<ae;ne++)q[ne]=w.readUByte();a(u._txtTrack.samples,{pts:E.pts,payloadType:k,uuid:ie.join(""),userData:Object(P.utf8ArrayToStr)(q),userDataBytes:q})}}else if(U<w.bytesAvailable)for(var se=0;se<U;se++)w.readUByte()}break}case 7:if(R=!0,M=!0,T&&y&&(y.debug+="SPS "),!o.sps){var fe=new l.default(_.data),le=fe.readSPS();o.width=le.width,o.height=le.height,o.pixelRatio=le.pixelRatio,o.sps=[_.data],o.duration=u._duration;for(var ce=_.data.subarray(1,4),pe="avc1.",re=0;re<3;re++){var he=ce[re].toString(16);he.length<2&&(he="0"+he),pe+=he}o.codec=pe}break;case 8:R=!0,T&&y&&(y.debug+="PPS "),o.pps||(o.pps=[_.data]);break;case 9:R=!1,o.audFound=!0,y&&n(y,o),y=u.avcSample=O(!1,E.pts,E.dts,T?"AUD ":"");break;case 12:R=!1;break;default:R=!1,y&&(y.debug+="unknown NAL "+_.type+" ");break}if(y&&R){var De=y.units;De.push(_)}}),c&&y&&(n(y,o),this.avcSample=null)},h.getLastNalUnit=function(){var E,c=this.avcSample,u;if(!c||c.units.length===0){var o=this._avcTrack.samples;c=o[o.length-1]}if((E=c)!==null&&E!==void 0&&E.units){var d=c.units;u=d[d.length-1]}return u},h.parseAVCNALu=function(E){var c=E.byteLength,u=this._avcTrack,o=u.naluState||0,d=o,T=[],y=0,R,M,_,F=-1,B=0;for(o===-1&&(F=0,B=E[0]&31,o=0,y=1);y<c;){if(R=E[y++],!o){o=R?0:1;continue}if(o===1){o=R?0:2;continue}if(!R)o=3;else if(R===1){if(F>=0){var w={data:E.subarray(F,y-o-1),type:B};T.push(w)}else{var k=this.getLastNalUnit();if(k&&(d&&y<=4-d&&k.state&&(k.data=k.data.subarray(0,k.data.byteLength-d)),M=y-o-1,M>0)){var U=new Uint8Array(k.data.byteLength+M);U.set(k.data,0),U.set(E.subarray(0,M),k.data.byteLength),k.data=U}}y<c?(_=E[y]&31,F=y,B=_,o=0):o=-1}else o=0}if(F>=0&&o>=0){var N={data:E.subarray(F,c),type:B,state:o};T.push(N)}if(T.length===0){var W=this.getLastNalUnit();if(W){var K=new Uint8Array(W.data.byteLength+E.byteLength);K.set(W.data,0),K.set(E,W.data.byteLength),W.data=K}}return u.naluState=o,T},h.parseAACPES=function(E){var c=0,u=this._audioTrack,o=this.aacOverFlow,d=E.data;if(o){this.aacOverFlow=null;var T=o.sample.unit.byteLength,y=Math.min(o.missing,T),R=T-y;o.sample.unit.set(d.subarray(0,y),R),u.samples.push(o.sample),c=o.missing}var M,_;for(M=c,_=d.length;M<_-1&&!g.isHeader(d,M);M++);if(M!==c){var F,B;if(M<_-1?(F="AAC PES did not start with ADTS header,offset:"+M,B=!1):(F="no ADTS header found in AAC PES",B=!0),m.logger.warn("parsing error:"+F),this.observer.emit(C.Events.ERROR,C.Events.ERROR,{type:A.ErrorTypes.MEDIA_ERROR,details:A.ErrorDetails.FRAG_PARSING_ERROR,fatal:B,reason:F}),B)return}g.initTrackConfig(u,this.observer,d,M,this.audioCodec);var w;if(E.pts!==void 0)w=E.pts;else if(o){var k=g.getFrameDuration(u.samplerate);w=o.sample.pts+k}else{m.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}for(var U=0;M<_;)if(g.isHeader(d,M)){if(M+5<_){var N=g.appendFrame(u,d,M,w,U);if(N)if(N.missing)this.aacOverFlow=N;else{M+=N.length,U++;continue}}break}else M++},h.parseMPEGPES=function(E){var c=E.data,u=c.length,o=0,d=0,T=E.pts;if(T===void 0){m.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;d<u;)if(v.isHeader(c,d)){var y=v.appendFrame(this._audioTrack,c,d,T,o);if(y)d+=y.length,o++;else break}else d++},h.parseID3PES=function(E){if(E.pts===void 0){m.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}this._id3Track.samples.push(E)},f}();S.minProbeByteLength=188;function O(f,h,x,E){return{key:f,frame:!1,pts:h,dts:x,units:[],debug:E,length:0}}function I(f,h){return(f[h+10]&31)<<8|f[h+11]}function s(f,h,x,E){var c={audio:-1,avc:-1,id3:-1,isAAC:!0},u=(f[h+1]&15)<<8|f[h+2],o=h+3+u-4,d=(f[h+10]&15)<<8|f[h+11];for(h+=12+d;h<o;){var T=(f[h+1]&31)<<8|f[h+2];switch(f[h]){case 207:if(!E){m.logger.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:c.audio===-1&&(c.audio=T);break;case 21:c.id3===-1&&(c.id3=T);break;case 219:if(!E){m.logger.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:c.avc===-1&&(c.avc=T);break;case 3:case 4:x?c.audio===-1&&(c.audio=T,c.isAAC=!1):m.logger.log("MPEG audio found, not supported in this browser");break;case 36:m.logger.warn("Unsupported HEVC stream type found");break;default:break}h+=((f[h+3]&15)<<8|f[h+4])+5}return c}function r(f){var h=0,x,E,c,u,o,d=f.data;if(!f||f.size===0)return null;for(;d[0].length<19&&d.length>1;){var T=new Uint8Array(d[0].length+d[1].length);T.set(d[0]),T.set(d[1],d[0].length),d[0]=T,d.splice(1,1)}x=d[0];var y=(x[0]<<16)+(x[1]<<8)+x[2];if(y===1){if(E=(x[4]<<8)+x[5],E&&E>f.size-6)return null;var R=x[7];R&192&&(u=(x[9]&14)*536870912+(x[10]&255)*4194304+(x[11]&254)*16384+(x[12]&255)*128+(x[13]&254)/2,R&64?(o=(x[14]&14)*536870912+(x[15]&255)*4194304+(x[16]&254)*16384+(x[17]&255)*128+(x[18]&254)/2,u-o>60*9e4&&(m.logger.warn(Math.round((u-o)/9e4)+"s delta between PTS and DTS, align them"),u=o)):o=u),c=x[8];var M=c+9;if(f.size<=M)return null;f.size-=M;for(var _=new Uint8Array(f.size),F=0,B=d.length;F<B;F++){x=d[F];var w=x.byteLength;if(M)if(M>w){M-=w;continue}else x=x.subarray(M),w-=M,M=0;_.set(x,h),h+=w}return E&&(E-=c+3),{data:_,pts:u,dts:o,len:E}}return null}function n(f,h){if(f.units.length&&f.frame){if(f.pts===void 0){var x=h.samples,E=x.length;if(E){var c=x[E-1];f.pts=c.pts,f.dts=c.dts}else{h.dropped++;return}}h.samples.push(f)}f.debug.length&&m.logger.log(f.pts+"/"+f.dts+":"+f.debug)}function a(f,h){var x=f.length;if(x>0){if(h.pts>=f[x-1].pts)f.push(h);else for(var E=x-1;E>=0;E--)if(h.pts<f[E].pts){f.splice(E,0,h);break}}else f.push(h)}function p(f){for(var h=f.byteLength,x=[],E=1;E<h-2;)f[E]===0&&f[E+1]===0&&f[E+2]===3?(x.push(E+2),E+=2):E++;if(x.length===0)return f;var c=h-x.length,u=new Uint8Array(c),o=0;for(E=0;E<c;o++,E++)o===x[0]&&(o++,x.shift()),u[E]=f[o];return u}e.default=S},"./src/errors.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"ErrorTypes",function(){return g}),t.d(e,"ErrorDetails",function(){return v});var g;(function(l){l.NETWORK_ERROR="networkError",l.MEDIA_ERROR="mediaError",l.KEY_SYSTEM_ERROR="keySystemError",l.MUX_ERROR="muxError",l.OTHER_ERROR="otherError"})(g||(g={}));var v;(function(l){l.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",l.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",l.KEY_SYSTEM_NO_SESSION="keySystemNoSession",l.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",l.KEY_SYSTEM_NO_INIT_DATA="keySystemNoInitData",l.MANIFEST_LOAD_ERROR="manifestLoadError",l.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",l.MANIFEST_PARSING_ERROR="manifestParsingError",l.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",l.LEVEL_EMPTY_ERROR="levelEmptyError",l.LEVEL_LOAD_ERROR="levelLoadError",l.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",l.LEVEL_SWITCH_ERROR="levelSwitchError",l.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",l.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",l.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",l.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",l.FRAG_LOAD_ERROR="fragLoadError",l.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",l.FRAG_DECRYPT_ERROR="fragDecryptError",l.FRAG_PARSING_ERROR="fragParsingError",l.REMUX_ALLOC_ERROR="remuxAllocError",l.KEY_LOAD_ERROR="keyLoadError",l.KEY_LOAD_TIMEOUT="keyLoadTimeOut",l.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",l.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",l.BUFFER_APPEND_ERROR="bufferAppendError",l.BUFFER_APPENDING_ERROR="bufferAppendingError",l.BUFFER_STALLED_ERROR="bufferStalledError",l.BUFFER_FULL_ERROR="bufferFullError",l.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",l.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",l.INTERNAL_EXCEPTION="internalException",l.INTERNAL_ABORTED="aborted",l.UNKNOWN="unknown"})(v||(v={}))},"./src/events.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"Events",function(){return g});var g;(function(v){v.MEDIA_ATTACHING="hlsMediaAttaching",v.MEDIA_ATTACHED="hlsMediaAttached",v.MEDIA_DETACHING="hlsMediaDetaching",v.MEDIA_DETACHED="hlsMediaDetached",v.BUFFER_RESET="hlsBufferReset",v.BUFFER_CODECS="hlsBufferCodecs",v.BUFFER_CREATED="hlsBufferCreated",v.BUFFER_APPENDING="hlsBufferAppending",v.BUFFER_APPENDED="hlsBufferAppended",v.BUFFER_EOS="hlsBufferEos",v.BUFFER_FLUSHING="hlsBufferFlushing",v.BUFFER_FLUSHED="hlsBufferFlushed",v.MANIFEST_LOADING="hlsManifestLoading",v.MANIFEST_LOADED="hlsManifestLoaded",v.MANIFEST_PARSED="hlsManifestParsed",v.LEVEL_SWITCHING="hlsLevelSwitching",v.LEVEL_SWITCHED="hlsLevelSwitched",v.LEVEL_LOADING="hlsLevelLoading",v.LEVEL_LOADED="hlsLevelLoaded",v.LEVEL_UPDATED="hlsLevelUpdated",v.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",v.LEVELS_UPDATED="hlsLevelsUpdated",v.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",v.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",v.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",v.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",v.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",v.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",v.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",v.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",v.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",v.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",v.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",v.CUES_PARSED="hlsCuesParsed",v.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",v.INIT_PTS_FOUND="hlsInitPtsFound",v.FRAG_LOADING="hlsFragLoading",v.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",v.FRAG_LOADED="hlsFragLoaded",v.FRAG_DECRYPTED="hlsFragDecrypted",v.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",v.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",v.FRAG_PARSING_METADATA="hlsFragParsingMetadata",v.FRAG_PARSED="hlsFragParsed",v.FRAG_BUFFERED="hlsFragBuffered",v.FRAG_CHANGED="hlsFragChanged",v.FPS_DROP="hlsFpsDrop",v.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",v.ERROR="hlsError",v.DESTROYING="hlsDestroying",v.KEY_LOADING="hlsKeyLoading",v.KEY_LOADED="hlsKeyLoaded",v.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",v.BACK_BUFFER_REACHED="hlsBackBufferReached"})(g||(g={}))},"./src/hls.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return f});var g=t("./node_modules/url-toolkit/src/url-toolkit.js"),v=t.n(g),l=t("./src/loader/playlist-loader.ts"),P=t("./src/loader/key-loader.ts"),b=t("./src/controller/id3-track-controller.ts"),C=t("./src/controller/latency-controller.ts"),L=t("./src/controller/level-controller.ts"),m=t("./src/controller/fragment-tracker.ts"),A=t("./src/controller/stream-controller.ts"),D=t("./src/is-supported.ts"),S=t("./src/utils/logger.ts"),O=t("./src/config.ts"),I=t("./node_modules/eventemitter3/index.js"),s=t.n(I),r=t("./src/events.ts"),n=t("./src/errors.ts");function a(h,x){for(var E=0;E<x.length;E++){var c=x[E];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(h,c.key,c)}}function p(h,x,E){return x&&a(h.prototype,x),E&&a(h,E),h}var f=function(){h.isSupported=function(){return Object(D.isSupported)()};function h(E){E===void 0&&(E={}),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new I.EventEmitter,this._autoLevelCapping=void 0,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this._media=null,this.url=null;var c=this.config=Object(O.mergeConfig)(h.DefaultConfig,E);this.userConfig=E,Object(S.enableLogs)(c.debug),this._autoLevelCapping=-1,c.progressive&&Object(O.enableStreamingMode)(c);var u=c.abrController,o=c.bufferController,d=c.capLevelController,T=c.fpsController,y=this.abrController=new u(this),R=this.bufferController=new o(this),M=this.capLevelController=new d(this),_=new T(this),F=new l.default(this),B=new P.default(this),w=new b.default(this),k=this.levelController=new L.default(this),U=new m.FragmentTracker(this),N=this.streamController=new A.default(this,U);M.setStreamController(N),_.setStreamController(N);var W=[k,N];this.networkControllers=W;var K=[F,B,y,R,M,_,w,U];this.audioTrackController=this.createController(c.audioTrackController,null,W),this.createController(c.audioStreamController,U,W),this.subtitleTrackController=this.createController(c.subtitleTrackController,null,W),this.createController(c.subtitleStreamController,U,W),this.createController(c.timelineController,null,K),this.emeController=this.createController(c.emeController,null,K),this.latencyController=this.createController(C.default,null,K),this.coreComponents=K}var x=h.prototype;return x.createController=function(c,u,o){if(c){var d=u?new c(this,u):new c(this);return o&&o.push(d),d}return null},x.on=function(c,u,o){o===void 0&&(o=this),this._emitter.on(c,u,o)},x.once=function(c,u,o){o===void 0&&(o=this),this._emitter.once(c,u,o)},x.removeAllListeners=function(c){this._emitter.removeAllListeners(c)},x.off=function(c,u,o,d){o===void 0&&(o=this),this._emitter.off(c,u,o,d)},x.listeners=function(c){return this._emitter.listeners(c)},x.emit=function(c,u,o){return this._emitter.emit(c,u,o)},x.trigger=function(c,u){if(this.config.debug)return this.emit(c,c,u);try{return this.emit(c,c,u)}catch(o){S.logger.error("An internal error happened while handling event "+c+'. Error message: "'+o.message+'". Here is a stacktrace:',o),this.trigger(r.Events.ERROR,{type:n.ErrorTypes.OTHER_ERROR,details:n.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:c,error:o})}return!1},x.listenerCount=function(c){return this._emitter.listenerCount(c)},x.destroy=function(){S.logger.log("destroy"),this.trigger(r.Events.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(function(c){return c.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(c){return c.destroy()}),this.coreComponents.length=0},x.attachMedia=function(c){S.logger.log("attachMedia"),this._media=c,this.trigger(r.Events.MEDIA_ATTACHING,{media:c})},x.detachMedia=function(){S.logger.log("detachMedia"),this.trigger(r.Events.MEDIA_DETACHING,void 0),this._media=null},x.loadSource=function(c){this.stopLoad();var u=this.media,o=this.url,d=this.url=g.buildAbsoluteURL(self.location.href,c,{alwaysNormalize:!0});S.logger.log("loadSource:"+d),u&&o&&o!==d&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(u)),this.trigger(r.Events.MANIFEST_LOADING,{url:c})},x.startLoad=function(c){c===void 0&&(c=-1),S.logger.log("startLoad("+c+")"),this.networkControllers.forEach(function(u){u.startLoad(c)})},x.stopLoad=function(){S.logger.log("stopLoad"),this.networkControllers.forEach(function(c){c.stopLoad()})},x.swapAudioCodec=function(){S.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()},x.recoverMediaError=function(){S.logger.log("recoverMediaError");var c=this._media;this.detachMedia(),c&&this.attachMedia(c)},x.removeLevel=function(c,u){u===void 0&&(u=0),this.levelController.removeLevel(c,u)},p(h,[{key:"levels",get:function(){var c=this.levelController.levels;return c||[]}},{key:"currentLevel",get:function(){return this.streamController.currentLevel},set:function(c){S.logger.log("set currentLevel:"+c),this.loadLevel=c,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function(){return this.streamController.nextLevel},set:function(c){S.logger.log("set nextLevel:"+c),this.levelController.manualLevel=c,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function(){return this.levelController.level},set:function(c){S.logger.log("set loadLevel:"+c),this.levelController.manualLevel=c}},{key:"nextLoadLevel",get:function(){return this.levelController.nextLoadLevel},set:function(c){this.levelController.nextLoadLevel=c}},{key:"firstLevel",get:function(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function(c){S.logger.log("set firstLevel:"+c),this.levelController.firstLevel=c}},{key:"startLevel",get:function(){return this.levelController.startLevel},set:function(c){S.logger.log("set startLevel:"+c),c!==-1&&(c=Math.max(c,this.minAutoLevel)),this.levelController.startLevel=c}},{key:"capLevelToPlayerSize",get:function(){return this.config.capLevelToPlayerSize},set:function(c){var u=!!c;u!==this.config.capLevelToPlayerSize&&(u?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=u)}},{key:"autoLevelCapping",get:function(){return this._autoLevelCapping},set:function(c){this._autoLevelCapping!==c&&(S.logger.log("set autoLevelCapping:"+c),this._autoLevelCapping=c)}},{key:"bandwidthEstimate",get:function(){var c=this.abrController.bwEstimator;return c?c.getEstimate():NaN}},{key:"autoLevelEnabled",get:function(){return this.levelController.manualLevel===-1}},{key:"manualLevel",get:function(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function(){var c=this.levels,u=this.config.minAutoBitrate;if(!c)return 0;for(var o=c.length,d=0;d<o;d++)if(c[d].maxBitrate>u)return d;return 0}},{key:"maxAutoLevel",get:function(){var c=this.levels,u=this.autoLevelCapping,o;return u===-1&&c&&c.length?o=c.length-1:o=u,o}},{key:"nextAutoLevel",get:function(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)},set:function(c){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,c)}},{key:"audioTracks",get:function(){var c=this.audioTrackController;return c?c.audioTracks:[]}},{key:"audioTrack",get:function(){var c=this.audioTrackController;return c?c.audioTrack:-1},set:function(c){var u=this.audioTrackController;u&&(u.audioTrack=c)}},{key:"subtitleTracks",get:function(){var c=this.subtitleTrackController;return c?c.subtitleTracks:[]}},{key:"subtitleTrack",get:function(){var c=this.subtitleTrackController;return c?c.subtitleTrack:-1},set:function(c){var u=this.subtitleTrackController;u&&(u.subtitleTrack=c)}},{key:"media",get:function(){return this._media}},{key:"subtitleDisplay",get:function(){var c=this.subtitleTrackController;return c?c.subtitleDisplay:!1},set:function(c){var u=this.subtitleTrackController;u&&(u.subtitleDisplay=c)}},{key:"lowLatencyMode",get:function(){return this.config.lowLatencyMode},set:function(c){this.config.lowLatencyMode=c}},{key:"liveSyncPosition",get:function(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function(){return this.latencyController.latency}},{key:"maxLatency",get:function(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function(){return this.latencyController.targetLatency}},{key:"drift",get:function(){return this.latencyController.drift}},{key:"forceStartLoad",get:function(){return this.streamController.forceStartLoad}}],[{key:"version",get:function(){return"1.0.11"}},{key:"Events",get:function(){return r.Events}},{key:"ErrorTypes",get:function(){return n.ErrorTypes}},{key:"ErrorDetails",get:function(){return n.ErrorDetails}},{key:"DefaultConfig",get:function(){return h.defaultConfig?h.defaultConfig:O.hlsDefaultConfig},set:function(c){h.defaultConfig=c}}]),h}();f.defaultConfig=void 0},"./src/is-supported.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"isSupported",function(){return l}),t.d(e,"changeTypeSupported",function(){return P});var g=t("./src/utils/mediasource-helper.ts");function v(){return self.SourceBuffer||self.WebKitSourceBuffer}function l(){var b=Object(g.getMediaSource)();if(!b)return!1;var C=v(),L=b&&typeof b.isTypeSupported=="function"&&b.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),m=!C||C.prototype&&typeof C.prototype.appendBuffer=="function"&&typeof C.prototype.remove=="function";return!!L&&!!m}function P(){var b,C=v();return typeof(C==null||(b=C.prototype)===null||b===void 0?void 0:b.changeType)=="function"}},"./src/loader/fragment-loader.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return S}),t.d(e,"LoadError",function(){return I});var g=t("./src/polyfills/number.ts"),v=t("./src/errors.ts");function l(s,r){s.prototype=Object.create(r.prototype),s.prototype.constructor=s,m(s,r)}function P(s){var r=typeof Map=="function"?new Map:void 0;return P=function(a){if(a===null||!L(a))return a;if(typeof a!="function")throw new TypeError("Super expression must either be null or a function");if(typeof r!="undefined"){if(r.has(a))return r.get(a);r.set(a,p)}function p(){return b(a,arguments,A(this).constructor)}return p.prototype=Object.create(a.prototype,{constructor:{value:p,enumerable:!1,writable:!0,configurable:!0}}),m(p,a)},P(s)}function b(s,r,n){return C()?b=Reflect.construct:b=function(p,f,h){var x=[null];x.push.apply(x,f);var E=Function.bind.apply(p,x),c=new E;return h&&m(c,h.prototype),c},b.apply(null,arguments)}function C(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(s){return!1}}function L(s){return Function.toString.call(s).indexOf("[native code]")!==-1}function m(s,r){return m=Object.setPrototypeOf||function(a,p){return a.__proto__=p,a},m(s,r)}function A(s){return A=Object.setPrototypeOf?Object.getPrototypeOf:function(n){return n.__proto__||Object.getPrototypeOf(n)},A(s)}var D=Math.pow(2,17),S=function(){function s(n){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=n}var r=s.prototype;return r.destroy=function(){this.loader&&(this.loader.destroy(),this.loader=null)},r.abort=function(){this.loader&&this.loader.abort()},r.load=function(a,p){var f=this,h=a.url;if(!h)return Promise.reject(new I({type:v.ErrorTypes.NETWORK_ERROR,details:v.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:a,networkDetails:null},"Fragment does not have a "+(h?"part list":"url")));this.abort();var x=this.config,E=x.fLoader,c=x.loader;return new Promise(function(u,o){f.loader&&f.loader.destroy();var d=f.loader=a.loader=E?new E(x):new c(x),T=O(a),y={timeout:x.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:x.fragLoadingMaxRetryTimeout,highWaterMark:D};a.stats=d.stats,d.load(T,y,{onSuccess:function(M,_,F,B){f.resetLoader(a,d),u({frag:a,part:null,payload:M.data,networkDetails:B})},onError:function(M,_,F){f.resetLoader(a,d),o(new I({type:v.ErrorTypes.NETWORK_ERROR,details:v.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:a,response:M,networkDetails:F}))},onAbort:function(M,_,F){f.resetLoader(a,d),o(new I({type:v.ErrorTypes.NETWORK_ERROR,details:v.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:a,networkDetails:F}))},onTimeout:function(M,_,F){f.resetLoader(a,d),o(new I({type:v.ErrorTypes.NETWORK_ERROR,details:v.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:a,networkDetails:F}))},onProgress:function(M,_,F,B){p&&p({frag:a,part:null,payload:F,networkDetails:B})}})})},r.loadPart=function(a,p,f){var h=this;this.abort();var x=this.config,E=x.fLoader,c=x.loader;return new Promise(function(u,o){h.loader&&h.loader.destroy();var d=h.loader=a.loader=E?new E(x):new c(x),T=O(a,p),y={timeout:x.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:x.fragLoadingMaxRetryTimeout,highWaterMark:D};p.stats=d.stats,d.load(T,y,{onSuccess:function(M,_,F,B){h.resetLoader(a,d),h.updateStatsFromPart(a,p);var w={frag:a,part:p,payload:M.data,networkDetails:B};f(w),u(w)},onError:function(M,_,F){h.resetLoader(a,d),o(new I({type:v.ErrorTypes.NETWORK_ERROR,details:v.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:a,part:p,response:M,networkDetails:F}))},onAbort:function(M,_,F){a.stats.aborted=p.stats.aborted,h.resetLoader(a,d),o(new I({type:v.ErrorTypes.NETWORK_ERROR,details:v.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:a,part:p,networkDetails:F}))},onTimeout:function(M,_,F){h.resetLoader(a,d),o(new I({type:v.ErrorTypes.NETWORK_ERROR,details:v.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:a,part:p,networkDetails:F}))}})})},r.updateStatsFromPart=function(a,p){var f=a.stats,h=p.stats,x=h.total;if(f.loaded+=h.loaded,x){var E=Math.round(a.duration/p.duration),c=Math.min(Math.round(f.loaded/x),E),u=E-c,o=u*Math.round(f.loaded/c);f.total=f.loaded+o}else f.total=Math.max(f.loaded,f.total);var d=f.loading,T=h.loading;d.start?d.first+=T.first-T.start:(d.start=T.start,d.first=T.first),d.end=T.end},r.resetLoader=function(a,p){a.loader=null,this.loader===p&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),p.destroy()},s}();function O(s,r){r===void 0&&(r=null);var n=r||s,a={frag:s,part:r,responseType:"arraybuffer",url:n.url,rangeStart:0,rangeEnd:0},p=n.byteRangeStartOffset,f=n.byteRangeEndOffset;return Object(g.isFiniteNumber)(p)&&Object(g.isFiniteNumber)(f)&&(a.rangeStart=p,a.rangeEnd=f),a}var I=function(s){l(r,s);function r(n){for(var a,p=arguments.length,f=new Array(p>1?p-1:0),h=1;h<p;h++)f[h-1]=arguments[h];return a=s.call.apply(s,[this].concat(f))||this,a.data=void 0,a.data=n,a}return r}(P(Error))},"./src/loader/fragment.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"ElementaryStreamTypes",function(){return S}),t.d(e,"BaseSegment",function(){return O}),t.d(e,"Fragment",function(){return I}),t.d(e,"Part",function(){return s});var g=t("./src/polyfills/number.ts"),v=t("./node_modules/url-toolkit/src/url-toolkit.js"),l=t.n(v),P=t("./src/utils/logger.ts"),b=t("./src/loader/level-key.ts"),C=t("./src/loader/load-stats.ts");function L(r,n){r.prototype=Object.create(n.prototype),r.prototype.constructor=r,m(r,n)}function m(r,n){return m=Object.setPrototypeOf||function(p,f){return p.__proto__=f,p},m(r,n)}function A(r,n){for(var a=0;a<n.length;a++){var p=n[a];p.enumerable=p.enumerable||!1,p.configurable=!0,"value"in p&&(p.writable=!0),Object.defineProperty(r,p.key,p)}}function D(r,n,a){return n&&A(r.prototype,n),a&&A(r,a),r}var S;(function(r){r.AUDIO="audio",r.VIDEO="video",r.AUDIOVIDEO="audiovideo"})(S||(S={}));var O=function(){function r(a){var p;this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams=(p={},p[S.AUDIO]=null,p[S.VIDEO]=null,p[S.AUDIOVIDEO]=null,p),this.baseurl=a}var n=r.prototype;return n.setByteRange=function(p,f){var h=p.split("@",2),x=[];h.length===1?x[0]=f?f.byteRangeEndOffset:0:x[0]=parseInt(h[1]),x[1]=parseInt(h[0])+x[0],this._byteRange=x},D(r,[{key:"byteRange",get:function(){return this._byteRange?this._byteRange:[]}},{key:"byteRangeStartOffset",get:function(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function(){return this.byteRange[1]}},{key:"url",get:function(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Object(v.buildAbsoluteURL)(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function(p){this._url=p}}]),r}(),I=function(r){L(n,r);function n(p,f){var h;return h=r.call(this,f)||this,h._decryptdata=null,h.rawProgramDateTime=null,h.programDateTime=null,h.tagList=[],h.duration=0,h.sn=0,h.levelkey=void 0,h.type=void 0,h.loader=null,h.level=-1,h.cc=0,h.startPTS=void 0,h.endPTS=void 0,h.appendedPTS=void 0,h.startDTS=void 0,h.endDTS=void 0,h.start=0,h.deltaPTS=void 0,h.maxStartPTS=void 0,h.minEndPTS=void 0,h.stats=new C.LoadStats,h.urlId=0,h.data=void 0,h.bitrateTest=!1,h.title=null,h.initSegment=null,h.type=p,h}var a=n.prototype;return a.createInitializationVector=function(f){for(var h=new Uint8Array(16),x=12;x<16;x++)h[x]=f>>8*(15-x)&255;return h},a.setDecryptDataFromLevelKey=function(f,h){var x=f;return(f==null?void 0:f.method)==="AES-128"&&f.uri&&!f.iv&&(x=b.LevelKey.fromURI(f.uri),x.method=f.method,x.iv=this.createInitializationVector(h),x.keyFormat="identity"),x},a.setElementaryStreamInfo=function(f,h,x,E,c,u){u===void 0&&(u=!1);var o=this.elementaryStreams,d=o[f];if(!d){o[f]={startPTS:h,endPTS:x,startDTS:E,endDTS:c,partial:u};return}d.startPTS=Math.min(d.startPTS,h),d.endPTS=Math.max(d.endPTS,x),d.startDTS=Math.min(d.startDTS,E),d.endDTS=Math.max(d.endDTS,c)},a.clearElementaryStreamInfo=function(){var f=this.elementaryStreams;f[S.AUDIO]=null,f[S.VIDEO]=null,f[S.AUDIOVIDEO]=null},D(n,[{key:"decryptdata",get:function(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){var f=this.sn;typeof f!="number"&&(this.levelkey&&this.levelkey.method==="AES-128"&&!this.levelkey.iv&&P.logger.warn('missing IV for initialization segment with method="'+this.levelkey.method+'" - compliance issue'),f=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,f)}return this._decryptdata}},{key:"end",get:function(){return this.start+this.duration}},{key:"endProgramDateTime",get:function(){if(this.programDateTime===null||!Object(g.isFiniteNumber)(this.programDateTime))return null;var f=Object(g.isFiniteNumber)(this.duration)?this.duration:0;return this.programDateTime+f*1e3}},{key:"encrypted",get:function(){var f;return!!((f=this.decryptdata)!==null&&f!==void 0&&f.keyFormat&&this.decryptdata.uri)}}]),n}(O),s=function(r){L(n,r);function n(a,p,f,h,x){var E;E=r.call(this,f)||this,E.fragOffset=0,E.duration=0,E.gap=!1,E.independent=!1,E.relurl=void 0,E.fragment=void 0,E.index=void 0,E.stats=new C.LoadStats,E.duration=a.decimalFloatingPoint("DURATION"),E.gap=a.bool("GAP"),E.independent=a.bool("INDEPENDENT"),E.relurl=a.enumeratedString("URI"),E.fragment=p,E.index=h;var c=a.enumeratedString("BYTERANGE");return c&&E.setByteRange(c,x),x&&(E.fragOffset=x.fragOffset+x.duration),E}return D(n,[{key:"start",get:function(){return this.fragment.start+this.fragOffset}},{key:"end",get:function(){return this.start+this.duration}},{key:"loaded",get:function(){var p=this.elementaryStreams;return!!(p.audio||p.video||p.audiovideo)}}]),n}(O)},"./src/loader/key-loader.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return P});var g=t("./src/events.ts"),v=t("./src/errors.ts"),l=t("./src/utils/logger.ts"),P=function(){function b(L){this.hls=void 0,this.loaders={},this.decryptkey=null,this.decrypturl=null,this.hls=L,this._registerListeners()}var C=b.prototype;return C._registerListeners=function(){this.hls.on(g.Events.KEY_LOADING,this.onKeyLoading,this)},C._unregisterListeners=function(){this.hls.off(g.Events.KEY_LOADING,this.onKeyLoading)},C.destroy=function(){this._unregisterListeners();for(var m in this.loaders){var A=this.loaders[m];A&&A.destroy()}this.loaders={}},C.onKeyLoading=function(m,A){var D=A.frag,S=D.type,O=this.loaders[S];if(!D.decryptdata){l.logger.warn("Missing decryption data on fragment in onKeyLoading");return}var I=D.decryptdata.uri;if(I!==this.decrypturl||this.decryptkey===null){var s=this.hls.config;if(O&&(l.logger.warn("abort previous key loader for type:"+S),O.abort()),!I){l.logger.warn("key uri is falsy");return}var r=s.loader,n=D.loader=this.loaders[S]=new r(s);this.decrypturl=I,this.decryptkey=null;var a={url:I,frag:D,responseType:"arraybuffer"},p={timeout:s.fragLoadingTimeOut,maxRetry:0,retryDelay:s.fragLoadingRetryDelay,maxRetryDelay:s.fragLoadingMaxRetryTimeout,highWaterMark:0},f={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};n.load(a,p,f)}else this.decryptkey&&(D.decryptdata.key=this.decryptkey,this.hls.trigger(g.Events.KEY_LOADED,{frag:D}))},C.loadsuccess=function(m,A,D){var S=D.frag;if(!S.decryptdata){l.logger.error("after key load, decryptdata unset");return}this.decryptkey=S.decryptdata.key=new Uint8Array(m.data),S.loader=null,delete this.loaders[S.type],this.hls.trigger(g.Events.KEY_LOADED,{frag:S})},C.loaderror=function(m,A){var D=A.frag,S=D.loader;S&&S.abort(),delete this.loaders[D.type],this.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.NETWORK_ERROR,details:v.ErrorDetails.KEY_LOAD_ERROR,fatal:!1,frag:D,response:m})},C.loadtimeout=function(m,A){var D=A.frag,S=D.loader;S&&S.abort(),delete this.loaders[D.type],this.hls.trigger(g.Events.ERROR,{type:v.ErrorTypes.NETWORK_ERROR,details:v.ErrorDetails.KEY_LOAD_TIMEOUT,fatal:!1,frag:D})},b}()},"./src/loader/level-details.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"LevelDetails",function(){return b});var g=t("./src/polyfills/number.ts");function v(C,L){for(var m=0;m<L.length;m++){var A=L[m];A.enumerable=A.enumerable||!1,A.configurable=!0,"value"in A&&(A.writable=!0),Object.defineProperty(C,A.key,A)}}function l(C,L,m){return L&&v(C.prototype,L),m&&v(C,m),C}var P=10,b=function(){function C(m){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.fragments=[],this.url=m}var L=C.prototype;return L.reloaded=function(A){if(!A){this.advanced=!0,this.updated=!0;return}var D=this.lastPartSn-A.lastPartSn,S=this.lastPartIndex-A.lastPartIndex;this.updated=this.endSN!==A.endSN||!!S||!!D,this.advanced=this.endSN>A.endSN||D>0||D===0&&S>0,this.updated||this.advanced?this.misses=Math.floor(A.misses*.6):this.misses=A.misses+1,this.availabilityDelay=A.availabilityDelay},l(C,[{key:"hasProgramDateTime",get:function(){return this.fragments.length?Object(g.isFiniteNumber)(this.fragments[this.fragments.length-1].programDateTime):!1}},{key:"levelTargetDuration",get:function(){return this.averagetargetduration||this.targetduration||P}},{key:"drift",get:function(){var A=this.driftEndTime-this.driftStartTime;if(A>0){var D=this.driftEnd-this.driftStart;return D*1e3/A}return 1}},{key:"edge",get:function(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function(){var A;return(A=this.partList)!==null&&A!==void 0&&A.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function(){var A;return(A=this.fragments)!==null&&A!==void 0&&A.length?this.fragments[this.fragments.length-1].end:0}},{key:"age",get:function(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function(){var A;return(A=this.partList)!==null&&A!==void 0&&A.length?this.partList[this.partList.length-1].index:-1}},{key:"lastPartSn",get:function(){var A;return(A=this.partList)!==null&&A!==void 0&&A.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}]),C}()},"./src/loader/level-key.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"LevelKey",function(){return b});var g=t("./node_modules/url-toolkit/src/url-toolkit.js"),v=t.n(g);function l(C,L){for(var m=0;m<L.length;m++){var A=L[m];A.enumerable=A.enumerable||!1,A.configurable=!0,"value"in A&&(A.writable=!0),Object.defineProperty(C,A.key,A)}}function P(C,L,m){return L&&l(C.prototype,L),m&&l(C,m),C}var b=function(){C.fromURL=function(m,A){return new C(m,A)},C.fromURI=function(m){return new C(m)};function C(L,m){this._uri=null,this.method=null,this.keyFormat=null,this.keyFormatVersions=null,this.keyID=null,this.key=null,this.iv=null,m?this._uri=Object(g.buildAbsoluteURL)(L,m,{alwaysNormalize:!0}):this._uri=L}return P(C,[{key:"uri",get:function(){return this._uri}}]),C}()},"./src/loader/load-stats.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"LoadStats",function(){return g});var g=function(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}},"./src/loader/m3u8-parser.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return n});var g=t("./src/polyfills/number.ts"),v=t("./node_modules/url-toolkit/src/url-toolkit.js"),l=t.n(v),P=t("./src/loader/fragment.ts"),b=t("./src/loader/level-details.ts"),C=t("./src/loader/level-key.ts"),L=t("./src/utils/attr-list.ts"),m=t("./src/utils/logger.ts"),A=t("./src/utils/codecs.ts"),D=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-SESSION-DATA:([^\r\n]*)[\r\n]+/g,S=/#EXT-X-MEDIA:(.*)/g,O=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),I=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(PLAYLIST-TYPE):(.+)/.source,/#EXT-X-(MEDIA-SEQUENCE): *(\d+)/.source,/#EXT-X-(SKIP):(.+)/.source,/#EXT-X-(TARGETDURATION): *(\d+)/.source,/#EXT-X-(KEY):(.+)/.source,/#EXT-X-(START):(.+)/.source,/#EXT-X-(ENDLIST)/.source,/#EXT-X-(DISCONTINUITY-SEQ)UENCE: *(\d+)/.source,/#EXT-X-(DIS)CONTINUITY/.source,/#EXT-X-(VERSION):(\d+)/.source,/#EXT-X-(MAP):(.+)/.source,/#EXT-X-(SERVER-CONTROL):(.+)/.source,/#EXT-X-(PART-INF):(.+)/.source,/#EXT-X-(GAP)/.source,/#EXT-X-(BITRATE):\s*(\d+)/.source,/#EXT-X-(PART):(.+)/.source,/#EXT-X-(PRELOAD-HINT):(.+)/.source,/#EXT-X-(RENDITION-REPORT):(.+)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),s=/\.(mp4|m4s|m4v|m4a)$/i;function r(x){var E,c;return s.test((E=(c=v.parseURL(x))===null||c===void 0?void 0:c.path)!=null?E:"")}var n=function(){function x(){}return x.findGroup=function(c,u){for(var o=0;o<c.length;o++){var d=c[o];if(d.id===u)return d}},x.convertAVC1ToAVCOTI=function(c){var u=c.split(".");if(u.length>2){var o=u.shift()+".";return o+=parseInt(u.shift()).toString(16),o+=("000"+parseInt(u.shift()).toString(16)).substr(-4),o}return c},x.resolve=function(c,u){return v.buildAbsoluteURL(u,c,{alwaysNormalize:!0})},x.parseMasterPlaylist=function(c,u){var o=[],d={},T=!1;D.lastIndex=0;for(var y;(y=D.exec(c))!=null;)if(y[1]){var R=new L.AttrList(y[1]),M={attrs:R,bitrate:R.decimalInteger("AVERAGE-BANDWIDTH")||R.decimalInteger("BANDWIDTH"),name:R.NAME,url:x.resolve(y[2],u)},_=R.decimalResolution("RESOLUTION");_&&(M.width=_.width,M.height=_.height),a((R.CODECS||"").split(/[ ,]+/).filter(function(B){return B}),M),M.videoCodec&&M.videoCodec.indexOf("avc1")!==-1&&(M.videoCodec=x.convertAVC1ToAVCOTI(M.videoCodec)),o.push(M)}else if(y[3]){var F=new L.AttrList(y[3]);F["DATA-ID"]&&(T=!0,d[F["DATA-ID"]]=F)}return{levels:o,sessionData:T?d:null}},x.parseMasterPlaylistMedia=function(c,u,o,d){d===void 0&&(d=[]);var T,y=[],R=0;for(S.lastIndex=0;(T=S.exec(c))!==null;){var M=new L.AttrList(T[1]);if(M.TYPE===o){var _={attrs:M,bitrate:0,id:R++,groupId:M["GROUP-ID"],instreamId:M["INSTREAM-ID"],name:M.NAME||M.LANGUAGE||"",type:o,default:M.bool("DEFAULT"),autoselect:M.bool("AUTOSELECT"),forced:M.bool("FORCED"),lang:M.LANGUAGE,url:M.URI?x.resolve(M.URI,u):""};if(d.length){var F=x.findGroup(d,_.groupId)||d[0];p(_,F,"audioCodec"),p(_,F,"textCodec")}y.push(_)}}return y},x.parseLevelPlaylist=function(c,u,o,d,T){var y=new b.LevelDetails(u),R=y.fragments,M=null,_=0,F=0,B=0,w=0,k=null,U=new P.Fragment(d,u),N,W,K,H=-1,G=!1;for(O.lastIndex=0,y.m3u8=c;(N=O.exec(c))!==null;){G&&(G=!1,U=new P.Fragment(d,u),U.start=B,U.sn=_,U.cc=w,U.level=o,M&&(U.initSegment=M,U.rawProgramDateTime=M.rawProgramDateTime));var V=N[1];if(V){U.duration=parseFloat(V);var X=(" "+N[2]).slice(1);U.title=X||null,U.tagList.push(X?["INF",V,X]:["INF",V])}else if(N[3])Object(g.isFiniteNumber)(U.duration)&&(U.start=B,K&&(U.levelkey=K),U.sn=_,U.level=o,U.cc=w,U.urlId=T,R.push(U),U.relurl=(" "+N[3]).slice(1),h(U,k),k=U,B+=U.duration,_++,F=0,G=!0);else if(N[4]){var z=(" "+N[4]).slice(1);k?U.setByteRange(z,k):U.setByteRange(z)}else if(N[5])U.rawProgramDateTime=(" "+N[5]).slice(1),U.tagList.push(["PROGRAM-DATE-TIME",U.rawProgramDateTime]),H===-1&&(H=R.length);else{if(N=N[0].match(I),!N){m.logger.warn("No matches on slow regex match for level playlist!");continue}for(W=1;W<N.length&&typeof N[W]=="undefined";W++);var $=(" "+N[W]).slice(1),Y=(" "+N[W+1]).slice(1),Q=N[W+2]?(" "+N[W+2]).slice(1):"";switch($){case"PLAYLIST-TYPE":y.type=Y.toUpperCase();break;case"MEDIA-SEQUENCE":_=y.startSN=parseInt(Y);break;case"SKIP":{var ie=new L.AttrList(Y),Z=ie.decimalInteger("SKIPPED-SEGMENTS");if(Object(g.isFiniteNumber)(Z)){y.skippedSegments=Z;for(var ae=Z;ae--;)R.unshift(null);_+=Z}var q=ie.enumeratedString("RECENTLY-REMOVED-DATERANGES");q&&(y.recentlyRemovedDateranges=q.split("	"));break}case"TARGETDURATION":y.targetduration=parseFloat(Y);break;case"VERSION":y.version=parseInt(Y);break;case"EXTM3U":break;case"ENDLIST":y.live=!1;break;case"#":(Y||Q)&&U.tagList.push(Q?[Y,Q]:[Y]);break;case"DIS":w++;case"GAP":U.tagList.push([$]);break;case"BITRATE":U.tagList.push([$,Y]);break;case"DISCONTINUITY-SEQ":w=parseInt(Y);break;case"KEY":{var ne,se=new L.AttrList(Y),fe=se.enumeratedString("METHOD"),le=se.URI,ce=se.hexadecimalInteger("IV"),pe=se.enumeratedString("KEYFORMATVERSIONS"),re=se.enumeratedString("KEYID"),he=(ne=se.enumeratedString("KEYFORMAT"))!=null?ne:"identity",De=["com.apple.streamingkeydelivery","com.microsoft.playready","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed","com.widevine"];if(De.indexOf(he)>-1){m.logger.warn("Keyformat "+he+" is not supported from the manifest");continue}else if(he!=="identity")continue;fe&&(K=C.LevelKey.fromURL(u,le),le&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(fe)>=0&&(K.method=fe,K.keyFormat=he,re&&(K.keyID=re),pe&&(K.keyFormatVersions=pe),K.iv=ce));break}case"START":{var Pe=new L.AttrList(Y),Te=Pe.decimalFloatingPoint("TIME-OFFSET");Object(g.isFiniteNumber)(Te)&&(y.startTimeOffset=Te);break}case"MAP":{var Ae=new L.AttrList(Y);U.relurl=Ae.URI,Ae.BYTERANGE&&U.setByteRange(Ae.BYTERANGE),U.level=o,U.sn="initSegment",K&&(U.levelkey=K),U.initSegment=null,M=U,G=!0;break}case"SERVER-CONTROL":{var ve=new L.AttrList(Y);y.canBlockReload=ve.bool("CAN-BLOCK-RELOAD"),y.canSkipUntil=ve.optionalFloat("CAN-SKIP-UNTIL",0),y.canSkipDateRanges=y.canSkipUntil>0&&ve.bool("CAN-SKIP-DATERANGES"),y.partHoldBack=ve.optionalFloat("PART-HOLD-BACK",0),y.holdBack=ve.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{var we=new L.AttrList(Y);y.partTarget=we.decimalFloatingPoint("PART-TARGET");break}case"PART":{var oe=y.partList;oe||(oe=y.partList=[]);var xe=F>0?oe[oe.length-1]:void 0,ze=F++,be=new P.Part(new L.AttrList(Y),U,u,ze,xe);oe.push(be),U.duration+=be.duration;break}case"PRELOAD-HINT":{var Me=new L.AttrList(Y);y.preloadHint=Me;break}case"RENDITION-REPORT":{var ot=new L.AttrList(Y);y.renditionReports=y.renditionReports||[],y.renditionReports.push(ot);break}default:m.logger.warn("line parsed but not handled: "+N);break}}}k&&!k.relurl?(R.pop(),B-=k.duration,y.partList&&(y.fragmentHint=k)):y.partList&&(h(U,k),U.cc=w,y.fragmentHint=U);var _e=R.length,Ee=R[0],Ue=R[_e-1];if(B+=y.skippedSegments*y.targetduration,B>0&&_e&&Ue){y.averagetargetduration=B/_e;var lt=Ue.sn;y.endSN=lt!=="initSegment"?lt:0,Ee&&(y.startCC=Ee.cc,Ee.initSegment||y.fragments.every(function(ke){return ke.relurl&&r(ke.relurl)})&&(m.logger.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),U=new P.Fragment(d,u),U.relurl=Ue.relurl,U.level=o,U.sn="initSegment",Ee.initSegment=U,y.needSidxRanges=!0))}else y.endSN=0,y.startCC=0;return y.fragmentHint&&(B+=y.fragmentHint.duration),y.totalduration=B,y.endCC=w,H>0&&f(R,H),y},x}();function a(x,E){["video","audio","text"].forEach(function(c){var u=x.filter(function(d){return Object(A.isCodecType)(d,c)});if(u.length){var o=u.filter(function(d){return d.lastIndexOf("avc1",0)===0||d.lastIndexOf("mp4a",0)===0});E[c+"Codec"]=o.length>0?o[0]:u[0],x=x.filter(function(d){return u.indexOf(d)===-1})}}),E.unknownCodecs=x}function p(x,E,c){var u=E[c];u&&(x[c]=u)}function f(x,E){for(var c=x[E],u=E;u--;){var o=x[u];if(!o)return;o.programDateTime=c.programDateTime-o.duration*1e3,c=o}}function h(x,E){x.rawProgramDateTime?x.programDateTime=Date.parse(x.rawProgramDateTime):E!=null&&E.programDateTime&&(x.programDateTime=E.endProgramDateTime),Object(g.isFiniteNumber)(x.programDateTime)||(x.programDateTime=null,x.rawProgramDateTime=null)}},"./src/loader/playlist-loader.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/polyfills/number.ts"),v=t("./src/events.ts"),l=t("./src/errors.ts"),P=t("./src/utils/logger.ts"),b=t("./src/utils/mp4-tools.ts"),C=t("./src/loader/m3u8-parser.ts"),L=t("./src/types/loader.ts"),m=t("./src/utils/attr-list.ts");function A(O){var I=O.type;switch(I){case L.PlaylistContextType.AUDIO_TRACK:return L.PlaylistLevelType.AUDIO;case L.PlaylistContextType.SUBTITLE_TRACK:return L.PlaylistLevelType.SUBTITLE;default:return L.PlaylistLevelType.MAIN}}function D(O,I){var s=O.url;return(s===void 0||s.indexOf("data:")===0)&&(s=I.url),s}var S=function(){function O(s){this.hls=void 0,this.loaders=Object.create(null),this.hls=s,this.registerListeners()}var I=O.prototype;return I.registerListeners=function(){var r=this.hls;r.on(v.Events.MANIFEST_LOADING,this.onManifestLoading,this),r.on(v.Events.LEVEL_LOADING,this.onLevelLoading,this),r.on(v.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),r.on(v.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},I.unregisterListeners=function(){var r=this.hls;r.off(v.Events.MANIFEST_LOADING,this.onManifestLoading,this),r.off(v.Events.LEVEL_LOADING,this.onLevelLoading,this),r.off(v.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),r.off(v.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},I.createInternalLoader=function(r){var n=this.hls.config,a=n.pLoader,p=n.loader,f=a||p,h=new f(n);return r.loader=h,this.loaders[r.type]=h,h},I.getInternalLoader=function(r){return this.loaders[r.type]},I.resetInternalLoader=function(r){this.loaders[r]&&delete this.loaders[r]},I.destroyInternalLoaders=function(){for(var r in this.loaders){var n=this.loaders[r];n&&n.destroy(),this.resetInternalLoader(r)}},I.destroy=function(){this.unregisterListeners(),this.destroyInternalLoaders()},I.onManifestLoading=function(r,n){var a=n.url;this.load({id:null,groupId:null,level:0,responseType:"text",type:L.PlaylistContextType.MANIFEST,url:a,deliveryDirectives:null})},I.onLevelLoading=function(r,n){var a=n.id,p=n.level,f=n.url,h=n.deliveryDirectives;this.load({id:a,groupId:null,level:p,responseType:"text",type:L.PlaylistContextType.LEVEL,url:f,deliveryDirectives:h})},I.onAudioTrackLoading=function(r,n){var a=n.id,p=n.groupId,f=n.url,h=n.deliveryDirectives;this.load({id:a,groupId:p,level:null,responseType:"text",type:L.PlaylistContextType.AUDIO_TRACK,url:f,deliveryDirectives:h})},I.onSubtitleTrackLoading=function(r,n){var a=n.id,p=n.groupId,f=n.url,h=n.deliveryDirectives;this.load({id:a,groupId:p,level:null,responseType:"text",type:L.PlaylistContextType.SUBTITLE_TRACK,url:f,deliveryDirectives:h})},I.load=function(r){var n,a=this.hls.config,p=this.getInternalLoader(r);if(p){var f=p.context;if(f&&f.url===r.url){P.logger.trace("[playlist-loader]: playlist request ongoing");return}P.logger.log("[playlist-loader]: aborting previous loader for type: "+r.type),p.abort()}var h,x,E,c;switch(r.type){case L.PlaylistContextType.MANIFEST:h=a.manifestLoadingMaxRetry,x=a.manifestLoadingTimeOut,E=a.manifestLoadingRetryDelay,c=a.manifestLoadingMaxRetryTimeout;break;case L.PlaylistContextType.LEVEL:case L.PlaylistContextType.AUDIO_TRACK:case L.PlaylistContextType.SUBTITLE_TRACK:h=0,x=a.levelLoadingTimeOut;break;default:h=a.levelLoadingMaxRetry,x=a.levelLoadingTimeOut,E=a.levelLoadingRetryDelay,c=a.levelLoadingMaxRetryTimeout;break}if(p=this.createInternalLoader(r),(n=r.deliveryDirectives)!==null&&n!==void 0&&n.part){var u;if(r.type===L.PlaylistContextType.LEVEL&&r.level!==null?u=this.hls.levels[r.level].details:r.type===L.PlaylistContextType.AUDIO_TRACK&&r.id!==null?u=this.hls.audioTracks[r.id].details:r.type===L.PlaylistContextType.SUBTITLE_TRACK&&r.id!==null&&(u=this.hls.subtitleTracks[r.id].details),u){var o=u.partTarget,d=u.targetduration;o&&d&&(x=Math.min(Math.max(o*3,d*.8)*1e3,x))}}var T={timeout:x,maxRetry:h,retryDelay:E,maxRetryDelay:c,highWaterMark:0},y={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};p.load(r,T,y)},I.loadsuccess=function(r,n,a,p){if(p===void 0&&(p=null),a.isSidxRequest){this.handleSidxRequest(r,a),this.handlePlaylistLoaded(r,n,a,p);return}this.resetInternalLoader(a.type);var f=r.data;if(f.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(r,a,"no EXTM3U delimiter",p);return}n.parsing.start=performance.now(),f.indexOf("#EXTINF:")>0||f.indexOf("#EXT-X-TARGETDURATION:")>0?this.handleTrackOrLevelPlaylist(r,n,a,p):this.handleMasterPlaylist(r,n,a,p)},I.loaderror=function(r,n,a){a===void 0&&(a=null),this.handleNetworkError(n,a,!1,r)},I.loadtimeout=function(r,n,a){a===void 0&&(a=null),this.handleNetworkError(n,a,!0)},I.handleMasterPlaylist=function(r,n,a,p){var f=this.hls,h=r.data,x=D(r,a),E=C.default.parseMasterPlaylist(h,x),c=E.levels,u=E.sessionData;if(!c.length){this.handleManifestParsingError(r,a,"no level found in manifest",p);return}var o=c.map(function(_){return{id:_.attrs.AUDIO,audioCodec:_.audioCodec}}),d=c.map(function(_){return{id:_.attrs.SUBTITLES,textCodec:_.textCodec}}),T=C.default.parseMasterPlaylistMedia(h,x,"AUDIO",o),y=C.default.parseMasterPlaylistMedia(h,x,"SUBTITLES",d),R=C.default.parseMasterPlaylistMedia(h,x,"CLOSED-CAPTIONS");if(T.length){var M=T.some(function(_){return!_.url});!M&&c[0].audioCodec&&!c[0].attrs.AUDIO&&(P.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),T.unshift({type:"main",name:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new m.AttrList({}),bitrate:0,url:""}))}f.trigger(v.Events.MANIFEST_LOADED,{levels:c,audioTracks:T,subtitles:y,captions:R,url:x,stats:n,networkDetails:p,sessionData:u})},I.handleTrackOrLevelPlaylist=function(r,n,a,p){var f=this.hls,h=a.id,x=a.level,E=a.type,c=D(r,a),u=Object(g.isFiniteNumber)(h)?h:0,o=Object(g.isFiniteNumber)(x)?x:u,d=A(a),T=C.default.parseLevelPlaylist(r.data,c,o,d,u);if(!T.fragments.length){f.trigger(v.Events.ERROR,{type:l.ErrorTypes.NETWORK_ERROR,details:l.ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url:c,reason:"no fragments found in level",level:typeof a.level=="number"?a.level:void 0});return}if(E===L.PlaylistContextType.MANIFEST){var y={attrs:new m.AttrList({}),bitrate:0,details:T,name:"",url:c};f.trigger(v.Events.MANIFEST_LOADED,{levels:[y],audioTracks:[],url:c,stats:n,networkDetails:p,sessionData:null})}if(n.parsing.end=performance.now(),T.needSidxRanges){var R,M=(R=T.fragments[0].initSegment)===null||R===void 0?void 0:R.url;this.load({url:M,isSidxRequest:!0,type:E,level:x,levelDetails:T,id:h,groupId:null,rangeStart:0,rangeEnd:2048,responseType:"arraybuffer",deliveryDirectives:null});return}a.levelDetails=T,this.handlePlaylistLoaded(r,n,a,p)},I.handleSidxRequest=function(r,n){var a=Object(b.parseSegmentIndex)(new Uint8Array(r.data));if(!!a){var p=a.references,f=n.levelDetails;p.forEach(function(h,x){var E=h.info,c=f.fragments[x];c.byteRange.length===0&&c.setByteRange(String(1+E.end-E.start)+"@"+String(E.start)),c.initSegment&&c.initSegment.setByteRange(String(a.moovEndOffset)+"@0")})}},I.handleManifestParsingError=function(r,n,a,p){this.hls.trigger(v.Events.ERROR,{type:l.ErrorTypes.NETWORK_ERROR,details:l.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:n.type===L.PlaylistContextType.MANIFEST,url:r.url,reason:a,response:r,context:n,networkDetails:p})},I.handleNetworkError=function(r,n,a,p){a===void 0&&(a=!1),P.logger.warn("[playlist-loader]: A network "+(a?"timeout":"error")+" occurred while loading "+r.type+" level: "+r.level+" id: "+r.id+' group-id: "'+r.groupId+'"');var f=l.ErrorDetails.UNKNOWN,h=!1,x=this.getInternalLoader(r);switch(r.type){case L.PlaylistContextType.MANIFEST:f=a?l.ErrorDetails.MANIFEST_LOAD_TIMEOUT:l.ErrorDetails.MANIFEST_LOAD_ERROR,h=!0;break;case L.PlaylistContextType.LEVEL:f=a?l.ErrorDetails.LEVEL_LOAD_TIMEOUT:l.ErrorDetails.LEVEL_LOAD_ERROR,h=!1;break;case L.PlaylistContextType.AUDIO_TRACK:f=a?l.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:l.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,h=!1;break;case L.PlaylistContextType.SUBTITLE_TRACK:f=a?l.ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:l.ErrorDetails.SUBTITLE_LOAD_ERROR,h=!1;break}x&&this.resetInternalLoader(r.type);var E={type:l.ErrorTypes.NETWORK_ERROR,details:f,fatal:h,url:r.url,loader:x,context:r,networkDetails:n};p&&(E.response=p),this.hls.trigger(v.Events.ERROR,E)},I.handlePlaylistLoaded=function(r,n,a,p){var f=a.type,h=a.level,x=a.id,E=a.groupId,c=a.loader,u=a.levelDetails,o=a.deliveryDirectives;if(!(u!=null&&u.targetduration)){this.handleManifestParsingError(r,a,"invalid target duration",p);return}if(!!c)switch(u.live&&(c.getCacheAge&&(u.ageHeader=c.getCacheAge()||0),(!c.getCacheAge||isNaN(u.ageHeader))&&(u.ageHeader=0)),f){case L.PlaylistContextType.MANIFEST:case L.PlaylistContextType.LEVEL:this.hls.trigger(v.Events.LEVEL_LOADED,{details:u,level:h||0,id:x||0,stats:n,networkDetails:p,deliveryDirectives:o});break;case L.PlaylistContextType.AUDIO_TRACK:this.hls.trigger(v.Events.AUDIO_TRACK_LOADED,{details:u,id:x||0,groupId:E||"",stats:n,networkDetails:p,deliveryDirectives:o});break;case L.PlaylistContextType.SUBTITLE_TRACK:this.hls.trigger(v.Events.SUBTITLE_TRACK_LOADED,{details:u,id:x||0,groupId:E||"",stats:n,networkDetails:p,deliveryDirectives:o});break}},O}();e.default=S},"./src/polyfills/number.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"isFiniteNumber",function(){return g}),t.d(e,"MAX_SAFE_INTEGER",function(){return v});var g=Number.isFinite||function(l){return typeof l=="number"&&isFinite(l)},v=Number.MAX_SAFE_INTEGER||9007199254740991},"./src/remux/aac-helper.ts":function(i,e,t){"use strict";t.r(e);var g=function(){function v(){}return v.getSilentFrame=function(P,b){switch(P){case"mp4a.40.2":if(b===1)return new Uint8Array([0,200,0,128,35,128]);if(b===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(b===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(b===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(b===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(b===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(b===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(b===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(b===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}},v}();e.default=g},"./src/remux/mp4-generator.ts":function(i,e,t){"use strict";t.r(e);var g=Math.pow(2,32)-1,v=function(){function l(){}return l.init=function(){l.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var b;for(b in l.types)l.types.hasOwnProperty(b)&&(l.types[b]=[b.charCodeAt(0),b.charCodeAt(1),b.charCodeAt(2),b.charCodeAt(3)]);var C=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),L=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);l.HDLR_TYPES={video:C,audio:L};var m=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),A=new Uint8Array([0,0,0,0,0,0,0,0]);l.STTS=l.STSC=l.STCO=A,l.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),l.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),l.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),l.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var D=new Uint8Array([105,115,111,109]),S=new Uint8Array([97,118,99,49]),O=new Uint8Array([0,0,0,1]);l.FTYP=l.box(l.types.ftyp,D,O,D,S),l.DINF=l.box(l.types.dinf,l.box(l.types.dref,m))},l.box=function(b){for(var C=8,L=arguments.length,m=new Array(L>1?L-1:0),A=1;A<L;A++)m[A-1]=arguments[A];for(var D=m.length,S=D;D--;)C+=m[D].byteLength;var O=new Uint8Array(C);for(O[0]=C>>24&255,O[1]=C>>16&255,O[2]=C>>8&255,O[3]=C&255,O.set(b,4),D=0,C=8;D<S;D++)O.set(m[D],C),C+=m[D].byteLength;return O},l.hdlr=function(b){return l.box(l.types.hdlr,l.HDLR_TYPES[b])},l.mdat=function(b){return l.box(l.types.mdat,b)},l.mdhd=function(b,C){C*=b;var L=Math.floor(C/(g+1)),m=Math.floor(C%(g+1));return l.box(l.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,b>>24&255,b>>16&255,b>>8&255,b&255,L>>24,L>>16&255,L>>8&255,L&255,m>>24,m>>16&255,m>>8&255,m&255,85,196,0,0]))},l.mdia=function(b){return l.box(l.types.mdia,l.mdhd(b.timescale,b.duration),l.hdlr(b.type),l.minf(b))},l.mfhd=function(b){return l.box(l.types.mfhd,new Uint8Array([0,0,0,0,b>>24,b>>16&255,b>>8&255,b&255]))},l.minf=function(b){return b.type==="audio"?l.box(l.types.minf,l.box(l.types.smhd,l.SMHD),l.DINF,l.stbl(b)):l.box(l.types.minf,l.box(l.types.vmhd,l.VMHD),l.DINF,l.stbl(b))},l.moof=function(b,C,L){return l.box(l.types.moof,l.mfhd(b),l.traf(L,C))},l.moov=function(b){for(var C=b.length,L=[];C--;)L[C]=l.trak(b[C]);return l.box.apply(null,[l.types.moov,l.mvhd(b[0].timescale,b[0].duration)].concat(L).concat(l.mvex(b)))},l.mvex=function(b){for(var C=b.length,L=[];C--;)L[C]=l.trex(b[C]);return l.box.apply(null,[l.types.mvex].concat(L))},l.mvhd=function(b,C){C*=b;var L=Math.floor(C/(g+1)),m=Math.floor(C%(g+1)),A=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,b>>24&255,b>>16&255,b>>8&255,b&255,L>>24,L>>16&255,L>>8&255,L&255,m>>24,m>>16&255,m>>8&255,m&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return l.box(l.types.mvhd,A)},l.sdtp=function(b){var C=b.samples||[],L=new Uint8Array(4+C.length),m,A;for(m=0;m<C.length;m++)A=C[m].flags,L[m+4]=A.dependsOn<<4|A.isDependedOn<<2|A.hasRedundancy;return l.box(l.types.sdtp,L)},l.stbl=function(b){return l.box(l.types.stbl,l.stsd(b),l.box(l.types.stts,l.STTS),l.box(l.types.stsc,l.STSC),l.box(l.types.stsz,l.STSZ),l.box(l.types.stco,l.STCO))},l.avc1=function(b){var C=[],L=[],m,A,D;for(m=0;m<b.sps.length;m++)A=b.sps[m],D=A.byteLength,C.push(D>>>8&255),C.push(D&255),C=C.concat(Array.prototype.slice.call(A));for(m=0;m<b.pps.length;m++)A=b.pps[m],D=A.byteLength,L.push(D>>>8&255),L.push(D&255),L=L.concat(Array.prototype.slice.call(A));var S=l.box(l.types.avcC,new Uint8Array([1,C[3],C[4],C[5],252|3,224|b.sps.length].concat(C).concat([b.pps.length]).concat(L))),O=b.width,I=b.height,s=b.pixelRatio[0],r=b.pixelRatio[1];return l.box(l.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,O>>8&255,O&255,I>>8&255,I&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),S,l.box(l.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),l.box(l.types.pasp,new Uint8Array([s>>24,s>>16&255,s>>8&255,s&255,r>>24,r>>16&255,r>>8&255,r&255])))},l.esds=function(b){var C=b.config.length;return new Uint8Array([0,0,0,0,3,23+C,0,1,0,4,15+C,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([C]).concat(b.config).concat([6,1,2]))},l.mp4a=function(b){var C=b.samplerate;return l.box(l.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,b.channelCount,0,16,0,0,0,0,C>>8&255,C&255,0,0]),l.box(l.types.esds,l.esds(b)))},l.mp3=function(b){var C=b.samplerate;return l.box(l.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,b.channelCount,0,16,0,0,0,0,C>>8&255,C&255,0,0]))},l.stsd=function(b){return b.type==="audio"?!b.isAAC&&b.codec==="mp3"?l.box(l.types.stsd,l.STSD,l.mp3(b)):l.box(l.types.stsd,l.STSD,l.mp4a(b)):l.box(l.types.stsd,l.STSD,l.avc1(b))},l.tkhd=function(b){var C=b.id,L=b.duration*b.timescale,m=b.width,A=b.height,D=Math.floor(L/(g+1)),S=Math.floor(L%(g+1));return l.box(l.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,C>>24&255,C>>16&255,C>>8&255,C&255,0,0,0,0,D>>24,D>>16&255,D>>8&255,D&255,S>>24,S>>16&255,S>>8&255,S&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,m>>8&255,m&255,0,0,A>>8&255,A&255,0,0]))},l.traf=function(b,C){var L=l.sdtp(b),m=b.id,A=Math.floor(C/(g+1)),D=Math.floor(C%(g+1));return l.box(l.types.traf,l.box(l.types.tfhd,new Uint8Array([0,0,0,0,m>>24,m>>16&255,m>>8&255,m&255])),l.box(l.types.tfdt,new Uint8Array([1,0,0,0,A>>24,A>>16&255,A>>8&255,A&255,D>>24,D>>16&255,D>>8&255,D&255])),l.trun(b,L.length+16+20+8+16+8+8),L)},l.trak=function(b){return b.duration=b.duration||4294967295,l.box(l.types.trak,l.tkhd(b),l.mdia(b))},l.trex=function(b){var C=b.id;return l.box(l.types.trex,new Uint8Array([0,0,0,0,C>>24,C>>16&255,C>>8&255,C&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},l.trun=function(b,C){var L=b.samples||[],m=L.length,A=12+16*m,D=new Uint8Array(A),S,O,I,s,r,n;for(C+=8+A,D.set([0,0,15,1,m>>>24&255,m>>>16&255,m>>>8&255,m&255,C>>>24&255,C>>>16&255,C>>>8&255,C&255],0),S=0;S<m;S++)O=L[S],I=O.duration,s=O.size,r=O.flags,n=O.cts,D.set([I>>>24&255,I>>>16&255,I>>>8&255,I&255,s>>>24&255,s>>>16&255,s>>>8&255,s&255,r.isLeading<<2|r.dependsOn,r.isDependedOn<<6|r.hasRedundancy<<4|r.paddingValue<<1|r.isNonSync,r.degradPrio&240<<8,r.degradPrio&15,n>>>24&255,n>>>16&255,n>>>8&255,n&255],12+16*S);return l.box(l.types.trun,D)},l.initSegment=function(b){l.types||l.init();var C=l.moov(b),L=new Uint8Array(l.FTYP.byteLength+C.byteLength);return L.set(l.FTYP),L.set(C,l.FTYP.byteLength),L},l}();v.types=void 0,v.HDLR_TYPES=void 0,v.STTS=void 0,v.STSC=void 0,v.STCO=void 0,v.STSZ=void 0,v.VMHD=void 0,v.SMHD=void 0,v.STSD=void 0,v.FTYP=void 0,v.DINF=void 0,e.default=v},"./src/remux/mp4-remuxer.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return n}),t.d(e,"normalizePts",function(){return a});var g=t("./src/polyfills/number.ts"),v=t("./src/remux/aac-helper.ts"),l=t("./src/remux/mp4-generator.ts"),P=t("./src/events.ts"),b=t("./src/errors.ts"),C=t("./src/utils/logger.ts"),L=t("./src/types/loader.ts"),m=t("./src/utils/timescale-conversion.ts");function A(){return A=Object.assign||function(x){for(var E=1;E<arguments.length;E++){var c=arguments[E];for(var u in c)Object.prototype.hasOwnProperty.call(c,u)&&(x[u]=c[u])}return x},A.apply(this,arguments)}var D=10*1e3,S=1024,O=1152,I=null,s=null,r=!1,n=function(){function x(c,u,o,d){if(d===void 0&&(d=""),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=void 0,this._initDTS=void 0,this.nextAvcDts=null,this.nextAudioPts=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=c,this.config=u,this.typeSupported=o,this.ISGenerated=!1,I===null){var T=navigator.userAgent||"",y=T.match(/Chrome\/(\d+)/i);I=y?parseInt(y[1]):0}if(s===null){var R=navigator.userAgent.match(/Safari\/(\d+)/i);s=R?parseInt(R[1]):0}r=!!I&&I<75||!!s&&s<600}var E=x.prototype;return E.destroy=function(){},E.resetTimeStamp=function(u){C.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=u},E.resetNextTimestamp=function(){C.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1},E.resetInitSegment=function(){C.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1},E.getVideoStartPts=function(u){var o=!1,d=u.reduce(function(T,y){var R=y.pts-T;return R<-4294967296?(o=!0,a(T,y.pts)):R>0?T:y.pts},u[0].pts);return o&&C.logger.debug("PTS rollover detected"),d},E.remux=function(u,o,d,T,y,R,M,_){var F,B,w,k,U,N,W=y,K=y,H=u.pid>-1,G=o.pid>-1,V=o.samples.length,X=u.samples.length>0,z=V>1,$=(!H||X)&&(!G||z)||this.ISGenerated||M;if($){this.ISGenerated||(w=this.generateIS(u,o,y));var Y=this.isVideoContiguous,Q=-1;if(z&&(Q=p(o.samples),!Y&&this.config.forceKeyFrameOnDiscontinuity))if(N=!0,Q>0){C.logger.warn("[mp4-remuxer]: Dropped "+Q+" out of "+V+" video samples due to a missing keyframe");var ie=this.getVideoStartPts(o.samples);o.samples=o.samples.slice(Q),o.dropped+=Q,K+=(o.samples[0].pts-ie)/(o.timescale||9e4)}else Q===-1&&(C.logger.warn("[mp4-remuxer]: No keyframe found out of "+V+" video samples"),N=!1);if(this.ISGenerated){if(X&&z){var Z=this.getVideoStartPts(o.samples),ae=a(u.samples[0].pts,Z)-Z,q=ae/o.inputTimeScale;W+=Math.max(0,q),K+=Math.max(0,-q)}if(X){if(u.samplerate||(C.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),w=this.generateIS(u,o,y)),B=this.remuxAudio(u,W,this.isAudioContiguous,R,G||z||_===L.PlaylistLevelType.AUDIO?K:void 0),z){var ne=B?B.endPTS-B.startPTS:0;o.inputTimeScale||(C.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),w=this.generateIS(u,o,y)),F=this.remuxVideo(o,K,Y,ne)}}else z&&(F=this.remuxVideo(o,K,Y,0));F&&(F.firstKeyFrame=Q,F.independent=Q!==-1)}}return this.ISGenerated&&(d.samples.length&&(U=this.remuxID3(d,y)),T.samples.length&&(k=this.remuxText(T,y))),{audio:B,video:F,initSegment:w,independent:N,text:k,id3:U}},E.generateIS=function(u,o,d){var T=u.samples,y=o.samples,R=this.typeSupported,M={},_=!Object(g.isFiniteNumber)(this._initPTS),F="audio/mp4",B,w,k;if(_&&(B=w=1/0),u.config&&T.length&&(u.timescale=u.samplerate,u.isAAC||(R.mpeg?(F="audio/mpeg",u.codec=""):R.mp3&&(u.codec="mp3")),M.audio={id:"audio",container:F,codec:u.codec,initSegment:!u.isAAC&&R.mpeg?new Uint8Array(0):l.default.initSegment([u]),metadata:{channelCount:u.channelCount}},_&&(k=u.inputTimeScale,B=w=T[0].pts-Math.round(k*d))),o.sps&&o.pps&&y.length&&(o.timescale=o.inputTimeScale,M.video={id:"main",container:"video/mp4",codec:o.codec,initSegment:l.default.initSegment([o]),metadata:{width:o.width,height:o.height}},_)){k=o.inputTimeScale;var U=this.getVideoStartPts(y),N=Math.round(k*d);w=Math.min(w,a(y[0].dts,U)-N),B=Math.min(B,U-N)}if(Object.keys(M).length)return this.ISGenerated=!0,_&&(this._initPTS=B,this._initDTS=w),{tracks:M,initPTS:B,timescale:k}},E.remuxVideo=function(u,o,d,T){var y=u.inputTimeScale,R=u.samples,M=[],_=R.length,F=this._initPTS,B=this.nextAvcDts,w=8,k,U,N,W=Number.POSITIVE_INFINITY,K=Number.NEGATIVE_INFINITY,H=0,G=!1;if(!d||B===null){var V=o*y,X=R[0].pts-a(R[0].dts,R[0].pts);B=V-X}for(var z=0;z<_;z++){var $=R[z];if($.pts=a($.pts-F,B),$.dts=a($.dts-F,B),$.dts>$.pts){var Y=9e4*.2;H=Math.max(Math.min(H,$.pts-$.dts),-1*Y)}$.dts<R[z>0?z-1:z].dts&&(G=!0)}G&&R.sort(function(bt,ar){var Gi=bt.dts-ar.dts,Hi=bt.pts-ar.pts;return Gi||Hi}),U=R[0].dts,N=R[R.length-1].dts;var Q=Math.round((N-U)/(_-1));if(H<0){if(H<Q*-2){C.logger.warn("PTS < DTS detected in video samples, offsetting DTS from PTS by "+Object(m.toMsFromMpegTsClock)(-Q,!0)+" ms");for(var ie=H,Z=0;Z<_;Z++)R[Z].dts=ie=Math.max(ie,R[Z].pts-Q),R[Z].pts=Math.max(ie,R[Z].pts)}else{C.logger.warn("PTS < DTS detected in video samples, shifting DTS by "+Object(m.toMsFromMpegTsClock)(H,!0)+" ms to overcome this issue");for(var ae=0;ae<_;ae++)R[ae].dts=R[ae].dts+H}U=R[0].dts}if(d){var q=U-B,ne=q>Q,se=q<-1;if(ne||se){ne?C.logger.warn("AVC: "+Object(m.toMsFromMpegTsClock)(q,!0)+" ms ("+q+"dts) hole between fragments detected, filling it"):C.logger.warn("AVC: "+Object(m.toMsFromMpegTsClock)(-q,!0)+" ms ("+q+"dts) overlapping between fragments detected"),U=B;var fe=R[0].pts-q;R[0].dts=U,R[0].pts=fe,C.logger.log("Video: First PTS/DTS adjusted: "+Object(m.toMsFromMpegTsClock)(fe,!0)+"/"+Object(m.toMsFromMpegTsClock)(U,!0)+", delta: "+Object(m.toMsFromMpegTsClock)(q,!0)+" ms")}}r&&(U=Math.max(0,U));for(var le=0,ce=0,pe=0;pe<_;pe++){for(var re=R[pe],he=re.units,De=he.length,Pe=0,Te=0;Te<De;Te++)Pe+=he[Te].data.length;ce+=Pe,le+=De,re.length=Pe,re.dts=Math.max(re.dts,U),re.pts=Math.max(re.pts,re.dts,0),W=Math.min(re.pts,W),K=Math.max(re.pts,K)}N=R[_-1].dts;var Ae=ce+4*le+8,ve;try{ve=new Uint8Array(Ae)}catch(bt){this.observer.emit(P.Events.ERROR,P.Events.ERROR,{type:b.ErrorTypes.MUX_ERROR,details:b.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:Ae,reason:"fail allocating video mdat "+Ae});return}var we=new DataView(ve.buffer);we.setUint32(0,Ae),ve.set(l.default.types.mdat,4);for(var oe=0;oe<_;oe++){for(var xe=R[oe],ze=xe.units,be=0,Me=0,ot=ze.length;Me<ot;Me++){var _e=ze[Me],Ee=_e.data,Ue=_e.data.byteLength;we.setUint32(w,Ue),w+=4,ve.set(Ee,w),w+=Ue,be+=4+Ue}if(oe<_-1)k=R[oe+1].dts-xe.dts;else{var lt=this.config,ke=xe.dts-R[oe>0?oe-1:oe].dts;if(lt.stretchShortVideoTrack&&this.nextAudioPts!==null){var ki=Math.floor(lt.maxBufferHole*y),Pt=(T?W+T*y:this.nextAudioPts)-xe.pts;Pt>ki?(k=Pt-ke,k<0&&(k=ke),C.logger.log("[mp4-remuxer]: It is approximately "+Pt/90+" ms to the next segment; using duration "+k/90+" ms for the last video frame.")):k=ke}else k=ke}var Ni=Math.round(xe.pts-xe.dts);M.push(new f(xe.key,k,be,Ni))}if(M.length&&I&&I<70){var nr=M[0].flags;nr.dependsOn=2,nr.isNonSync=0}console.assert(k!==void 0,"mp4SampleDuration must be computed"),this.nextAvcDts=B=N+k,this.isVideoContiguous=!0;var Ki=l.default.moof(u.sequenceNumber++,U,A({},u,{samples:M})),Wi="video",ji={data1:Ki,data2:ve,startPTS:W/y,endPTS:(K+k)/y,startDTS:U/y,endDTS:B/y,type:Wi,hasAudio:!1,hasVideo:!0,nb:M.length,dropped:u.dropped};return u.samples=[],u.dropped=0,console.assert(ve.length,"MDAT length must not be zero"),ji},E.remuxAudio=function(u,o,d,T,y){var R=u.inputTimeScale,M=u.samplerate?u.samplerate:R,_=R/M,F=u.isAAC?S:O,B=F*_,w=this._initPTS,k=!u.isAAC&&this.typeSupported.mpeg,U=[],N=u.samples,W=k?0:8,K=this.nextAudioPts||-1,H=o*R;if(this.isAudioContiguous=d=d||N.length&&K>0&&(T&&Math.abs(H-K)<9e3||Math.abs(a(N[0].pts-w,H)-K)<20*B),N.forEach(function(Ee){Ee.pts=a(Ee.pts-w,H)}),!d||K<0){if(N=N.filter(function(Ee){return Ee.pts>=0}),!N.length)return;y===0?K=0:T?K=Math.max(0,H):K=N[0].pts}if(u.isAAC)for(var G=y!==void 0,V=this.config.maxAudioFramesDrift,X=0,z=K;X<N.length;X++){var $=N[X],Y=$.pts,Q=Y-z,ie=Math.abs(1e3*Q/R);if(Q<=-V*B&&G)X===0&&(C.logger.warn("Audio frame @ "+(Y/R).toFixed(3)+"s overlaps nextAudioPts by "+Math.round(1e3*Q/R)+" ms."),this.nextAudioPts=K=z=Y);else if(Q>=V*B&&ie<D&&G){var Z=Math.round(Q/B);z=Y-Z*B,z<0&&(Z--,z+=B),X===0&&(this.nextAudioPts=K=z),C.logger.warn("[mp4-remuxer]: Injecting "+Z+" audio frame @ "+(z/R).toFixed(3)+"s due to "+Math.round(1e3*Q/R)+" ms gap.");for(var ae=0;ae<Z;ae++){var q=Math.max(z,0),ne=v.default.getSilentFrame(u.manifestCodec||u.codec,u.channelCount);ne||(C.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),ne=$.unit.subarray()),N.splice(X,0,{unit:ne,pts:q}),z+=B,X++}}$.pts=z,z+=B}for(var se=null,fe=null,le,ce=0,pe=N.length;pe--;)ce+=N[pe].unit.byteLength;for(var re=0,he=N.length;re<he;re++){var De=N[re],Pe=De.unit,Te=De.pts;if(fe!==null){var Ae=U[re-1];Ae.duration=Math.round((Te-fe)/_)}else if(d&&u.isAAC&&(Te=K),se=Te,ce>0){ce+=W;try{le=new Uint8Array(ce)}catch(Ee){this.observer.emit(P.Events.ERROR,P.Events.ERROR,{type:b.ErrorTypes.MUX_ERROR,details:b.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:ce,reason:"fail allocating audio mdat "+ce});return}if(!k){var ve=new DataView(le.buffer);ve.setUint32(0,ce),le.set(l.default.types.mdat,4)}}else return;le.set(Pe,W);var we=Pe.byteLength;W+=we,U.push(new f(!0,F,we,0)),fe=Te}var oe=U.length;if(!!oe){var xe=U[U.length-1];this.nextAudioPts=K=fe+_*xe.duration;var ze=k?new Uint8Array(0):l.default.moof(u.sequenceNumber++,se/_,A({},u,{samples:U}));u.samples=[];var be=se/R,Me=K/R,ot="audio",_e={data1:ze,data2:le,startPTS:be,endPTS:Me,startDTS:be,endDTS:Me,type:ot,hasAudio:!0,hasVideo:!1,nb:oe};return this.isAudioContiguous=!0,console.assert(le.length,"MDAT length must not be zero"),_e}},E.remuxEmptyAudio=function(u,o,d,T){var y=u.inputTimeScale,R=u.samplerate?u.samplerate:y,M=y/R,_=this.nextAudioPts,F=(_!==null?_:T.startDTS*y)+this._initDTS,B=T.endDTS*y+this._initDTS,w=M*S,k=Math.ceil((B-F)/w),U=v.default.getSilentFrame(u.manifestCodec||u.codec,u.channelCount);if(C.logger.warn("[mp4-remuxer]: remux empty Audio"),!U){C.logger.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}for(var N=[],W=0;W<k;W++){var K=F+W*w;N.push({unit:U,pts:K,dts:K})}return u.samples=N,this.remuxAudio(u,o,d,!1)},E.remuxID3=function(u,o){var d=u.samples.length;if(!!d){for(var T=u.inputTimeScale,y=this._initPTS,R=this._initDTS,M=0;M<d;M++){var _=u.samples[M];_.pts=a(_.pts-y,o*T)/T,_.dts=a(_.dts-R,o*T)/T}var F=u.samples;return u.samples=[],{samples:F}}},E.remuxText=function(u,o){var d=u.samples.length;if(!!d){for(var T=u.inputTimeScale,y=this._initPTS,R=0;R<d;R++){var M=u.samples[R];M.pts=a(M.pts-y,o*T)/T}u.samples.sort(function(F,B){return F.pts-B.pts});var _=u.samples;return u.samples=[],{samples:_}}},x}();function a(x,E){var c;if(E===null)return x;for(E<x?c=-8589934592:c=8589934592;Math.abs(x-E)>4294967296;)x+=c;return x}function p(x){for(var E=0;E<x.length;E++)if(x[E].key)return E;return-1}var f=function(E,c,u,o){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=c,this.size=u,this.cts=o,this.flags=new h(E)},h=function(E){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=E?2:1,this.isNonSync=E?0:1}},"./src/remux/passthrough-remuxer.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/polyfills/number.ts"),v=t("./src/utils/mp4-tools.ts"),l=t("./src/loader/fragment.ts"),P=t("./src/utils/logger.ts"),b=function(){function m(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=void 0,this.initTracks=void 0,this.lastEndDTS=null}var A=m.prototype;return A.destroy=function(){},A.resetTimeStamp=function(S){this.initPTS=S,this.lastEndDTS=null},A.resetNextTimestamp=function(){this.lastEndDTS=null},A.resetInitSegment=function(S,O,I){this.audioCodec=O,this.videoCodec=I,this.generateInitSegment(S),this.emitInitSegment=!0},A.generateInitSegment=function(S){var O=this.audioCodec,I=this.videoCodec;if(!S||!S.byteLength){this.initTracks=void 0,this.initData=void 0;return}var s=this.initData=Object(v.parseInitSegment)(S);O||(O=L(s.audio,l.ElementaryStreamTypes.AUDIO)),I||(I=L(s.video,l.ElementaryStreamTypes.VIDEO));var r={};s.audio&&s.video?r.audiovideo={container:"video/mp4",codec:O+","+I,initSegment:S,id:"main"}:s.audio?r.audio={container:"audio/mp4",codec:O,initSegment:S,id:"audio"}:s.video?r.video={container:"video/mp4",codec:I,initSegment:S,id:"main"}:P.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r},A.remux=function(S,O,I,s,r){var n=this.initPTS,a=this.lastEndDTS,p={audio:void 0,video:void 0,text:s,id3:I,initSegment:void 0};Object(g.isFiniteNumber)(a)||(a=this.lastEndDTS=r||0);var f=O.samples;if(!f||!f.length)return p;var h={initPTS:void 0,timescale:1},x=this.initData;if((!x||!x.length)&&(this.generateInitSegment(f),x=this.initData),!x||!x.length)return P.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),p;this.emitInitSegment&&(h.tracks=this.initTracks,this.emitInitSegment=!1),Object(g.isFiniteNumber)(n)||(this.initPTS=h.initPTS=n=C(x,f,a));var E=Object(v.getDuration)(f,x),c=a,u=E+c;Object(v.offsetStartDTS)(x,f,n),E>0?this.lastEndDTS=u:(P.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var o=!!x.audio,d=!!x.video,T="";o&&(T+="audio"),d&&(T+="video");var y={data1:f,startPTS:c,startDTS:c,endPTS:u,endDTS:u,type:T,hasAudio:o,hasVideo:d,nb:1,dropped:0};return p.audio=y.type==="audio"?y:void 0,p.video=y.type!=="audio"?y:void 0,p.text=s,p.id3=I,p.initSegment=h,p},m}(),C=function(A,D,S){return Object(v.getStartDTS)(A,D)-S};function L(m,A){var D=m==null?void 0:m.codec;return D&&D.length>4?D:D==="hvc1"?"hvc1.1.c.L120.90":D==="av01"?"av01.0.04M.08":D==="avc1"||A===l.ElementaryStreamTypes.VIDEO?"avc1.42e01e":"mp4a.40.5"}e.default=b},"./src/task-loop.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return g});var g=function(){function v(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}var l=v.prototype;return l.destroy=function(){this.onHandlerDestroying(),this.onHandlerDestroyed()},l.onHandlerDestroying=function(){this.clearNextTick(),this.clearInterval()},l.onHandlerDestroyed=function(){},l.hasInterval=function(){return!!this._tickInterval},l.hasNextTick=function(){return!!this._tickTimer},l.setInterval=function(b){return this._tickInterval?!1:(this._tickInterval=self.setInterval(this._boundTick,b),!0)},l.clearInterval=function(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1},l.clearNextTick=function(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1},l.tick=function(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)},l.tickImmediate=function(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},l.doTick=function(){},v}()},"./src/types/level.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"HlsSkip",function(){return l}),t.d(e,"getSkipValue",function(){return P}),t.d(e,"HlsUrlParameters",function(){return b}),t.d(e,"Level",function(){return C});function g(L,m){for(var A=0;A<m.length;A++){var D=m[A];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty(L,D.key,D)}}function v(L,m,A){return m&&g(L.prototype,m),A&&g(L,A),L}var l;(function(L){L.No="",L.Yes="YES",L.v2="v2"})(l||(l={}));function P(L,m){var A=L.canSkipUntil,D=L.canSkipDateRanges,S=L.endSN,O=m!==void 0?m-S:0;return A&&O<A?D?l.v2:l.Yes:l.No}var b=function(){function L(A,D,S){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=A,this.part=D,this.skip=S}var m=L.prototype;return m.addDirectives=function(D){var S=new self.URL(D);return this.msn!==void 0&&S.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&S.searchParams.set("_HLS_part",this.part.toString()),this.skip&&S.searchParams.set("_HLS_skip",this.skip),S.toString()},L}(),C=function(){function L(m){this.attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[m.url],this.attrs=m.attrs,this.bitrate=m.bitrate,m.details&&(this.details=m.details),this.id=m.id||0,this.name=m.name,this.width=m.width||0,this.height=m.height||0,this.audioCodec=m.audioCodec,this.videoCodec=m.videoCodec,this.unknownCodecs=m.unknownCodecs,this.codecSet=[m.videoCodec,m.audioCodec].filter(function(A){return A}).join(",").replace(/\.[^.,]+/g,"")}return v(L,[{key:"maxBitrate",get:function(){return Math.max(this.realBitrate,this.bitrate)}},{key:"uri",get:function(){return this.url[this._urlId]||""}},{key:"urlId",get:function(){return this._urlId},set:function(A){var D=A%this.url.length;this._urlId!==D&&(this.details=void 0,this._urlId=D)}}]),L}()},"./src/types/loader.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"PlaylistContextType",function(){return g}),t.d(e,"PlaylistLevelType",function(){return v});var g;(function(l){l.MANIFEST="manifest",l.LEVEL="level",l.AUDIO_TRACK="audioTrack",l.SUBTITLE_TRACK="subtitleTrack"})(g||(g={}));var v;(function(l){l.MAIN="main",l.AUDIO="audio",l.SUBTITLE="subtitle"})(v||(v={}))},"./src/types/transmuxer.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"ChunkMetadata",function(){return g});var g=function(P,b,C,L,m,A){L===void 0&&(L=0),m===void 0&&(m=-1),A===void 0&&(A=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=v(),this.buffering={audio:v(),video:v(),audiovideo:v()},this.level=P,this.sn=b,this.id=C,this.size=L,this.part=m,this.partial=A};function v(){return{start:0,executeStart:0,executeEnd:0,end:0}}},"./src/utils/attr-list.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"AttrList",function(){return l});var g=/^(\d+)x(\d+)$/,v=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,l=function(){function P(C){typeof C=="string"&&(C=P.parseAttrList(C));for(var L in C)C.hasOwnProperty(L)&&(this[L]=C[L])}var b=P.prototype;return b.decimalInteger=function(L){var m=parseInt(this[L],10);return m>Number.MAX_SAFE_INTEGER?1/0:m},b.hexadecimalInteger=function(L){if(this[L]){var m=(this[L]||"0x").slice(2);m=(m.length&1?"0":"")+m;for(var A=new Uint8Array(m.length/2),D=0;D<m.length/2;D++)A[D]=parseInt(m.slice(D*2,D*2+2),16);return A}else return null},b.hexadecimalIntegerAsNumber=function(L){var m=parseInt(this[L],16);return m>Number.MAX_SAFE_INTEGER?1/0:m},b.decimalFloatingPoint=function(L){return parseFloat(this[L])},b.optionalFloat=function(L,m){var A=this[L];return A?parseFloat(A):m},b.enumeratedString=function(L){return this[L]},b.bool=function(L){return this[L]==="YES"},b.decimalResolution=function(L){var m=g.exec(this[L]);if(m!==null)return{width:parseInt(m[1],10),height:parseInt(m[2],10)}},P.parseAttrList=function(L){var m,A={},D='"';for(v.lastIndex=0;(m=v.exec(L))!==null;){var S=m[2];S.indexOf(D)===0&&S.lastIndexOf(D)===S.length-1&&(S=S.slice(1,-1)),A[m[1]]=S}return A},P}()},"./src/utils/binary-search.ts":function(i,e,t){"use strict";t.r(e);var g={search:function(l,P){for(var b=0,C=l.length-1,L=null,m=null;b<=C;){L=(b+C)/2|0,m=l[L];var A=P(m);if(A>0)b=L+1;else if(A<0)C=L-1;else return m}return null}};e.default=g},"./src/utils/buffer-helper.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"BufferHelper",function(){return l});var g=t("./src/utils/logger.ts"),v={length:0,start:function(){return 0},end:function(){return 0}},l=function(){function P(){}return P.isBuffered=function(C,L){try{if(C){for(var m=P.getBuffered(C),A=0;A<m.length;A++)if(L>=m.start(A)&&L<=m.end(A))return!0}}catch(D){}return!1},P.bufferInfo=function(C,L,m){try{if(C){var A=P.getBuffered(C),D=[],S;for(S=0;S<A.length;S++)D.push({start:A.start(S),end:A.end(S)});return this.bufferedInfo(D,L,m)}}catch(O){}return{len:0,start:L,end:L,nextStart:void 0}},P.bufferedInfo=function(C,L,m){L=Math.max(0,L),C.sort(function(h,x){var E=h.start-x.start;return E||x.end-h.end});var A=[];if(m)for(var D=0;D<C.length;D++){var S=A.length;if(S){var O=A[S-1].end;C[D].start-O<m?C[D].end>O&&(A[S-1].end=C[D].end):A.push(C[D])}else A.push(C[D])}else A=C;for(var I=0,s,r=L,n=L,a=0;a<A.length;a++){var p=A[a].start,f=A[a].end;if(L+m>=p&&L<f)r=p,n=f,I=n-L;else if(L+m<p){s=p;break}}return{len:I,start:r||0,end:n||0,nextStart:s}},P.getBuffered=function(C){try{return C.buffered}catch(L){return g.logger.log("failed to get media.buffered",L),v}},P}()},"./src/utils/cea-608-parser.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"Row",function(){return n}),t.d(e,"CaptionScreen",function(){return a});var g=t("./src/utils/logger.ts"),v={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},l=function(u){var o=u;return v.hasOwnProperty(u)&&(o=v[u]),String.fromCharCode(o)},P=15,b=100,C={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},L={17:2,18:4,21:6,22:8,23:10,19:13,20:15},m={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},A={25:2,26:4,29:6,30:8,31:10,27:13,28:15},D=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],S;(function(c){c[c.ERROR=0]="ERROR",c[c.TEXT=1]="TEXT",c[c.WARNING=2]="WARNING",c[c.INFO=2]="INFO",c[c.DEBUG=3]="DEBUG",c[c.DATA=3]="DATA"})(S||(S={}));var O=function(){function c(){this.time=null,this.verboseLevel=S.ERROR}var u=c.prototype;return u.log=function(d,T){this.verboseLevel>=d&&g.logger.log(this.time+" ["+d+"] "+T)},c}(),I=function(u){for(var o=[],d=0;d<u.length;d++)o.push(u[d].toString(16));return o},s=function(){function c(o,d,T,y,R){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=o||"white",this.underline=d||!1,this.italics=T||!1,this.background=y||"black",this.flash=R||!1}var u=c.prototype;return u.reset=function(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1},u.setStyles=function(d){for(var T=["foreground","underline","italics","background","flash"],y=0;y<T.length;y++){var R=T[y];d.hasOwnProperty(R)&&(this[R]=d[R])}},u.isDefault=function(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash},u.equals=function(d){return this.foreground===d.foreground&&this.underline===d.underline&&this.italics===d.italics&&this.background===d.background&&this.flash===d.flash},u.copy=function(d){this.foreground=d.foreground,this.underline=d.underline,this.italics=d.italics,this.background=d.background,this.flash=d.flash},u.toString=function(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash},c}(),r=function(){function c(o,d,T,y,R,M){this.uchar=void 0,this.penState=void 0,this.uchar=o||" ",this.penState=new s(d,T,y,R,M)}var u=c.prototype;return u.reset=function(){this.uchar=" ",this.penState.reset()},u.setChar=function(d,T){this.uchar=d,this.penState.copy(T)},u.setPenState=function(d){this.penState.copy(d)},u.equals=function(d){return this.uchar===d.uchar&&this.penState.equals(d.penState)},u.copy=function(d){this.uchar=d.uchar,this.penState.copy(d.penState)},u.isEmpty=function(){return this.uchar===" "&&this.penState.isDefault()},c}(),n=function(){function c(o){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(var d=0;d<b;d++)this.chars.push(new r);this.logger=o,this.pos=0,this.currPenState=new s}var u=c.prototype;return u.equals=function(d){for(var T=!0,y=0;y<b;y++)if(!this.chars[y].equals(d.chars[y])){T=!1;break}return T},u.copy=function(d){for(var T=0;T<b;T++)this.chars[T].copy(d.chars[T])},u.isEmpty=function(){for(var d=!0,T=0;T<b;T++)if(!this.chars[T].isEmpty()){d=!1;break}return d},u.setCursor=function(d){this.pos!==d&&(this.pos=d),this.pos<0?(this.logger.log(S.DEBUG,"Negative cursor position "+this.pos),this.pos=0):this.pos>b&&(this.logger.log(S.DEBUG,"Too large cursor position "+this.pos),this.pos=b)},u.moveCursor=function(d){var T=this.pos+d;if(d>1)for(var y=this.pos+1;y<T+1;y++)this.chars[y].setPenState(this.currPenState);this.setCursor(T)},u.backSpace=function(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)},u.insertChar=function(d){d>=144&&this.backSpace();var T=l(d);if(this.pos>=b){this.logger.log(S.ERROR,"Cannot insert "+d.toString(16)+" ("+T+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(T,this.currPenState),this.moveCursor(1)},u.clearFromPos=function(d){var T;for(T=d;T<b;T++)this.chars[T].reset()},u.clear=function(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},u.clearToEndOfRow=function(){this.clearFromPos(this.pos)},u.getTextString=function(){for(var d=[],T=!0,y=0;y<b;y++){var R=this.chars[y].uchar;R!==" "&&(T=!1),d.push(R)}return T?"":d.join("")},u.setPenStyles=function(d){this.currPenState.setStyles(d);var T=this.chars[this.pos];T.setPenState(this.currPenState)},c}(),a=function(){function c(o){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(var d=0;d<P;d++)this.rows.push(new n(o));this.logger=o,this.currRow=P-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}var u=c.prototype;return u.reset=function(){for(var d=0;d<P;d++)this.rows[d].clear();this.currRow=P-1},u.equals=function(d){for(var T=!0,y=0;y<P;y++)if(!this.rows[y].equals(d.rows[y])){T=!1;break}return T},u.copy=function(d){for(var T=0;T<P;T++)this.rows[T].copy(d.rows[T])},u.isEmpty=function(){for(var d=!0,T=0;T<P;T++)if(!this.rows[T].isEmpty()){d=!1;break}return d},u.backSpace=function(){var d=this.rows[this.currRow];d.backSpace()},u.clearToEndOfRow=function(){var d=this.rows[this.currRow];d.clearToEndOfRow()},u.insertChar=function(d){var T=this.rows[this.currRow];T.insertChar(d)},u.setPen=function(d){var T=this.rows[this.currRow];T.setPenStyles(d)},u.moveCursor=function(d){var T=this.rows[this.currRow];T.moveCursor(d)},u.setCursor=function(d){this.logger.log(S.INFO,"setCursor: "+d);var T=this.rows[this.currRow];T.setCursor(d)},u.setPAC=function(d){this.logger.log(S.INFO,"pacData = "+JSON.stringify(d));var T=d.row-1;if(this.nrRollUpRows&&T<this.nrRollUpRows-1&&(T=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==T){for(var y=0;y<P;y++)this.rows[y].clear();var R=this.currRow+1-this.nrRollUpRows,M=this.lastOutputScreen;if(M){var _=M.rows[R].cueStartTime,F=this.logger.time;if(_&&F!==null&&_<F)for(var B=0;B<this.nrRollUpRows;B++)this.rows[T-this.nrRollUpRows+B+1].copy(M.rows[R+B])}}this.currRow=T;var w=this.rows[this.currRow];if(d.indent!==null){var k=d.indent,U=Math.max(k-1,0);w.setCursor(d.indent),d.color=w.chars[U].penState.foreground}var N={foreground:d.color,underline:d.underline,italics:d.italics,background:"black",flash:!1};this.setPen(N)},u.setBkgData=function(d){this.logger.log(S.INFO,"bkgData = "+JSON.stringify(d)),this.backSpace(),this.setPen(d),this.insertChar(32)},u.setRollUpRows=function(d){this.nrRollUpRows=d},u.rollUp=function(){if(this.nrRollUpRows===null){this.logger.log(S.DEBUG,"roll_up but nrRollUpRows not set yet");return}this.logger.log(S.TEXT,this.getDisplayText());var d=this.currRow+1-this.nrRollUpRows,T=this.rows.splice(d,1)[0];T.clear(),this.rows.splice(this.currRow,0,T),this.logger.log(S.INFO,"Rolling up")},u.getDisplayText=function(d){d=d||!1;for(var T=[],y="",R=-1,M=0;M<P;M++){var _=this.rows[M].getTextString();_&&(R=M+1,d?T.push("Row "+R+": '"+_+"'"):T.push(_.trim()))}return T.length>0&&(d?y="["+T.join(" | ")+"]":y=T.join(`
`)),y},u.getTextAndFormat=function(){return this.rows},c}(),p=function(){function c(o,d,T){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=o,this.outputFilter=d,this.mode=null,this.verbose=0,this.displayedMemory=new a(T),this.nonDisplayedMemory=new a(T),this.lastOutputScreen=new a(T),this.currRollUpRow=this.displayedMemory.rows[P-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=T}var u=c.prototype;return u.reset=function(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[P-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},u.getHandler=function(){return this.outputFilter},u.setHandler=function(d){this.outputFilter=d},u.setPAC=function(d){this.writeScreen.setPAC(d)},u.setBkgData=function(d){this.writeScreen.setBkgData(d)},u.setMode=function(d){d!==this.mode&&(this.mode=d,this.logger.log(S.INFO,"MODE="+d),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=d)},u.insertChars=function(d){for(var T=0;T<d.length;T++)this.writeScreen.insertChar(d[T]);var y=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(S.INFO,y+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(S.TEXT,"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())},u.ccRCL=function(){this.logger.log(S.INFO,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")},u.ccBS=function(){this.logger.log(S.INFO,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},u.ccAOF=function(){},u.ccAON=function(){},u.ccDER=function(){this.logger.log(S.INFO,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},u.ccRU=function(d){this.logger.log(S.INFO,"RU("+d+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(d)},u.ccFON=function(){this.logger.log(S.INFO,"FON - Flash On"),this.writeScreen.setPen({flash:!0})},u.ccRDC=function(){this.logger.log(S.INFO,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")},u.ccTR=function(){this.logger.log(S.INFO,"TR"),this.setMode("MODE_TEXT")},u.ccRTD=function(){this.logger.log(S.INFO,"RTD"),this.setMode("MODE_TEXT")},u.ccEDM=function(){this.logger.log(S.INFO,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)},u.ccCR=function(){this.logger.log(S.INFO,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},u.ccENM=function(){this.logger.log(S.INFO,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()},u.ccEOC=function(){if(this.logger.log(S.INFO,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){var d=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=d,this.writeScreen=this.nonDisplayedMemory,this.logger.log(S.TEXT,"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)},u.ccTO=function(d){this.logger.log(S.INFO,"TO("+d+") - Tab Offset"),this.writeScreen.moveCursor(d)},u.ccMIDROW=function(d){var T={flash:!1};if(T.underline=d%2==1,T.italics=d>=46,T.italics)T.foreground="white";else{var y=Math.floor(d/2)-16,R=["white","green","blue","cyan","red","yellow","magenta"];T.foreground=R[y]}this.logger.log(S.INFO,"MIDROW: "+JSON.stringify(T)),this.writeScreen.setPen(T)},u.outputDataUpdate=function(d){d===void 0&&(d=!1);var T=this.logger.time;T!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=T:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,T,this.lastOutputScreen),d&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:T),this.lastOutputScreen.copy(this.displayedMemory))},u.cueSplitAtTime=function(d){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,d,this.displayedMemory),this.cueStartTime=d))},c}(),f=function(){function c(o,d,T){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;var y=new O;this.channels=[null,new p(o,d,y),new p(o+1,T,y)],this.cmdHistory=E(),this.logger=y}var u=c.prototype;return u.getHandler=function(d){return this.channels[d].getHandler()},u.setHandler=function(d,T){this.channels[d].setHandler(T)},u.addData=function(d,T){var y,R,M,_=!1;this.logger.time=d;for(var F=0;F<T.length;F+=2)if(R=T[F]&127,M=T[F+1]&127,!(R===0&&M===0)){if(this.logger.log(S.DATA,"["+I([T[F],T[F+1]])+"] -> ("+I([R,M])+")"),y=this.parseCmd(R,M),y||(y=this.parseMidrow(R,M)),y||(y=this.parsePAC(R,M)),y||(y=this.parseBackgroundAttributes(R,M)),!y&&(_=this.parseChars(R,M),_)){var B=this.currentChannel;if(B&&B>0){var w=this.channels[B];w.insertChars(_)}else this.logger.log(S.WARNING,"No channel found yet. TEXT-MODE?")}!y&&!_&&this.logger.log(S.WARNING,"Couldn't parse cleaned data "+I([R,M])+" orig: "+I([T[F],T[F+1]]))}},u.parseCmd=function(d,T){var y=this.cmdHistory,R=(d===20||d===28||d===21||d===29)&&T>=32&&T<=47,M=(d===23||d===31)&&T>=33&&T<=35;if(!(R||M))return!1;if(x(d,T,y))return h(null,null,y),this.logger.log(S.DEBUG,"Repeated command ("+I([d,T])+") is dropped"),!0;var _=d===20||d===21||d===23?1:2,F=this.channels[_];return d===20||d===21||d===28||d===29?T===32?F.ccRCL():T===33?F.ccBS():T===34?F.ccAOF():T===35?F.ccAON():T===36?F.ccDER():T===37?F.ccRU(2):T===38?F.ccRU(3):T===39?F.ccRU(4):T===40?F.ccFON():T===41?F.ccRDC():T===42?F.ccTR():T===43?F.ccRTD():T===44?F.ccEDM():T===45?F.ccCR():T===46?F.ccENM():T===47&&F.ccEOC():F.ccTO(T-32),h(d,T,y),this.currentChannel=_,!0},u.parseMidrow=function(d,T){var y=0;if((d===17||d===25)&&T>=32&&T<=47){if(d===17?y=1:y=2,y!==this.currentChannel)return this.logger.log(S.ERROR,"Mismatch channel in midrow parsing"),!1;var R=this.channels[y];return R?(R.ccMIDROW(T),this.logger.log(S.DEBUG,"MIDROW ("+I([d,T])+")"),!0):!1}return!1},u.parsePAC=function(d,T){var y,R=this.cmdHistory,M=(d>=17&&d<=23||d>=25&&d<=31)&&T>=64&&T<=127,_=(d===16||d===24)&&T>=64&&T<=95;if(!(M||_))return!1;if(x(d,T,R))return h(null,null,R),!0;var F=d<=23?1:2;T>=64&&T<=95?y=F===1?C[d]:m[d]:y=F===1?L[d]:A[d];var B=this.channels[F];return B?(B.setPAC(this.interpretPAC(y,T)),h(d,T,R),this.currentChannel=F,!0):!1},u.interpretPAC=function(d,T){var y,R={color:null,italics:!1,indent:null,underline:!1,row:d};return T>95?y=T-96:y=T-64,R.underline=(y&1)==1,y<=13?R.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(y/2)]:y<=15?(R.italics=!0,R.color="white"):R.indent=Math.floor((y-16)/2)*4,R},u.parseChars=function(d,T){var y,R=null,M=null;if(d>=25?(y=2,M=d-8):(y=1,M=d),M>=17&&M<=19){var _;M===17?_=T+80:M===18?_=T+112:_=T+144,this.logger.log(S.INFO,"Special char '"+l(_)+"' in channel "+y),R=[_]}else d>=32&&d<=127&&(R=T===0?[d]:[d,T]);if(R){var F=I(R);this.logger.log(S.DEBUG,"Char codes =  "+F.join(",")),h(d,T,this.cmdHistory)}return R},u.parseBackgroundAttributes=function(d,T){var y=(d===16||d===24)&&T>=32&&T<=47,R=(d===23||d===31)&&T>=45&&T<=47;if(!(y||R))return!1;var M,_={};d===16||d===24?(M=Math.floor((T-32)/2),_.background=D[M],T%2==1&&(_.background=_.background+"_semi")):T===45?_.background="transparent":(_.foreground="black",T===47&&(_.underline=!0));var F=d<=23?1:2,B=this.channels[F];return B.setBkgData(_),h(d,T,this.cmdHistory),!0},u.reset=function(){for(var d=0;d<Object.keys(this.channels).length;d++){var T=this.channels[d];T&&T.reset()}this.cmdHistory=E()},u.cueSplitAtTime=function(d){for(var T=0;T<this.channels.length;T++){var y=this.channels[T];y&&y.cueSplitAtTime(d)}},c}();function h(c,u,o){o.a=c,o.b=u}function x(c,u,o){return o.a===c&&o.b===u}function E(){return{a:null,b:null}}e.default=f},"./src/utils/codecs.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"isCodecType",function(){return v}),t.d(e,"isCodecSupportedInMp4",function(){return l});var g={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function v(P,b){var C=g[b];return!!C&&C[P.slice(0,4)]===!0}function l(P,b){return MediaSource.isTypeSupported((b||"video")+'/mp4;codecs="'+P+'"')}},"./src/utils/cues.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/utils/vttparser.ts"),v=t("./src/utils/webvtt-parser.ts"),l=t("./src/utils/texttrack-utils.ts"),P=/\s/,b={newCue:function(L,m,A,D){for(var S=[],O,I,s,r,n,a=self.VTTCue||self.TextTrackCue,p=0;p<D.rows.length;p++)if(O=D.rows[p],s=!0,r=0,n="",!O.isEmpty()){for(var f=0;f<O.chars.length;f++)P.test(O.chars[f].uchar)&&s?r++:(n+=O.chars[f].uchar,s=!1);O.cueStartTime=m,m===A&&(A+=1e-4),r>=16?r--:r++;var h=Object(g.fixLineBreaks)(n.trim()),x=Object(v.generateCueId)(m,A,h);(!L||!L.cues||!L.cues.getCueById(x))&&(I=new a(m,A,h),I.id=x,I.line=p+1,I.align="left",I.position=10+Math.min(80,Math.floor(r*8/32)*10),S.push(I))}return L&&S.length&&(S.sort(function(E,c){return E.line==="auto"||c.line==="auto"?0:E.line>8&&c.line>8?c.line-E.line:E.line-c.line}),S.forEach(function(E){return Object(l.addCueToTrack)(L,E)})),S}};e.default=b},"./src/utils/discontinuities.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"findFirstFragWithCC",function(){return P}),t.d(e,"shouldAlignOnDiscontinuities",function(){return b}),t.d(e,"findDiscontinuousReferenceFrag",function(){return C}),t.d(e,"adjustSlidingStart",function(){return m}),t.d(e,"alignStream",function(){return A}),t.d(e,"alignPDT",function(){return S}),t.d(e,"alignFragmentByPDTDelta",function(){return O}),t.d(e,"alignMediaPlaylistByPDT",function(){return I});var g=t("./src/polyfills/number.ts"),v=t("./src/utils/logger.ts"),l=t("./src/controller/level-helper.ts");function P(s,r){for(var n=null,a=0,p=s.length;a<p;a++){var f=s[a];if(f&&f.cc===r){n=f;break}}return n}function b(s,r,n){return!!(r.details&&(n.endCC>n.startCC||s&&s.cc<n.startCC))}function C(s,r){var n=s.fragments,a=r.fragments;if(!a.length||!n.length){v.logger.log("No fragments to align");return}var p=P(n,a[0].cc);if(!p||p&&!p.startPTS){v.logger.log("No frag in previous level to align on");return}return p}function L(s,r){if(s){var n=s.start+r;s.start=s.startPTS=n,s.endPTS=n+s.duration}}function m(s,r){for(var n=r.fragments,a=0,p=n.length;a<p;a++)L(n[a],s);r.fragmentHint&&L(r.fragmentHint,s),r.alignedSliding=!0}function A(s,r,n){!r||(D(s,n,r),!n.alignedSliding&&r.details&&S(n,r.details),!n.alignedSliding&&r.details&&!n.skippedSegments&&Object(l.adjustSliding)(r.details,n))}function D(s,r,n){if(b(s,n,r)){var a=C(n.details,r);a&&Object(g.isFiniteNumber)(a.start)&&(v.logger.log("Adjusting PTS using last level due to CC increase within current level "+r.url),m(a.start,r))}}function S(s,r){if(!(!r.fragments.length||!s.hasProgramDateTime||!r.hasProgramDateTime)){var n=r.fragments[0].programDateTime,a=s.fragments[0].programDateTime,p=(a-n)/1e3+r.fragments[0].start;p&&Object(g.isFiniteNumber)(p)&&(v.logger.log("Adjusting PTS using programDateTime delta "+(a-n)+"ms, sliding:"+p.toFixed(3)+" "+s.url+" "),m(p,s))}}function O(s,r){var n=s.programDateTime;if(!!n){var a=(n-r)/1e3;s.start=s.startPTS=a,s.endPTS=a+s.duration}}function I(s,r){if(!(!r.fragments.length||!s.hasProgramDateTime||!r.hasProgramDateTime)){var n=r.fragments[0].programDateTime,a=r.fragments[0].start,p=n-a*1e3;s.fragments.forEach(function(f){O(f,p)}),s.fragmentHint&&O(s.fragmentHint,p),s.alignedSliding=!0}}},"./src/utils/ewma-bandwidth-estimator.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/utils/ewma.ts"),v=function(){function l(b,C,L){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultEstimate_=L,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new g.default(b),this.fast_=new g.default(C)}var P=l.prototype;return P.update=function(C,L){var m=this.slow_,A=this.fast_;this.slow_.halfLife!==C&&(this.slow_=new g.default(C,m.getEstimate(),m.getTotalWeight())),this.fast_.halfLife!==L&&(this.fast_=new g.default(L,A.getEstimate(),A.getTotalWeight()))},P.sample=function(C,L){C=Math.max(C,this.minDelayMs_);var m=8*L,A=C/1e3,D=m/A;this.fast_.sample(A,D),this.slow_.sample(A,D)},P.canEstimate=function(){var C=this.fast_;return C&&C.getTotalWeight()>=this.minWeight_},P.getEstimate=function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},P.destroy=function(){},l}();e.default=v},"./src/utils/ewma.ts":function(i,e,t){"use strict";t.r(e);var g=function(){function v(P,b,C){b===void 0&&(b=0),C===void 0&&(C=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=P,this.alpha_=P?Math.exp(Math.log(.5)/P):0,this.estimate_=b,this.totalWeight_=C}var l=v.prototype;return l.sample=function(b,C){var L=Math.pow(this.alpha_,b);this.estimate_=C*(1-L)+L*this.estimate_,this.totalWeight_+=b},l.getTotalWeight=function(){return this.totalWeight_},l.getEstimate=function(){if(this.alpha_){var b=1-Math.pow(this.alpha_,this.totalWeight_);if(b)return this.estimate_/b}return this.estimate_},v}();e.default=g},"./src/utils/fetch-loader.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"fetchSupported",function(){return S});var g=t("./src/polyfills/number.ts"),v=t("./src/loader/load-stats.ts"),l=t("./src/demux/chunk-cache.ts");function P(n,a){n.prototype=Object.create(a.prototype),n.prototype.constructor=n,A(n,a)}function b(n){var a=typeof Map=="function"?new Map:void 0;return b=function(f){if(f===null||!m(f))return f;if(typeof f!="function")throw new TypeError("Super expression must either be null or a function");if(typeof a!="undefined"){if(a.has(f))return a.get(f);a.set(f,h)}function h(){return C(f,arguments,D(this).constructor)}return h.prototype=Object.create(f.prototype,{constructor:{value:h,enumerable:!1,writable:!0,configurable:!0}}),A(h,f)},b(n)}function C(n,a,p){return L()?C=Reflect.construct:C=function(h,x,E){var c=[null];c.push.apply(c,x);var u=Function.bind.apply(h,c),o=new u;return E&&A(o,E.prototype),o},C.apply(null,arguments)}function L(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}function m(n){return Function.toString.call(n).indexOf("[native code]")!==-1}function A(n,a){return A=Object.setPrototypeOf||function(f,h){return f.__proto__=h,f},A(n,a)}function D(n){return D=Object.setPrototypeOf?Object.getPrototypeOf:function(p){return p.__proto__||Object.getPrototypeOf(p)},D(n)}function S(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(n){}return!1}var O=function(){function n(p){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=p.fetchSetup||s,this.controller=new self.AbortController,this.stats=new v.LoadStats}var a=n.prototype;return a.destroy=function(){this.loader=this.callbacks=null,this.abortInternal()},a.abortInternal=function(){var f=this.response;(!f||!f.ok)&&(this.stats.aborted=!0,this.controller.abort())},a.abort=function(){var f;this.abortInternal(),(f=this.callbacks)!==null&&f!==void 0&&f.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},a.load=function(f,h,x){var E=this,c=this.stats;if(c.loading.start)throw new Error("Loader can only be used once.");c.loading.start=self.performance.now();var u=I(f,this.controller.signal),o=x.onProgress,d=f.responseType==="arraybuffer",T=d?"byteLength":"length";this.context=f,this.config=h,this.callbacks=x,this.request=this.fetchSetup(f,u),self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(function(){E.abortInternal(),x.onTimeout(c,f,E.response)},h.timeout),self.fetch(this.request).then(function(y){if(E.response=E.loader=y,!y.ok){var R=y.status,M=y.statusText;throw new r(M||"fetch, bad network response",R,y)}return c.loading.first=Math.max(self.performance.now(),c.loading.start),c.total=parseInt(y.headers.get("Content-Length")||"0"),o&&Object(g.isFiniteNumber)(h.highWaterMark)?E.loadProgressively(y,c,f,h.highWaterMark,o):d?y.arrayBuffer():y.text()}).then(function(y){var R=E.response;self.clearTimeout(E.requestTimeout),c.loading.end=Math.max(self.performance.now(),c.loading.first),c.loaded=c.total=y[T];var M={url:R.url,data:y};o&&!Object(g.isFiniteNumber)(h.highWaterMark)&&o(c,f,y,R),x.onSuccess(M,c,f,R)}).catch(function(y){if(self.clearTimeout(E.requestTimeout),!c.aborted){var R=y.code||0;x.onError({code:R,text:y.message},f,y.details)}})},a.getCacheAge=function(){var f=null;if(this.response){var h=this.response.headers.get("age");f=h?parseFloat(h):null}return f},a.loadProgressively=function(f,h,x,E,c){E===void 0&&(E=0);var u=new l.default,o=f.body.getReader(),d=function T(){return o.read().then(function(y){if(y.done)return u.dataLength&&c(h,x,u.flush(),f),Promise.resolve(new ArrayBuffer(0));var R=y.value,M=R.length;return h.loaded+=M,M<E||u.dataLength?(u.push(R),u.dataLength>=E&&c(h,x,u.flush(),f)):c(h,x,R,f),T()}).catch(function(){return Promise.reject()})};return d()},n}();function I(n,a){var p={method:"GET",mode:"cors",credentials:"same-origin",signal:a};return n.rangeEnd&&(p.headers=new self.Headers({Range:"bytes="+n.rangeStart+"-"+String(n.rangeEnd-1)})),p}function s(n,a){return new self.Request(n.url,a)}var r=function(n){P(a,n);function a(p,f,h){var x;return x=n.call(this,p)||this,x.code=void 0,x.details=void 0,x.code=f,x.details=h,x}return a}(b(Error));e.default=O},"./src/utils/imsc1-ttml-parser.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"IMSC1_CODEC",function(){return m}),t.d(e,"parseIMSC1",function(){return O});var g=t("./src/utils/mp4-tools.ts"),v=t("./src/utils/vttparser.ts"),l=t("./src/utils/vttcue.ts"),P=t("./src/demux/id3.ts"),b=t("./src/utils/timescale-conversion.ts"),C=t("./src/utils/webvtt-parser.ts");function L(){return L=Object.assign||function(c){for(var u=1;u<arguments.length;u++){var o=arguments[u];for(var d in o)Object.prototype.hasOwnProperty.call(o,d)&&(c[d]=o[d])}return c},L.apply(this,arguments)}var m="stpp.ttml.im1t",A=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,D=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,S={left:"start",center:"center",right:"end",start:"start",end:"end"};function O(c,u,o,d,T){var y=Object(g.findBox)(new Uint8Array(c),["mdat"]);if(y.length===0){T(new Error("Could not parse IMSC1 mdat"));return}var R=y[0],M=Object(P.utf8ArrayToStr)(new Uint8Array(c,R.start,R.end-R.start)),_=Object(b.toTimescaleFromScale)(u,1,o);try{d(I(M,_))}catch(F){T(F)}}function I(c,u){var o=new DOMParser,d=o.parseFromString(c,"text/xml"),T=d.getElementsByTagName("tt")[0];if(!T)throw new Error("Invalid ttml");var y={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},R=Object.keys(y).reduce(function(w,k){return w[k]=T.getAttribute("ttp:"+k)||y[k],w},{}),M=T.getAttribute("xml:space")!=="preserve",_=r(s(T,"styling","style")),F=r(s(T,"layout","region")),B=s(T,"body","[begin]");return[].map.call(B,function(w){var k=n(w,M);if(!k||!w.hasAttribute("begin"))return null;var U=h(w.getAttribute("begin"),R),N=h(w.getAttribute("dur"),R),W=h(w.getAttribute("end"),R);if(U===null)throw f(w);if(W===null){if(N===null)throw f(w);W=U+N}var K=new l.default(U-u,W-u,k);K.id=Object(C.generateCueId)(K.startTime,K.endTime,K.text);var H=F[w.getAttribute("region")],G=_[w.getAttribute("style")];K.position=10,K.size=80;var V=a(H,G),X=V.textAlign;if(X){var z=S[X];z&&(K.lineAlign=z),K.align=X}return L(K,V),K}).filter(function(w){return w!==null})}function s(c,u,o){var d=c.getElementsByTagName(u)[0];return d?[].slice.call(d.querySelectorAll(o)):[]}function r(c){return c.reduce(function(u,o){var d=o.getAttribute("xml:id");return d&&(u[d]=o),u},{})}function n(c,u){return[].slice.call(c.childNodes).reduce(function(o,d,T){var y;return d.nodeName==="br"&&T?o+`
`:(y=d.childNodes)!==null&&y!==void 0&&y.length?n(d,u):u?o+d.textContent.trim().replace(/\s+/g," "):o+d.textContent},"")}function a(c,u){var o="http://www.w3.org/ns/ttml#styling",d=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"];return d.reduce(function(T,y){var R=p(u,o,y)||p(c,o,y);return R&&(T[y]=R),T},{})}function p(c,u,o){return c.hasAttributeNS(u,o)?c.getAttributeNS(u,o):null}function f(c){return new Error("Could not parse ttml timestamp "+c)}function h(c,u){if(!c)return null;var o=Object(v.parseTimeStamp)(c);return o===null&&(A.test(c)?o=x(c,u):D.test(c)&&(o=E(c,u))),o}function x(c,u){var o=A.exec(c),d=(o[4]|0)+(o[5]|0)/u.subFrameRate;return(o[1]|0)*3600+(o[2]|0)*60+(o[3]|0)+d/u.frameRate}function E(c,u){var o=D.exec(c),d=Number(o[1]),T=o[2];switch(T){case"h":return d*3600;case"m":return d*60;case"ms":return d*1e3;case"f":return d/u.frameRate;case"t":return d/u.tickRate}return d}},"./src/utils/logger.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"enableLogs",function(){return C}),t.d(e,"logger",function(){return L});var g=function(){},v={trace:g,debug:g,log:g,warn:g,info:g,error:g},l=v;function P(m){var A=self.console[m];return A?A.bind(self.console,"["+m+"] >"):g}function b(m){for(var A=arguments.length,D=new Array(A>1?A-1:0),S=1;S<A;S++)D[S-1]=arguments[S];D.forEach(function(O){l[O]=m[O]?m[O].bind(m):P(O)})}function C(m){if(self.console&&m===!0||typeof m=="object"){b(m,"debug","log","info","warn","error");try{l.log()}catch(A){l=v}}else l=v}var L=l},"./src/utils/mediakeys-helper.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"KeySystems",function(){return g}),t.d(e,"requestMediaKeySystemAccess",function(){return v});var g;(function(l){l.WIDEVINE="com.widevine.alpha",l.PLAYREADY="com.microsoft.playready"})(g||(g={}));var v=function(){return typeof self!="undefined"&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}()},"./src/utils/mediasource-helper.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"getMediaSource",function(){return g});function g(){return self.MediaSource||self.WebKitMediaSource}},"./src/utils/mp4-tools.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"bin2str",function(){return b}),t.d(e,"readUint16",function(){return C}),t.d(e,"readUint32",function(){return L}),t.d(e,"writeUint32",function(){return m}),t.d(e,"findBox",function(){return A}),t.d(e,"parseSegmentIndex",function(){return D}),t.d(e,"parseInitSegment",function(){return S}),t.d(e,"getStartDTS",function(){return O}),t.d(e,"getDuration",function(){return I}),t.d(e,"computeRawDurationFromSamples",function(){return s}),t.d(e,"offsetStartDTS",function(){return r}),t.d(e,"segmentValidRange",function(){return n}),t.d(e,"appendUint8Array",function(){return a});var g=t("./src/utils/typed-array.ts"),v=t("./src/loader/fragment.ts"),l=Math.pow(2,32)-1,P=[].push;function b(p){return String.fromCharCode.apply(null,p)}function C(p,f){"data"in p&&(f+=p.start,p=p.data);var h=p[f]<<8|p[f+1];return h<0?65536+h:h}function L(p,f){"data"in p&&(f+=p.start,p=p.data);var h=p[f]<<24|p[f+1]<<16|p[f+2]<<8|p[f+3];return h<0?4294967296+h:h}function m(p,f,h){"data"in p&&(f+=p.start,p=p.data),p[f]=h>>24,p[f+1]=h>>16&255,p[f+2]=h>>8&255,p[f+3]=h&255}function A(p,f){var h=[];if(!f.length)return h;var x,E,c;"data"in p?(x=p.data,E=p.start,c=p.end):(x=p,E=0,c=x.byteLength);for(var u=E;u<c;){var o=L(x,u),d=b(x.subarray(u+4,u+8)),T=o>1?u+o:c;if(d===f[0])if(f.length===1)h.push({data:x,start:u+8,end:T});else{var y=A({data:x,start:u+8,end:T},f.slice(1));y.length&&P.apply(h,y)}u=T}return h}function D(p){var f=A(p,["moov"]),h=f[0],x=h?h.end:null,E=A(p,["sidx"]);if(!E||!E[0])return null;var c=[],u=E[0],o=u.data[0],d=o===0?8:16,T=L(u,d);d+=4;var y=0,R=0;o===0?d+=8:d+=16,d+=2;var M=u.end+R,_=C(u,d);d+=2;for(var F=0;F<_;F++){var B=d,w=L(u,B);B+=4;var k=w&2147483647,U=(w&2147483648)>>>31;if(U===1)return console.warn("SIDX has hierarchical references (not supported)"),null;var N=L(u,B);B+=4,c.push({referenceSize:k,subsegmentDuration:N,info:{duration:N/T,start:M,end:M+k-1}}),M+=k,B+=4,d=B}return{earliestPresentationTime:y,timescale:T,version:o,referencesCount:_,references:c,moovEndOffset:x}}function S(p){for(var f=[],h=A(p,["moov","trak"]),x=0;x<h.length;x++){var E=h[x],c=A(E,["tkhd"])[0];if(c){var u=c.data[c.start],o=u===0?12:20,d=L(c,o),T=A(E,["mdia","mdhd"])[0];if(T){u=T.data[T.start],o=u===0?12:20;var y=L(T,o),R=A(E,["mdia","hdlr"])[0];if(R){var M=b(R.data.subarray(R.start+8,R.start+12)),_={soun:v.ElementaryStreamTypes.AUDIO,vide:v.ElementaryStreamTypes.VIDEO}[M];if(_){var F=A(E,["mdia","minf","stbl","stsd"])[0],B=void 0;F&&(B=b(F.data.subarray(F.start+12,F.start+16))),f[d]={timescale:y,type:_},f[_]={timescale:y,id:d,codec:B}}}}}}var w=A(p,["moov","mvex","trex"]);return w.forEach(function(k){var U=L(k,4),N=f[U];N&&(N.default={duration:L(k,12),flags:L(k,20)})}),f}function O(p,f){return A(f,["moof","traf"]).reduce(function(h,x){var E=A(x,["tfdt"])[0],c=E.data[E.start],u=A(x,["tfhd"]).reduce(function(o,d){var T=L(d,4),y=p[T];if(y){var R=L(E,4);c===1&&(R*=Math.pow(2,32),R+=L(E,8));var M=y.timescale||9e4,_=R/M;if(isFinite(_)&&(o===null||_<o))return _}return o},null);return u!==null&&isFinite(u)&&(h===null||u<h)?u:h},null)||0}function I(p,f){for(var h=0,x=0,E=0,c=A(p,["moof","traf"]),u=0;u<c.length;u++){var o=c[u],d=A(o,["tfhd"])[0],T=L(d,4),y=f[T];if(!!y){var R=y.default,M=L(d,0)|(R==null?void 0:R.flags),_=R==null?void 0:R.duration;M&8&&(M&2?_=L(d,12):_=L(d,8));for(var F=y.timescale||9e4,B=A(o,["trun"]),w=0;w<B.length;w++){if(_){var k=L(B[w],4);h=_*k}else h=s(B[w]);y.type===v.ElementaryStreamTypes.VIDEO?x+=h/F:y.type===v.ElementaryStreamTypes.AUDIO&&(E+=h/F)}}}if(x===0&&E===0){var U=D(p);if(U!=null&&U.references)return U.references.reduce(function(N,W){return N+W.info.duration||0},0)}return x||E}function s(p){var f=L(p,0),h=8;f&1&&(h+=4),f&4&&(h+=4);for(var x=0,E=L(p,4),c=0;c<E;c++){if(f&256){var u=L(p,h);x+=u,h+=4}f&512&&(h+=4),f&1024&&(h+=4),f&2048&&(h+=4)}return x}function r(p,f,h){A(f,["moof","traf"]).forEach(function(x){A(x,["tfhd"]).forEach(function(E){var c=L(E,4),u=p[c];if(!!u){var o=u.timescale||9e4;A(x,["tfdt"]).forEach(function(d){var T=d.data[d.start],y=L(d,4);if(T===0)m(d,4,y-h*o);else{y*=Math.pow(2,32),y+=L(d,8),y-=h*o,y=Math.max(y,0);var R=Math.floor(y/(l+1)),M=Math.floor(y%(l+1));m(d,4,R),m(d,8,M)}})}})})}function n(p){var f={valid:null,remainder:null},h=A(p,["moof"]);if(h){if(h.length<2)return f.remainder=p,f}else return f;var x=h[h.length-1];return f.valid=Object(g.sliceUint8)(p,0,x.start-8),f.remainder=Object(g.sliceUint8)(p,x.start-8),f}function a(p,f){var h=new Uint8Array(p.length+f.length);return h.set(p),h.set(f,p.length),h}},"./src/utils/output-filter.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"default",function(){return g});var g=function(){function v(P,b){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=P,this.trackName=b}var l=v.prototype;return l.dispatchCue=function(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},l.newCue=function(b,C,L){(this.startTime===null||this.startTime>b)&&(this.startTime=b),this.endTime=C,this.screen=L,this.timelineController.createCaptionsTrack(this.trackName)},l.reset=function(){this.cueRanges=[]},v}()},"./src/utils/texttrack-utils.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"sendAddTrackEvent",function(){return v}),t.d(e,"addCueToTrack",function(){return l}),t.d(e,"clearCurrentCues",function(){return P}),t.d(e,"removeCuesInRange",function(){return b}),t.d(e,"getCuesInRange",function(){return L});var g=t("./src/utils/logger.ts");function v(m,A){var D;try{D=new Event("addtrack")}catch(S){D=document.createEvent("Event"),D.initEvent("addtrack",!1,!1)}D.track=m,A.dispatchEvent(D)}function l(m,A){var D=m.mode;if(D==="disabled"&&(m.mode="hidden"),m.cues&&!m.cues.getCueById(A.id))try{if(m.addCue(A),!m.cues.getCueById(A.id))throw new Error("addCue is failed for: "+A)}catch(O){g.logger.debug("[texttrack-utils]: "+O);var S=new self.TextTrackCue(A.startTime,A.endTime,A.text);S.id=A.id,m.addCue(S)}D==="disabled"&&(m.mode=D)}function P(m){var A=m.mode;if(A==="disabled"&&(m.mode="hidden"),m.cues)for(var D=m.cues.length;D--;)m.removeCue(m.cues[D]);A==="disabled"&&(m.mode=A)}function b(m,A,D){var S=m.mode;if(S==="disabled"&&(m.mode="hidden"),m.cues&&m.cues.length>0)for(var O=L(m.cues,A,D),I=0;I<O.length;I++)m.removeCue(O[I]);S==="disabled"&&(m.mode=S)}function C(m,A){if(A<m[0].startTime)return 0;var D=m.length-1;if(A>m[D].endTime)return-1;for(var S=0,O=D;S<=O;){var I=Math.floor((O+S)/2);if(A<m[I].startTime)O=I-1;else if(A>m[I].startTime&&S<D)S=I+1;else return I}return m[S].startTime-A<A-m[O].startTime?S:O}function L(m,A,D){var S=[],O=C(m,A);if(O>-1)for(var I=O,s=m.length;I<s;I++){var r=m[I];if(r.startTime>=A&&r.endTime<=D)S.push(r);else if(r.startTime>D)return S}return S}},"./src/utils/time-ranges.ts":function(i,e,t){"use strict";t.r(e);var g={toString:function(l){for(var P="",b=l.length,C=0;C<b;C++)P+="["+l.start(C).toFixed(3)+","+l.end(C).toFixed(3)+"]";return P}};e.default=g},"./src/utils/timescale-conversion.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"toTimescaleFromBase",function(){return v}),t.d(e,"toTimescaleFromScale",function(){return l}),t.d(e,"toMsFromMpegTsClock",function(){return P}),t.d(e,"toMpegTsClockFromTimescale",function(){return b});var g=9e4;function v(C,L,m,A){m===void 0&&(m=1),A===void 0&&(A=!1);var D=C*L*m;return A?Math.round(D):D}function l(C,L,m,A){return m===void 0&&(m=1),A===void 0&&(A=!1),v(C,L,1/m,A)}function P(C,L){return L===void 0&&(L=!1),v(C,1e3,1/g,L)}function b(C,L){return L===void 0&&(L=1),v(C,g,1/L)}},"./src/utils/typed-array.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"sliceUint8",function(){return g});function g(v,l,P){return Uint8Array.prototype.slice?v.slice(l,P):new Uint8Array(Array.prototype.slice.call(v,l,P))}},"./src/utils/vttcue.ts":function(i,e,t){"use strict";t.r(e),e.default=function(){if(typeof self!="undefined"&&self.VTTCue)return self.VTTCue;var g=["","lr","rl"],v=["start","middle","end","left","right"];function l(m,A){if(typeof A!="string"||!Array.isArray(m))return!1;var D=A.toLowerCase();return~m.indexOf(D)?D:!1}function P(m){return l(g,m)}function b(m){return l(v,m)}function C(m){for(var A=arguments.length,D=new Array(A>1?A-1:0),S=1;S<A;S++)D[S-1]=arguments[S];for(var O=1;O<arguments.length;O++){var I=arguments[O];for(var s in I)m[s]=I[s]}return m}function L(m,A,D){var S=this,O={enumerable:!0};S.hasBeenReset=!1;var I="",s=!1,r=m,n=A,a=D,p=null,f="",h=!0,x="auto",E="start",c=50,u="middle",o=50,d="middle";Object.defineProperty(S,"id",C({},O,{get:function(){return I},set:function(y){I=""+y}})),Object.defineProperty(S,"pauseOnExit",C({},O,{get:function(){return s},set:function(y){s=!!y}})),Object.defineProperty(S,"startTime",C({},O,{get:function(){return r},set:function(y){if(typeof y!="number")throw new TypeError("Start time must be set to a number.");r=y,this.hasBeenReset=!0}})),Object.defineProperty(S,"endTime",C({},O,{get:function(){return n},set:function(y){if(typeof y!="number")throw new TypeError("End time must be set to a number.");n=y,this.hasBeenReset=!0}})),Object.defineProperty(S,"text",C({},O,{get:function(){return a},set:function(y){a=""+y,this.hasBeenReset=!0}})),Object.defineProperty(S,"region",C({},O,{get:function(){return p},set:function(y){p=y,this.hasBeenReset=!0}})),Object.defineProperty(S,"vertical",C({},O,{get:function(){return f},set:function(y){var R=P(y);if(R===!1)throw new SyntaxError("An invalid or illegal string was specified.");f=R,this.hasBeenReset=!0}})),Object.defineProperty(S,"snapToLines",C({},O,{get:function(){return h},set:function(y){h=!!y,this.hasBeenReset=!0}})),Object.defineProperty(S,"line",C({},O,{get:function(){return x},set:function(y){if(typeof y!="number"&&y!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");x=y,this.hasBeenReset=!0}})),Object.defineProperty(S,"lineAlign",C({},O,{get:function(){return E},set:function(y){var R=b(y);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");E=R,this.hasBeenReset=!0}})),Object.defineProperty(S,"position",C({},O,{get:function(){return c},set:function(y){if(y<0||y>100)throw new Error("Position must be between 0 and 100.");c=y,this.hasBeenReset=!0}})),Object.defineProperty(S,"positionAlign",C({},O,{get:function(){return u},set:function(y){var R=b(y);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");u=R,this.hasBeenReset=!0}})),Object.defineProperty(S,"size",C({},O,{get:function(){return o},set:function(y){if(y<0||y>100)throw new Error("Size must be between 0 and 100.");o=y,this.hasBeenReset=!0}})),Object.defineProperty(S,"align",C({},O,{get:function(){return d},set:function(y){var R=b(y);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");d=R,this.hasBeenReset=!0}})),S.displayState=void 0}return L.prototype.getCueAsHTML=function(){var m=self.WebVTT;return m.convertCueToDOMTree(self,this.text)},L}()},"./src/utils/vttparser.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"parseTimeStamp",function(){return l}),t.d(e,"fixLineBreaks",function(){return A}),t.d(e,"VTTParser",function(){return D});var g=t("./src/utils/vttcue.ts"),v=function(){function S(){}var O=S.prototype;return O.decode=function(s,r){if(!s)return"";if(typeof s!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(s))},S}();function l(S){function O(s,r,n,a){return(s|0)*3600+(r|0)*60+(n|0)+parseFloat(a||0)}var I=S.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return I?parseFloat(I[2])>59?O(I[2],I[3],0,I[4]):O(I[1],I[2],I[3],I[4]):null}var P=function(){function S(){this.values=Object.create(null)}var O=S.prototype;return O.set=function(s,r){!this.get(s)&&r!==""&&(this.values[s]=r)},O.get=function(s,r,n){return n?this.has(s)?this.values[s]:r[n]:this.has(s)?this.values[s]:r},O.has=function(s){return s in this.values},O.alt=function(s,r,n){for(var a=0;a<n.length;++a)if(r===n[a]){this.set(s,r);break}},O.integer=function(s,r){/^-?\d+$/.test(r)&&this.set(s,parseInt(r,10))},O.percent=function(s,r){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(r)){var n=parseFloat(r);if(n>=0&&n<=100)return this.set(s,n),!0}return!1},S}();function b(S,O,I,s){var r=s?S.split(s):[S];for(var n in r)if(typeof r[n]=="string"){var a=r[n].split(I);if(a.length===2){var p=a[0],f=a[1];O(p,f)}}}var C=new g.default(0,0,""),L=C.align==="middle"?"middle":"center";function m(S,O,I){var s=S;function r(){var p=l(S);if(p===null)throw new Error("Malformed timestamp: "+s);return S=S.replace(/^[^\sa-zA-Z-]+/,""),p}function n(p,f){var h=new P;b(p,function(c,u){var o;switch(c){case"region":for(var d=I.length-1;d>=0;d--)if(I[d].id===u){h.set(c,I[d].region);break}break;case"vertical":h.alt(c,u,["rl","lr"]);break;case"line":o=u.split(","),h.integer(c,o[0]),h.percent(c,o[0])&&h.set("snapToLines",!1),h.alt(c,o[0],["auto"]),o.length===2&&h.alt("lineAlign",o[1],["start",L,"end"]);break;case"position":o=u.split(","),h.percent(c,o[0]),o.length===2&&h.alt("positionAlign",o[1],["start",L,"end","line-left","line-right","auto"]);break;case"size":h.percent(c,u);break;case"align":h.alt(c,u,["start",L,"end","left","right"]);break}},/:/,/\s/),f.region=h.get("region",null),f.vertical=h.get("vertical","");var x=h.get("line","auto");x==="auto"&&C.line===-1&&(x=-1),f.line=x,f.lineAlign=h.get("lineAlign","start"),f.snapToLines=h.get("snapToLines",!0),f.size=h.get("size",100),f.align=h.get("align",L);var E=h.get("position","auto");E==="auto"&&C.position===50&&(E=f.align==="start"||f.align==="left"?0:f.align==="end"||f.align==="right"?100:50),f.position=E}function a(){S=S.replace(/^\s+/,"")}if(a(),O.startTime=r(),a(),S.substr(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+s);S=S.substr(3),a(),O.endTime=r(),a(),n(S,O)}function A(S){return S.replace(/<br(?: \/)?>/gi,`
`)}var D=function(){function S(){this.state="INITIAL",this.buffer="",this.decoder=new v,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}var O=S.prototype;return O.parse=function(s){var r=this;s&&(r.buffer+=r.decoder.decode(s,{stream:!0}));function n(){var E=r.buffer,c=0;for(E=A(E);c<E.length&&E[c]!=="\r"&&E[c]!==`
`;)++c;var u=E.substr(0,c);return E[c]==="\r"&&++c,E[c]===`
`&&++c,r.buffer=E.substr(c),u}function a(E){b(E,function(c,u){},/:/)}try{var p="";if(r.state==="INITIAL"){if(!/\r\n|\n/.test(r.buffer))return this;p=n();var f=p.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!f||!f[0])throw new Error("Malformed WebVTT signature.");r.state="HEADER"}for(var h=!1;r.buffer;){if(!/\r\n|\n/.test(r.buffer))return this;switch(h?h=!1:p=n(),r.state){case"HEADER":/:/.test(p)?a(p):p||(r.state="ID");continue;case"NOTE":p||(r.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(p)){r.state="NOTE";break}if(!p)continue;if(r.cue=new g.default(0,0,""),r.state="CUE",p.indexOf("-->")===-1){r.cue.id=p;continue}case"CUE":if(!r.cue){r.state="BADCUE";continue}try{m(p,r.cue,r.regionList)}catch(E){r.cue=null,r.state="BADCUE";continue}r.state="CUETEXT";continue;case"CUETEXT":{var x=p.indexOf("-->")!==-1;if(!p||x&&(h=!0)){r.oncue&&r.cue&&r.oncue(r.cue),r.cue=null,r.state="ID";continue}if(r.cue===null)continue;r.cue.text&&(r.cue.text+=`
`),r.cue.text+=p}continue;case"BADCUE":p||(r.state="ID")}}}catch(E){r.state==="CUETEXT"&&r.cue&&r.oncue&&r.oncue(r.cue),r.cue=null,r.state=r.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this},O.flush=function(){var s=this;try{if((s.cue||s.state==="HEADER")&&(s.buffer+=`

`,s.parse()),s.state==="INITIAL"||s.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(r){s.onparsingerror&&s.onparsingerror(r)}return s.onflush&&s.onflush(),this},S}()},"./src/utils/webvtt-parser.ts":function(i,e,t){"use strict";t.r(e),t.d(e,"generateCueId",function(){return D}),t.d(e,"parseWebVTT",function(){return O});var g=t("./src/polyfills/number.ts"),v=t("./src/utils/vttparser.ts"),l=t("./src/demux/id3.ts"),P=t("./src/utils/timescale-conversion.ts"),b=t("./src/remux/mp4-remuxer.ts"),C=/\r\n|\n\r|\n|\r/g,L=function(s,r,n){return n===void 0&&(n=0),s.substr(n,r.length)===r},m=function(s){var r=parseInt(s.substr(-3)),n=parseInt(s.substr(-6,2)),a=parseInt(s.substr(-9,2)),p=s.length>9?parseInt(s.substr(0,s.indexOf(":"))):0;if(!Object(g.isFiniteNumber)(r)||!Object(g.isFiniteNumber)(n)||!Object(g.isFiniteNumber)(a)||!Object(g.isFiniteNumber)(p))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+s);return r+=1e3*n,r+=60*1e3*a,r+=60*60*1e3*p,r},A=function(s){for(var r=5381,n=s.length;n;)r=r*33^s.charCodeAt(--n);return(r>>>0).toString()};function D(I,s,r){return A(I.toString())+A(s.toString())+A(r)}var S=function(s,r,n){var a=s[r],p=s[a.prevCC];if(!p||!p.new&&a.new){s.ccOffset=s.presentationOffset=a.start,a.new=!1;return}for(;(f=p)!==null&&f!==void 0&&f.new;){var f;s.ccOffset+=a.start-p.start,a.new=!1,a=p,p=s[a.prevCC]}s.presentationOffset=n};function O(I,s,r,n,a,p,f,h){var x=new v.VTTParser,E=Object(l.utf8ArrayToStr)(new Uint8Array(I)).trim().replace(C,`
`).split(`
`),c=[],u=Object(P.toMpegTsClockFromTimescale)(s,r),o="00:00.000",d=0,T=0,y,R=!0,M=!1;x.oncue=function(_){var F=n[a],B=n.ccOffset,w=(d-u)/9e4;if(F!=null&&F.new&&(T!==void 0?B=n.ccOffset=F.start:S(n,a,w)),w&&(B=w-n.presentationOffset),M){var k=_.endTime-_.startTime,U=Object(b.normalizePts)((_.startTime+B-T)*9e4,p*9e4)/9e4;_.startTime=U,_.endTime=U+k}var N=_.text.trim();_.text=decodeURIComponent(encodeURIComponent(N)),_.id||(_.id=D(_.startTime,_.endTime,N)),_.endTime>0&&c.push(_)},x.onparsingerror=function(_){y=_},x.onflush=function(){if(y){h(y);return}f(c)},E.forEach(function(_){if(R)if(L(_,"X-TIMESTAMP-MAP=")){R=!1,M=!0,_.substr(16).split(",").forEach(function(F){L(F,"LOCAL:")?o=F.substr(6):L(F,"MPEGTS:")&&(d=parseInt(F.substr(7)))});try{T=m(o)/1e3}catch(F){M=!1,y=F}return}else _===""&&(R=!1);x.parse(_+`
`)}),x.flush()}},"./src/utils/xhr-loader.ts":function(i,e,t){"use strict";t.r(e);var g=t("./src/utils/logger.ts"),v=t("./src/loader/load-stats.ts"),l=/^age:\s*[\d.]+\s*$/m,P=function(){function b(L){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=L?L.xhrSetup:null,this.stats=new v.LoadStats,this.retryDelay=0}var C=b.prototype;return C.destroy=function(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null},C.abortInternal=function(){var m=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),m&&(m.onreadystatechange=null,m.onprogress=null,m.readyState!==4&&(this.stats.aborted=!0,m.abort()))},C.abort=function(){var m;this.abortInternal(),(m=this.callbacks)!==null&&m!==void 0&&m.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},C.load=function(m,A,D){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=m,this.config=A,this.callbacks=D,this.retryDelay=A.retryDelay,this.loadInternal()},C.loadInternal=function(){var m=this.config,A=this.context;if(!!m){var D=this.loader=new self.XMLHttpRequest,S=this.stats;S.loading.first=0,S.loaded=0;var O=this.xhrSetup;try{if(O)try{O(D,A.url)}catch(I){D.open("GET",A.url,!0),O(D,A.url)}D.readyState||D.open("GET",A.url,!0)}catch(I){this.callbacks.onError({code:D.status,text:I.message},A,D);return}A.rangeEnd&&D.setRequestHeader("Range","bytes="+A.rangeStart+"-"+(A.rangeEnd-1)),D.onreadystatechange=this.readystatechange.bind(this),D.onprogress=this.loadprogress.bind(this),D.responseType=A.responseType,self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),m.timeout),D.send()}},C.readystatechange=function(){var m=this.context,A=this.loader,D=this.stats;if(!(!m||!A)){var S=A.readyState,O=this.config;if(!D.aborted&&S>=2)if(self.clearTimeout(this.requestTimeout),D.loading.first===0&&(D.loading.first=Math.max(self.performance.now(),D.loading.start)),S===4){A.onreadystatechange=null,A.onprogress=null;var I=A.status;if(I>=200&&I<300){D.loading.end=Math.max(self.performance.now(),D.loading.first);var s,r;if(m.responseType==="arraybuffer"?(s=A.response,r=s.byteLength):(s=A.responseText,r=s.length),D.loaded=D.total=r,!this.callbacks)return;var n=this.callbacks.onProgress;if(n&&n(D,m,s,A),!this.callbacks)return;var a={url:A.responseURL,data:s};this.callbacks.onSuccess(a,D,m,A)}else D.retry>=O.maxRetry||I>=400&&I<499?(g.logger.error(I+" while loading "+m.url),this.callbacks.onError({code:I,text:A.statusText},m,A)):(g.logger.warn(I+" while loading "+m.url+", retrying in "+this.retryDelay+"..."),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,O.maxRetryDelay),D.retry++)}else self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),O.timeout)}},C.loadtimeout=function(){g.logger.warn("timeout while loading "+this.context.url);var m=this.callbacks;m&&(this.abortInternal(),m.onTimeout(this.stats,this.context,this.loader))},C.loadprogress=function(m){var A=this.stats;A.loaded=m.loaded,m.lengthComputable&&(A.total=m.total)},C.getCacheAge=function(){var m=null;if(this.loader&&l.test(this.loader.getAllResponseHeaders())){var A=this.loader.getResponseHeader("age");m=A?parseFloat(A):null}return m},b}();e.default=P}}).default})});import Ve,{useEffect as As}from"react";import je from"react";function _t(i,e,t){return e in i?Object.defineProperty(i,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):i[e]=t,i}function fr(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var g=Object.getOwnPropertySymbols(i);e&&(g=g.filter(function(v){return Object.getOwnPropertyDescriptor(i,v).enumerable})),t.push.apply(t,g)}return t}function xt(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?fr(Object(t),!0).forEach(function(g){_t(i,g,t[g])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):fr(Object(t)).forEach(function(g){Object.defineProperty(i,g,Object.getOwnPropertyDescriptor(t,g))})}return i}function ue(i){return"Minified Redux error #"+i+"; visit https://redux.js.org/Errors?code="+i+" for the full message or use the non-minified dev environment for full errors. "}var dr=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}(),Ft=function(){return Math.random().toString(36).substring(7).split("").join(".")},St={INIT:"@@redux/INIT"+Ft(),REPLACE:"@@redux/REPLACE"+Ft(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+Ft()}};function qi(i){if(typeof i!="object"||i===null)return!1;for(var e=i;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(i)===e}function Bt(i,e,t){var g;if(typeof e=="function"&&typeof t=="function"||typeof t=="function"&&typeof arguments[3]=="function")throw new Error(ue(0));if(typeof e=="function"&&typeof t=="undefined"&&(t=e,e=void 0),typeof t!="undefined"){if(typeof t!="function")throw new Error(ue(1));return t(Bt)(i,e)}if(typeof i!="function")throw new Error(ue(2));var v=i,l=e,P=[],b=P,C=!1;function L(){b===P&&(b=P.slice())}function m(){if(C)throw new Error(ue(3));return l}function A(I){if(typeof I!="function")throw new Error(ue(4));if(C)throw new Error(ue(5));var s=!0;return L(),b.push(I),function(){if(!!s){if(C)throw new Error(ue(6));s=!1,L();var n=b.indexOf(I);b.splice(n,1),P=null}}}function D(I){if(!qi(I))throw new Error(ue(7));if(typeof I.type=="undefined")throw new Error(ue(8));if(C)throw new Error(ue(9));try{C=!0,l=v(l,I)}finally{C=!1}for(var s=P=b,r=0;r<s.length;r++){var n=s[r];n()}return I}function S(I){if(typeof I!="function")throw new Error(ue(10));v=I,D({type:St.REPLACE})}function O(){var I,s=A;return I={subscribe:function(n){if(typeof n!="object"||n===null)throw new Error(ue(11));function a(){n.next&&n.next(m())}a();var p=s(a);return{unsubscribe:p}}},I[dr]=function(){return this},I}return D({type:St.INIT}),g={dispatch:D,subscribe:A,getState:m,replaceReducer:S},g[dr]=O,g}function en(i){Object.keys(i).forEach(function(e){var t=i[e],g=t(void 0,{type:St.INIT});if(typeof g=="undefined")throw new Error(ue(12));if(typeof t(void 0,{type:St.PROBE_UNKNOWN_ACTION()})=="undefined")throw new Error(ue(13))})}function wt(i){for(var e=Object.keys(i),t={},g=0;g<e.length;g++){var v=e[g];typeof i[v]=="function"&&(t[v]=i[v])}var l=Object.keys(t),P,b;try{en(t)}catch(C){b=C}return function(L,m){if(L===void 0&&(L={}),b)throw b;if(!1)var A;for(var D=!1,S={},O=0;O<l.length;O++){var I=l[O],s=t[I],r=L[I],n=s(r,m);if(typeof n=="undefined"){var a=m&&m.type;throw new Error(ue(14))}S[I]=n,D=D||n!==r}return D=D||l.length!==Object.keys(L).length,D?S:L}}function At(){for(var i=arguments.length,e=new Array(i),t=0;t<i;t++)e[t]=arguments[t];return e.length===0?function(g){return g}:e.length===1?e[0]:e.reduce(function(g,v){return function(){return g(v.apply(void 0,arguments))}})}function cr(){for(var i=arguments.length,e=new Array(i),t=0;t<i;t++)e[t]=arguments[t];return function(g){return function(){var v=g.apply(void 0,arguments),l=function(){throw new Error(ue(15))},P={getState:v.getState,dispatch:function(){return l.apply(void 0,arguments)}},b=e.map(function(C){return C(P)});return l=At.apply(void 0,b)(v.dispatch),xt(xt({},v),{},{dispatch:l})}}}var Ie=ur(vr());function Ye(i){return i.endsWith("info.json")?i:i.endsWith("/")?`${i}info.json`:`${i}/info.json`}function tn(i,e,t){let g=t.length,v=[];for(let l=0;l<g;l++){let b=t[l].width;v.push(i/b)}return v}function rn(i,e,t){let g=t.length,v=[];for(let l=0;l<g;l++){let P=t[l];v.push({width:Math.floor(i/P),height:Math.floor(e/P)})}return v}var nn="http://library.stanford.edu/iiif/image-api/compliance.html#level0",gr="http://library.stanford.edu/iiif/image-api/compliance.html#level1",mr="http://library.stanford.edu/iiif/image-api/compliance.html#level2",an="http://library.stanford.edu/iiif/image-api/conformance.html#level0",pr="http://library.stanford.edu/iiif/image-api/conformance.html#level1",Er="http://library.stanford.edu/iiif/image-api/conformance.html#level2",sn="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",yr="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",Tr="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",on="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",xr="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",Sr="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",ln="http://iiif.io/api/image/1/level0.json",un="http://iiif.io/api/image/1/profiles/level0.json",Ar="http://iiif.io/api/image/1/level1.json",Lr="http://iiif.io/api/image/1/profiles/level1.json",Ir="http://iiif.io/api/image/1/level2.json",Dr="http://iiif.io/api/image/1/profiles/level2.json",fn="http://iiif.io/api/image/2/level0.json",dn="http://iiif.io/api/image/2/profiles/level0.json",Or="http://iiif.io/api/image/2/level1.json",Rr="http://iiif.io/api/image/2/profiles/level1.json",Cr="http://iiif.io/api/image/2/level2.json",Pr="http://iiif.io/api/image/2/profiles/level2.json",cn="level0",br="level1",Mr="level2",hn="http://iiif.io/api/image/2/level0",_r="http://iiif.io/api/image/2/level1",Fr="http://iiif.io/api/image/2/level2",Ut=[_r,Fr,gr,mr,pr,Er,yr,Tr,xr,Sr,Ar,Lr,Ir,Dr,Or,Rr,Cr,Pr,br,Mr],kt=[hn,_r,Fr,nn,gr,mr,an,pr,Er,sn,yr,Tr,on,xr,Sr,ln,un,Ar,Lr,Ir,Dr,fn,dn,Or,Rr,Cr,Pr,cn,br,Mr];function te(i){if(i["@id"])return i["@id"];if(i.id)return i.id}function Nt(i){if(!i||!i.profile||!te(i))return!1;let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t=="string"&&kt.indexOf(t)!==-1)return!0;return!1}function vn(i){if(!Nt(i))return!1;let e=Array.isArray(i.profile)?i.profile:[i.profile];for(let t of e)if(typeof t=="string"){if(Ut.indexOf(t)!==-1)return!0}else{let g=t.supports||[];if(g.indexOf("regionByPx")!==-1&&(g.indexOf("sizeByW")!==-1||g.indexOf("sizeByWh")!==-1))return!0}return!1}function gn(i){if(!vn(i))return[];let e=[],t=Array.isArray(i.profile)?i.profile:[i.profile],g=t.length;for(let v=0;v<g;v++){let l=t[v];if(typeof l!="string"&&(l.maxHeight||l.maxWidth))return[{id:te(i),type:"variable",minWidth:0,minHeight:0,maxHeight:l.maxHeight||l.maxWidth,maxWidth:l.maxWidth||l.maxHeight}]}if(i.tiles){let v=i.tiles.length;for(let l=0;l<v;l++){let P=i.tiles[l];(P.height||P.width)&&e.push({id:te(i),type:"variable",minHeight:0,minWidth:0,maxHeight:P.height||P.width,maxWidth:P.width})}}return e}function Br(i){let e=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,t=i.match(e);if(t){let g=t[1],v=parseInt(t[4],10),l=parseInt(t[5],10),P=t[7];if((g==="max"||g==="full")&&v&&l&&P)return{type:"fixed",id:i,height:l,width:v}}return{type:"unknown",id:i}}function mn(i){if(i["@type"])return i["@type"];if(i.type)return i.type}function It(i){if(typeof i=="string")return Br(i);let e=mn(i);if(e!=="Image"&&e!=="sc:Image")return null;let t=i,g=te(t);return g?g&&t.width&&t.height?{id:g,type:"fixed",width:t.width,height:t.height,unsafe:!0}:Br(g):null}function pn(i){return Nt(i)?(i&&i.sizes?i.sizes:[]).map(e=>({id:te(i),type:"fixed-service",height:e.height,width:e.width})):[]}function wr(i){let e=[],t=i.length;for(let g=0;g<t;g++){let v=pn(i[g]);v.length&&e.push(...v);let l=gn(i[g]);l.length&&e.push(...l)}return e}function Ur(i){let e=i.service?Array.isArray(i.service)?i.service:[i.service]:[],t=e.length,g=[];for(let v=0;v<t;v++)Nt(e[v])&&i.width&&i.height&&g.push(e[v]);return g}function En(i,e=!0,t){let g=[],v=It(i);if(v===null)return g;let l=i;if(g.push(v),e&&l.width&&l.height){let P=[],b=Ur(l);for(let C of b){let L={id:te(C),width:l.width,height:l.height};if(t.canLoadSync(L)){let m=t.loadServiceSync(L);m&&(m.height||(m.height=l.height),m.width||(m.width=l.width),P.push(...wr([m])))}}if(P.length)return g.push(...P),g}return l.service&&g.push(...wr(l.service)),g}function Kt(i,e,t){return{id:[Ye(te(i)).slice(0,-10),"full",[e,t||""].join(","),0,"default.jpg"].join("/"),type:"fixed",width:e,height:t||i.height/i.width*e,unsafe:i.width>e}}function $e(i){let e=i.replace(/(https?:\/\/)?(www.)?/i,"");return e.indexOf("/")!==-1?e.split("/")[0]:e}function yn(i,e,t){let g=i.width?i.width:i.maxWidth;return t.height<=i.maxHeight&&t.width<=i.maxWidth&&t.height>=i.minHeight&&t.width>=i.minWidth&&(!e||Math.abs(t.width-g)<Math.abs(e.width-g))}function Tn(i,e){let t=[],g=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},i),v=[],l=[],P=null,b=(L,m)=>{if(yn(g,m,L)){if(g.preferFixedSize&&L.unsafe){l.push(L);return}g.returnAllOptions&&m&&l.push(m),P=L}else g.returnAllOptions&&l.push(L)},C=e.length;for(let L=0;L<C;L++){let m=e[L](),A=m.length;for(let D=0;D<A;D++){let S=m[D];if(S.type==="unknown"&&g.atAnyCost&&v.push(S),S.type==="fixed"&&(S.unsafe?v.push(S):b(S,P)),S.type==="fixed-service")if(g.unsafeImageService){let O=Kt(S,g.width,g.height);b(O,P)}else{let O=Kt(S,S.width,S.height);b(O,P)}if(S.type==="variable"&&S.maxWidth){let O=Kt({id:S.id,type:"fixed-service",width:S.maxWidth,height:S.maxWidth},S.maxWidth);b(O,P)}}if(P&&!g.returnAllOptions){if(P.unsafe||g.allowUnsafe)continue;break}}return g.atAnyCost&&l.length===0?{best:P||v[0],fallback:v.slice(1),log:t}:g.returnAllOptions?{best:g.atAnyCost?P||l[0]||v[0]:P||l[0],fallback:[...l,...v],log:t}:{best:P||l[0]||null,fallback:P?l:l.slice(1),log:t}}function xn(i,e,t){let g=i>e?i:e,v=t.length,l=[];for(let P=0;P<v;P++){let b=t[P],C=b.scaleFactors[0],L=g/C,m=[C];for(;L>=b.width;)C=C*2,m.push(C),L=L/2;l.push(Object.assign(Object.assign({},b),{scaleFactors:m}))}return l}function Sn(i,e){if(i.length!==e.length)return!1;if(i.length===0&&e.length===0)return!0;let t=i.length,g=!0;for(let l=0;l<t;l++){let P=i[l],b=e[l];if(P.width!==b.width||P.height!==b.height){g=!1;break}}if(g)return!0;let v=0;for(let l=0;l<t;l++)for(let P=0;P<t;P++)if(i[l].width===e[P].width&&i[l].height===e[P].height){v++;break}return v===t}function Xe(i,e,t,g){function v(l){return l instanceof t?l:new t(function(P){P(l)})}return new(t||(t=Promise))(function(l,P){function b(m){try{L(g.next(m))}catch(A){P(A)}}function C(m){try{L(g.throw(m))}catch(A){P(A)}}function L(m){m.done?l(m.value):v(m.value).then(b,C)}L((g=g.apply(i,e||[])).next())})}var Dt=class{constructor(){this.config={verificationsRequired:1,approximateServices:!0,enableFetching:!0,disableThrottling:!1},this.fetchingCount=0,this.imageServices={},this.knownImageServers={}}setConfig(e){Object.assign(this.config,e)}sample(e,t,g=!0){let v=$e(te(e)),l=Ye(te(e)),P=this.knownImageServers[v];return this.imageServices[l]=Object.assign(e,{real:!0}),P?this.verify(e):(this.knownImageServers[v]={verifications:0,malformed:!1,root:v,preLoaded:g,sampledId:te(e),verified:!1,server:null,result:{context:e["@context"]||[],sampledProfile:e.profile,resourceServiceRatio:t&&e.height?t.height/e.height:1,sampledSizes:e.sizes||[],sizeRatios:tn(e.width,e.height,e.sizes||[]),sampledTiles:e.tiles||[]}},!0)}preLoad(e,t=!0){this.knownImageServers[e.root]=e,t&&(this.knownImageServers[e.root].malformed=!1,this.knownImageServers[e.root].verifications=this.config.verificationsRequired)}predict(e,t=!1,g=!1){let v=$e(te(e)),l=this.knownImageServers[v];if(!l||!l.result||!g&&(l.malformed||l.verifications<this.config.verificationsRequired))return null;let P=Ye(te(e));return this.imageServices[P]||(this.imageServices[P]={"@context":l.result.context,"@id":te(e),id:te(e),protocol:"http://iiif.io/api/image",tiles:xn(e.width,e.height,l.result.sampledTiles),sizes:rn(Math.floor(e.width/l.result.resourceServiceRatio),Math.floor(e.height/l.result.resourceServiceRatio),l.result.sizeRatios),profile:l.result.sampledProfile,height:e.height,width:e.width,real:!1}),this.imageServices[P]}getThumbnailFromResource(e,t,g=!0,v=[]){return Xe(this,void 0,void 0,function*(){let l=yield this.getImageCandidates(e,g);return Tn(t,[()=>v,()=>l])})}getImageCandidates(e,t=!0){return Xe(this,void 0,void 0,function*(){let g=e;if(t&&g.height&&g.width){let v=Ur(g);for(let l of v){let P={id:te(l),width:l.width?l.width:g.width,height:l.height?l.height:g.height};yield this.loadService(P)}}return En(e,t,this)})}verify(e){return Xe(this,void 0,void 0,function*(){let t=this.predict(e,!1,!0),g=yield this.fetchService(te(e));if(!t)return!1;let v=t.height===g.height&&t.width===g.width&&t["@context"]===g["@context"]&&Sn(t.sizes||[],g.sizes||[]);if(v){let l=$e(te(e));this.knownImageServers[l].verifications+=1,this.knownImageServers[l].verifications>=this.config.verificationsRequired&&(this.knownImageServers[l].verified=!0)}return v})}canLoadSync(e){let t=typeof e=="string"?e:te(e),g=Ye(t);if(this.imageServices[g])return!0;let v=this.knownImageServers[$e(t)];return v&&!v.malformed&&v.verifications>=this.config.verificationsRequired}markAsMalformed(e){return Xe(this,void 0,void 0,function*(){return this.knownImageServers[$e(te(e))].malformed=!0,this.loadService(e,!0)})}fetchService(e,t=!1){return Xe(this,void 0,void 0,function*(){let g=Ye(e);if(this.imageServices[g]&&(!t||this.imageServices[g].real))return this.imageServices[g];if(!this.config.enableFetching)throw new Error("Fetching is not enabled");let v=yield fetch(g).then(l=>l.json());return!v.id&&v["@id"]&&(v.id=v["@id"]),v.id!==e&&(v.id=e,v["@id"]&&(v["@id"]=e)),this.imageServices[g]=Object.assign(v,{real:!0}),this.imageServices[g]})}loadService(e,t=!1){return Xe(this,void 0,void 0,function*(){if(!this.config.disableThrottling)for(;this.fetchingCount>=this.config.verificationsRequired;)yield new Promise(l=>setTimeout(l,500));let g=this.knownImageServers[$e(te(e))];if(g&&!g.malformed&&!t){yield g.result;let l=this.loadServiceSync(e);if(l)return l}this.fetchingCount++;let v=yield this.fetchService(te(e),t);return this.fetchingCount--,v.real&&this.sample(v,e),v})}loadServiceSync(e){let t=Ye(te(e));return this.imageServices[t]?this.imageServices[t]:this.predict(e)}},Ms=new Dt;var kr=["sc:Collection","sc:Manifest","sc:Canvas","oa:AnnotationList","oa:Annotation","sc:Range","sc:Layer","sc:Sequence","oa:Choice","Service","ContentResource"];function An(i){if(typeof i=="undefined"||i===null)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(i))throw new Error("Array is not a valid entity");if(typeof i!="object")throw new Error(`${typeof i} is not a valid entity`);if(typeof i["@type"]=="string"){let e=kr.indexOf(i["@type"]);if(e!==-1)return kr[e]}if(i.profile)return"Service";if(i.format||i["@type"])return"ContentResource";throw new Error("Resource type is not known")}var Ot=class{constructor(e,t={}){this.traversals=Object.assign({collection:[],manifest:[],canvas:[],annotationList:[],sequence:[],annotation:[],contentResource:[],choice:[],range:[],service:[],layer:[]},e),this.options=Object.assign({convertPropsToArray:!0,mergeMemberProperties:!0,allowUndefinedReturn:!1},t)}static all(e){return new Ot({collection:[e],manifest:[e],canvas:[e],annotationList:[e],sequence:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e],layer:[e]})}traverseCollection(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(e))),this.traversals.collection)}traverseCollectionItems(e){if(this.options.mergeMemberProperties){let t=[...(e.manifests||[]).map(g=>typeof g=="string"?{"@id":g,"@type":"sc:Manifest"}:g),...(e.collections||[]).map(g=>typeof g=="string"?{"@id":g,"@type":"sc:Collection"}:g),...e.members||[]];delete e.collections,delete e.manifests,e.members=t}return e.manifests&&(e.manifests=e.manifests.map(t=>this.traverseManifest(typeof t=="string"?{"@id":t,"@type":"sc:Manifest"}:t))),e.collections&&(e.collections=e.collections.map(t=>this.traverseCollection(typeof t=="string"?{"@id":t,"@type":"sc:Collection"}:t))),e.members&&(e.members=e.members.map(t=>typeof t=="string"?t:this.traverseUnknown(t))),e}traverseManifest(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(e))),this.traversals.manifest)}traverseManifestItems(e){return e.sequences&&(e.sequences=e.sequences.map(t=>this.traverseSequence(t))),e.structures&&(e.structures=e.structures.map(t=>this.traverseRange(t))),e}traverseSequence(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(e))),this.traversals.sequence)}traverseSequenceItems(e){return e.canvases&&(e.canvases=e.canvases.map(t=>this.traverseCanvas(t))),e}traverseCanvas(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(e))),this.traversals.canvas)}traverseCanvasItems(e){return e.images&&(e.images=e.images.map(t=>this.traverseAnnotation(t))),e.otherContent&&(e.otherContent=e.otherContent.map(t=>this.traverseAnnotationList(t))),e}traverseRange(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(e))),this.traversals.range)}traverseRangeItems(e){if(this.options.mergeMemberProperties){let t=[...(e.ranges||[]).map(g=>typeof g=="string"?{"@id":g,"@type":"sc:Range"}:g),...(e.canvases||[]).map(g=>typeof g=="string"?{"@id":g,"@type":"sc:Canvas"}:g),...e.members||[]];delete e.ranges,delete e.canvases,e.members=t.length?t.map(g=>this.traverseUnknown(g)):void 0}return e}traverseAnnotationList(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationListItems(e))),this.traversals.annotationList)}traverseAnnotationListItems(e){return e.resources&&(e.resources=e.resources.map(t=>this.traverseAnnotation(t))),e}traverseAnnotation(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(e))),this.traversals.annotation)}traverseAnnotationItems(e){return e.resource&&(e.resource=this.traverseContentResource(e.resource)),e.on,e}traverseLayer(e){return this.traverseType(this.traverseLinking(this.traverseLayerItems(e)),this.traversals.layer)}traverseLayerItems(e){return e.otherContent&&(e.otherContent=e.otherContent.map(t=>this.traverseAnnotationList(t))),e}traverseChoice(e){return this.traverseType(this.traverseChoiceItems(e),this.traversals.choice)}traverseChoiceItems(e){return e.default&&e.default!=="rdf:nil"&&(e.default=this.traverseContentResource(e.default)),e.item&&e.item!=="rdf:nil"&&(e.item=e.item.map(t=>this.traverseContentResource(t))),e}traverseService(e){return this.traverseType(this.traverseLinking(e),this.traversals.service)}traverseContentResource(e){return e["@type"]==="oa:Choice"?this.traverseChoice(e):this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),this.traversals.contentResource)}traverseUnknown(e){if(!e["@type"]||typeof e=="string")return e;switch(An(e)){case"sc:Collection":return this.traverseCollection(e);case"sc:Manifest":return this.traverseManifest(e);case"sc:Canvas":return this.traverseCanvas(e);case"sc:Sequence":return this.traverseSequence(e);case"sc:Range":return this.traverseRange(e);case"oa:Annotation":return this.traverseAnnotation(e);case"oa:AnnotationList":return this.traverseAnnotationList(e);case"sc:Layer":return this.traverseLayer(e);case"Service":return this.traverseService(e);case"oa:Choice":return this.traverseChoice(e);case"ContentResource":return this.traverseContentResource(e)}return e.profile?this.traverseService(e):e}traverseImageResource(e){let t=Array.isArray(e),g=Array.isArray(e)?e:[e],v=[];for(let l of g)typeof l=="string"?v.push(this.traverseContentResource({"@id":l,"@type":"dctypes:Image"})):v.push(this.traverseContentResource(l));return!t&&!this.options.convertPropsToArray?v[0]:v}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=this.traverseImageResource(e.thumbnail)),e.logo&&(e.logo=this.traverseImageResource(e.logo)),e}traverseOneOrMoreServices(e){let t=Array.isArray(e),g=Array.isArray(e)?e:[e],v=[];for(let l of g)v.push(this.traverseService(l));return!t&&!this.options.convertPropsToArray?v[0]:v}traverseLinking(e){return e.related&&(e.related=this.traverseOneOrManyType(e.related,this.traversals.contentResource)),e.rendering&&(e.rendering=this.traverseOneOrManyType(e.rendering,this.traversals.contentResource)),e.service&&(e.service=this.traverseOneOrMoreServices(e.service)),e.seeAlso&&(e.seeAlso=this.traverseOneOrManyType(e.seeAlso,this.traversals.contentResource)),e.within&&(typeof e.within=="string"||(e.within=this.traverseOneOrManyType(e.within,this.traversals.contentResource))),e.startCanvas&&(typeof e.startCanvas=="string"?e.startCanvas=this.traverseType({"@id":e.startCanvas,"@type":"sc:Canvas"},this.traversals.canvas):e.startCanvas&&this.traverseType(e.startCanvas,this.traversals.canvas)),e.contentLayer&&(typeof e.contentLayer=="string"?e.contentLayer=this.traverseLayer({"@id":e.contentLayer,"@type":"sc:Layer"}):e.contentLayer=this.traverseLayer(e.contentLayer)),e}traverseOneOrManyType(e,t){if(!Array.isArray(e))if(this.options.convertPropsToArray)e=[e];else return this.traverseType(e,t);return e.map(g=>this.traverseType(g,t))}traverseType(e,t){return t.reduce((g,v)=>{let l=v(g);return typeof l=="undefined"&&!this.options.allowUndefinedReturn?g:l},e)}};function Ln(i,e){var t={};for(var g in i)Object.prototype.hasOwnProperty.call(i,g)&&e.indexOf(g)<0&&(t[g]=i[g]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var v=0,g=Object.getOwnPropertySymbols(i);v<g.length;v++)e.indexOf(g[v])<0&&Object.prototype.propertyIsEnumerable.call(i,g[v])&&(t[g[v]]=i[g[v]]);return t}var Wt={attributionLabel:"Attribution",lang:"none",providerId:"http://example.org/provider",providerName:"Unknown"};function Ne(i,e="none"){if(!i)return{};let t=Array.isArray(i)?i:[i],g={};for(let v of t){if(typeof v=="string"){g[e]=g[e]?g[e]:[],g[e].push(v||"");continue}if(!v["@language"]){g[e]=g[e]?g[e]:[],g[e].push(v["@value"]||"");continue}let l=v["@language"];g[l]=g[l]?g[l]:[],g[l].push(v["@value"]||"")}return g}function Nr(i){if(Array.isArray(i))return Nr(i.find(e=>typeof e=="string"));if(kt.indexOf(i)!==-1)return"level2";if(Ut.indexOf(i)!==-1)return"level1";if(typeof i=="string")return i}function In(i){let e=Array.isArray(i)?i:[i];for(let t of e)switch(t){case"http://iiif.io/api/image/2/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2":return"ImageService2";case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":return"ImageService1";case"http://iiif.io/api/annex/openannotation/context.json":return"ImageApiSelector"}}function Dn(i){switch(i){case"http://iiif.io/api/image/2/level0.json":case"http://iiif.io/api/image/2/level1.json":case"http://iiif.io/api/image/2/level2.json":return"ImageService2";case"http://iiif.io/api/auth/1/kiosk":case"http://iiif.io/api/auth/1/login":case"http://iiif.io/api/auth/1/clickthrough":case"http://iiif.io/api/auth/1/external":case"http://iiif.io/api/auth/0/kiosk":case"http://iiif.io/api/auth/0/login":case"http://iiif.io/api/auth/0/clickthrough":case"http://iiif.io/api/auth/0/external":return"AuthCookieService1";case"http://iiif.io/api/auth/1/token":case"http://iiif.io/api/auth/0/token":return"AuthTokenService1";case"http://iiif.io/api/auth/1/logout":case"http://iiif.io/api/auth/0/logout":return"AuthLogoutService1";case"http://iiif.io/api/search/1/search":case"http://iiif.io/api/search/0/search":return"SearchService1";case"http://iiif.io/api/search/1/autocomplete":case"http://iiif.io/api/search/0/autocomplete":return"AutoCompleteService1"}}function On(i){return Array.isArray(i)?i:[i]}function Rn(i){for(let e of["sc","oa","dcterms","dctypes","iiif"])if(i.startsWith(`${e}:`))return i.slice(e.length+1);return i}function jt(i){let e=i["@id"]||i.id,t=i["@type"]||i.type,g=i.profile||void 0,v=i["@context"]||void 0;if(g){let l=Dn(g);if(l)return l}if(v){let l=In(v);if(l)return l}if(t){if(Array.isArray(t)){if(t.indexOf("oa:CssStylesheet")!==-1)return"CssStylesheet";if(t.indexOf("cnt:ContentAsText")!==-1)return"TextualBody";t=t[0]}for(let l of["sc","oa","dcterms","dctypes","iiif"])if(t.startsWith(`${l}:`)){t=t.slice(l.length+1);break}switch(t){case"Layer":return"AnnotationCollection";case"AnnotationList":return"AnnotationPage";case"cnt:ContentAsText":return"TextualBody"}}if(i.format){if(i.format.startsWith("image/"))return"Image";if(i.format.startsWith("text/")||i.format==="application/pdf")return"Text";if(i.format.startsWith("application/"))return"Dataset"}return e&&(e.endsWith(".jpg")||e.endsWith(".png")||e.endsWith(".jpeg"))?"Image":t||"unknown"}var Cn=/http(s)?:\/\/(creativecommons.org|rightsstatements.org)[^"'\\<\n]+/gm;function Pn(i){let e=i.match(Cn);return e?e[0]:i}function bn(i,e="Rights/License",t="none"){let g=null,v=[],l=Array.isArray(i)?i:[i];for(let P of l){let b=P?Pn(P):void 0;if(b&&(b.indexOf("creativecommons.org")!==-1||b.indexOf("rightsstatements.org")!==-1)){b.startsWith("https://")?g=`http://${b.slice(8)}`:g=b;continue}b&&v.push({label:{[t]:[e]},value:{[t]:[b]}})}return[g,v]}var Mn=["http://iiif.io/api/presentation/2/context.json","http://iiif.io/api/image/2/context.json","http://iiif.io/api/image/1/context.json","http://library.stanford.edu/iiif/image-api/1.1/context.json","http://iiif.io/api/search/1/context.json","http://iiif.io/api/search/0/context.json","http://iiif.io/api/auth/1/context.json","http://iiif.io/api/auth/0/context.json","http://iiif.io/api/annex/openannotation/context.json"];function _n(i){if(i){let e=Array.isArray(i)?i:[i],t=[];for(let g of e)g==="http://iiif.io/api/presentation/2/context.json"&&t.push("http://iiif.io/api/presentation/3/context.json"),Mn.indexOf(g)===-1&&t.push(g);if(e.length)return t.length===1?t[0]:t}}function Fn(i){return i?i.map(e=>({label:Ne(e.label),value:Ne(e.value)})):[]}function Oe(i){for(let e in i)(typeof i[e]=="undefined"||i[e]===null)&&delete i[e];return i}var Kr=0;function Wr(i,e){let t=encodeURI(i.id||i["@id"]||"").trim();return t&&e?`${t}/${e}`:t||(Kr++,`http://example.org/${i["@type"]}${e?`/${e}`:""}/${Kr}`)}function Re(i){let e=[...i.behavior||[]];return i.viewingHint&&e.push(i.viewingHint),{"@context":i["@context"]?_n(i["@context"]):void 0,id:(i["@id"]||Wr(i)).trim(),type:jt(i),behavior:e.length?e:void 0,height:i.height?i.height:void 0,width:i.width?i.width:void 0,motivation:i.motivation?Rn(i.motivation):void 0,viewingDirection:i.viewingDirection,profile:i.profile,format:i.format?i.format:void 0,duration:void 0,timeMode:void 0}}function Le(i){let[e,t]=bn(i.license),g=[...i.metadata?Fn(i.metadata):[],...t];return{rights:e,metadata:g.length?g:void 0,label:i.label?Ne(i.label):void 0,requiredStatement:i.attribution?{label:Ne(Wt.attributionLabel),value:Ne(i.attribution)}:void 0,navDate:i.navDate,summary:i.description?Ne(i.description):void 0,thumbnail:i.thumbnail}}function Bn(i){if(!i.within)return;let e=Array.isArray(i.within)?i.within:[i.within],t=[];for(let g of e)if(typeof g=="string"){if(g)switch(i["@type"]){case"sc:Manifest":t.push({id:g,type:"Collection"});break}}else g["@id"]&&t.push({id:g["@id"],type:jt(g)});return t.length?t:void 0}function Fe(i){let e=i.related?Array.isArray(i.related)?i.related:[i.related]:[],t=i.contentLayer;return{provider:i.logo||e.length?[{id:Wt.providerId,type:"Agent",homepage:e.length?[e[0]]:void 0,logo:i.logo?Array.isArray(i.logo)?i.logo:[i.logo]:void 0,label:Ne(Wt.providerName)}]:void 0,partOf:Bn(i),rendering:i.rendering,seeAlso:i.seeAlso,start:i.startCanvas,service:i.service?On(i.service):void 0,supplementary:t?[t]:void 0}}function wn(i){return Oe(Object.assign(Object.assign(Object.assign(Object.assign({},Re(i)),Le(i)),Fe(i)),{items:i.members}))}function Un(i){let e=[];for(let t of i||[])e.push(...t);return e}function kn(i){return Oe(Object.assign(Object.assign(Object.assign(Object.assign({},Re(i)),Le(i)),Fe(i)),{items:Un(i.sequences||[]),structures:i.structures}))}function Nn(i){return Oe(Object.assign(Object.assign(Object.assign(Object.assign({},Re(i)),Le(i)),Fe(i)),{items:i.images&&i.images.length?[{id:Wr(i,"annotation-page"),type:"AnnotationPage",items:i.images}]:void 0}))}function Kn(i){return Oe(Object.assign(Object.assign(Object.assign(Object.assign({},Re(i)),Le(i)),Fe(i)),{items:i.resources}))}function Wn(i){return!i.canvases||i.canvases.length===0?[]:i.canvases}function jn(i){return Oe(Object.assign(Object.assign(Object.assign(Object.assign({},Re(i)),Le(i)),Fe(i)),{target:typeof i.on=="string"?encodeURI(i.on).trim():i.on,body:i.resource}))}function Gn(i){let e=i;return Oe(Object.assign(Object.assign(Object.assign({},Re(e)),Le(e)),Fe(e)))}function Hn(i){let e=[];return i.default&&i.default!=="rdf:nil"&&e.push(i.default),i.item&&i.item!=="rdf:nil"&&e.push(...i.item),Object.assign(Object.assign(Object.assign({},Re(i)),Le(i)),{items:e})}function Vn(i){return Oe(Object.assign(Object.assign(Object.assign(Object.assign({},Re(i)),Le(i)),Fe(i)),{items:i.members}))}function zn(i){let e=i,{"@id":t,"@type":g,"@context":v,profile:l}=e,P=Ln(e,["@id","@type","@context","profile"]);return t&&(P.id=t),P.type=jt(i),P.type==="unknown"&&(P.type="Service"),l&&(P.profile=Nr(l)),Oe(Object.assign(Object.assign({},P),Le(P)))}function Yn(i){return Oe(Object.assign(Object.assign(Object.assign({},Re(i)),Le(i)),Fe(i)))}var $n=new Ot({collection:[wn],manifest:[kn],canvas:[Nn],annotationList:[Kn],sequence:[Wn],annotation:[jn],contentResource:[Gn],choice:[Hn],range:[Vn],service:[zn],layer:[Yn]});function jr(i){return i&&i["@context"]&&(i["@context"]==="http://iiif.io/api/presentation/2/context.json"||i["@context"].indexOf("http://iiif.io/api/presentation/2/context.json")!==-1||i["@context"]==="http://www.shared-canvas.org/ns/context.json")||i["@context"]==="http://iiif.io/api/image/2/context.json"?$n.traverseUnknown(i):i}var Xn={id:"https://hyperion/annotation-page",type:"AnnotationPage",behavior:[],motivation:null,label:null,thumbnail:[],summary:null,requiredStatement:null,metadata:[],rights:null,provider:[],items:[],seeAlso:[],homepage:null,logo:[],rendering:[],service:[]},Qn={id:"https://hyperion/empty-canvas",type:"Canvas",label:null,behavior:[],motivation:null,thumbnail:[],posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:[],rights:null,navDate:null,provider:[],items:[],annotations:[],seeAlso:[],homepage:null,logo:[],partOf:[],rendering:[],service:[],duration:0,height:0,width:0},Zn={id:"https://hyperion/empty-collection",type:"Collection",label:null,viewingDirection:"left-to-right",behavior:[],motivation:null,thumbnail:[],posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:[],rights:null,navDate:null,provider:[],items:[],annotations:[],seeAlso:[],homepage:null,logo:[],partOf:[],rendering:[],service:[],services:[]},Jn={id:"https://hyperion/empty-manifest",type:"Manifest",annotations:[],behavior:[],homepage:null,items:[],label:null,logo:[],metadata:[],motivation:null,navDate:null,provider:[],partOf:[],posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,rendering:[],requiredStatement:null,rights:null,seeAlso:[],service:[],services:[],start:null,structures:[],summary:null,thumbnail:[],viewingDirection:"left-to-right"},qn={id:"https://hyperion/empty-canvas",type:"Range",label:null,behavior:[],motivation:null,thumbnail:[],posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:[],rights:null,navDate:null,provider:[],items:[],annotations:[],seeAlso:[],homepage:null,logo:[],partOf:[],rendering:[],service:[],start:null,supplementary:null,viewingDirection:"left-to-right"},Gr=["Collection","Manifest","Canvas","AnnotationPage","AnnotationCollection","Annotation","ContentResource","Range","Service","Selector"];function ea(i){if(typeof i=="undefined"||i===null)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(i))throw new Error("Array is not a valid entity");if(typeof i!="object")throw new Error(`${typeof i} is not a valid entity`);if(typeof i.type=="string"){let e=Gr.indexOf(i.type);if(e!==-1)return Gr[e]}if(i.profile)return"Service";throw new Error("Resource type is not known")}var Rt=class{constructor(e,t={}){this.traversals=Object.assign({collection:[],manifest:[],canvas:[],annotationCollection:[],annotationPage:[],annotation:[],contentResource:[],choice:[],range:[],service:[]},e),this.options=Object.assign({allowUndefinedReturn:!1},t)}static all(e){return new Rt({collection:[e],manifest:[e],canvas:[e],annotationCollection:[e],annotationPage:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e]})}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=e.thumbnail.map(t=>this.traverseType(t,this.traversals.contentResource))),e}traverseLinking(e){return e.seeAlso&&(e.seeAlso=e.seeAlso.map(t=>this.traverseType(t,this.traversals.contentResource))),e.service&&(e.service=e.service.map(t=>this.traverseType(t,this.traversals.service))),e.services&&(e.services=e.services.map(t=>this.traverseType(t,this.traversals.service))),e.logo&&(e.logo=e.logo.map(t=>this.traverseType(t,this.traversals.contentResource))),e.homepage&&(e.homepage=this.traverseType(e.homepage,this.traversals.contentResource)),e.partOf&&(e.partOf=e.partOf.map(t=>typeof t=="string"||!t.type?this.traverseType(t,this.traversals.contentResource):t.type==="Canvas"?this.traverseType(t,this.traversals.canvas):t.type==="AnnotationCollection"?this.traverseType(t,this.traversals.annotationCollection):this.traverseType(t,this.traversals.contentResource))),e.start&&(e.start=e.start.map(t=>this.traverseType(t,this.traversals.canvas))),e.rendering&&(e.rendering=e.rendering.map(t=>this.traverseType(t,this.traversals.contentResource))),e.supplementary&&(e.supplementary=e.supplementary.map(t=>this.traverseType(t,this.traversals.contentResource))),e}traverseCollectionItems(e){return e.items.map(t=>t.type==="Collection"?this.traverseCollection(t):this.traverseManifest(t)),e}traverseCollection(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traversePosterCanvas(this.traverseCollectionItems(e)))),this.traversals.collection)}traverseManifestItems(e){return e.items&&(e.items=e.items.map(t=>this.traverseCanvas(t))),e}traverseManifestStructures(e){return e.structures&&(e.structures=e.structures.map(t=>this.traverseRange(t))),e}traverseManifest(e){return this.traverseType(this.traverseManifestStructures(this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(e))))),this.traversals.manifest)}traverseCanvasItems(e){return e.items=(e.items||[]).map(t=>this.traverseAnnotationPage(t)),e}traverseCanvas(e){return this.traverseType(this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(e)))),this.traversals.canvas)}traverseAnnotationPageItems(e){return e.items&&(e.items=e.items.map(t=>this.traverseAnnotation(t))),e}traverseAnnotationPage(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationPageItems(e))),this.traversals.annotationPage)}traverseAnnotationBody(e){return Array.isArray(e.body)?e.body=e.body.map(t=>this.traverseContentResource(t)):e.body&&(e.body=this.traverseContentResource(e.body)),e}traversePosterCanvas(e){return e.posterCanvas&&(e.posterCanvas=this.traverseType(e.posterCanvas,this.traversals.canvas)),e.placeholderCanvas&&(e.placeholderCanvas=this.traverseType(e.placeholderCanvas,this.traversals.canvas)),e.accompanyingCanvas&&(e.accompanyingCanvas=this.traverseType(e.accompanyingCanvas,this.traversals.canvas)),e}traverseAnnotation(e){return this.traverseType(this.traverseLinking(this.traverseAnnotationBody(e)),this.traversals.annotation)}traverseContentResourceLinking(e){return typeof e=="string"||!e||e&&e.service&&(e.service=(e.service||[]).map(t=>this.traverseType(t,this.traversals.service))),e}traverseContentResource(e){return this.traverseType(this.traverseContentResourceLinking(e),this.traversals.contentResource)}traverseRangeRanges(e){return e.items&&(e.items=e.items.map(t=>typeof t=="string"?this.traverseCanvas({id:t,type:"Canvas"}):t.type==="Manifest"?this.traverseManifest(t):this.traverseRange(t))),e}traverseRange(e){return this.traverseType(this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseRangeRanges(e)))),this.traversals.range)}traverseType(e,t){return t.reduce((g,v)=>{let l=v(g);return typeof l=="undefined"&&!this.options.allowUndefinedReturn?g:l},e)}traverseService(e){return this.traverseType(e,this.traversals.service)}traverseUnknown(e){let t=ea(e);switch(t){case"Collection":return this.traverseCollection(e);case"Manifest":return this.traverseManifest(e);case"Canvas":return this.traverseCanvas(e);case"AnnotationPage":return this.traverseAnnotationPage(e);case"Annotation":return this.traverseAnnotation(e);case"ContentResource":return this.traverseContentResource(e);case"Range":return this.traverseRange(e);case"Service":return this.traverseService(e);default:throw new Error(`Unknown or unsupported resource type of ${t}`)}}};function Gt(){return{Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{}}}function Hr(i,e){if(typeof i=="string")return{id:i,type:e};if(!i.id)throw new Error(`Invalid resource does not have an ID (${e})`);return i}function ta(i){return(e,t)=>{let g=i[e]?i[e]:{};return v=>{let l=Hr(v,t||e);return l&&l.id&&e?(g[l.id]=g[l.id]?Object.assign({},g[l.id],l):Object.assign({},l),{id:l.id,type:e==="ContentResource"?e:l.type}):l}}}function ra(i){return(e,t)=>g=>{let{id:v,type:l}=Hr(g,t||e);if(typeof v=="undefined")throw new Error("Found invalid entity without an ID.");return e==="ContentResource"?i[v]=e:i[v]=l,g}}function ia(i){let e=JSON.stringify(i),t=5381,g=e.length;for(;g;)t=t*33^e.charCodeAt(--g);let l=(t>>>0).toString(16);return l.length%2?"0"+l:l}function Ht(i){return e=>typeof e=="string"?{id:e,type:i}:e.id?e.type?e:Object.assign({type:i},e):Object.assign({id:ia(e),type:i},e)}function ft(i){return e=>Object.assign(Object.assign({},i),e)}function Qe(i){return Array.isArray(i)?i:[i]}function na(i){return i.body&&(i.body=Qe(i.body)),i.seeAlso&&(i.seeAlso=Qe(i.seeAlso)),i.body&&(i.body=Qe(i.body)),i.audience&&(i.audience=Qe(i.audience)),i.accessibility&&(i.accessibility=Qe(i.accessibility)),i.motivation&&(i.motivation=Qe(i.motivation)),i}function Vr(i){let e=jr(i),t=Gt(),g={},v=ta(t),l=ra(g),b=new Rt({collection:[ft(Zn),l("Collection"),v("Collection")],manifest:[ft(Jn),l("Manifest"),v("Manifest")],canvas:[ft(Qn),l("Canvas"),v("Canvas")],annotationPage:[Ht("AnnotationPage"),ft(Xn),l("AnnotationPage"),v("AnnotationPage")],annotation:[Ht("Annotation"),na,l("Annotation"),v("Annotation")],contentResource:[Ht("ContentResource"),l("ContentResource"),v("ContentResource")],range:[ft(qn),l("Range","Canvas"),v("Range","Canvas")]}).traverseUnknown(e);return{entities:t,resource:b,mapping:g}}var Ze="__$HF_UNSET$__",zr="__$HF_UNWRAP$__";function aa(i,e){let t=i.hyperion.requests[e],g=i.hyperion.mapping[e];if(!(!g||t&&t.resourceUri&&!i.hyperion.entities[g][t.resourceUri]))return i.hyperion.entities[g][t?t.resourceUri:e]}function sa(i){let e={};for(let[t,g]of i){if(t===zr)return g;g!==Ze&&typeof g!="undefined"&&g!==null&&(e[t]=g)}return e}function Yr(i,e,t){if(!e.type||!e.id)throw new Error("Unknown entity");if(!t[e.type])throw new Error(`Serialiser not found for ${e.type}`);function g(v){let l=t[v.type];if(!l)return Ze;let P=aa(i,v.id);if(!P)return Ze;let b=l(P,i),C=b.next();for(;!C.done;){let L=C.value,m=Ze;if(L)if(Array.isArray(L)){let A=[];for(let D of L)A.push(g(D));m=A}else m=g(L);C=b.next(m)}return C.value===Ze?Ze:sa(C.value)}return g(e)}function Je(i){if(!i)return;let e=Object.keys(i);if(e.length!==0){if(e.length===1){let t=e[0];if(!t)return"";let g=(i[t]||[]).join("");return t==="@none"||t==="none"||t==="en"?g:{"@language":t,"@value":g}}return e.map(t=>({"@language":t,"@value":(i[t]||[]).join("")}))}}function $r(i){return Array.isArray(i)?i.map(e=>$r(e)):typeof i=="string"?i:i.type&&i.type==="Canvas"?i.id:i}function Be(i,e=!1){if(!!i)return i.length>1&&!e?i:i[0]||void 0}function oa(i){if(!!i){if(typeof i=="string")return{"@id":i};if("@id"in i){let e=Object.assign({},i);return delete e["@type"],e}return{"@context":"http://iiif.io/api/image/2/context.json","@id":i.id,profile:`http://iiif.io/api/image/2/profiles/${i.profile}.json`}}}function Ke(i,e){return[["@id",i.id],["@type",e],["format",i.format],["height",i.height],["width",i.width],["viewingDirection",i.viewingDirection!=="left-to-right"?i.viewingDirection:void 0]]}function*We(i){let e=i.provider?i.provider[0]:void 0;return[["label",Je(i.label)],["metadata",i.metadata&&i.metadata.length?i.metadata.map(t=>({label:Je(t.label)||"",value:Je(t.value)||""})):void 0],["description",Je(i.summary)],["thumbnail",Be(yield i.thumbnail)],["navDate",i.navDate],["logo",e?Be(e.logo):void 0],["homepage",e?e.homepage:void 0],["attribution",i.requiredStatement?Je(i.requiredStatement.value):void 0]]}function*dt(i){return[["seeAlso",Be(yield i.seeAlso)],["service",Be((i.service||[]).map(oa))],["rendering",Be(yield i.rendering)],["startCanvas",i.start?i.start.id:void 0]]}var Xr={Manifest:function*(i){return[...Ke(i,"sc:Manifest"),...yield*We(i),...yield*dt(i),["sequences",[{"@id":`${i.id}/sequence0`,"@type":"sc:Sequence",canvases:yield i.items}]],["structures",yield i.structures]]},Canvas:function*(i){let t=(yield i.items)[0];return[...Ke(i,"sc:Canvas"),...yield*We(i),...yield*dt(i),["images",t?[t.resources]:void 0],["annotations",i.annotations&&i.annotations.length?Be(yield i.annotations):void 0]]},AnnotationPage:function*(i){return[...Ke(i,"sc:AnnotationList"),...yield*We(i),["resources",i.items&&i.items.length?Be(yield i.items):void 0]]},Annotation:function*(i){return[["@id",i.id],["@type","oa:Annotation"],["motivation","sc:painting"],["on",$r(i.target)],["resource",Be(yield i.body,!0)]]},ContentResource:function*(i){switch(i.type){case"Image":return[...Ke(i,"dctypes:Image"),...yield*We(i),...yield*dt(i)];case"Text":case"Dataset":default:return[...Ke(i,void 0),...yield*We(i)]}},AnnotationCollection:function*(i){return[["@id",i.id],["@type","sc:Layer"],["label",Je(i.label)]]},Collection:function*(i){return[...Ke(i,"sc:Collection"),...yield*We(i),...yield*dt(i),["members",yield*i.items]]},Range:function*(i){let e=[],t=[];if(i.items)for(let g of i.items){let v=yield g;e.push({"@id":g.id,"@type":g.type,label:v?v.label:void 0,within:i.id}),g.type==="Canvas"&&t.push(g.id)}return[...Ke(i,"sc:Range"),...yield*We(i),...yield*dt(i),["canvases",t.length===e.length?t:void 0],["members",t.length!==e.length?e:void 0]]}};function ct(i){return[["id",i.id],["type",i.type],["format",i.format],["profile",i.profile],["height",i.height],["width",i.width],["duration",i.duration||void 0],["viewingDirection",i.viewingDirection!=="left-to-right"?i.viewingDirection:void 0],["behavior",i.behavior&&i.behavior.length?i.behavior:void 0],["timeMode",i.timeMode],["motivation",i.motivation]]}function ge(i){if(!(!i||i.length===0))return i}function*ht(i){return[["label",i.label],["metadata",ge(i.metadata)],["summary",i.summary],["requiredStatement",i.requiredStatement],["rights",i.rights],["navDate",i.navDate],["language",i.language],["thumbnail",ge(yield i.thumbnail)],["placeholderCanvas",yield i.placeholderCanvas],["accompanyingCanvas",yield i.accompanyingCanvas],["provider",ge(i.provider)]]}function*qe(i){return[["seeAlso",ge(yield i.seeAlso)],["service",ge(i.service)],["services",ge(i.services)],["rendering",ge(yield i.rendering)],["supplementary",ge(yield i.supplementary)],["partOf",ge(i.partOf)],["start",i.start]]}var Qr={Manifest:function*(i){return[...ct(i),...yield*ht(i),...yield*qe(i),["items",yield i.items],["structures",ge(yield i.structures)]]},Canvas:function*(i){return[...ct(i),...yield*ht(i),...yield*qe(i),["items",yield i.items],["annotations",ge(yield i.annotations)]]},AnnotationPage:function*(i){return[...Object.entries(i).map(([t,g])=>[t,Array.isArray(g)?ge(g):g]).filter(([t,g])=>t!=="items"),...yield*qe(i),["items",yield i.items]]},Service:function*(i){return[[zr,i]]},Annotation:function*(i){return[...Object.entries(i).map(([t,g])=>[t,Array.isArray(g)?ge(g):g]).filter(([t])=>t!=="body"),["body",yield i.body]]},ContentResource:function*(i){return[...ct(i),...yield*ht(i),...yield*qe(i)]},AnnotationCollection:function*(i){return[["id",i.id],["type","AnnotationCollection"],["label",i.label]]},Collection:function*(i){return[...ct(i),...yield*ht(i),...yield*qe(i),["items",yield*i.items]]},Range:function*(i){let e=[];for(let t of i.items)t.type==="Range"?e.push(yield t):e.push(t);return[...ct(i),...yield*ht(i),...yield*qe(i),["items",e],["annotations",ge(yield i.annotations)]]}};var Zr="@hyperion/ADD_MAPPING",Jr="@hyperion/ADD_MAPPINGS",la=(0,Ie.createAction)(Zr)(),ua=(0,Ie.createAction)(Jr)();var fa=(i={},e)=>{switch(e.type){case Zr:return Object.assign(Object.assign({},i),{[e.payload.id]:e.payload.type});case Jr:return Object.assign(Object.assign({},i),e.payload.mapping);default:return i}},qr="@hyperion/IMPORT_ENTITIES",ei="@hyperion/MODIFY_ENTITY_FIELD",ti=(0,Ie.createAction)(qr)(),da=(0,Ie.createAction)(ei)(),ri={importEntities:ti,modifyEntityField:da},ca=(i=Gt(),e)=>{if(e.type===ei){if(!i[e.payload.type]||!i[e.payload.type][e.payload.id])return i;let t=i[e.payload.type][e.payload.id];return typeof t=="string"?i:Object.assign(Object.assign({},i),{[e.payload.type]:Object.assign(Object.assign({},i[e.payload.type]),{[e.payload.id]:Object.assign(Object.assign({},t),{[e.payload.key]:e.payload.value})})})}return e.type===qr?{Collection:Object.assign(Object.assign({},i.Collection),e.payload.entities.Collection),Manifest:Object.assign(Object.assign({},i.Manifest),e.payload.entities.Manifest),Canvas:Object.assign(Object.assign({},i.Canvas),e.payload.entities.Canvas),AnnotationPage:Object.assign(Object.assign({},i.AnnotationPage),e.payload.entities.AnnotationPage),AnnotationCollection:Object.assign(Object.assign({},i.AnnotationCollection),e.payload.entities.AnnotationCollection),Annotation:Object.assign(Object.assign({},i.Annotation),e.payload.entities.Annotation),ContentResource:Object.assign(Object.assign({},i.ContentResource),e.payload.entities.ContentResource),Range:Object.assign(Object.assign({},i.Range),e.payload.entities.Range),Service:Object.assign(Object.assign({},i.Service),e.payload.entities.Service),Selector:Object.assign(Object.assign({},i.Selector),e.payload.entities.Selector)}:i},ii="@hyperion/REQUEST_RESOURCE",ni="@hyperion/REQUEST_ERROR",ai="@hyperion/REQUEST_MISMATCH",si="@hyperion/REQUEST_COMPLETE",oi="@hyperion/REQUEST_OFFLINE_RESOURCE",ha=(0,Ie.createAction)(ii)(),li=(0,Ie.createAction)(ni)(),va=(0,Ie.createAction)(ai)(),ga=(0,Ie.createAction)(si)(),Ks=(0,Ie.createAction)(oi)();var ma=(i={},e)=>{switch(e.type){case ii:case oi:return Object.assign(Object.assign({},i),{[e.payload.id]:{requestUri:e.payload.id,loadingState:"RESOURCE_LOADING",uriMismatch:!1,resourceUri:e.payload.id}});case ai:return Object.assign(Object.assign({},i),{[e.payload.requestId]:Object.assign(Object.assign({},i[e.payload.requestId]||{}),{uriMismatch:!0,resourceUri:e.payload.actualId}),[e.payload.actualId]:{requestUri:e.payload.requestId,loadingState:i[e.payload.requestId].loadingState,uriMismatch:!0,resourceUri:e.payload.actualId}});case ni:return Object.assign(Object.assign({},i),{[e.payload.id]:Object.assign(Object.assign({},i[e.payload.id]||{}),{loadingState:"RESOURCE_ERROR",error:e.payload.message})});case si:return Object.assign(Object.assign({},i),{[e.payload.id]:Object.assign(Object.assign({},i[e.payload.id]||{}),{loadingState:"RESOURCE_READY",error:void 0})})}return i},pa=wt({mapping:fa,entities:ca,requests:ma}),Ea=typeof window!="undefined"?window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__||At:At;function ui(i={},e=[],t={}){return Bt(wt(Object.assign({hyperion:pa},i)),t,Ea(cr(...e)))}var ya=(i,e)=>{let{entities:t,resource:g,mapping:v}=Vr(e);if(g.id===void 0)return[li({id:i,message:"ID is not defined in resource."})];let l=[ti({entities:t}),ua({mapping:v})];return g.id!==i&&(l.push(la({id:i,type:g.type})),l.push(va({requestId:i,actualId:g.id}))),l.push(ga({id:i})),l};function Ta(i,e,t,g){function v(l){return l instanceof t?l:new t(function(P){P(l)})}return new(t||(t=Promise))(function(l,P){function b(m){try{L(g.next(m))}catch(A){P(A)}}function C(m){try{L(g.throw(m))}catch(A){P(A)}}function L(m){m.done?l(m.value):v(m.value).then(b,C)}L((g=g.apply(i,e||[])).next())})}function Vt(i,e){let t=i.hyperion.requests[e],g=i.hyperion.mapping[e];if(!(!g||!i.hyperion.entities[g][t.resourceUri]))return i.hyperion.entities[g][t.resourceUri]}function zt(i,e,{waitTimeout:t=30}={}){return(g,v)=>Ta(this,void 0,void 0,function*(){let l=i.getState(),P=l.hyperion.requests[g];if(P)switch(P.loadingState){case"RESOURCE_ERROR":break;case"RESOURCE_LOADING":{let b;try{let C=yield Promise.race([new Promise((L,m)=>{b=i.subscribe(()=>{let A=i.getState();if(A.hyperion.requests[g].loadingState==="RESOURCE_ERROR"){m();return}if(A.hyperion.requests[g].loadingState==="RESOURCE_READY"){let D=Vt(A,g);D?L(D):m()}})}),new Promise((L,m)=>setTimeout(m,t*60))]);if(b&&b(),C)return C}catch(C){b&&b();break}break}case"RESOURCE_READY":{let b=Vt(l,g);if(b)return b;break}}i.dispatch(ha({id:g}));try{let b=yield e(g,v),C=ya(g,b);for(let L of C)i.dispatch(L);return Vt(i.getState(),g)}catch(b){throw i.dispatch(li({id:g,message:b.toString()})),b}})}function fi(i){return{all:i=i||new Map,on:function(e,t){var g=i.get(e);g&&g.push(t)||i.set(e,[t])},off:function(e,t){var g=i.get(e);g&&g.splice(g.indexOf(t)>>>0,1)},emit:function(e,t){(i.get(e)||[]).slice().map(function(g){g(t)}),(i.get("*")||[]).slice().map(function(g){g(e,t)})}}}function xa(i,e,t,g){function v(l){return l instanceof t?l:new t(function(P){P(l)})}return new(t||(t=Promise))(function(l,P){function b(m){try{L(g.next(m))}catch(A){P(A)}}function C(m){try{L(g.throw(m))}catch(A){P(A)}}function L(m){m.done?l(m.value):v(m.value).then(b,C)}L((g=g.apply(i,e||[])).next())})}var Yt=class{constructor(e,t){this.defaultFetcher=g=>fetch(g).then(v=>v.json()),this.middleware=g=>v=>l=>{this.emitter.emit(l.type,{action:l,state:g.getState()});let P=v(l);return this.emitter.emit(`after:${l.type}`,{action:l,state:g.getState()}),P},this.options=Object.assign({reducers:{},middleware:[],defaultState:{},customFetcher:this.defaultFetcher},e||{}),this.store=t||ui(this.options.reducers,[...this.options.middleware,this.middleware],this.options.defaultState),this.emitter=fi(),this.imageService=new Dt,this.remoteFetcher=zt(this.store,this.options.customFetcher),this.staticFetcher=zt(this.store,(g,v)=>v)}modifyEntityField(e,t,g){this.store.dispatch(ri.modifyEntityField({id:e.id,type:e.type,key:t,value:g}))}serialise(e,t){return Yr(this.getState(),e,t)}toPresentation2(e){return this.serialise(e,Xr)}toPresentation3(e){return this.serialise(e,Qr)}fromRef(e,t){let g=this.getState(),v=g.hyperion.entities[e.type]&&g.hyperion.entities[e.type][e.id]?g.hyperion.entities[e.type][e.id]:e;return t?t(g,v):v}allFromRef(e,t){return e.map(g=>this.fromRef(g,t))}select(e){return e(this.getState())}getStore(){return this.store}getState(){return this.store.getState()}getImageService(){return this.imageService}loadManifest(e,t){return this.load(e,t)}loadCollection(e,t){return this.load(e,t)}getThumbnail(e,t,g,v=[],l){return xa(this,void 0,void 0,function*(){if(typeof e=="string")return{best:It(e),fallback:[],log:[]};let P=this.fromRef(e);if(typeof P=="string")return{best:It(P),fallback:[],log:[]};switch(P.type){case"Annotation":{let b=P.body,C=this.fromRef(b[0]);return l&&!C.width&&(C.width=l.width,C.height=l.height),yield this.imageService.getThumbnailFromResource(C,t,g,v)}case"Canvas":{let b=P;if(b.thumbnail&&b.thumbnail.length){let C=this.fromRef(b.thumbnail[0]),L=yield this.imageService.getImageCandidates(C,g);L&&L.length&&v.push(...L)}return this.getThumbnail(b.items[0],t,g,v,{width:b.width,height:b.height})}case"AnnotationPage":{let b=P;return this.getThumbnail(b.items[0],t,g,v,l)}case"Choice":{let b=P;return this.getThumbnail(b.items[0],t,g,v,l)}case"Collection":{let C=P.items[0];return this.getThumbnail(C,t,g,v,l)}case"Manifest":{let C=P.items[0];return this.getThumbnail(C,t,g,v,l)}case"SpecificResource":case"Image":case"Dataset":case"Sound":case"Text":case"TextualBody":case"Video":return l&&!P.width&&(P.width=l.width,P.height=l.height),this.imageService.getThumbnailFromResource(P,t,g,v);case"Service":case"Range":case"AnnotationCollection":case"CanvasReference":case"ContentResource":return{best:void 0,fallback:[],log:[]}}return{best:void 0,fallback:[],log:[]}})}load(e,t){return t?this.staticFetcher(e,t):this.remoteFetcher(e)}subscribe(e,t){let g;return this.store.subscribe(()=>{let v=this.store.getState(),l=e(v);g!==l&&t(l,this),g=l})}};var $t={activeCanvas:"",isLoaded:!1,vault:new Yt},di=je.createContext($t),ci=je.createContext($t);function Sa(i,e){switch(e.type){case"updateActiveCanvas":return ut(Se({},i),{activeCanvas:e.canvasId});case"updateIsLoaded":return ut(Se({},i),{isLoaded:e.isLoaded});default:throw new Error(`Unhandled action type: ${e.type}`)}}var hi=({initialState:i=$t,children:e})=>{let[t,g]=je.useReducer(Sa,i);return je.createElement(di.Provider,{value:t},je.createElement(ci.Provider,{value:g},e))};function et(){let i=je.useContext(di);if(i===void 0)throw new Error("useViewerState must be used within a ViewerProvider");return i}function Ct(){let i=je.useContext(ci);if(i===void 0)throw new Error("useViewerDispatch must be used within a ViewerProvider");return i}import me from"react";import xi from"react";var J="colors",de="sizes",j="space",Aa={gap:j,gridGap:j,columnGap:j,gridColumnGap:j,rowGap:j,gridRowGap:j,inset:j,insetBlock:j,insetBlockEnd:j,insetBlockStart:j,insetInline:j,insetInlineEnd:j,insetInlineStart:j,margin:j,marginTop:j,marginRight:j,marginBottom:j,marginLeft:j,marginBlock:j,marginBlockEnd:j,marginBlockStart:j,marginInline:j,marginInlineEnd:j,marginInlineStart:j,padding:j,paddingTop:j,paddingRight:j,paddingBottom:j,paddingLeft:j,paddingBlock:j,paddingBlockEnd:j,paddingBlockStart:j,paddingInline:j,paddingInlineEnd:j,paddingInlineStart:j,top:j,right:j,bottom:j,left:j,scrollMargin:j,scrollMarginTop:j,scrollMarginRight:j,scrollMarginBottom:j,scrollMarginLeft:j,scrollMarginX:j,scrollMarginY:j,scrollMarginBlock:j,scrollMarginBlockEnd:j,scrollMarginBlockStart:j,scrollMarginInline:j,scrollMarginInlineEnd:j,scrollMarginInlineStart:j,scrollPadding:j,scrollPaddingTop:j,scrollPaddingRight:j,scrollPaddingBottom:j,scrollPaddingLeft:j,scrollPaddingX:j,scrollPaddingY:j,scrollPaddingBlock:j,scrollPaddingBlockEnd:j,scrollPaddingBlockStart:j,scrollPaddingInline:j,scrollPaddingInlineEnd:j,scrollPaddingInlineStart:j,fontSize:"fontSizes",background:J,backgroundColor:J,backgroundImage:J,borderImage:J,border:J,borderBlock:J,borderBlockEnd:J,borderBlockStart:J,borderBottom:J,borderBottomColor:J,borderColor:J,borderInline:J,borderInlineEnd:J,borderInlineStart:J,borderLeft:J,borderLeftColor:J,borderRight:J,borderRightColor:J,borderTop:J,borderTopColor:J,caretColor:J,color:J,columnRuleColor:J,fill:J,outline:J,outlineColor:J,stroke:J,textDecorationColor:J,fontFamily:"fonts",fontWeight:"fontWeights",lineHeight:"lineHeights",letterSpacing:"letterSpacings",blockSize:de,minBlockSize:de,maxBlockSize:de,inlineSize:de,minInlineSize:de,maxInlineSize:de,width:de,minWidth:de,maxWidth:de,height:de,minHeight:de,maxHeight:de,flexBasis:de,gridTemplateColumns:de,gridTemplateRows:de,borderWidth:"borderWidths",borderTopWidth:"borderWidths",borderRightWidth:"borderWidths",borderBottomWidth:"borderWidths",borderLeftWidth:"borderWidths",borderStyle:"borderStyles",borderTopStyle:"borderStyles",borderRightStyle:"borderStyles",borderBottomStyle:"borderStyles",borderLeftStyle:"borderStyles",borderRadius:"radii",borderTopLeftRadius:"radii",borderTopRightRadius:"radii",borderBottomRightRadius:"radii",borderBottomLeftRadius:"radii",boxShadow:"shadows",textShadow:"shadows",transition:"transitions",zIndex:"zIndices"},La=(i,e)=>typeof e=="function"?{"()":Function.prototype.toString.call(e)}:e,tt=()=>{let i=Object.create(null);return(e,t,...g)=>{let v=(l=>JSON.stringify(l,La))(e);return v in i?i[v]:i[v]=t(e,...g)}},Ge=Symbol.for("sxs.internal"),Xt=(i,e)=>Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)),vi=i=>{for(let e in i)return!0;return!1},{hasOwnProperty:Ia}=Object.prototype,Qt=i=>i.includes("-")?i:i.replace(/[A-Z]/g,e=>"-"+e.toLowerCase()),Da=/\s+(?![^()]*\))/,rt=i=>e=>i(...typeof e=="string"?String(e).split(Da):[e]),gi={appearance:i=>({WebkitAppearance:i,appearance:i}),backfaceVisibility:i=>({WebkitBackfaceVisibility:i,backfaceVisibility:i}),backdropFilter:i=>({WebkitBackdropFilter:i,backdropFilter:i}),backgroundClip:i=>({WebkitBackgroundClip:i,backgroundClip:i}),boxDecorationBreak:i=>({WebkitBoxDecorationBreak:i,boxDecorationBreak:i}),clipPath:i=>({WebkitClipPath:i,clipPath:i}),content:i=>({content:i.includes('"')||i.includes("'")||/^([A-Za-z]+\([^]*|[^]*-quote|inherit|initial|none|normal|revert|unset)$/.test(i)?i:`"${i}"`}),hyphens:i=>({WebkitHyphens:i,hyphens:i}),maskImage:i=>({WebkitMaskImage:i,maskImage:i}),maskSize:i=>({WebkitMaskSize:i,maskSize:i}),tabSize:i=>({MozTabSize:i,tabSize:i}),textSizeAdjust:i=>({WebkitTextSizeAdjust:i,textSizeAdjust:i}),userSelect:i=>({WebkitUserSelect:i,userSelect:i}),marginBlock:rt((i,e)=>({marginBlockStart:i,marginBlockEnd:e||i})),marginInline:rt((i,e)=>({marginInlineStart:i,marginInlineEnd:e||i})),maxSize:rt((i,e)=>({maxBlockSize:i,maxInlineSize:e||i})),minSize:rt((i,e)=>({minBlockSize:i,minInlineSize:e||i})),paddingBlock:rt((i,e)=>({paddingBlockStart:i,paddingBlockEnd:e||i})),paddingInline:rt((i,e)=>({paddingInlineStart:i,paddingInlineEnd:e||i}))},Zt=/([\d.]+)([^]*)/,Oa=(i,e)=>i.length?i.reduce((t,g)=>(t.push(...e.map(v=>v.includes("&")?v.replace(/&/g,/[ +>|~]/.test(g)&&/&.*&/.test(v)?`:is(${g})`:g):g+" "+v)),t),[]):e,Ra=(i,e)=>i in Ca&&typeof e=="string"?e.replace(/^((?:[^]*[^\w-])?)(fit-content|stretch)((?:[^\w-][^]*)?)$/,(t,g,v,l)=>g+(v==="stretch"?`-moz-available${l};${Qt(i)}:${g}-webkit-fill-available`:`-moz-fit-content${l};${Qt(i)}:${g}fit-content`)+l):String(e),Ca={blockSize:1,height:1,inlineSize:1,maxBlockSize:1,maxHeight:1,maxInlineSize:1,maxWidth:1,minBlockSize:1,minHeight:1,minInlineSize:1,minWidth:1,width:1},Ce=i=>i?i+"-":"",mi=(i,e,t)=>i.replace(/([+-])?((?:\d+(?:\.\d*)?|\.\d+)(?:[Ee][+-]?\d+)?)?(\$|--)([$\w-]+)/g,(g,v,l,P,b)=>P=="$"==!!l?g:(v||P=="--"?"calc(":"")+"var(--"+(P==="$"?Ce(e)+(b.includes("$")?"":Ce(t))+b.replace(/\$/g,"-"):b)+")"+(v||P=="--"?"*"+(v||"")+(l||"1")+")":"")),Pa=/\s*,\s*(?![^()]*\))/,ba=Object.prototype.toString,it=(i,e,t,g,v)=>{let l,P,b,C=(L,m,A)=>{let D,S,O=I=>{for(D in I){let n=D.charCodeAt(0)===64,a=n&&Array.isArray(I[D])?I[D]:[I[D]];for(S of a){let p=typeof S=="object"&&S&&S.toString===ba,f=/[A-Z]/.test(r=D)?r:r.replace(/-[^]/g,h=>h[1].toUpperCase());if(f in g.utils){let h=g.utils[f];if(h!==P){P=h,O(h(S)),P=null;continue}}else if(f in gi){let h=gi[f];if(h!==b){b=h,O(h(S)),b=null;continue}}if(n&&(s=D.slice(1)in g.media?"@media "+g.media[D.slice(1)]:D,D=s.replace(/\(\s*([\w-]+)\s*(=|<|<=|>|>=)\s*([\w-]+)\s*(?:(<|<=|>|>=)\s*([\w-]+)\s*)?\)/g,(h,x,E,c,u,o)=>{let d=Zt.test(x),T=.0625*(d?-1:1),[y,R]=d?[c,x]:[x,c];return"("+(E[0]==="="?"":E[0]===">"===d?"max-":"min-")+y+":"+(E[0]!=="="&&E.length===1?R.replace(Zt,(M,_,F)=>Number(_)+T*(E===">"?1:-1)+F):R)+(u?") and ("+(u[0]===">"?"min-":"max-")+y+":"+(u.length===1?o.replace(Zt,(M,_,F)=>Number(_)+T*(u===">"?-1:1)+F):o):"")+")"})),p){let h=n?A.concat(D):[...A],x=n?[...m]:Oa(m,D.split(Pa));l!==void 0&&v(pi(...l)),l=void 0,C(S,x,h)}else l===void 0&&(l=[[],m,A]),D=n||D.charCodeAt(0)!==36?D:`--${Ce(g.prefix)}${D.slice(1).replace(/\$/g,"-")}`,S=p?S:typeof S=="number"?S&&f in Ma?String(S)+"px":String(S):mi(Ra(f,S==null?"":S),g.prefix,g.themeMap[f]),l[0].push(`${n?`${D} `:`${Qt(D)}:`}${S}`)}}var s,r};O(L),l!==void 0&&v(pi(...l)),l=void 0};C(i,e,t)},pi=(i,e,t)=>`${t.map(g=>`${g}{`).join("")}${e.length?`${e.join(",")}{`:""}${i.join(";")}${e.length?"}":""}${Array(t.length?t.length+1:0).join("}")}`,Ma={animationDelay:1,animationDuration:1,backgroundSize:1,blockSize:1,border:1,borderBlock:1,borderBlockEnd:1,borderBlockEndWidth:1,borderBlockStart:1,borderBlockStartWidth:1,borderBlockWidth:1,borderBottom:1,borderBottomLeftRadius:1,borderBottomRightRadius:1,borderBottomWidth:1,borderEndEndRadius:1,borderEndStartRadius:1,borderInlineEnd:1,borderInlineEndWidth:1,borderInlineStart:1,borderInlineStartWidth:1,borderInlineWidth:1,borderLeft:1,borderLeftWidth:1,borderRadius:1,borderRight:1,borderRightWidth:1,borderSpacing:1,borderStartEndRadius:1,borderStartStartRadius:1,borderTop:1,borderTopLeftRadius:1,borderTopRightRadius:1,borderTopWidth:1,borderWidth:1,bottom:1,columnGap:1,columnRule:1,columnRuleWidth:1,columnWidth:1,containIntrinsicSize:1,flexBasis:1,fontSize:1,gap:1,gridAutoColumns:1,gridAutoRows:1,gridTemplateColumns:1,gridTemplateRows:1,height:1,inlineSize:1,inset:1,insetBlock:1,insetBlockEnd:1,insetBlockStart:1,insetInline:1,insetInlineEnd:1,insetInlineStart:1,left:1,letterSpacing:1,margin:1,marginBlock:1,marginBlockEnd:1,marginBlockStart:1,marginBottom:1,marginInline:1,marginInlineEnd:1,marginInlineStart:1,marginLeft:1,marginRight:1,marginTop:1,maxBlockSize:1,maxHeight:1,maxInlineSize:1,maxWidth:1,minBlockSize:1,minHeight:1,minInlineSize:1,minWidth:1,offsetDistance:1,offsetRotate:1,outline:1,outlineOffset:1,outlineWidth:1,overflowClipMargin:1,padding:1,paddingBlock:1,paddingBlockEnd:1,paddingBlockStart:1,paddingBottom:1,paddingInline:1,paddingInlineEnd:1,paddingInlineStart:1,paddingLeft:1,paddingRight:1,paddingTop:1,perspective:1,right:1,rowGap:1,scrollMargin:1,scrollMarginBlock:1,scrollMarginBlockEnd:1,scrollMarginBlockStart:1,scrollMarginBottom:1,scrollMarginInline:1,scrollMarginInlineEnd:1,scrollMarginInlineStart:1,scrollMarginLeft:1,scrollMarginRight:1,scrollMarginTop:1,scrollPadding:1,scrollPaddingBlock:1,scrollPaddingBlockEnd:1,scrollPaddingBlockStart:1,scrollPaddingBottom:1,scrollPaddingInline:1,scrollPaddingInlineEnd:1,scrollPaddingInlineStart:1,scrollPaddingLeft:1,scrollPaddingRight:1,scrollPaddingTop:1,shapeMargin:1,textDecoration:1,textDecorationThickness:1,textIndent:1,textUnderlineOffset:1,top:1,transitionDelay:1,transitionDuration:1,verticalAlign:1,width:1,wordSpacing:1},Ei=i=>String.fromCharCode(i+(i>25?39:97)),He=i=>(e=>{let t,g="";for(t=Math.abs(e);t>52;t=t/52|0)g=Ei(t%52)+g;return Ei(t%52)+g})(((e,t)=>{let g=t.length;for(;g;)e=33*e^t.charCodeAt(--g);return e})(5381,JSON.stringify(i))>>>0),_a=tt(),yi=(i,e)=>_a(i,()=>(...t)=>{let g={type:null,composers:new Set};for(let v of t)if(v!=null)if(v[Ge]){g.type==null&&(g.type=v[Ge].type);for(let l of v[Ge].composers)g.composers.add(l)}else v.constructor!==Object||v.$$typeof?g.type==null&&(g.type=v):g.composers.add(Fa(v,i));return g.type==null&&(g.type="span"),g.composers.size||g.composers.add(["PJLV",{},[],[],{},[]]),Ba(i,g,e)}),Fa=(l,v)=>{var P=l,{variants:i,compoundVariants:e,defaultVariants:t}=P,g=Tt(P,["variants","compoundVariants","defaultVariants"]);let b=`${Ce(v.prefix)}c-${He(g)}`,C=[],L=[],m=Object.create(null),A=[];for(let I in t)m[I]=String(t[I]);if(typeof i=="object"&&i)for(let I in i){D=m,S=I,Ia.call(D,S)||(m[I]="undefined");let s=i[I];for(let r in s){let n={[I]:String(r)};String(r)==="undefined"&&A.push(I);let a=s[r],p=[n,a,!vi(a)];C.push(p)}}var D,S;if(typeof e=="object"&&e)for(let I of e){let O=I,{css:s}=O,r=Tt(O,["css"]);s=typeof s=="object"&&s||{};for(let a in r)r[a]=String(r[a]);let n=[r,s,!vi(s)];L.push(n)}return[b,g,C,L,m,A]},Ba=(i,e,t)=>{let[g,v,l,P]=wa(e.composers),b=`.${g}${v.length>1?`:where(.${v.slice(1).join(".")})`:""}`,C=L=>{L=typeof L=="object"&&L||Ua;let I=L,{css:m}=I,A=Tt(I,["css"]),D={};for(let s in l)if(delete A[s],s in L){let r=L[s];typeof r=="object"&&r?D[s]=Se({"@initial":l[s]},r):(r=String(r),D[s]=r!=="undefined"||P.has(s)?r:l[s])}else D[s]=l[s];let S=new Set([...v]);for(let[s,r,n,a]of e.composers){t.rules.styled.cache.has(s)||(t.rules.styled.cache.add(s),it(r,[`.${s}`],[],i,h=>{t.rules.styled.apply(h)}));let p=Ti(n,D,i.media),f=Ti(a,D,i.media,!0);for(let h of p)if(h!==void 0)for(let[x,E]of h){let c=`${s}-${He(E)}-${x}`;S.add(c),t.rules.onevar.cache.has(c)||(t.rules.onevar.cache.add(c),it(E,[`.${c}`],[],i,u=>{t.rules.onevar.apply(u)}))}for(let h of f)if(h!==void 0)for(let[x,E]of h){let c=`${s}-${He(E)}-${x}`;S.add(c),t.rules.allvar.cache.has(c)||(t.rules.allvar.cache.add(c),it(E,[`.${c}`],[],i,u=>{t.rules.allvar.apply(u)}))}}if(typeof m=="object"&&m){let s=`${g}-i${He(m)}-css`;S.add(s),t.rules.inline.cache.has(s)||(t.rules.inline.cache.add(s),it(m,[`.${s}`],[],i,r=>{t.rules.inline.apply(r)}))}for(let s of String(L.className||"").trim().split(/\s+/))s&&S.add(s);let O=A.className=[...S].join(" ");return{type:e.type,className:O,selector:b,props:A,toString:()=>O}};return Xt(C,{className:g,selector:b,[Ge]:e,toString:()=>(t.rules.styled.cache.has(g)||C(),g)})},wa=i=>{let e="",t=[],g={},v=[];for(let[l,,,,P,b]of i){e===""&&(e=l),t.push(l),v.push(...b);for(let C in P){let L=P[C];(g[C]===void 0||L!=="undefined"||b.includes(L))&&(g[C]=L)}}return[e,t,g,new Set(v)]},Ti=(i,e,t,g)=>{let v=[];e:for(let[l,P,b]of i){if(b)continue;let C,L=0;for(C in l){let m=l[C],A=e[C];if(A!==m){if(typeof A!="object"||!A)continue e;{let D,S=0;for(let O in A)m===String(A[O])&&(O!=="@initial"&&(P={[O in t?t[O]:O]:P}),L+=S,D=!0),++S;if(!D)continue e}}}(v[L]=v[L]||[]).push([g?"cv":`${C}-${l[C]}`,P])}return v},Ua={},ka=tt(),Na=(i,e)=>ka(i,()=>(...t)=>{let g=()=>{for(let v of t){v=typeof v=="object"&&v||{};let l=He(v);if(!e.rules.global.cache.has(l)){if(e.rules.global.cache.add(l),"@import"in v){let P=[].indexOf.call(e.sheet.cssRules,e.rules.themed.group)-1;for(let b of[].concat(v["@import"]))b=b.includes('"')||b.includes("'")?b:`"${b}"`,e.sheet.insertRule(`@import ${b};`,P++);delete v["@import"]}it(v,[],[],i,P=>{e.rules.global.apply(P)})}}return""};return Xt(g,{toString:g})}),Ka=tt(),Wa=(i,e)=>Ka(i,()=>t=>{let g=`${Ce(i.prefix)}k-${He(t)}`,v=()=>{if(!e.rules.global.cache.has(g)){e.rules.global.cache.add(g);let l=[];it(t,[],[],i,b=>l.push(b));let P=`@keyframes ${g}{${l.join("")}}`;e.rules.global.apply(P)}return g};return Xt(v,{get name(){return v()},toString:v})}),ja=class{constructor(i,e,t,g){this.token=i==null?"":String(i),this.value=e==null?"":String(e),this.scale=t==null?"":String(t),this.prefix=g==null?"":String(g)}get computedValue(){return"var("+this.variable+")"}get variable(){return"--"+Ce(this.prefix)+Ce(this.scale)+this.token}toString(){return this.computedValue}},Ga=tt(),Ha=(i,e)=>Ga(i,()=>(t,g)=>{g=typeof t=="object"&&t||Object(g);let v=`.${t=(t=typeof t=="string"?t:"")||`${Ce(i.prefix)}t-${He(g)}`}`,l={},P=[];for(let C in g){l[C]={};for(let L in g[C]){let m=`--${Ce(i.prefix)}${C}-${L}`,A=mi(String(g[C][L]),i.prefix,C);l[C][L]=new ja(L,A,C,i.prefix),P.push(`${m}:${A}`)}}let b=()=>{if(P.length&&!e.rules.themed.cache.has(t)){e.rules.themed.cache.add(t);let C=`${g===i.theme?":root,":""}.${t}{${P.join(";")}}`;e.rules.themed.apply(C)}return t};return ut(Se({},l),{get className(){return b()},selector:v,toString:b})}),Va=["themed","global","styled","onevar","allvar","inline"],za=i=>{let e,t=()=>{if(e){let{rules:P,sheet:b}=e;if(!b.deleteRule){for(;Object(Object(b.cssRules)[0]).type===3;)b.cssRules.splice(0,1);b.cssRules=[]}for(let C in P)delete P[C];b.ownerRule&&(b.ownerRule.textContent=b.ownerRule.textContent)}let g=Object(i).styleSheets||[];for(let P of g)if(!P.href||P.href.startsWith(location.origin)){for(let b=0,C=P.cssRules;C[b];++b){let L=Object(C[b]);if(L.type!==1)continue;let m=Object(C[b+1]);if(m.type!==4)continue;++b;let{cssText:A}=L;if(!A.startsWith("--sxs"))continue;let D=A.slice(14,-3).trim().split(/\s+/),S=Va[D[0]];S&&(e||(e={sheet:P,reset:t,rules:{}}),e.rules[S]={group:m,index:b,cache:new Set(D)})}if(e)break}if(!e){let P=(b,C)=>({type:C,cssRules:[],insertRule(L,m){this.cssRules.splice(m,0,P(L,{import:3,undefined:1}[(L.toLowerCase().match(/^@([a-z]+)/)||[])[1]]||4))},get cssText(){return b==="@media{}"?`@media{${[].map.call(this.cssRules,L=>L.cssText).join("")}}`:b}});e={sheet:i?(i.head||i).appendChild(document.createElement("style")).sheet:P("","text/css"),rules:{},reset:t,toString(){let{cssRules:b}=e.sheet;return[].map.call(b,(C,L)=>{let{cssText:m}=C,A="";if(m.startsWith("--sxs"))return"";if(b[L-1]&&(A=b[L-1].cssText).startsWith("--sxs")){if(!C.cssRules.length)return"";for(let D in e.rules)if(e.rules[D].group===C)return`--sxs{--sxs:${[...e.rules[D].cache].join(" ")}}${m}`;return C.cssRules.length?`${A}${m}`:""}return m}).join("")}}}let{sheet:v,rules:l}=e;if(!l.inline){let P=v.cssRules.length;v.insertRule("@media{}",P),v.insertRule("--sxs{--sxs:5}",P),l.inline={index:P,group:v.cssRules[P+1],cache:new Set([5])}}if(nt(l.inline),!l.allvar){let P=l.inline.index;v.insertRule("@media{}",P),v.insertRule("--sxs{--sxs:4}",P),l.allvar={index:P,group:v.cssRules[P+1],cache:new Set([4])}}if(nt(l.allvar),!l.onevar){let P=l.allvar.index;v.insertRule("@media{}",P),v.insertRule("--sxs{--sxs:3}",P),l.onevar={index:P,group:v.cssRules[P+1],cache:new Set([3])}}if(nt(l.onevar),!l.styled){let P=l.onevar.index;v.insertRule("@media{}",P),v.insertRule("--sxs{--sxs:2}",P),l.styled={index:P,group:v.cssRules[P+1],cache:new Set([2])}}if(nt(l.styled),!l.global){let P=l.styled.index;v.insertRule("@media{}",P),v.insertRule("--sxs{--sxs:1}",P),l.global={index:P,group:v.cssRules[P+1],cache:new Set([1])}}if(nt(l.global),!l.themed){let P=l.global.index;v.insertRule("@media{}",P),v.insertRule("--sxs{--sxs:0}",P),l.themed={index:P,group:v.cssRules[P+1],cache:new Set([0])}}nt(l.themed)};return t(),e},nt=i=>{let e=i.group,t=e.cssRules.length;i.apply=g=>{try{e.insertRule(g,t),++t}catch{}}},Ya=tt(),Si,$a=tt(),Xa=i=>{let e=(t=>{let g=!1,v=Ya(t,l=>{g=!0;let P="prefix"in(l=typeof l=="object"&&l||{})?String(l.prefix):"",b=typeof l.media=="object"&&l.media||{},C=typeof l.root=="object"?l.root||null:globalThis.document||null,L=typeof l.theme=="object"&&l.theme||{},m={prefix:P,media:b,root:C,theme:L,themeMap:typeof l.themeMap=="object"&&l.themeMap||Se({},Aa),utils:typeof l.utils=="object"&&l.utils||{}},A=za(C),D={css:yi(m,A),globalCss:Na(m,A),keyframes:Wa(m,A),createTheme:Ha(m,A),reset(){A.reset(),D.theme.toString()},theme:{},sheet:A,config:m,prefix:P,getCssText:A.toString,toString:A.toString};return String(D.theme=D.createTheme(L)),D});return g||v.reset(),v})(i);return e.styled=(({config:t,sheet:g})=>$a(t,()=>{let v=yi(t,g);return(...l)=>{let P=v(...l),b=P[Ge].type,C=xi.forwardRef((L,m)=>{let A=L&&L.as||b,D=P(L).props;return delete D.as,D.ref=m,xi.createElement(A,D)});return C.className=P.className,C.displayName=`Styled.${b.displayName||b.name||b}`,C.selector=P.selector,C.toString=()=>P.selector,C[Ge]=P[Ge],C}}))(e),e},Qa=()=>Si||(Si=Xa());var ee=(...i)=>Qa().styled(...i);var vt=(i,e,t,g)=>{let v={canvas:void 0,annotationPage:void 0,annotations:[]},l=P=>{if(P){if(!P.body||!P.motivation){console.error("Invalid annotation after Hyperion parsing: missing either 'body' or 'motivation'",P);return}let b=i.allFromRef(P.body);switch(t){case"painting":return P.target===e.id&&P.motivation&&P.motivation[0]==="painting"&&g.includes(b[0].type)&&(P.body=b),P;case"supplementing":return;default:throw new Error("Invalid annotation motivation.")}}};return v.canvas=i.fromRef(e),v.canvas&&(v.annotationPage=i.fromRef(v.canvas.items[0])),v.annotationPage&&(v.annotations=i.allFromRef(v.annotationPage.items).filter(l)),v};var Jt=(i,e)=>{let t=vt(i,{id:e,type:"Canvas"},"painting",["Image","Sound","Video"]);if(t.annotations.length!==0&&t.annotations[0])return i.allFromRef(t.annotations[0].body)[0]};var gt=(i,e="en")=>i[e];var qt=(i,e,t,g)=>{let v=[];if(e.canvas&&e.canvas.thumbnail.length>0){let b=i.fromRef(e.canvas.thumbnail[0]);v.push(b)}if(e.annotations[0]){if(e.annotations[0].thumbnail&&e.annotations[0].thumbnail.length>0){let C=i.fromRef(e.annotations[0].thumbnail[0]);v.push(C)}let b=i.allFromRef(e.annotations[0].body);b[0].type==="Image"&&v.push(b[0])}return v.length===0?void 0:{id:v[0].id,format:v[0].format,type:v[0].type,width:t,height:g}};import Ii from"react";import at,{createRef as Ja}from"react";var er=i=>{var e=i.split(":"),t=Math.ceil(parseInt(e[0])),g=Math.ceil(parseInt(e[1])),v=Za(Math.ceil(parseInt(e[2])),2);let l=`${g}:${v}`;return t!==0&&(l=`${t}:${l}`),l},Ai=i=>{let e=new Date(i*1e3).toISOString().substr(11,8);return er(e)},Za=(i,e)=>String(i).padStart(e,"0");var qa=({canvas:i,active:e,thumbnail:t,handleChange:g})=>{let v=Ja();return at.createElement(es,{onClick:()=>g(i.id),"data-testid":"media-item-wrapper","data-active":e,ref:v},at.createElement("figure",null,at.createElement("div",null,(t==null?void 0:t.id)&&at.createElement("img",{src:t.id}),at.createElement(tr,null,Ai(i.duration))),at.createElement("figcaption",null,gt(i.label,"en"))))},tr=ee("span",{display:"flex"}),es=ee("a",{display:"flex",flexShrink:"0",margin:"0 1.618rem 0 0",cursor:"pointer",figure:{margin:"0",width:"199px","> div":{position:"relative",display:"flex",backgroundColor:"#f1f1f1",overflow:"hidden",transition:"all 200ms ease-in-out",img:{width:"199px",height:"123px",objectFit:"cover",filter:"blur(0)",transform:"scale3d(1, 1, 1)",transition:"all 200ms ease-in-out"},[`& ${tr}`]:{position:"absolute",right:"0.25rem",bottom:"0.25rem",padding:"0.125rem 0.25rem",backgroundColor:"black",color:"white",fontWeight:"700",fontSize:"0.7272rem",borderRadius:"1px",transition:"all 200ms ease-in-out",opacity:"1"}},figcaption:{marginTop:"0.382rem",fontWeight:"400"}},"&[data-active='true']":{figure:{"> div":{backgroundColor:"black","&::before":{position:"absolute",zIndex:"1",color:"white",textTransform:"uppercase",fontSize:"0.8333rem",fontWeight:"700",content:"Now Playing",display:"flex",width:"100%",height:"100%",flexDirection:"column",justifyContent:"center",textAlign:"center"},img:{opacity:"0.382",filter:"blur(2px)",transform:"scale3d(1.1, 1.1, 1.1)"},[`& ${tr}`]:{opacity:"0"}}},figcaption:{fontWeight:"700"}}}),Li=qa;var ts=({items:i})=>{let e=Ct(),t=et(),{activeCanvas:g,vault:v}=t,l="painting",P=["Image","Sound","Video"],b=L=>{g!==L&&e({type:"updateActiveCanvas",canvasId:L})},C=[];for(let L of i){let m=vt(v,L,l,P);m.annotations.length>0&&C.push(m)}return Ii.createElement(rs,null,C.map(L=>{var m,A;return Ii.createElement(Li,{active:g===((m=L==null?void 0:L.canvas)==null?void 0:m.id),canvas:L.canvas,thumbnail:qt(v,L,200,200),key:(A=L==null?void 0:L.canvas)==null?void 0:A.id,handleChange:b})}))},rs=ee("nav",{display:"flex",flexDirection:"row",flexGrow:"1",padding:"1.618rem 0.618rem 1.618rem 0 ",overflowX:"scroll",backgroundColor:"white"}),Di=ts;import ye from"react";import Oi from"react";var is=({label:i,startTime:e})=>Oi.createElement(ns,null,i,Oi.createElement("strong",null,er(e))),ns=ee("a",{display:"flex",flexGrow:"1",justifyContent:"space-between",padding:"0.5rem  1.618rem ",cursor:"pointer","&:hover":{backgroundColor:"#D8D6D6"},"&:last-child":{margin:"0 0 1.618rem"}}),Ri=is;var as=[{id:1,startTime:"00:00:00",endTime:"00:00:05.131",text:"In Santa Monica, California, latest in a long line is the Douglas DC-6 and"},{id:2,startTime:"00:00:05.131",endTime:"00:00:08.568",text:"Ben Howard, test pilot, demonstrates the reversible-pitch propellers"},{id:3,startTime:"00:00:08.568",endTime:"00:00:13.281",text:"on the four-engine craft that add to both safety and ease of operation"},{id:4,startTime:"00:00:13.281",endTime:"00:00:17.275",text:"on the ground. With the props in reverse pitch, the giant plane"},{id:5,startTime:"00:00:17.275",endTime:"00:00:20.038",text:"could be slowed down during an emergency landing."},{id:6,startTime:"00:00:20.038",endTime:"00:00:24.891",text:"Many other war-tested devices are incorporated in the luxury airliner"},{id:7,startTime:"00:00:24.891",endTime:"00:00:28.212",text:"which ushers in a new era in American aviation."},{id:8,startTime:"00:00:40.000",endTime:"00:00:44.141",text:"56 passengers will travel in up-to-the-minute comfort onboard"},{id:9,startTime:"00:00:44.141",endTime:"00:00:46.323",text:"this successor to the famous Skymaster."},{id:10,startTime:"00:00:46.323",endTime:"00:00:50.665",text:"Pressure cabins, sound proofing, traveling at a speed of 300 mph"},{id:11,startTime:"00:00:50.665",endTime:"00:00:54.009",text:"in roomy cabins that can be quickly converted into"},{id:12,startTime:"00:00:54.009",endTime:"00:00:57.097",text:"sleeping compartments for 26 passengers."},{id:13,startTime:"00:01:03.000",endTime:"00:01:06.919",text:"In this 20th-century magic carpet, you'll soon be able to laugh"},{id:14,startTime:"00:01:06.919",endTime:"00:01:10.008",text:"at time and space and dream your way across the vastness"},{id:15,startTime:"00:01:10.008",endTime:"00:01:12.933",text:"of a nation at 20,000 feet."},{id:16,startTime:"00:01:16.000",endTime:"00:01:19.481",text:"An ancient chore in a modern setting!"},{id:17,startTime:"00:01:20.800",endTime:"00:01:24.033",text:"Everything snug as a bug in a rug, ready to call it a day"},{id:18,startTime:"00:01:24.033",endTime:"00:01:26.192",text:"and tomorrow comes on wings of safety."},{id:19,startTime:"00:01:26.400",endTime:"00:01:27.800",text:"Bye now!"}],Pi={output:as};var ss=({currentTime:i})=>ye.createElement(os,{"data-testid":"navigator-wrapper"},ye.createElement(ls,null,ye.createElement(rr,{label:"Camptium",active:!0}),ye.createElement(rr,{label:"Mauris",active:!1}),ye.createElement(rr,{label:"Tristique",active:!1})),ye.createElement(us,null,ye.createElement(fs,null,ye.createElement(bi,{items:Pi.output,currentTime:i})))),rr=({label:i})=>ye.createElement(ds,null,i),bi=({items:i,currentTime:e})=>ye.createElement(ye.Fragment,null,i.map(({id:t,text:g,startTime:v})=>ye.createElement(Ri,{label:g,startTime:v,t:e,key:t}))),os=ee("div",{display:"flex",flexDirection:"column",width:"100%",height:"100%",flexGrow:"1",flexShrink:"0",position:"relative",zIndex:"1",boxShadow:"-5px 0 5px #00000011"}),ls=ee("header",{display:"flex",flexGrow:"0",padding:"0 1.618rem 1.618rem"}),us=ee("div",{display:"flex",flexGrow:"1",flexShrink:"0",position:"relative","&::after":{content:"",marginLeft:"-5px",width:"calc(100% + 5px)",height:"1.618rem",backgroundImage:"linear-gradient(0deg, #FFFFFF 0%, #FFFFFF00 100%)",position:"absolute",bottom:"0"},[`& ${bi}`]:{position:"absolute",overflowY:"scroll",height:"100%",width:"100%"}}),fs=ee("div",{position:"absolute",overflowY:"scroll",height:"100%",width:"100%"}),ds=ee("button",{display:"flex",padding:"0.618rem 1rem",background:"none",backgroundColor:"#4e2a84",color:"#fff",border:"none",fontFamily:"inherit",fontSize:"1rem",textTransform:"uppercase",marginRight:"1rem",whiteSpace:"nowrap"}),Mi=ss;var st=ur(_i());import pt from"react";var cs=({id:i,height:e,type:t,width:g})=>{let v=pt.useRef(null);return pt.useEffect(()=>{if(!i||!v.current)return;let l=new st.default;return l.attachMedia(v.current),l.on(st.default.Events.MEDIA_ATTACHED,function(){l.loadSource(i)}),l.on(st.default.Events.ERROR,function(P,b){if(b.fatal)switch(b.type){case st.default.ErrorTypes.NETWORK_ERROR:console.error(`fatal ${P} network error encountered, try to recover`),l.startLoad();break;case st.default.ErrorTypes.MEDIA_ERROR:console.error(`fatal ${P} media error encountered, try to recover`),l.recoverMediaError();break;default:l.destroy();break}}),()=>{l&&(l.detachMedia(),l.destroy())}},[i]),pt.createElement(hs,null,pt.createElement("video",{ref:v,controls:!0,height:e,width:g},pt.createElement("source",{src:i,type:t}),"Sorry, your browser doesn't support embedded videos."))},hs=ee("div",{flexGrow:"0",flexShrink:"0",maxHeight:"61.8vh",video:{display:"flex",objectFit:"cover",width:"100%",height:"100%",backgroundColor:"#e0e0e0"}}),Fi=cs;import Bi from"react";var vs=({id:i})=>Bi.createElement(gs,{"data-testid":"image-container"},Bi.createElement(ms,{src:i,alt:"Yo gimme something to describe",style:{maxHeight:"100%"}})),gs=ee("div",{width:"100%",height:"300px",background:"black",backgroundSize:"contain",color:"white"}),ms=ee("img",{maxHeight:"100%"}),wi=vs;var ps=({manifest:i})=>{let e=et(),{activeCanvas:t,vault:g}=e,[v,l]=me.useState(void 0),[P,b]=me.useState(!1);return me.useEffect(()=>{let C=Jt(g,t);C&&(b(["Audio","Video"].indexOf(C.type)>-1),l(Se({},C)))},[t]),me.createElement(Es,null,me.createElement(Ss,null,me.createElement("span",null,gt(i.label,"en"))),me.createElement(ys,null,me.createElement(Ts,null,P?me.createElement(Fi,Se({},v)):me.createElement(wi,Se({},v),"Ima placeholder for the image"),me.createElement(Di,{items:i.items,activeItem:0})),me.createElement(xs,null,me.createElement(Mi,{currentTime:100,tracks:{}}))))},Es=ee("section",{display:"flex",flexDirection:"column",padding:"1.618rem",fontFamily:"inherit"}),ys=ee("div",{display:"flex",flexDirection:"row",overflow:"hidden"}),Ts=ee("div",{display:"flex",flexDirection:"column",flexGrow:"0",flexShrink:"1",width:"61.8%"}),xs=ee("aside",{display:"flex",flexGrow:"1",flexShrink:"0",width:"38.2%"}),Ss=ee("header",{display:"flex",span:{fontSize:"1.25rem",fontWeight:"700",padding:"1rem 0"}}),Ui=ps;var Ls=({manifestId:i})=>Ve.createElement(hi,null,Ve.createElement(Is,{manifestId:i})),Is=({manifestId:i})=>{let e=Ct(),t=et(),{isLoaded:g,vault:v}=t,l=v.fromRef({id:i,type:"Manifest"});return As(()=>{v.loadManifest(i).then(P=>{e({type:"updateActiveCanvas",canvasId:P&&P.items[0].id})}).catch(P=>{console.error(`Manifest failed to load: ${P}`)}).finally(()=>{e({type:"updateIsLoaded",isLoaded:!0})})},[]),g?l.label===void 0?Ve.createElement(Ve.Fragment,null,"The IIIF manifest ",i," failed to load."):Ve.createElement(Ui,{manifest:l}):Ve.createElement(Ve.Fragment,null,"Loading")},Qo=Ls;export{Qo as default};
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
//# sourceMappingURL=index.js.map
